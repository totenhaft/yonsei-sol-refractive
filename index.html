<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EX500 Nomogram Calculator | ì—°ì„¸ì†”ì•ˆê³¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --bg-accent: #ede9fe;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --accent-primary: #7c3aed;
    --accent-secondary: #8b5cf6;
    --accent-light: #ede9fe;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --info: #2563eb;
    --info-light: #dbeafe;
    --font-sans: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'JetBrains Mono', 'Consolas', monospace;
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --transition-fast: 150ms ease;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-accent: #4c1d95;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --border-light: #334155;
    --border-medium: #475569;
    --accent-light: #4c1d95;
    --success-light: #064e3b;
    --warning-light: #78350f;
    --danger-light: #7f1d1d;
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

.app-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-lg);
}

.header {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    padding: var(--space-lg) var(--space-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-lg);
}

.header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.header .clinic-name {
    font-size: 0.875rem;
    opacity: 0.9;
}

.btn-theme {
    background: rgba(255,255,255,0.2);
    border: none;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    color: white;
    cursor: pointer;
    font-size: 1rem;
    transition: var(--transition-fast);
}

.btn-theme:hover {
    background: rgba(255,255,255,0.3);
}

.panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-lg);
    overflow: hidden;
}

.panel-header {
    background: var(--bg-tertiary);
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.panel-badge {
    background: var(--accent-light);
    color: var(--accent-primary);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.panel-content {
    padding: var(--space-lg);
}

/* Patient Info Section */
.patient-info-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    background: var(--bg-tertiary);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-lg);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-group label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input,
.form-group select {
    padding: 10px 12px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    transition: var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
}

.input-with-unit {
    position: relative;
    display: flex;
    align-items: center;
}

.input-with-unit input {
    flex: 1;
    padding-right: 40px;
}

.input-with-unit .unit {
    position: absolute;
    right: 12px;
    color: var(--text-tertiary);
    font-size: 0.8rem;
    font-family: var(--font-mono);
}

/* Eye Panels */
.eye-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
}

@media (max-width: 768px) {
    .eye-panels {
        grid-template-columns: 1fr;
    }
}

.eye-panel {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    border: 2px solid transparent;
}

.eye-panel.od {
    border-color: #3b82f6;
}

.eye-panel.os {
    border-color: #22c55e;
}

.eye-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
    font-weight: 600;
    font-size: 1rem;
}

.eye-panel.od .eye-panel-header {
    color: #3b82f6;
}

.eye-panel.os .eye-panel-header {
    color: #22c55e;
}

.eye-input-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
}

.eye-input-grid .form-group.full-width {
    grid-column: 1 / -1;
}

/* Mode Selection */
.mode-selection {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    flex-wrap: wrap;
    background: var(--accent-light);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-top: var(--space-lg);
}

.mode-selection .form-group {
    flex: 1;
    min-width: 180px;
}

.btn-calculate {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    border: none;
    padding: 14px 32px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.btn-calculate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
}

/* Results Section */
.results-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
    color: var(--text-tertiary);
    text-align: center;
}

.results-placeholder .icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
}

.result-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
}

@media (max-width: 768px) {
    .result-cards {
        grid-template-columns: 1fr;
    }
}

.result-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    border: 2px solid transparent;
}

.result-card.od {
    border-color: #3b82f6;
}

.result-card.os {
    border-color: #22c55e;
}

.result-header {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.result-card.od .result-header {
    color: #3b82f6;
}

.result-card.os .result-header {
    color: #22c55e;
}

.mode-badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 12px;
    background: var(--accent-light);
    color: var(--accent-primary);
}

.warning-box {
    background: var(--warning-light);
    color: var(--warning);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.result-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    margin-bottom: var(--space-md);
}

.result-table th,
.result-table td {
    padding: 10px 8px;
    text-align: center;
    border: 1px solid var(--border-light);
}

.result-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.result-table .highlight {
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    font-weight: 700;
}

.result-table .value-changed {
    color: #7c3aed;
    font-weight: 700;
}

.notes-box {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    margin-top: var(--space-sm);
}

.notes-box .label {
    font-weight: 600;
    color: var(--accent-primary);
}

.seq-check {
    background: var(--success-light);
    color: var(--success);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-sm);
}

.seq-check.error {
    background: var(--danger-light);
    color: var(--danger);
}

/* Actions */
.actions {
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: center;
    gap: var(--space-md);
}

.btn-print {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.btn-print:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
}

.btn-print:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.footer {
    text-align: center;
    padding: var(--space-lg);
    color: var(--text-tertiary);
    font-size: 0.8rem;
}

.footer a {
    color: var(--accent-primary);
    text-decoration: none;
}

/* Info Section */
.info-section {
    background: var(--info-light);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-lg);
}

.info-section h3 {
    color: var(--info);
    font-size: 0.9rem;
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.info-section p {
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Print Styles */
@media print {
    body {
        background: white;
        padding: 0;
    }
    
    .app-container {
        max-width: none;
        padding: 10mm;
    }
    
    .header, .panel, .result-card {
        box-shadow: none;
    }
    
    .btn-theme, .btn-calculate, .btn-print, .actions {
        display: none !important;
    }
    
    @page {
        size: A4;
        margin: 10mm;
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div>
                <h1>ğŸ¯ EX500 Nomogram Calculator</h1>
                <div class="clinic-name">ì—°ì„¸ì†”ì•ˆê³¼ YONSEI SOL EYE CLINIC</div>
            </div>
            <button class="btn-theme" onclick="toggleTheme()" title="í…Œë§ˆ ë³€ê²½">ğŸŒ“</button>
        </header>

        <div class="info-section">
            <h3>â„¹ï¸ ì‚¬ìš© ì•ˆë‚´</h3>
            <p>
                ë³¸ ê³„ì‚°ê¸°ëŠ” Alcon WaveLight EX500 ë ˆì´ì €ì˜ Nomogram ê³„ì‚°ì„ ì§€ì›í•©ë‹ˆë‹¤.<br>
                â€¢ <strong>Streamlight/CustomQ (WFO)</strong>: Manifest Refraction ê¸°ë°˜ + ë‚˜ì´ë³„ ì¡°ì •<br>
                â€¢ <strong>Contoura Vision (TG)</strong>: Alcon Training Card í”„ë¡œí† ì½œ ê¸°ë°˜ Modified ê°’ ê³„ì‚°
            </p>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>ğŸ‘¤ í™˜ì ì •ë³´</h2>
                <span class="panel-badge">Patient Info</span>
            </div>
            <div class="panel-content">
                <div class="patient-info-section">
                    <div class="form-group">
                        <label>í™˜ì ì´ë¦„</label>
                        <input type="text" id="patient-name" placeholder="í™ê¸¸ë™">
                    </div>
                    <div class="form-group">
                        <label>ë“±ë¡ë²ˆí˜¸</label>
                        <input type="text" id="patient-id" placeholder="12345678">
                    </div>
                    <div class="form-group">
                        <label>ë‚˜ì´</label>
                        <div class="input-with-unit">
                            <input type="number" id="age" min="18" max="80" value="25">
                            <span class="unit">ì„¸</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>ğŸ“Š êµ´ì ˆ ë°ì´í„° ì…ë ¥</h2>
                <span class="panel-badge">Refraction Data</span>
            </div>
            <div class="panel-content">
                <div class="eye-panels">
                    <!-- ìš°ì•ˆ (OD) -->
                    <div class="eye-panel od">
                        <div class="eye-panel-header">
                            <span>ğŸ‘ï¸ ìš°ì•ˆ (OD)</span>
                        </div>
                        <div class="eye-input-grid">
                            <div class="form-group">
                                <label>Manifest SPH</label>
                                <div class="input-with-unit">
                                    <input type="number" id="od-sph" step="0.25" value="-3.00">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manifest CYL</label>
                                <div class="input-with-unit">
                                    <input type="number" id="od-cyl" step="0.25" value="-1.00">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manifest AXIS</label>
                                <div class="input-with-unit">
                                    <input type="number" id="od-axis" min="1" max="180" value="180">
                                    <span class="unit">Â°</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>SE (ìë™)</label>
                                <div class="input-with-unit">
                                    <input type="text" id="od-se" readonly>
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group full-width" style="border-top: 1px dashed var(--border-light); padding-top: var(--space-sm); margin-top: var(--space-sm);">
                                <label style="color: var(--accent-primary);">ğŸ“ Topolyzer Measured (Contouraìš©)</label>
                            </div>
                            <div class="form-group">
                                <label>Measured CYL</label>
                                <div class="input-with-unit">
                                    <input type="number" id="od-measured-cyl" step="0.25" value="-1.25">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Measured AXIS</label>
                                <div class="input-with-unit">
                                    <input type="number" id="od-measured-axis" min="1" max="180" value="178">
                                    <span class="unit">Â°</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì¢Œì•ˆ (OS) -->
                    <div class="eye-panel os">
                        <div class="eye-panel-header">
                            <span>ğŸ‘ï¸ ì¢Œì•ˆ (OS)</span>
                        </div>
                        <div class="eye-input-grid">
                            <div class="form-group">
                                <label>Manifest SPH</label>
                                <div class="input-with-unit">
                                    <input type="number" id="os-sph" step="0.25" value="-3.25">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manifest CYL</label>
                                <div class="input-with-unit">
                                    <input type="number" id="os-cyl" step="0.25" value="-0.75">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manifest AXIS</label>
                                <div class="input-with-unit">
                                    <input type="number" id="os-axis" min="1" max="180" value="175">
                                    <span class="unit">Â°</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>SE (ìë™)</label>
                                <div class="input-with-unit">
                                    <input type="text" id="os-se" readonly>
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group full-width" style="border-top: 1px dashed var(--border-light); padding-top: var(--space-sm); margin-top: var(--space-sm);">
                                <label style="color: var(--accent-primary);">ğŸ“ Topolyzer Measured (Contouraìš©)</label>
                            </div>
                            <div class="form-group">
                                <label>Measured CYL</label>
                                <div class="input-with-unit">
                                    <input type="number" id="os-measured-cyl" step="0.25" value="-1.00">
                                    <span class="unit">D</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Measured AXIS</label>
                                <div class="input-with-unit">
                                    <input type="number" id="os-measured-axis" min="1" max="180" value="173">
                                    <span class="unit">Â°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mode-selection">
                    <div class="form-group">
                        <label>ìˆ˜ìˆ  ëª¨ë“œ ì„ íƒ</label>
                        <select id="surgery-mode">
                            <option value="streamlight">Streamlight / CustomQ (WFO)</option>
                            <option value="contoura">Contoura Vision (TG)</option>
                        </select>
                    </div>
                    <button class="btn-calculate" onclick="calculateNomogram()">
                        ğŸ¯ Nomogram ê³„ì‚°
                    </button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>ğŸ“‹ ê³„ì‚° ê²°ê³¼</h2>
                <span class="panel-badge">Modified Values</span>
            </div>
            <div class="panel-content" id="results-container">
                <div class="results-placeholder">
                    <div class="icon">ğŸ¯</div>
                    <p>êµ´ì ˆ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³ <br><strong>Nomogram ê³„ì‚°</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                </div>
            </div>
            <div class="actions">
                <button class="btn-print" onclick="printReport()" id="btn-print" disabled>
                    ğŸ–¨ï¸ ê²°ê³¼ ì¶œë ¥
                </button>
            </div>
        </div>

        <footer class="footer">
            <p>âš ï¸ ë³¸ ê³„ì‚°ê¸°ëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ìˆ˜ìˆ  ê²°ì •ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ì˜ ì„ìƒì  íŒë‹¨ì— ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.</p>
            <p>Wellington Nomogram & Contoura Vision Advisory Board ê¶Œê³  ê¸°ë°˜ | Alcon WaveLight EX500</p>
        </footer>
    </div>

    <script>
// SE ìë™ ê³„ì‚°
function updateSE() {
    ['od', 'os'].forEach(eye => {
        const sph = parseFloat(document.getElementById(`${eye}-sph`).value) || 0;
        const cyl = parseFloat(document.getElementById(`${eye}-cyl`).value) || 0;
        const se = sph + (cyl / 2);
        document.getElementById(`${eye}-se`).value = se.toFixed(2);
    });
}

// ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.querySelectorAll('#od-sph, #od-cyl, #os-sph, #os-cyl').forEach(input => {
    input.addEventListener('input', updateSE);
});
updateSE();

// í…Œë§ˆ í† ê¸€
function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
}

/**
 * Streamlight/CustomQ(WFO) Nomogram ê³„ì‚°
 */
function calculateStreamlightNomogram(sph, cyl, axis, age) {
    let sphAdjustment = 0;
    let ageNote = '';
    
    if (age < 25) {
        sphAdjustment = -0.25;
        ageNote = '20ëŒ€ ì´ˆë°˜: +0.25D ê³¼êµì • (ì¡°ì ˆë ¥, í‡´í–‰ ëŒ€ë¹„)';
    } else if (age >= 25 && age < 35) {
        sphAdjustment = 0;
        ageNote = '25-34ì„¸: í‘œì¤€ êµì •';
    } else if (age >= 35 && age < 40) {
        sphAdjustment = 0;
        ageNote = '35-39ì„¸: í‘œì¤€ êµì • (ë…¸ì•ˆ ìƒë‹´ í•„ìš”)';
    } else if (age >= 40 && age < 45) {
        sphAdjustment = 0.25;
        ageNote = '40-44ì„¸: -0.25D ì €êµì • (ë…¸ì•ˆ ê³ ë ¤)';
    } else {
        sphAdjustment = 0.25;
        ageNote = '45ì„¸ ì´ìƒ: -0.25D ì €êµì • (ë…¸ì•ˆ/monovision)';
    }
    
    const se = sph + (cyl / 2);
    let highMyopiaAdjustment = 0;
    let highMyopiaNote = '';
    
    if (se < -6) {
        highMyopiaAdjustment = Math.abs(se) * 0.05;
        highMyopiaNote = `ê³ ë„ê·¼ì‹œ (SE: ${se.toFixed(2)}D): ${highMyopiaAdjustment.toFixed(2)}D ê°ì†Œ`;
    } else if (se > -3) {
        highMyopiaAdjustment = -0.12;
        highMyopiaNote = `ì €ë„ê·¼ì‹œ (SE: ${se.toFixed(2)}D): 0.12D ì¶”ê°€`;
    }
    
    const modifiedSph = sph + sphAdjustment + highMyopiaAdjustment;
    
    return {
        mode: 'Streamlight/CustomQ (WFO)',
        manifest: { sph, cyl, axis, se },
        modified: {
            sph: Math.round(modifiedSph * 4) / 4,
            cyl: cyl,
            axis: axis,
            se: Math.round(modifiedSph * 4) / 4 + (cyl / 2)
        },
        adjustments: { age: sphAdjustment, highMyopia: highMyopiaAdjustment },
        notes: { age: ageNote, highMyopia: highMyopiaNote },
        seqMatch: true,
        warning: null
    };
}

/**
 * Contoura Vision (TG) Nomogram ê³„ì‚°
 */
function calculateContouraVisionNomogram(sph, cyl, axis, measuredCyl, measuredAxis, age) {
    const refSph = parseFloat(sph);
    const refCyl = parseFloat(cyl);
    const refAxis = parseFloat(axis);
    const measCyl = parseFloat(measuredCyl);
    const measAxis = parseFloat(measuredAxis);
    
    let axisDiff = Math.abs(refAxis - measAxis);
    if (axisDiff > 90) axisDiff = 180 - axisDiff;
    
    const cylDiff = Math.abs(measCyl) - Math.abs(refCyl);
    
    let warning = null;
    if (Math.abs(cylDiff) > 1.25) {
        warning = `âš ï¸ CYL ì°¨ì´ ${Math.abs(cylDiff).toFixed(2)}D > 1.25D: WFO ê¶Œì¥`;
    } else if (Math.abs(refCyl) >= 2.0 && axisDiff > 5) {
        warning = `âš ï¸ Axis ì°¨ì´ ${axisDiff}Â° > 5Â° (CYLâ‰¥2D): WFO ê¶Œì¥`;
    } else if (Math.abs(refCyl) < 2.0 && axisDiff > 10) {
        warning = `âš ï¸ Axis ì°¨ì´ ${axisDiff}Â° > 10Â° (CYL<2D): WFO ê¶Œì¥`;
    }
    
    const modifiedAxis = measAxis;
    
    let modifiedCyl;
    if (Math.abs(refCyl) >= Math.abs(measCyl)) {
        modifiedCyl = measCyl;
    } else {
        const halfDiff = (Math.abs(measCyl) - Math.abs(refCyl)) / 2;
        modifiedCyl = refCyl - halfDiff;
    }
    
    const manifestSeq = refSph + (refCyl / 2);
    let modifiedSph;
    
    if (Math.abs(refCyl) >= Math.abs(measCyl)) {
        const cylDiffHalf = (Math.abs(refCyl) - Math.abs(measCyl)) / 2;
        modifiedSph = refSph - cylDiffHalf;
    } else {
        const cylDiffQuarter = (Math.abs(measCyl) - Math.abs(refCyl)) / 4;
        modifiedSph = refSph + cylDiffQuarter;
    }
    
    let ageAdjustment = 0;
    let ageNote = '';
    
    if (age < 25) {
        ageAdjustment = -0.12;
        ageNote = '20ëŒ€ ì´ˆë°˜: ì¶”ê°€ 0.12D ê³¼êµì •';
    } else if (age >= 40) {
        ageAdjustment = 0.12;
        ageNote = '40ì„¸ ì´ìƒ: 0.12D ì €êµì • (ë…¸ì•ˆ)';
    }
    
    const finalModifiedSph = modifiedSph + ageAdjustment;
    const modifiedSeq = finalModifiedSph + (modifiedCyl / 2);
    const seqDiff = Math.abs(manifestSeq - modifiedSeq);
    const seqMatch = seqDiff < 0.13;
    
    return {
        mode: 'Contoura Vision (TG)',
        manifest: { sph: refSph, cyl: refCyl, axis: refAxis, se: manifestSeq },
        measured: { cyl: measCyl, axis: measAxis },
        modified: {
            sph: Math.round(finalModifiedSph * 4) / 4,
            cyl: Math.round(modifiedCyl * 4) / 4,
            axis: modifiedAxis,
            se: Math.round((finalModifiedSph + modifiedCyl/2) * 4) / 4
        },
        adjustments: {
            age: ageAdjustment,
            cylMethod: Math.abs(refCyl) >= Math.abs(measCyl) ? '2.a' : '2.b',
            sphMethod: Math.abs(refCyl) >= Math.abs(measCyl) ? '3.a' : '3.b'
        },
        notes: {
            age: ageNote,
            axis: `Axis: Manifest ${refAxis}Â° â†’ Measured ${measAxis}Â°`,
            cyl: Math.abs(refCyl) >= Math.abs(measCyl) 
                ? `CYL: Measured (${measCyl}D) ì‚¬ìš©`
                : `CYL: Refraction + Â½ì°¨ì´ = ${modifiedCyl.toFixed(2)}D`,
            sph: Math.abs(refCyl) >= Math.abs(measCyl)
                ? `SPH: +Â½(CYLì°¨ì´) = ${modifiedSph.toFixed(2)}D`
                : `SPH: -Â¼(CYLì°¨ì´) = ${modifiedSph.toFixed(2)}D`
        },
        seqMatch: seqMatch,
        seqDiff: seqDiff,
        warning: warning
    };
}

/**
 * Nomogram ê³„ì‚° ì‹¤í–‰
 */
function calculateNomogram() {
    const mode = document.getElementById('surgery-mode').value;
    const age = parseInt(document.getElementById('age').value);
    
    const odData = {
        sph: parseFloat(document.getElementById('od-sph').value),
        cyl: parseFloat(document.getElementById('od-cyl').value),
        axis: parseFloat(document.getElementById('od-axis').value),
        measuredCyl: parseFloat(document.getElementById('od-measured-cyl').value),
        measuredAxis: parseFloat(document.getElementById('od-measured-axis').value)
    };
    
    const osData = {
        sph: parseFloat(document.getElementById('os-sph').value),
        cyl: parseFloat(document.getElementById('os-cyl').value),
        axis: parseFloat(document.getElementById('os-axis').value),
        measuredCyl: parseFloat(document.getElementById('os-measured-cyl').value),
        measuredAxis: parseFloat(document.getElementById('os-measured-axis').value)
    };
    
    let odResult, osResult;
    
    if (mode === 'streamlight') {
        odResult = calculateStreamlightNomogram(odData.sph, odData.cyl, odData.axis, age);
        osResult = calculateStreamlightNomogram(osData.sph, osData.cyl, osData.axis, age);
    } else {
        odResult = calculateContouraVisionNomogram(
            odData.sph, odData.cyl, odData.axis,
            odData.measuredCyl, odData.measuredAxis, age
        );
        osResult = calculateContouraVisionNomogram(
            osData.sph, osData.cyl, osData.axis,
            osData.measuredCyl, osData.measuredAxis, age
        );
    }
    
    window.nomogramResults = { od: odResult, os: osResult, age, mode };
    renderResults(odResult, osResult, mode);
    document.getElementById('btn-print').disabled = false;
}

/**
 * ê²°ê³¼ ë Œë”ë§
 */
function renderResults(odResult, osResult, mode) {
    const container = document.getElementById('results-container');
    container.innerHTML = `
        <div class="result-cards">
            ${renderEyeResult('od', 'ìš°ì•ˆ (OD)', odResult, mode)}
            ${renderEyeResult('os', 'ì¢Œì•ˆ (OS)', osResult, mode)}
        </div>
    `;
}

function renderEyeResult(eye, label, result, mode) {
    const warningHtml = result.warning ? `<div class="warning-box">${result.warning}</div>` : '';
    
    const measuredRow = mode === 'contoura' ? `
        <tr>
            <td>Measured (Topolyzer)</td>
            <td>-</td>
            <td>${result.measured.cyl.toFixed(2)}</td>
            <td>${result.measured.axis}Â°</td>
            <td>-</td>
        </tr>
    ` : '';
    
    const methodNotes = mode === 'contoura' ? `
        <div class="notes-box">
            <div><span class="label">ì ìš© ë°©ë²•:</span></div>
            <div>â€¢ ${result.notes.axis}</div>
            <div>â€¢ ${result.notes.cyl}</div>
            <div>â€¢ ${result.notes.sph}</div>
        </div>
    ` : '';
    
    const seqClass = result.seqMatch ? '' : 'error';
    const seqIcon = result.seqMatch ? 'âœ“' : 'âš ï¸';
    const seqText = result.seqMatch 
        ? `SEQ ì¼ì¹˜: Manifest ${result.manifest.se.toFixed(2)}D â‰ˆ Modified ${result.modified.se.toFixed(2)}D`
        : `SEQ ë¶ˆì¼ì¹˜: Manifest ${result.manifest.se.toFixed(2)}D â‰  Modified ${result.modified.se.toFixed(2)}D (ì°¨ì´: ${result.seqDiff?.toFixed(2) || 0}D)`;
    
    return `
        <div class="result-card ${eye}">
            <div class="result-header">
                <span>ğŸ‘ï¸ ${label}</span>
                <span class="mode-badge">${result.mode}</span>
            </div>
            
            ${warningHtml}
            
            <table class="result-table">
                <thead>
                    <tr>
                        <th>êµ¬ë¶„</th>
                        <th>SPH</th>
                        <th>CYL</th>
                        <th>AXIS</th>
                        <th>SEQ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Manifest Refraction</td>
                        <td>${result.manifest.sph.toFixed(2)}</td>
                        <td>${result.manifest.cyl.toFixed(2)}</td>
                        <td>${result.manifest.axis}Â°</td>
                        <td>${result.manifest.se.toFixed(2)}</td>
                    </tr>
                    ${measuredRow}
                    <tr class="highlight">
                        <td><strong>Modified (ì…ë ¥ê°’)</strong></td>
                        <td class="${result.manifest.sph !== result.modified.sph ? 'value-changed' : ''}">${result.modified.sph.toFixed(2)}</td>
                        <td class="${result.manifest.cyl !== result.modified.cyl ? 'value-changed' : ''}">${result.modified.cyl.toFixed(2)}</td>
                        <td class="${result.manifest.axis !== result.modified.axis ? 'value-changed' : ''}">${result.modified.axis}Â°</td>
                        <td>${result.modified.se.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="notes-box">
                <span class="label">ğŸ“… ë‚˜ì´ ì¡°ì •:</span> ${result.notes.age || 'í‘œì¤€ êµì •'}
                ${result.notes.highMyopia ? `<br><span class="label">ğŸ“Š êµ´ì ˆë ¥ ì¡°ì •:</span> ${result.notes.highMyopia}` : ''}
            </div>
            
            ${methodNotes}
            
            <div class="seq-check ${seqClass}">
                <span>${seqIcon}</span>
                <span>${seqText}</span>
            </div>
        </div>
    `;
}

/**
 * ì¸ì‡„ ê¸°ëŠ¥
 */
function printReport() {
    if (!window.nomogramResults) return;
    
    const results = window.nomogramResults;
    const patientName = document.getElementById('patient-name').value || '-';
    const patientId = document.getElementById('patient-id').value || '-';
    const age = results.age;
    const mode = results.mode === 'streamlight' ? 'Streamlight/CustomQ (WFO)' : 'Contoura Vision (TG)';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <title>EX500 Nomogram Report</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Noto Sans KR', -apple-system, sans-serif;
                    padding: 15mm;
                    font-size: 10pt;
                    color: #000;
                }
                .header {
                    display: flex;
                    justify-content: space-between;
                    border-bottom: 3px solid #7c3aed;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                .header h1 { font-size: 16pt; color: #7c3aed; }
                .clinic { text-align: right; font-size: 9pt; color: #666; }
                .patient-info {
                    background: #f5f5f5;
                    padding: 10px 15px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                    display: flex;
                    gap: 30px;
                    flex-wrap: wrap;
                }
                .patient-info .item { display: flex; gap: 8px; }
                .patient-info .label { color: #666; font-size: 9pt; }
                .patient-info .value { font-weight: 600; }
                .mode-badge {
                    background: #ede9fe;
                    color: #7c3aed;
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-size: 9pt;
                    font-weight: 600;
                }
                .eyes-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 20px;
                }
                .eye-box {
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                }
                .eye-box.od { border-color: #3b82f6; }
                .eye-box.os { border-color: #22c55e; }
                .eye-box h3 { margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid #eee; }
                .eye-box.od h3 { color: #3b82f6; }
                .eye-box.os h3 { color: #22c55e; }
                table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 12px; }
                th, td { padding: 6px 8px; border: 1px solid #ddd; text-align: center; }
                th { background: #f5f5f5; font-weight: 600; }
                .modified { background: #ede9fe; font-weight: 700; }
                .changed { color: #7c3aed; }
                .notes { background: #f0f9ff; padding: 8px; border-radius: 4px; font-size: 8pt; color: #0369a1; margin-top: 10px; }
                .warning { background: #fef3c7; color: #92400e; padding: 8px; border-radius: 4px; font-size: 8pt; margin-bottom: 10px; }
                .footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 8pt; color: #999; text-align: center; }
                .disclaimer { background: #fff3cd; padding: 8px; border-radius: 4px; font-size: 7pt; color: #856404; margin-top: 15px; }
                @media print { body { padding: 10mm; } @page { size: A4; margin: 10mm; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ¯ EX500 Nomogram Report</h1>
                <div class="clinic">
                    <div>ì—°ì„¸ì†”ì•ˆê³¼</div>
                    <div>YONSEI SOL EYE CLINIC</div>
                    <div>${new Date().toLocaleDateString('ko-KR')}</div>
                </div>
            </div>
            
            <div class="patient-info">
                <div class="item"><span class="label">í™˜ìëª…:</span><span class="value">${patientName}</span></div>
                <div class="item"><span class="label">ë“±ë¡ë²ˆí˜¸:</span><span class="value">${patientId}</span></div>
                <div class="item"><span class="label">ë‚˜ì´:</span><span class="value">${age}ì„¸</span></div>
                <div class="item"><span class="label">ìˆ˜ìˆ  ëª¨ë“œ:</span><span class="mode-badge">${mode}</span></div>
            </div>
            
            <div class="eyes-grid">
                ${generatePrintEye('od', 'ìš°ì•ˆ (OD)', results.od, results.mode)}
                ${generatePrintEye('os', 'ì¢Œì•ˆ (OS)', results.os, results.mode)}
            </div>
            
            <div class="disclaimer">
                âš ï¸ ë³¸ Nomogramì€ Alcon WaveLight EX500 ë ˆì´ì €ì— ìµœì í™”ë˜ì–´ ìˆìœ¼ë©°, Wellington Nomogram ë° Contoura Vision Advisory Board ê¶Œê³ ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
                ìµœì¢… ìˆ˜ìˆ  íŒŒë¼ë¯¸í„°ëŠ” ë°˜ë“œì‹œ ì§‘ë„ì˜ì˜ ì„ìƒì  íŒë‹¨ì— ë”°ë¼ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            </div>
            
            <div class="footer">
                Generated by EX500 Nomogram Calculator | ${new Date().toLocaleString('ko-KR')}
            </div>
            
            <script>window.onload = function() { window.print(); };</script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

function generatePrintEye(eye, label, result, mode) {
    const warningHtml = result.warning ? `<div class="warning">${result.warning}</div>` : '';
    const measuredRow = mode === 'contoura' ? `
        <tr><td>Measured</td><td>-</td><td>${result.measured.cyl.toFixed(2)}</td><td>${result.measured.axis}Â°</td><td>-</td></tr>
    ` : '';
    
    const sphChanged = result.manifest.sph !== result.modified.sph;
    const cylChanged = result.manifest.cyl !== result.modified.cyl;
    const axisChanged = result.manifest.axis !== result.modified.axis;
    
    return `
        <div class="eye-box ${eye}">
            <h3>ğŸ‘ï¸ ${label}</h3>
            ${warningHtml}
            <table>
                <thead><tr><th>êµ¬ë¶„</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>SEQ</th></tr></thead>
                <tbody>
                    <tr>
                        <td>Manifest</td>
                        <td>${result.manifest.sph.toFixed(2)}</td>
                        <td>${result.manifest.cyl.toFixed(2)}</td>
                        <td>${result.manifest.axis}Â°</td>
                        <td>${result.manifest.se.toFixed(2)}</td>
                    </tr>
                    ${measuredRow}
                    <tr class="modified">
                        <td><strong>Modified</strong></td>
                        <td class="${sphChanged ? 'changed' : ''}">${result.modified.sph.toFixed(2)}</td>
                        <td class="${cylChanged ? 'changed' : ''}">${result.modified.cyl.toFixed(2)}</td>
                        <td class="${axisChanged ? 'changed' : ''}">${result.modified.axis}Â°</td>
                        <td>${result.modified.se.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            <div class="notes">
                <strong>ğŸ“… ë‚˜ì´ ì¡°ì •:</strong> ${result.notes.age || 'í‘œì¤€ êµì •'}<br>
                ${result.notes.highMyopia ? `<strong>ğŸ“Š êµ´ì ˆë ¥:</strong> ${result.notes.highMyopia}<br>` : ''}
                ${mode === 'contoura' ? `
                    <strong>ğŸ“ ë°©ë²•:</strong><br>
                    â€¢ ${result.notes.axis}<br>
                    â€¢ ${result.notes.cyl}<br>
                    â€¢ ${result.notes.sph}
                ` : ''}
            </div>
        </div>
    `;
}
    </script>
</body>
</html>
