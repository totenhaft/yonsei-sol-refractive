<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시력교정술 적합성 검사 | Refractive Surgery Eligibility Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ============================================
   Refractive Surgery Eligibility Checker
   Medical-Grade Professional UI
   ============================================ */

:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --bg-accent: #e0f2fe;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    --text-inverse: #ffffff;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-focus: #0ea5e9;
    --accent-primary: #0284c7;
    --accent-secondary: #0ea5e9;
    --accent-light: #e0f2fe;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --info: #2563eb;
    --info-light: #dbeafe;
    --font-sans: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'JetBrains Mono', 'Consolas', monospace;
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-accent: #0c4a6e;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --text-inverse: #0f172a;
    --border-light: #334155;
    --border-medium: #475569;
    --border-focus: #38bdf8;
    --accent-primary: #38bdf8;
    --accent-secondary: #0ea5e9;
    --accent-light: #0c4a6e;
    --success-light: #064e3b;
    --warning-light: #78350f;
    --danger-light: #7f1d1d;
    --info-light: #1e3a8a;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    padding: var(--space-md) var(--space-xl);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
}

.header-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.logo-icon {
    width: 40px;
    height: 40px;
    color: var(--accent-primary);
}

.logo-text h1 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.02em;
}

.logo-text .subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-weight: 400;
}

.btn-icon {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.btn-icon:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-icon svg {
    width: 20px;
    height: 20px;
}

.icon-moon { display: none; }
[data-theme="dark"] .icon-sun { display: none; }
[data-theme="dark"] .icon-moon { display: block; }

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding: var(--space-md);
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

.panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* Input panel - full width, compact */
.input-panel {
    width: 100%;
}

.input-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
}

.input-panel .panel-header h2 {
    font-size: 1rem;
}

.input-panel .form-grid {
    padding: var(--space-sm) var(--space-md);
    gap: var(--space-sm);
}

/* Results panel */
.results-panel {
    width: 100%;
}

.results-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    user-select: none;
}

.results-panel .panel-header:hover {
    background: var(--bg-tertiary);
}

.results-panel .panel-header h2 {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.results-panel .panel-header h2::before {
    content: '▼';
    font-size: 0.625rem;
    transition: transform var(--transition-fast);
}

.results-panel.collapsed .panel-header h2::before {
    transform: rotate(-90deg);
}

.results-panel.collapsed .results-container {
    display: none;
}

.panel-header {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, var(--bg-accent), transparent);
}

.panel-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.panel-badge {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--accent-primary);
    background: var(--accent-light);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.form-grid {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    overflow-y: auto;
    flex: 1;
}

.form-section {
    padding: var(--space-lg);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

.section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
}

.section-icon { font-size: 1rem; }

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.form-row.triple { grid-template-columns: repeat(3, 1fr); }

@media (max-width: 600px) {
    .form-row, .form-row.triple { grid-template-columns: 1fr; }
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.form-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-group input,
.form-group select {
    height: 44px;
    padding: 0 var(--space-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 1rem;
    font-family: var(--font-mono);
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-light);
}

.form-group input::-webkit-inner-spin-button { opacity: 1; }

.calculated-field {
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px dashed var(--border-medium);
}

.calc-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.btn-primary {
    height: 52px;
    padding: 0 var(--space-xl);
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: var(--text-inverse);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
    height: 44px;
    padding: 0 var(--space-lg);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
}

.btn-secondary:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-focus);
}

.btn-secondary svg {
    width: 18px;
    height: 18px;
}

.btn-calculate { margin-top: var(--space-md); }

.results-container {
    flex: 1;
    padding: var(--space-xl);
    overflow-y: auto;
}

.results-placeholder {
    height: 100%;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-tertiary);
}

.placeholder-icon {
    width: 80px;
    height: 80px;
    margin-bottom: var(--space-lg);
    opacity: 0.5;
}

.placeholder-icon svg {
    width: 100%;
    height: 100%;
}

.results-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.card-header {
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: var(--font-mono);
}

.summary-card {
    background: linear-gradient(135deg, var(--accent-light), var(--bg-tertiary));
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    padding: var(--space-lg);
}

.summary-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    transition: all var(--transition-fast);
}

.summary-item.eligible {
    border-color: var(--success);
    background: var(--success-light);
}

.summary-item.caution {
    border-color: var(--warning);
    background: var(--warning-light);
}

.summary-item.not-eligible {
    border-color: var(--danger);
    background: var(--danger-light);
}

.summary-item.pending {
    border-color: var(--text-tertiary);
    background: var(--bg-tertiary);
}

.summary-item.pending .surgery-status {
    color: var(--text-tertiary);
}

.surgery-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
}

.surgery-status { font-size: 0.8125rem; font-weight: 500; }
.summary-item.eligible .surgery-status { color: var(--success); }
.summary-item.caution .surgery-status { color: var(--warning); }
.summary-item.not-eligible .surgery-status { color: var(--danger); }

.table-container {
    padding: var(--space-md);
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table th,
.data-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.data-table th {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    font-family: var(--font-mono);
    color: var(--text-primary);
}

.data-table tbody tr:hover { background: var(--bg-secondary); }
.data-table .warning { color: var(--warning); font-weight: 600; }
.data-table .danger { color: var(--danger); font-weight: 600; }
.data-table .success { color: var(--success); font-weight: 600; }

/* ICL Card Styles */
.icl-card .card-header {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
}

.icl-assessment {
    padding: var(--space-md);
}

.icl-criteria-grid {
    display: grid;
    gap: var(--space-sm);
}

.icl-criterion {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    border-left: 4px solid var(--border-light);
}

.icl-criterion.pass {
    border-left-color: var(--success);
    background: rgba(34, 197, 94, 0.05);
}

.icl-criterion.fail {
    border-left-color: var(--danger);
    background: rgba(239, 68, 68, 0.05);
}

.icl-criterion.warning {
    border-left-color: var(--warning);
    background: rgba(245, 158, 11, 0.05);
}

.icl-criterion-name {
    font-weight: 500;
    color: var(--text-primary);
}

.icl-criterion-value {
    font-family: var(--font-mono);
    font-weight: 600;
}

.icl-criterion-status {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.icl-criterion-status .icon {
    font-size: 1rem;
}

.icl-overall-result {
    margin-top: var(--space-md);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    text-align: center;
}

.icl-overall-result.eligible {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2));
    border: 2px solid var(--success);
}

.icl-overall-result.not-eligible {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
    border: 2px solid var(--danger);
}

.icl-overall-result.caution {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
    border: 2px solid var(--warning);
}

.icl-result-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: var(--space-xs);
}

.icl-result-message {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.icl-lens-size {
    margin-top: var(--space-md);
    padding: var(--space-sm);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    text-align: center;
}

.icl-lens-size .size-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.icl-lens-size .size-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #8b5cf6;
}

.icl-lens-size .size-note {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: var(--space-xs);
}

.icl-criterion-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.icl-criterion-req {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.summary-item#summary-icl-od,
.summary-item#summary-icl-os {
    border-color: #8b5cf6;
}

.summary-item#summary-icl-od.eligible,
.summary-item#summary-icl-os.eligible {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.2));
    border-color: #8b5cf6;
}

.summary-item#summary-icl-od.caution,
.summary-item#summary-icl-os.caution {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
    border-color: var(--warning);
}

.summary-item#summary-icl-od.not-eligible,
.summary-item#summary-icl-os.not-eligible {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
    border-color: var(--danger);
}

.k-values-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-xl);
}

.k-value-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    min-width: 140px;
}

.k-value-item.highlight {
    background: var(--accent-light);
    border: 2px solid var(--accent-primary);
}

.k-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.k-value {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.k-arrow {
    font-size: 1.5rem;
    color: var(--accent-primary);
}

.k-note {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-align: center;
    border-top: 1px solid var(--border-light);
}

.k-note.warning {
    background: var(--warning-light);
    color: var(--warning);
}

.risk-section {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-light);
}

.risk-section:last-child { border-bottom: none; }

.risk-section h4 {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}

.erss-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.erss-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
}

.erss-item-label { color: var(--text-secondary); }

.erss-item-score {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--text-primary);
}

.erss-total {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.erss-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.erss-score {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.erss-risk-level {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.erss-risk-level.low { background: var(--success-light); color: var(--success); }
.erss-risk-level.moderate { background: var(--warning-light); color: var(--warning); }
.erss-risk-level.high { background: var(--danger-light); color: var(--danger); }

.pta-display {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.pta-item {
    text-align: center;
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
}

.pta-item.safe { border-color: var(--success); }
.pta-item.caution { border-color: var(--warning); }
.pta-item.danger { border-color: var(--danger); }

.pta-surgery {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.pta-value {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
}

.pta-item.safe .pta-value { color: var(--success); }
.pta-item.caution .pta-value { color: var(--warning); }
.pta-item.danger .pta-value { color: var(--danger); }

.pta-status {
    font-size: 0.6875rem;
    margin-top: var(--space-xs);
}

.nomogram-info { padding: var(--space-lg); }

.nomogram-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--accent-primary);
    margin-bottom: var(--space-sm);
}

.nomogram-item:last-child { margin-bottom: 0; }

.nomogram-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.nomogram-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.erss-note {
    margin-top: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--warning-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--warning);
}

.combined-risk-guide {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.risk-guide-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--border-light);
}

.risk-guide-item.low-risk {
    border-left-color: var(--success);
    background: var(--success-light);
}

.risk-guide-item.moderate-risk {
    border-left-color: var(--warning);
    background: var(--warning-light);
}

.risk-guide-item.high-risk {
    border-left-color: var(--danger);
    background: var(--danger-light);
}

.risk-guide-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

.risk-guide-icon {
    font-size: 1.25rem;
}

.risk-guide-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.risk-guide-condition {
    font-size: 0.75rem;
    font-family: var(--font-mono);
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    display: inline-block;
}

.risk-guide-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.risk-guide-recommendation {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px dashed var(--border-light);
    font-size: 0.8125rem;
    font-weight: 500;
}

.risk-guide-item.low-risk .risk-guide-recommendation {
    color: var(--success);
}

.risk-guide-item.moderate-risk .risk-guide-recommendation {
    color: var(--warning);
}

.risk-guide-item.high-risk .risk-guide-recommendation {
    color: var(--danger);
}

/* Combined Risk Interpretation */
.combined-risk-section {
    padding: var(--space-lg);
}

.combined-risk-matrix {
    display: grid;
    grid-template-columns: auto repeat(3, 1fr);
    gap: 2px;
    margin-bottom: var(--space-lg);
    background: var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.matrix-cell {
    padding: var(--space-sm) var(--space-md);
    text-align: center;
    font-size: 0.75rem;
    background: var(--bg-secondary);
}

.matrix-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.matrix-row-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    text-align: left;
}

.matrix-cell.risk-low {
    background: var(--success-light);
    color: var(--success);
    font-weight: 500;
}

.matrix-cell.risk-moderate {
    background: var(--warning-light);
    color: var(--warning);
    font-weight: 500;
}

.matrix-cell.risk-high {
    background: var(--danger-light);
    color: var(--danger);
    font-weight: 500;
}

.matrix-cell.current-position {
    outline: 3px solid var(--accent-primary);
    outline-offset: -3px;
    font-weight: 700;
}

.interpretation-guide {
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.interpretation-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.interpretation-badge {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 600;
}

.interpretation-badge.low {
    background: var(--success-light);
    color: var(--success);
}

.interpretation-badge.moderate {
    background: var(--warning-light);
    color: var(--warning);
}

.interpretation-badge.high {
    background: var(--danger-light);
    color: var(--danger);
}

.interpretation-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.interpretation-recommendations {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.interpretation-recommendations h5 {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.recommendation-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recommendation-list li {
    font-size: 0.8125rem;
    color: var(--text-primary);
    padding: var(--space-xs) 0;
    padding-left: var(--space-lg);
    position: relative;
}

.recommendation-list li::before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--accent-primary);
}

.clinical-note {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--info-light);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--info);
}

.note-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.note-content {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.note-content strong {
    color: var(--text-primary);
}

.reference {
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    font-style: italic;
}

.result-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.footer {
    padding: var(--space-lg) var(--space-xl);
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-light);
    text-align: center;
}

.footer p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.footer-small {
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

@media print {
    .header, .footer, .input-panel, .result-actions { display: none; }
    .main-content { display: block; }
    .results-panel { box-shadow: none; border: none; }
    .result-card { break-inside: avoid; margin-bottom: 1rem; }
}

@media (max-width: 768px) {
    .header { padding: var(--space-sm) var(--space-md); }
    .main-content { padding: var(--space-md); gap: var(--space-md); }
    .panel-header { padding: var(--space-md); }
    .form-grid { padding: var(--space-md); }
    .summary-grid { grid-template-columns: 1fr; }
    .pta-display { grid-template-columns: 1fr; }
    .k-values-display { flex-direction: column; gap: var(--space-md); }
    .k-arrow { transform: rotate(90deg); }
    .result-actions { flex-direction: column; }
    .result-actions button { width: 100%; }
    .eye-panels { flex-direction: column; }
}

/* Bilateral Eye Input Styles */
.eye-panels-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

@media (max-width: 800px) {
    .eye-panels-container {
        grid-template-columns: 1fr;
    }
}

.eye-panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    overflow: visible;
}

.eye-panel.right-eye {
    border-color: #3b82f6;
}

.eye-panel.left-eye {
    border-color: #22c55e;
}

.eye-panel-header {
    padding: var(--space-xs) var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-weight: 600;
    font-size: 0.875rem;
}

.eye-panel.right-eye .eye-panel-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.eye-panel.left-eye .eye-panel-header {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.eye-icon {
    font-size: 0.875rem;
}

.eye-panel-content {
    padding: var(--space-sm) var(--space-md);
}

.eye-panel .form-section {
    padding: 0;
    margin-bottom: var(--space-sm);
    border: none;
    background: transparent;
}

.eye-panel .form-section:last-child {
    margin-bottom: 0;
}

.eye-panel .section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: var(--space-xs) 0;
    margin-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

/* Compact form layout for eye panels */
.form-row-compact {
    display: flex;
    gap: 4px;
    margin-bottom: 4px;
    flex-wrap: nowrap;
}

.form-group.compact {
    flex: 1;
    min-width: 45px;
}

.form-group.compact label {
    font-size: 0.5625rem;
    margin-bottom: 1px;
    display: block;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.input-with-unit {
    display: flex;
    align-items: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.input-with-unit input {
    flex: 1;
    border: none;
    padding: 4px 6px;
    font-size: 0.75rem;
    min-width: 0;
    background: transparent;
    font-family: var(--font-mono);
}

.input-with-unit input:focus {
    outline: none;
    box-shadow: none;
}

.input-with-unit:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15);
}

.input-with-unit .unit {
    padding: 4px 4px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    font-size: 0.5625rem;
    font-family: var(--font-mono);
    border-left: 1px solid var(--border-light);
    white-space: nowrap;
}

.select-compact {
    padding: 4px 6px;
    font-size: 0.75rem;
    width: 100%;
}

.eye-panel select {
    padding: 4px 6px;
    font-size: 0.75rem;
}

/* Four column layout for patient info */
.form-row.four-col {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr 1fr;
    gap: var(--space-md);
}

@media (max-width: 768px) {
    .form-row.four-col {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Patient info section */
.patient-info-section {
    background: var(--bg-accent);
    border: 1px solid var(--accent-primary);
    padding: var(--space-sm) var(--space-md);
}

.patient-info-section .shared-section-title {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

.patient-info-section .form-row {
    gap: var(--space-sm);
}

.patient-info-section input,
.patient-info-section select {
    padding: 6px 8px;
    font-size: 0.8125rem;
}

/* Calculated field */
.calculated-field {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px var(--space-xs);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: 2px;
}

.calc-label {
    font-size: 0.625rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
}

/* Form actions */
.form-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: var(--space-sm);
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.form-actions .tabindex-hint {
    margin: 0;
    font-size: 0.6875rem;
}

.btn-calculate {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.875rem;
}

/* AI Analysis Section Styles */
.ai-analysis-section {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    border: 1px solid #6366f1;
    color: white;
    padding: var(--space-sm) var(--space-md);
}

[data-theme="light"] .ai-analysis-section {
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    border-color: #a5b4fc;
    color: var(--text-primary);
}

.ai-analysis-section .shared-section-title {
    color: white;
    border-bottom-color: rgba(255,255,255,0.2);
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

[data-theme="light"] .ai-analysis-section .shared-section-title {
    color: #4338ca;
    border-bottom-color: #c7d2fe;
}

.beta-badge {
    font-size: 0.5rem;
    padding: 1px 4px;
    background: #f59e0b;
    color: #000;
    border-radius: 3px;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin-left: var(--space-xs);
}

.section-description {
    font-size: 0.6875rem;
    color: rgba(255,255,255,0.8);
    margin-bottom: var(--space-sm);
}

[data-theme="light"] .section-description {
    color: #6366f1;
}

.ai-analysis-panels {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

@media (max-width: 800px) {
    .ai-analysis-panels {
        grid-template-columns: 1fr;
    }
}

.ai-panel {
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

[data-theme="light"] .ai-panel {
    background: white;
    border: 1px solid #c7d2fe;
}

.ai-panel.right-eye .ai-panel-header {
    background: rgba(59, 130, 246, 0.3);
    border-left: 3px solid #3b82f6;
}

.ai-panel.left-eye .ai-panel-header {
    background: rgba(34, 197, 94, 0.3);
    border-left: 3px solid #22c55e;
}

[data-theme="light"] .ai-panel.right-eye .ai-panel-header {
    background: #dbeafe;
}

[data-theme="light"] .ai-panel.left-eye .ai-panel-header {
    background: #dcfce7;
}

.ai-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    font-weight: 600;
    font-size: 0.75rem;
}

.ai-panel-content {
    padding: var(--space-sm);
}

.topo-textarea {
    width: 100%;
    min-height: 80px;
    padding: var(--space-xs);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius-sm);
    background: rgba(0,0,0,0.2);
    color: white;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    resize: vertical;
    margin-bottom: var(--space-xs);
}

[data-theme="light"] .topo-textarea {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: var(--text-primary);
}

.topo-textarea::placeholder {
    color: rgba(255,255,255,0.5);
    font-size: 0.5625rem;
}

[data-theme="light"] .topo-textarea::placeholder {
    color: #94a3b8;
}

.topo-textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}

.btn-analyze {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-analyze:hover:not(:disabled) {
    background: #4f46e5;
}

.btn-analyze:disabled {
    background: #475569;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-analyze.analyzing {
    background: #f59e0b;
}

.btn-analyze.analyzing .analyze-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.ai-result {
    min-height: 60px;
    padding: var(--space-xs);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result {
    background: #f1f5f9;
}

.ai-result-placeholder {
    color: rgba(255,255,255,0.5);
    text-align: center;
    padding: var(--space-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result-placeholder {
    color: #94a3b8;
}

.ai-result-content {
    color: white;
}

[data-theme="light"] .ai-result-content {
    color: var(--text-primary);
}

.ai-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-result-header {
    border-bottom-color: #e2e8f0;
}

.ai-classification {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.6875rem;
}

.ai-classification.normal {
    background: var(--success-light);
    color: var(--success);
}

.ai-classification.suspect {
    background: var(--warning-light);
    color: var(--warning);
}

.ai-classification.abnormal {
    background: var(--danger-light);
    color: var(--danger);
}

.ai-confidence {
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.6);
}

[data-theme="light"] .ai-confidence {
    color: var(--text-tertiary);
}

.ai-findings {
    margin-top: var(--space-xs);
}

.ai-finding-item {
    display: flex;
    align-items: flex-start;
    gap: 2px;
    padding: 1px 0;
    font-size: 0.625rem;
    line-height: 1.3;
}

.finding-icon {
    flex-shrink: 0;
    font-size: 0.625rem;
}

.ai-indices {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px;
    margin-top: var(--space-xs);
    padding-top: var(--space-xs);
    border-top: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-indices {
    border-top-color: #e2e8f0;
}

.ai-index-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.5625rem;
    padding: 1px 2px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
}

[data-theme="light"] .ai-index-item {
    background: #e2e8f0;
}

.ai-index-label {
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-index-label {
    color: var(--text-secondary);
}

.ai-index-value {
    font-family: var(--font-mono);
    font-weight: 600;
}

.ai-index-value.normal { color: var(--success); }
.ai-index-value.warning { color: var(--warning); }
.ai-index-value.danger { color: var(--danger); }

.ai-disclaimer {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-disclaimer {
    background: #fef3c7;
    color: #92400e;
}

.disclaimer-icon {
    flex-shrink: 0;
}

.copy-button {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.copy-button:hover {
    background: var(--accent-light);
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.shared-section {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-sm);
}

.shared-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--accent-primary);
}

.eye-se-display {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-family: var(--font-mono);
}

.eye-se-display.right { color: #3b82f6; }
.eye-se-display.left { color: #22c55e; }

/* Eye Tab Results Styles */
.eye-tabs {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
}

.eye-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
}

.eye-tab:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.eye-tab.active {
    background: var(--bg-secondary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

.eye-tab.right-tab.active {
    border-left: 3px solid #3b82f6;
}

.eye-tab.left-tab.active {
    border-left: 3px solid #22c55e;
}

.eye-results-content {
    display: none;
}

.eye-results-content.active {
    display: block;
}

/* Focus/Keyboard navigation styles */
.tabindex-hint {
    display: block;
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

input:focus, select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-overlay.active { display: flex; }
.modal {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
.modal.modal-lg { max-width: 600px; }
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-light);
}
.modal-header h3 { margin: 0; font-size: 1rem; }
.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--text-secondary);
}
.modal-body { padding: var(--space-md); }
.login-error {
    color: var(--danger);
    font-size: 0.75rem;
    margin-bottom: var(--space-sm);
    min-height: 1rem;
}
.demo-notice {
    margin-top: var(--space-md);
    padding: var(--space-sm);
    background: var(--warning-light);
    color: var(--warning);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    text-align: center;
}
.search-box {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}
.search-box input { flex: 1; }
.search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-md);
}
.search-placeholder {
    padding: var(--space-lg);
    text-align: center;
    color: var(--text-tertiary);
    font-size: 0.8125rem;
}
.search-result-item {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background var(--transition-fast);
}
.search-result-item:hover { background: var(--bg-tertiary); }
.search-result-item:last-child { border-bottom: none; }
.search-result-name { font-weight: 600; font-size: 0.875rem; }
.search-result-info { font-size: 0.6875rem; color: var(--text-secondary); }
.recent-patients h4 {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    color: var(--text-secondary);
}
#recent-patients-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}
.recent-patient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
}
.recent-patient-item:hover { background: var(--border-light); }

/* User info in header */
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.user-email {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.btn-logout {
    padding: 2px 8px;
    font-size: 0.625rem;
    background: var(--danger-light);
    color: var(--danger);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
}

/* Header buttons */
.header-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--text-primary);
    transition: all var(--transition-fast);
}
.header-btn:hover {
    background: var(--accent-light);
    border-color: var(--accent-primary);
}

/* Logo image style */
.logo-img {
    height: 40px;
    width: auto;
}

/* Login Screen (Full Page) */
.login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #0c4a6e 0%, #0369a1 50%, #0284c7 100%);
    padding: var(--space-lg);
}

.login-box {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    padding: var(--space-2xl);
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-logo {
    margin-bottom: var(--space-lg);
}

.login-logo img {
    height: 80px;
    width: auto;
    margin-bottom: var(--space-md);
}

.login-logo h1 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.login-logo p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.login-box .form-group {
    text-align: left;
    margin-bottom: var(--space-md);
}

.login-box .form-group label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
    color: var(--text-primary);
}

.login-box .form-group input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-size: 1rem;
}

.login-box .form-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15);
}

.login-box .btn-login {
    width: 100%;
    padding: var(--space-md);
    background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-top: var(--space-md);
}

.login-box .btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -10px rgba(2, 132, 199, 0.5);
}

.login-error-msg {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: var(--space-sm);
    min-height: 1.25rem;
}

.login-footer {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-light);
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

/* Hide app when not logged in */
.app-container {
    display: none;
}

.app-container.logged-in {
    display: flex;
}

.login-screen.hidden {
    display: none;
}

/* Print Styles */
@media print {
    html, body {
        height: auto !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    body * {
        visibility: hidden;
    }
    
    .print-container, .print-container * {
        visibility: visible;
    }
    
    .print-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 210mm;
        padding: 8mm;
        background: white;
        overflow: visible !important;
        height: auto !important;
    }
    
    .no-print, .login-screen, .app-container, .modal-overlay {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    @page {
        size: A4;
        margin: 10mm;
    }
}

.print-container {
    font-family: var(--font-sans);
    font-size: 9pt;
    line-height: 1.4;
    color: #000;
    background: white;
}

.print-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #0284c7;
    padding-bottom: 8px;
    margin-bottom: 12px;
}

.print-header h1 {
    font-size: 14pt;
    color: #0284c7;
    margin: 0;
}

.print-header .clinic-name {
    font-size: 10pt;
    color: #666;
}

.print-patient-info {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 12px;
}

.print-patient-info .info-item {
    display: flex;
    flex-direction: column;
}

.print-patient-info .info-label {
    font-size: 7pt;
    color: #666;
}

.print-patient-info .info-value {
    font-size: 9pt;
    font-weight: 600;
}

.print-eye-section {
    margin-bottom: 12px;
}

.print-eye-title {
    font-size: 11pt;
    font-weight: 700;
    padding: 4px 8px;
    margin-bottom: 8px;
    border-radius: 4px;
}

.print-eye-title.od {
    background: #dbeafe;
    color: #1e40af;
}

.print-eye-title.os {
    background: #dcfce7;
    color: #166534;
}

.print-data-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.print-data-box {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 6px;
}

.print-data-box h4 {
    font-size: 8pt;
    color: #666;
    margin: 0 0 4px 0;
    padding-bottom: 4px;
    border-bottom: 1px solid #eee;
}

.print-data-row {
    display: flex;
    justify-content: space-between;
    font-size: 8pt;
    padding: 2px 0;
}

.print-data-row .label {
    color: #666;
}

.print-data-row .value {
    font-weight: 600;
    font-family: var(--font-mono);
}

.print-data-row .value.safe { color: #059669; }
.print-data-row .value.warning { color: #d97706; }
.print-data-row .value.danger { color: #dc2626; }

.print-surgery-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8pt;
    margin-top: 4px;
}

.print-surgery-table th,
.print-surgery-table td {
    border: 1px solid #ddd;
    padding: 4px;
    text-align: center;
}

.print-surgery-table th {
    background: #f5f5f5;
    font-weight: 600;
}

.print-surgery-table .eligible { background: #dcfce7; color: #166534; }
.print-surgery-table .caution { background: #fef3c7; color: #92400e; }
.print-surgery-table .not-eligible { background: #fee2e2; color: #991b1b; }

.print-risk-section {
    margin-top: 8px;
    padding: 8px;
    background: #fafafa;
    border-radius: 4px;
}

.print-risk-title {
    font-size: 9pt;
    font-weight: 600;
    margin-bottom: 6px;
}

.print-risk-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.print-risk-item {
    text-align: center;
    padding: 6px;
    border-radius: 4px;
}

.print-risk-item.low { background: #dcfce7; }
.print-risk-item.moderate { background: #fef3c7; }
.print-risk-item.high { background: #fee2e2; }

.print-risk-item .risk-label {
    font-size: 7pt;
    color: #666;
}

.print-risk-item .risk-value {
    font-size: 11pt;
    font-weight: 700;
}

.print-footer {
    margin-top: 8px;
    padding-top: 6px;
    border-top: 1px solid #ddd;
    font-size: 7pt;
    color: #999;
    text-align: center;
}

.print-disclaimer {
    background: #fff3cd;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 6pt;
    color: #856404;
    margin-top: 6px;
}

/* New Print Layout - Side by Side */
.print-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.print-eye-column {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
}

.print-eye-column.od {
    border-color: #3b82f6;
}

.print-eye-column.os {
    border-color: #22c55e;
}

.print-section-title {
    font-size: 8pt;
    font-weight: 600;
    color: #666;
    margin: 6px 0 4px 0;
    padding-bottom: 2px;
    border-bottom: 1px solid #eee;
}

.print-compact-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 7pt;
    margin-bottom: 6px;
}

.print-compact-table th,
.print-compact-table td {
    border: 1px solid #ddd;
    padding: 2px 4px;
    text-align: center;
}

.print-compact-table th {
    background: #f5f5f5;
    font-weight: 600;
}

.print-mini-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    margin-bottom: 6px;
}

.print-mini-item {
    display: flex;
    justify-content: space-between;
    font-size: 7pt;
    padding: 2px 4px;
    background: #f9f9f9;
    border-radius: 2px;
}

.print-mini-item .label {
    color: #666;
}

.print-mini-item .value {
    font-weight: 600;
    font-family: var(--font-mono);
}

.print-risk-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 7pt;
    font-weight: 600;
    margin: 2px;
}

.print-risk-badge.low { background: #dcfce7; color: #166534; }
.print-risk-badge.moderate { background: #fef3c7; color: #92400e; }
.print-risk-badge.high { background: #fee2e2; color: #991b1b; }

/* Google Login Button */
.btn-google {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    width: 100%;
    padding: var(--space-md);
    background: white;
    color: #444;
    border: 1px solid #ddd;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-md);
}

.btn-google:hover {
    background: #f5f5f5;
    border-color: #ccc;
}

.btn-google svg {
    width: 20px;
    height: 20px;
}

.login-divider {
    display: flex;
    align-items: center;
    margin: var(--space-md) 0;
    color: var(--text-tertiary);
    font-size: 0.75rem;
}

.login-divider::before,
.login-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-light);
}

.login-divider span {
    padding: 0 var(--space-md);
}

/* Login Tabs */
.login-tabs {
    display: flex;
    margin-bottom: var(--space-lg);
    border-bottom: 2px solid var(--border-light);
}

.login-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    background: none;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--transition-fast);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.login-tab.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
}

.login-tab:hover:not(.active) {
    color: var(--text-secondary);
}

.login-form-container {
    display: none;
}

.login-form-container.active {
    display: block;
}

.signup-notice {
    background: var(--info-light);
    color: var(--info);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-bottom: var(--space-md);
    text-align: center;
}

.pending-notice {
    background: var(--warning-light);
    color: var(--warning);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    text-align: center;
}

.pending-notice h3 {
    margin: 0 0 var(--space-sm) 0;
    font-size: 1rem;
}

.pending-notice p {
    margin: 0;
    font-size: 0.875rem;
}
    </style>
</head>
<body>
    <!-- 로그인 화면 (메인) -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <img src="logo.jpg" alt="연세솔안과" onerror="this.style.display='none'">
                <h1>시력교정술 적합성 검사</h1>
                <p>연세솔안과 YONSEI SOL EYE CLINIC</p>
            </div>
            
            <!-- 로그인/회원가입 탭 -->
            <div class="login-tabs">
                <button type="button" class="login-tab active" onclick="switchLoginTab('login')">로그인</button>
                <button type="button" class="login-tab" onclick="switchLoginTab('signup')">회원가입</button>
            </div>
            
            <!-- 로그인 폼 -->
            <div class="login-form-container active" id="login-form-container">
                <!-- 구글 로그인 -->
                <button type="button" class="btn-google" onclick="handleGoogleLogin()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google 계정으로 로그인
                </button>
                
                <div class="login-divider"><span>또는 이메일로 로그인</span></div>
                
                <form onsubmit="handleLogin(); return false;">
                    <div class="form-group">
                        <label for="login-email">이메일</label>
                        <input type="email" id="login-email" placeholder="example@yonsei-sol.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">비밀번호</label>
                        <input type="password" id="login-password" placeholder="비밀번호 입력" required>
                    </div>
                    <div class="login-error-msg" id="login-error"></div>
                    <button type="submit" class="btn-login">🔐 로그인</button>
                </form>
            </div>
            
            <!-- 회원가입 폼 -->
            <div class="login-form-container" id="signup-form-container">
                <div class="signup-notice">
                    ℹ️ 회원가입 후 관리자 승인이 필요합니다.<br>
                    승인 완료 시 이메일로 알림을 받게 됩니다.
                </div>
                
                <!-- 구글로 회원가입 -->
                <button type="button" class="btn-google" onclick="handleGoogleSignup()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google 계정으로 회원가입
                </button>
                
                <div class="login-divider"><span>또는 이메일로 회원가입</span></div>
                
                <form onsubmit="handleSignup(); return false;">
                    <div class="form-group">
                        <label for="signup-name">이름</label>
                        <input type="text" id="signup-name" placeholder="홍길동" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">이메일</label>
                        <input type="email" id="signup-email" placeholder="example@yonsei-sol.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">비밀번호</label>
                        <input type="password" id="signup-password" placeholder="6자 이상" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">비밀번호 확인</label>
                        <input type="password" id="signup-password-confirm" placeholder="비밀번호 재입력" required>
                    </div>
                    <div class="login-error-msg" id="signup-error"></div>
                    <button type="submit" class="btn-login">📝 회원가입 신청</button>
                </form>
            </div>
            
            <!-- 승인 대기 화면 -->
            <div class="login-form-container" id="pending-form-container">
                <div class="pending-notice">
                    <h3>⏳ 승인 대기 중</h3>
                    <p>회원가입 신청이 완료되었습니다.<br>관리자 승인 후 로그인 가능합니다.</p>
                    <p style="margin-top:10px;font-size:0.75rem;color:#666;">
                        문의: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="04706b70616a6c656270446369656d682a676b69">[email&#160;protected]</a>
                    </p>
                </div>
                <button type="button" class="btn-login" style="margin-top:var(--space-md);" onclick="switchLoginTab('login')">
                    로그인 화면으로 돌아가기
                </button>
            </div>
            
            <div class="login-footer">
                © 2024 연세솔안과. All rights reserved.<br>
                관리자 문의: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="11657e65747f7970776551767c70787d3f727e7c">[email&#160;protected]</a>
            </div>
        </div>
    </div>

    <!-- 환자 검색 모달 -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>🔍 환자 검색</h3>
                <button class="modal-close" onclick="toggleModal('search-modal', false)">✕</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="환자 이름 또는 등록번호 입력..." onkeyup="if(event.key==='Enter')searchPatients()">
                    <button class="btn-primary" onclick="searchPatients()">검색</button>
                </div>
                <div class="search-results" id="search-results">
                    <div class="search-placeholder">환자 이름 또는 등록번호를 입력하세요</div>
                </div>
                <div class="recent-patients">
                    <h4>📋 최근 환자</h4>
                    <div id="recent-patients-list">
                        <div class="search-placeholder">저장된 환자가 없습니다</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 인쇄 컨테이너 -->
    <div id="print-container" class="print-container" style="display:none;"></div>

    <div class="app-container" id="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.jpg" alt="연세솔안과" class="logo-img" onerror="this.style.display='none'">
                    <div class="logo-text">
                        <h1>시력교정술 적합성 검사</h1>
                        <span class="subtitle">연세솔안과 YONSEI SOL EYE CLINIC</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="toggleModal('search-modal', true)" title="환자 검색">
                        🔍 환자 검색
                    </button>
                    <div id="auth-container">
                        <button class="header-btn" onclick="toggleModal('login-modal', true)" id="login-btn">
                            🔐 로그인
                        </button>
                    </div>
                    <button class="btn-icon" id="theme-toggle" title="테마 변경">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section class="panel input-panel">
                <div class="panel-header">
                    <h2>환자 정보 입력</h2>
                    <span class="panel-badge">Patient Data (OD/OS)</span>
                </div>
                
                <form id="patient-form" class="form-grid">
                    <!-- 환자 기본 정보 섹션 -->
                    <div class="shared-section patient-info-section">
                        <div class="shared-section-title">
                            <span>👤</span>
                            환자 정보
                        </div>
                        <div class="form-row four-col">
                            <div class="form-group">
                                <label for="patient-name">환자 이름</label>
                                <input type="text" id="patient-name" name="patient-name" placeholder="홍길동" tabindex="1">
                            </div>
                            <div class="form-group">
                                <label for="patient-id">등록번호</label>
                                <input type="text" id="patient-id" name="patient-id" placeholder="12345678" tabindex="2">
                            </div>
                            <div class="form-group">
                                <label for="age">나이 (세)</label>
                                <input type="number" id="age" name="age" min="18" max="80" value="25" required tabindex="3">
                            </div>
                            <div class="form-group">
                                <label for="gender">성별</label>
                                <select id="gender" name="gender" tabindex="4">
                                    <option value="male">남성</option>
                                    <option value="female">여성</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 양안 입력 패널 -->
                    <div class="eye-panels-container">
                        <!-- 우안 (OD) -->
                        <div class="eye-panel right-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">👁️</span>
                                우안 (OD)
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">굴절 검사</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-sph" name="od-sph" step="0.25" min="-20" max="10" value="-3.00" required tabindex="10">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cyl" name="od-cyl" step="0.25" min="-6" max="0" value="-1.00" required tabindex="11">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-axis" name="od-axis" min="1" max="180" value="180" required tabindex="12">
                                                <span class="unit">°</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display right" id="od-se-display">-3.50 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">각막 검사</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cct" name="od-cct" min="400" max="700" value="540" required tabindex="13">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-acd" title="전방깊이 (내피~수정체)">ACD</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-acd" name="od-acd" step="0.01" min="2.0" max="5.0" value="3.20" tabindex="13">
                                                <span class="unit">mm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-wtw" title="백색-백색 거리">WTW</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-wtw" name="od-wtw" step="0.1" min="10.0" max="14.0" value="11.8" tabindex="13">
                                                <span class="unit">mm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-ecd" title="각막내피세포밀도">ECD</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-ecd" name="od-ecd" min="1500" max="4500" value="2800" tabindex="13">
                                                <span class="unit">/mm²</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k1" name="od-k1" step="0.01" min="35" max="50" value="43.00" required tabindex="14">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k2" name="od-k2" step="0.01" min="35" max="50" value="44.00" required tabindex="15">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-steep-axis" name="od-steep-axis" min="1" max="180" value="90" tabindex="16">
                                                <span class="unit">°</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="od-topography" name="od-topography" tabindex="17">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">수술 파라미터</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-optical-zone">OZ</label>
                                            <select id="od-optical-zone" name="od-optical-zone" tabindex="18" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasik-flap" name="od-lasik-flap" min="80" max="160" value="90" tabindex="19">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasek-epi" name="od-lasek-epi" min="40" max="80" value="55" tabindex="20">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-smile-cap" name="od-smile-cap" min="100" max="160" value="120" tabindex="21">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 좌안 (OS) -->
                        <div class="eye-panel left-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">👁️</span>
                                좌안 (OS)
                                <button type="button" class="copy-button" id="copy-od-to-os" style="margin-left: auto;">
                                    ← OD 복사
                                </button>
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">굴절 검사</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-sph" name="os-sph" step="0.25" min="-20" max="10" value="-3.25" required tabindex="30">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cyl" name="os-cyl" step="0.25" min="-6" max="0" value="-0.75" required tabindex="31">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-axis" name="os-axis" min="1" max="180" value="175" required tabindex="32">
                                                <span class="unit">°</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display left" id="os-se-display">-3.63 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">각막 검사</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cct" name="os-cct" min="400" max="700" value="535" required tabindex="33">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-acd" title="전방깊이 (내피~수정체)">ACD</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-acd" name="os-acd" step="0.01" min="2.0" max="5.0" value="3.15" tabindex="33">
                                                <span class="unit">mm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-wtw" title="백색-백색 거리">WTW</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-wtw" name="os-wtw" step="0.1" min="10.0" max="14.0" value="11.7" tabindex="33">
                                                <span class="unit">mm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-ecd" title="각막내피세포밀도">ECD</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-ecd" name="os-ecd" min="1500" max="4500" value="2750" tabindex="33">
                                                <span class="unit">/mm²</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k1" name="os-k1" step="0.01" min="35" max="50" value="43.25" required tabindex="34">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k2" name="os-k2" step="0.01" min="35" max="50" value="44.25" required tabindex="35">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-steep-axis" name="os-steep-axis" min="1" max="180" value="85" tabindex="36">
                                                <span class="unit">°</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="os-topography" name="os-topography" tabindex="37">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">수술 파라미터</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-optical-zone">OZ</label>
                                            <select id="os-optical-zone" name="os-optical-zone" tabindex="38" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasik-flap" name="os-lasik-flap" min="80" max="160" value="90" tabindex="39">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasek-epi" name="os-lasek-epi" min="40" max="80" value="55" tabindex="40">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-smile-cap" name="os-smile-cap" min="100" max="160" value="120" tabindex="41">
                                                <span class="unit">μm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Topography 분석 섹션 -->
                    <div class="shared-section ai-analysis-section">
                        <div class="shared-section-title">
                            <span>🤖</span>
                            AI 각막 지형도 분석
                            <span class="beta-badge">BETA</span>
                        </div>
                        <p class="section-description">
                            Galilei G4, Pentacam, Orbscan 등의 검사 결과를 붙여넣으면 AI가 자동으로 분석합니다.
                        </p>
                        
                        <div class="ai-analysis-panels">
                            <!-- 우안 AI 분석 -->
                            <div class="ai-panel right-eye">
                                <div class="ai-panel-header">
                                    <span>👁️ OD</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-od" disabled>
                                        <span class="analyze-icon">🔍</span> 분석
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="od-topo-data" 
                                        name="od-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 또는 Pentacam 결과를 여기에 붙여넣기 하세요...

예시 데이터:
- Sim K: 43.5 @ 180 / 44.2 @ 90
- TCT: 512 μm
- Thinnest: 508 μm at (0.2, -0.3)
- BAD-D: 1.2
- I-S: 0.8
- KISA: 32%
- Posterior Elevation: 12 μm
..."
                                        tabindex="22"
                                    ></textarea>
                                    <div class="ai-result" id="od-ai-result">
                                        <div class="ai-result-placeholder">
                                            데이터를 붙여넣고 분석 버튼을 클릭하세요
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 좌안 AI 분석 -->
                            <div class="ai-panel left-eye">
                                <div class="ai-panel-header">
                                    <span>👁️ OS</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-os" disabled>
                                        <span class="analyze-icon">🔍</span> 분석
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="os-topo-data" 
                                        name="os-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 또는 Pentacam 결과를 여기에 붙여넣기 하세요..."
                                        tabindex="42"
                                    ></textarea>
                                    <div class="ai-result" id="os-ai-result">
                                        <div class="ai-result-placeholder">
                                            데이터를 붙여넣고 분석 버튼을 클릭하세요
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ai-disclaimer">
                            <span class="disclaimer-icon">⚠️</span>
                            <span>AI 분석은 참고용이며, 최종 판단은 반드시 전문의가 수행해야 합니다. 
                            지원 장비: Galilei G4, Pentacam, Orbscan, Topcon, Nidek OPD</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <span class="tabindex-hint">💡 Tab 키 또는 Enter 키로 다음 입력칸으로 이동</span>
                        <button type="submit" class="btn-primary btn-calculate" tabindex="50">
                            <span class="btn-text">양안 계산하기</span>
                            <span class="btn-icon-right">→</span>
                        </button>
                    </div>
                </form>
            </section>

            <section class="panel results-panel" id="results-panel">
                <div class="panel-header" onclick="document.getElementById('results-panel').classList.toggle('collapsed')">
                    <h2>검사 결과</h2>
                    <span class="panel-badge">Results (OD/OS)</span>
                </div>

                <div id="results-container" class="results-container">
                    <div class="results-placeholder">
                        <div class="placeholder-icon">
                            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                                <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <p>환자 정보를 입력하고<br><strong>양안 계산하기</strong> 버튼을 클릭하세요</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>⚠️ 본 프로그램은 참고용이며, 최종 수술 결정은 반드시 전문의와 상담하세요.</p>
            <p class="footer-small">Munnerlyn's Formula 기반 | Randleman ERSS & PTA 평가</p>
        </footer>
    </div>

    <template id="results-template">
        <div class="results-content">
            <!-- 양안 탭 -->
            <div class="eye-tabs">
                <button type="button" class="eye-tab right-tab active" data-eye="od">
                    <span>👁️</span> 우안 (OD)
                </button>
                <button type="button" class="eye-tab left-tab" data-eye="os">
                    <span>👁️</span> 좌안 (OS)
                </button>
            </div>

            <!-- 우안 결과 -->
            <div class="eye-results-content active" id="results-od">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>우안 (OD) 종합 평가</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-od">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-od">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-od">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-icl-od">
                            <div class="surgery-name">EVO ICL</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <!-- ICL 적합성 평가 (OD) -->
                <div class="result-card icl-card">
                    <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                        <h3>🔮 EVO ICL 적합성 평가 (OD)</h3>
                    </div>
                    <div class="icl-assessment" id="icl-assessment-od">
                        <div class="icl-criteria-grid"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>절삭량 및 잔여각막 (OD)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>수술</th><th>절삭량</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-od"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>수술 후 예상 K값 (OD)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">수술 전</span>
                            <span class="k-value" id="preop-k-od"></span>
                        </div>
                        <div class="k-arrow">→</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">수술 후</span>
                            <span class="k-value" id="postop-k-od"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-od"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>위험도 평가 (OD)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-od"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-od"></span>
                            <span class="erss-risk-level" id="erss-risk-level-od"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>복합 위험도 해석 (OD)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-od"></div>
                        <div class="interpretation-guide" id="interpretation-guide-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram 권장 (OD)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-od"></div>
                </div>
            </div>

            <!-- 좌안 결과 -->
            <div class="eye-results-content" id="results-os">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>좌안 (OS) 종합 평가</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-os">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-os">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-os">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-icl-os">
                            <div class="surgery-name">EVO ICL</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <!-- ICL 적합성 평가 (OS) -->
                <div class="result-card icl-card">
                    <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                        <h3>🔮 EVO ICL 적합성 평가 (OS)</h3>
                    </div>
                    <div class="icl-assessment" id="icl-assessment-os">
                        <div class="icl-criteria-grid"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>절삭량 및 잔여각막 (OS)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>수술</th><th>절삭량</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-os"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>수술 후 예상 K값 (OS)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">수술 전</span>
                            <span class="k-value" id="preop-k-os"></span>
                        </div>
                        <div class="k-arrow">→</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">수술 후</span>
                            <span class="k-value" id="postop-k-os"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-os"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>위험도 평가 (OS)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-os"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-os"></span>
                            <span class="erss-risk-level" id="erss-risk-level-os"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>복합 위험도 해석 (OS)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-os"></div>
                        <div class="interpretation-guide" id="interpretation-guide-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram 권장 (OS)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-os"></div>
                </div>
            </div>

            <div class="clinical-note" style="margin-top: var(--space-lg);">
                <div class="note-icon">ℹ️</div>
                <div class="note-content">
                    <strong>참고:</strong> ERSS는 보수적 평가 경향이 있습니다. PTA는 정상 Topography에서 더 강한 예측력을 보입니다.
                    <span class="reference">(Santhiago et al., Chan et al. 2018)</span>
                </div>
            </div>

            <div class="result-actions">
                <button class="btn-secondary" id="btn-print">🖨️ 인쇄</button>
                <button class="btn-secondary" id="btn-save">💾 저장</button>
                <button class="btn-primary" id="btn-new">🔄 새 검사</button>
            </div>
        </div>
    </template>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============================================
// 연세솔안과 시력교정술 적합성 검사
// Firebase & Authentication Module
// ============================================

// Demo mode flag (set to false when Firebase is configured)
const DEMO_MODE = true;
const LOCAL_STORAGE_KEY = 'yonsei_sol_patients';
const PENDING_USERS_KEY = 'yonsei_sol_pending_users';
const APPROVED_USERS_KEY = 'yonsei_sol_approved_users';
const ADMIN_EMAIL = 'totenhaft@gmail.com';

// Current user state
let currentUser = null;

// Switch login/signup tabs
function switchLoginTab(tab) {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.login-form-container').forEach(f => f.classList.remove('active'));
    
    if (tab === 'login') {
        document.querySelector('.login-tab:first-child').classList.add('active');
        document.getElementById('login-form-container').classList.add('active');
    } else if (tab === 'signup') {
        document.querySelector('.login-tab:last-child').classList.add('active');
        document.getElementById('signup-form-container').classList.add('active');
    } else if (tab === 'pending') {
        document.getElementById('pending-form-container').classList.add('active');
    }
}

// Show/hide login screen
function showLoginScreen() {
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app-container').classList.remove('logged-in');
}

function hideLoginScreen() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-container').classList.add('logged-in');
}

// Update auth UI based on login state
function updateAuthUI() {
    const authContainer = document.getElementById('auth-container');
    if (!authContainer) return;
    
    if (currentUser) {
        hideLoginScreen();
        authContainer.innerHTML = `
            <div class="user-info">
                <span class="user-email">${currentUser.email}</span>
                <button class="btn-logout" onclick="handleLogout()">로그아웃</button>
            </div>
        `;
    } else {
        showLoginScreen();
        authContainer.innerHTML = `
            <button class="header-btn" onclick="showLoginScreen()" id="login-btn">
                🔐 로그인
            </button>
        `;
    }
}

// Check if user is approved
function isUserApproved(email) {
    // Admin is always approved
    if (email === ADMIN_EMAIL) return true;
    
    const approvedUsers = JSON.parse(localStorage.getItem(APPROVED_USERS_KEY) || '[]');
    return approvedUsers.includes(email.toLowerCase());
}

// Check if user is pending
function isUserPending(email) {
    const pendingUsers = JSON.parse(localStorage.getItem(PENDING_USERS_KEY) || '[]');
    return pendingUsers.some(u => u.email.toLowerCase() === email.toLowerCase());
}

// Add user to pending list
function addPendingUser(name, email) {
    const pendingUsers = JSON.parse(localStorage.getItem(PENDING_USERS_KEY) || '[]');
    if (!pendingUsers.some(u => u.email.toLowerCase() === email.toLowerCase())) {
        pendingUsers.push({
            name: name,
            email: email.toLowerCase(),
            requestedAt: new Date().toISOString()
        });
        localStorage.setItem(PENDING_USERS_KEY, JSON.stringify(pendingUsers));
    }
}

// Modal toggle function
function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (show) {
            modal.classList.add('active');
            if (modalId === 'search-modal') {
                loadRecentPatients();
            }
        } else {
            modal.classList.remove('active');
        }
    }
}

// Close modal when clicking overlay
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
    }
});

// Handle email login
function handleLogin() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorDiv = document.getElementById('login-error');
    
    if (!email || !password) {
        errorDiv.textContent = '이메일과 비밀번호를 입력하세요.';
        return;
    }
    
    if (DEMO_MODE) {
        // Demo mode: check approval status
        if (!isUserApproved(email) && email !== ADMIN_EMAIL) {
            if (isUserPending(email)) {
                errorDiv.textContent = '승인 대기 중입니다. 관리자에게 문의하세요.';
            } else {
                errorDiv.textContent = '등록되지 않은 계정입니다. 회원가입을 해주세요.';
            }
            return;
        }
        currentUser = { email: email };
        updateAuthUI();
        showNotification('로그인 성공!', 'success');
    } else {
        // Firebase authentication
        if (typeof auth !== 'undefined') {
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Check if approved
                    return checkUserApprovalFirebase(userCredential.user.email)
                        .then(approved => {
                            if (approved || userCredential.user.email === ADMIN_EMAIL) {
                                currentUser = userCredential.user;
                                updateAuthUI();
                                showNotification('로그인 성공!', 'success');
                            } else {
                                auth.signOut();
                                errorDiv.textContent = '승인 대기 중입니다. 관리자에게 문의하세요.';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    if (error.code === 'auth/user-not-found') {
                        errorDiv.textContent = '등록되지 않은 이메일입니다.';
                    } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        errorDiv.textContent = '이메일 또는 비밀번호가 올바르지 않습니다.';
                    } else {
                        errorDiv.textContent = '로그인 실패: ' + error.message;
                    }
                });
        } else {
            errorDiv.textContent = 'Firebase 설정이 필요합니다.';
        }
    }
}

// Handle Google login
function handleGoogleLogin() {
    if (DEMO_MODE) {
        const email = prompt('데모 모드: Google 로그인을 시뮬레이션합니다.\n이메일을 입력하세요:');
        if (email) {
            if (!isUserApproved(email) && email !== ADMIN_EMAIL) {
                if (isUserPending(email)) {
                    document.getElementById('login-error').textContent = '승인 대기 중입니다.';
                } else {
                    document.getElementById('login-error').textContent = '등록되지 않은 계정입니다.';
                }
                return;
            }
            currentUser = { email: email };
            updateAuthUI();
            showNotification('Google 로그인 성공!', 'success');
        }
    } else {
        if (typeof auth !== 'undefined' && typeof firebase !== 'undefined') {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    return checkUserApprovalFirebase(result.user.email)
                        .then(approved => {
                            if (approved || result.user.email === ADMIN_EMAIL) {
                                currentUser = result.user;
                                updateAuthUI();
                                showNotification('Google 로그인 성공!', 'success');
                            } else {
                                auth.signOut();
                                document.getElementById('login-error').textContent = '승인 대기 중입니다. 관리자에게 문의하세요.';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Google login error:', error);
                    document.getElementById('login-error').textContent = 'Google 로그인 실패: ' + error.message;
                });
        } else {
            document.getElementById('login-error').textContent = 'Firebase 설정이 필요합니다.';
        }
    }
}

// Handle signup
function handleSignup() {
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const passwordConfirm = document.getElementById('signup-password-confirm').value;
    const errorDiv = document.getElementById('signup-error');
    
    if (!name || !email || !password) {
        errorDiv.textContent = '모든 필드를 입력하세요.';
        return;
    }
    
    if (password !== passwordConfirm) {
        errorDiv.textContent = '비밀번호가 일치하지 않습니다.';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.textContent = '비밀번호는 6자 이상이어야 합니다.';
        return;
    }
    
    if (DEMO_MODE) {
        // Demo mode: add to pending list
        if (isUserPending(email)) {
            errorDiv.textContent = '이미 가입 신청된 이메일입니다.';
            return;
        }
        addPendingUser(name, email);
        showNotification('회원가입 신청이 완료되었습니다!', 'success');
        switchLoginTab('pending');
    } else {
        if (typeof auth !== 'undefined') {
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Update display name
                    return userCredential.user.updateProfile({ displayName: name })
                        .then(() => {
                            // Add to pending users in Firestore
                            return db.collection('pendingUsers').doc(email.toLowerCase()).set({
                                name: name,
                                email: email.toLowerCase(),
                                requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .then(() => {
                            auth.signOut();
                            showNotification('회원가입 신청이 완료되었습니다!', 'success');
                            switchLoginTab('pending');
                        });
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        errorDiv.textContent = '이미 사용 중인 이메일입니다.';
                    } else {
                        errorDiv.textContent = '회원가입 실패: ' + error.message;
                    }
                });
        } else {
            errorDiv.textContent = 'Firebase 설정이 필요합니다.';
        }
    }
}

// Handle Google signup
function handleGoogleSignup() {
    if (DEMO_MODE) {
        const email = prompt('데모 모드: Google 회원가입을 시뮬레이션합니다.\n이메일을 입력하세요:');
        const name = prompt('이름을 입력하세요:');
        if (email && name) {
            if (isUserPending(email)) {
                document.getElementById('signup-error').textContent = '이미 가입 신청된 이메일입니다.';
                return;
            }
            addPendingUser(name, email);
            showNotification('회원가입 신청이 완료되었습니다!', 'success');
            switchLoginTab('pending');
        }
    } else {
        if (typeof auth !== 'undefined' && typeof firebase !== 'undefined') {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    // Add to pending users
                    return db.collection('pendingUsers').doc(user.email.toLowerCase()).set({
                        name: user.displayName || user.email,
                        email: user.email.toLowerCase(),
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        auth.signOut();
                        showNotification('회원가입 신청이 완료되었습니다!', 'success');
                        switchLoginTab('pending');
                    });
                })
                .catch((error) => {
                    console.error('Google signup error:', error);
                    document.getElementById('signup-error').textContent = 'Google 회원가입 실패: ' + error.message;
                });
        } else {
            document.getElementById('signup-error').textContent = 'Firebase 설정이 필요합니다.';
        }
    }
}

// Check user approval in Firebase
async function checkUserApprovalFirebase(email) {
    if (email === ADMIN_EMAIL) return true;
    
    try {
        const doc = await db.collection('approvedUsers').doc(email.toLowerCase()).get();
        return doc.exists;
    } catch (error) {
        console.error('Check approval error:', error);
        return false;
    }
}

// Handle logout
function handleLogout() {
    if (!DEMO_MODE && typeof auth !== 'undefined') {
        auth.signOut().catch(console.error);
    }
    currentUser = null;
    updateAuthUI();
    showNotification('로그아웃 되었습니다.', 'info');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0284c7'};
        color: white;
        border-radius: 8px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Print patient report - NEW IMPROVED VERSION
function printPatientReport() {
    if (!window.calculator || !window.calculator.results) {
        showNotification('먼저 계산을 수행해주세요.', 'error');
        return;
    }
    
    const results = window.calculator.results;
    const patientName = document.getElementById('patient-name').value || '환자';
    const patientId = document.getElementById('patient-id').value || '00000000';
    const age = document.getElementById('age').value || '-';
    const gender = document.getElementById('gender').value === 'male' ? '남성' : '여성';
    const printDate = new Date().toLocaleString('ko-KR');
    
    // Set document title for PDF filename
    document.title = `${patientName}_${patientId}`;
    
    const odData = results.od?.data || {};
    const osData = results.os?.data || {};
    const odResults = results.od?.surgeryResults || {};
    const osResults = results.os?.surgeryResults || {};
    const odErss = results.od?.erssResult || {};
    const osErss = results.os?.erssResult || {};
    
    // Get eligibility status
    const getEligibility = (surgeryResult) => {
        if (!surgeryResult) return { text: '-', class: 'neutral' };
        if (surgeryResult.rsb < 280 || surgeryResult.pta >= 40) {
            return { text: '부적합', class: 'danger' };
        } else if (surgeryResult.rsb < 300 || surgeryResult.pta >= 35) {
            return { text: '주의', class: 'warning' };
        }
        return { text: '적합', class: 'success' };
    };
    
    const odLasikElig = getEligibility(odResults.lasik);
    const odLasekElig = getEligibility(odResults.lasek);
    const osLasikElig = getEligibility(osResults.lasik);
    const osLasekElig = getEligibility(osResults.lasek);
    
    const getErssRiskText = (score) => score <= 2 ? '저위험' : score === 3 ? '중등도' : '고위험';
    const getStatusStyle = (status) => {
        if (status === 'success') return 'background:#dcfce7;color:#166534;';
        if (status === 'warning') return 'background:#fef3c7;color:#92400e;';
        if (status === 'danger') return 'background:#fee2e2;color:#991b1b;';
        return 'background:#f3f4f6;color:#6b7280;';
    };
    
    // ICL results
    const odIcl = results.od?.iclResult || {};
    const osIcl = results.os?.iclResult || {};
    
    const getIclStatusStyle = (status) => {
        if (status === 'eligible') return 'background:#ede9fe;color:#6d28d9;';
        if (status === 'caution') return 'background:#fef3c7;color:#92400e;';
        return 'background:#fee2e2;color:#991b1b;';
    };
    
    const printHTML = `
        <div style="font-family: 'Noto Sans KR', -apple-system, sans-serif; font-size: 9pt; color: #000; padding: 0; max-width: 210mm; margin: 0 auto;">
            <!-- 헤더 -->
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #0284c7; padding-bottom: 8px; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 16pt; font-weight: 700; color: #0284c7;">시력교정술 적합성 검사 결과</div>
                    <div style="font-size: 10pt; color: #666;">연세솔안과 YONSEI SOL EYE CLINIC</div>
                </div>
                <div style="text-align: right; font-size: 8pt; color: #666;">
                    검사일시: ${printDate}<br>
                    담당자: ${currentUser?.email || '-'}
                </div>
            </div>
            
            <!-- 환자 정보 -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #0284c7;">
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">환자명</div>
                    <div style="font-size: 12pt; font-weight: 700;">${patientName}</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">등록번호</div>
                    <div style="font-size: 12pt; font-weight: 700;">${patientId}</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">나이</div>
                    <div style="font-size: 12pt; font-weight: 700;">${age}세</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">성별</div>
                    <div style="font-size: 12pt; font-weight: 700;">${gender}</div>
                </div>
            </div>
            
            <!-- ========== 종합 평가 ========== -->
            <div style="background: #1e3a5f; color: white; padding: 8px 12px; border-radius: 6px 6px 0 0; font-weight: 700; font-size: 11pt;">
                📋 종합 평가 (Summary)
            </div>
            <div style="border: 2px solid #1e3a5f; border-top: none; border-radius: 0 0 6px 6px; padding: 12px; margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                    <thead>
                        <tr style="background: #f8fafc;">
                            <th style="border: 1px solid #ddd; padding: 8px; width: 15%;"></th>
                            <th style="border: 1px solid #ddd; padding: 8px; width: 42.5%; background: #dbeafe; color: #1e40af;">👁 우안 (OD)</th>
                            <th style="border: 1px solid #ddd; padding: 8px; width: 42.5%; background: #dcfce7; color: #166534;">👁 좌안 (OS)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">LASIK</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(odLasikElig.class)}">${odLasikElig.text}</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(osLasikElig.class)}">${osLasikElig.text}</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">LASEK/PRK</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(odLasekElig.class)}">${odLasekElig.text}</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(osLasekElig.class)}">${osLasekElig.text}</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">🔮 EVO ICL</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getIclStatusStyle(odIcl.status)}">${odIcl.statusMessage || '-'}</span>
                                ${odIcl.overallEligible && odIcl.recommendedSize ? `<div style="font-size: 7pt; color: #8b5cf6; margin-top: 4px;">권장 크기: ${odIcl.recommendedSize.recommended}mm</div>` : ''}
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getIclStatusStyle(osIcl.status)}">${osIcl.statusMessage || '-'}</span>
                                ${osIcl.overallEligible && osIcl.recommendedSize ? `<div style="font-size: 7pt; color: #8b5cf6; margin-top: 4px;">권장 크기: ${osIcl.recommendedSize.recommended}mm</div>` : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">ERSS</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <strong style="font-size: 11pt;">${odErss.total || 0}점</strong>
                                <span style="margin-left: 6px; font-size: 8pt; color: #666;">(${getErssRiskText(odErss.total || 0)})</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <strong style="font-size: 11pt;">${osErss.total || 0}점</strong>
                                <span style="margin-left: 6px; font-size: 8pt; color: #666;">(${getErssRiskText(osErss.total || 0)})</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ========== 양안 데이터 (좌우 배치) ========== -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <!-- 우안 (OD) -->
                <div style="border: 2px solid #3b82f6; border-radius: 6px; overflow: hidden;">
                    <div style="background: #3b82f6; color: white; padding: 8px 12px; font-weight: 700; font-size: 11pt;">
                        👁 우안 (OD) 상세 데이터
                    </div>
                    <div style="padding: 10px;">
                        ${generateDetailedEyeSection(odData, odResults, odErss)}
                    </div>
                </div>
                
                <!-- 좌안 (OS) -->
                <div style="border: 2px solid #22c55e; border-radius: 6px; overflow: hidden;">
                    <div style="background: #22c55e; color: white; padding: 8px 12px; font-weight: 700; font-size: 11pt;">
                        👁 좌안 (OS) 상세 데이터
                    </div>
                    <div style="padding: 10px;">
                        ${generateDetailedEyeSection(osData, osResults, osErss)}
                    </div>
                </div>
            </div>
            
            <!-- 주의사항 -->
            <div style="background: #fef3c7; padding: 10px 15px; border-radius: 6px; margin-top: 15px; font-size: 8pt; color: #92400e; border: 1px solid #f59e0b;">
                ⚠️ <strong>주의사항:</strong> 본 검사 결과는 참고용이며, 최종 수술 결정은 반드시 전문의 상담 후 결정하시기 바랍니다. 
                각막 두께, 굴절력, 지형도 패턴 등을 종합적으로 고려하여 판단됩니다.
            </div>
            
            <!-- 푸터 -->
            <div style="text-align: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 7pt; color: #999;">
                © 연세솔안과 YONSEI SOL EYE CLINIC | Munnerlyn's Formula 기반 계산 | Randleman ERSS & PTA 위험도 평가
            </div>
        </div>
    `;
    
    const printContainer = document.getElementById('print-container');
    printContainer.innerHTML = printHTML;
    printContainer.style.display = 'block';
    
    // Hide other elements before printing
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        window.print();
        setTimeout(() => {
            printContainer.style.display = 'none';
            printContainer.innerHTML = '';
            document.body.style.overflow = '';
            // Reset document title
            document.title = '시력교정술 적합성 검사 | Refractive Surgery Eligibility Checker';
        }, 500);
    }, 300);
}

// Generate detailed eye section for print (SMILE 제외)
function generateDetailedEyeSection(data, surgeryResults, erssResult) {
    const se = (data.sph || 0) + ((data.cyl || 0) / 2);
    const avgK = ((data.k1 || 0) + (data.k2 || 0)) / 2;
    const erssScore = erssResult.total || 0;
    
    const getErssRiskText = (score) => score <= 2 ? '저위험' : score === 3 ? '중등도' : '고위험';
    const getRiskStyle = (level) => {
        if (level === 'low') return 'background:#dcfce7;color:#166534;';
        if (level === 'moderate') return 'background:#fef3c7;color:#92400e;';
        return 'background:#fee2e2;color:#991b1b;';
    };
    const getErssLevel = (score) => score <= 2 ? 'low' : score === 3 ? 'moderate' : 'high';
    const getPtaLevel = (pta) => pta < 35 ? 'low' : pta < 40 ? 'moderate' : 'high';
    
    return `
        <!-- 입력 데이터 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <!-- 굴절 검사 -->
            <div style="background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0;">📊 굴절 검사</div>
                <table style="width: 100%; font-size: 8pt;">
                    <tr><td style="color: #666;">SPH</td><td style="text-align: right; font-weight: 600;">${(data.sph || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">CYL</td><td style="text-align: right; font-weight: 600;">${(data.cyl || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">AXIS</td><td style="text-align: right; font-weight: 600;">${data.axis || 0}°</td></tr>
                    <tr style="background: #e0f2fe;"><td style="color: #0369a1; font-weight: 600;">SE</td><td style="text-align: right; font-weight: 700; color: #0369a1;">${se.toFixed(2)} D</td></tr>
                </table>
            </div>
            
            <!-- 각막 검사 -->
            <div style="background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0;">🔬 각막 검사</div>
                <table style="width: 100%; font-size: 8pt;">
                    <tr><td style="color: #666;">CCT</td><td style="text-align: right; font-weight: 600;">${data.cct || 0} μm</td></tr>
                    <tr><td style="color: #666;">K1</td><td style="text-align: right; font-weight: 600;">${(data.k1 || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">K2</td><td style="text-align: right; font-weight: 600;">${(data.k2 || 0).toFixed(2)} D</td></tr>
                    <tr style="background: #e0f2fe;"><td style="color: #0369a1; font-weight: 600;">Avg K</td><td style="text-align: right; font-weight: 700; color: #0369a1;">${avgK.toFixed(2)} D</td></tr>
                </table>
            </div>
        </div>
        
        <!-- 수술별 결과 (SMILE 제외) -->
        <div style="margin-bottom: 10px;">
            <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px;">🔪 수술별 계산 결과</div>
            <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="border: 1px solid #ddd; padding: 5px;">수술</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">절삭량</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">RSB</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">PTA</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">판정</th>
                    </tr>
                </thead>
                <tbody>
                    ${generatePrintSurgeryRow('LASIK', surgeryResults.lasik)}
                    ${generatePrintSurgeryRow('LASEK/PRK', surgeryResults.lasek)}
                </tbody>
            </table>
        </div>
        
        <!-- 위험도 평가 -->
        <div style="background: #fafafa; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
            <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px;">⚠️ 위험도 평가</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getErssLevel(erssScore))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">ERSS Score</div>
                    <div style="font-size: 12pt; font-weight: 700;">${erssScore}점</div>
                    <div style="font-size: 7pt;">${getErssRiskText(erssScore)}</div>
                </div>
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getPtaLevel(surgeryResults.lasik?.pta || 0))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">LASIK PTA</div>
                    <div style="font-size: 12pt; font-weight: 700;">${(surgeryResults.lasik?.pta || 0).toFixed(1)}%</div>
                </div>
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getPtaLevel(surgeryResults.lasek?.pta || 0))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">LASEK PTA</div>
                    <div style="font-size: 12pt; font-weight: 700;">${(surgeryResults.lasek?.pta || 0).toFixed(1)}%</div>
                </div>
            </div>
        </div>
    `;
}

// Generate surgery row for print (improved)
function generatePrintSurgeryRow(name, data) {
    if (!data) return '';
    
    let bgColor = '#dcfce7';
    let textColor = '#166534';
    let text = '적합';
    
    if (data.rsb < 280 || data.pta >= 40) {
        bgColor = '#fee2e2'; textColor = '#991b1b'; text = '부적합';
    } else if (data.rsb < 300 || data.pta >= 35) {
        bgColor = '#fef3c7'; textColor = '#92400e'; text = '주의';
    }
    
    const rsbStyle = data.rsb < 280 ? 'color:#dc2626;font-weight:700;' : data.rsb < 300 ? 'color:#d97706;font-weight:600;' : '';
    const ptaStyle = data.pta >= 40 ? 'color:#dc2626;font-weight:700;' : data.pta >= 35 ? 'color:#d97706;font-weight:600;' : '';
    
    // Ablation depth warning
    const ablation = data.ablation || data.ablationDepth || 0;
    const isLasik = name.toUpperCase().includes('LASIK');
    const safeLimit = isLasik ? 90 : 100;
    const cautionLimit = isLasik ? 120 : 130;
    
    let ablationStyle = '';
    let ablationIcon = '';
    if (ablation > cautionLimit) {
        ablationStyle = 'color:#dc2626;font-weight:700;';
        ablationIcon = '🚨';
    } else if (ablation > safeLimit) {
        ablationStyle = 'color:#d97706;font-weight:600;';
        ablationIcon = '⚠️';
    }
    
    return `
        <tr>
            <td style="border: 1px solid #ddd; padding: 5px; font-weight: 600;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${ablationStyle}">${ablationIcon} ${ablation.toFixed(1)} μm</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${rsbStyle}">${data.rsb?.toFixed(0) || '-'} μm</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${ptaStyle}">${data.pta?.toFixed(1) || '-'}%</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 700;">${text}</td>
        </tr>
    `;
}

function generateEyeSection(data, surgeryResults, erssResult) {
    const se = (data.sph || 0) + ((data.cyl || 0) / 2);
    const avgK = ((data.k1 || 0) + (data.k2 || 0)) / 2;
    const erssScore = erssResult.total || 0;
    
    const getErssRiskClass = (score) => score <= 2 ? 'low' : score === 3 ? 'moderate' : 'high';
    const getErssRiskText = (score) => score <= 2 ? '저위험' : score === 3 ? '중등도' : '고위험';
    const getRiskBadgeStyle = (level) => {
        if (level === 'low') return 'background:#dcfce7;color:#166534;';
        if (level === 'moderate') return 'background:#fef3c7;color:#92400e;';
        return 'background:#fee2e2;color:#991b1b;';
    };
    
    return `
        <!-- 굴절/각막 검사 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
            <div style="background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">굴절 검사</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 7pt;">
                    <div>SPH: <strong>${(data.sph || 0).toFixed(2)}D</strong></div>
                    <div>CYL: <strong>${(data.cyl || 0).toFixed(2)}D</strong></div>
                    <div>AXIS: <strong>${data.axis || 0}°</strong></div>
                    <div style="color:#0284c7;">SE: <strong>${se.toFixed(2)}D</strong></div>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">각막 검사</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 7pt;">
                    <div>CCT: <strong>${data.cct || 0}μm</strong></div>
                    <div>Avg K: <strong>${avgK.toFixed(2)}D</strong></div>
                    <div>K1: <strong>${(data.k1 || 0).toFixed(2)}D</strong></div>
                    <div>K2: <strong>${(data.k2 || 0).toFixed(2)}D</strong></div>
                </div>
            </div>
        </div>
        
        <!-- 수술별 결과 테이블 -->
        <table style="width: 100%; border-collapse: collapse; font-size: 7pt; margin-bottom: 8px;">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th style="border: 1px solid #ddd; padding: 3px;">수술</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">절삭량</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">RSB</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">PTA</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">적합성</th>
                </tr>
            </thead>
            <tbody>
                ${generateSurgeryRowNew('LASIK', surgeryResults.lasik)}
                ${generateSurgeryRowNew('LASEK', surgeryResults.lasek)}
                ${generateSurgeryRowNew('SMILE', surgeryResults.smile)}
            </tbody>
        </table>
        
        <!-- 위험도 평가 -->
        <div style="background: #fafafa; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
            <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px;">위험도 평가</div>
            <div style="display: flex; gap: 6px; justify-content: center;">
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(getErssRiskClass(erssScore))}">
                    <div style="font-size: 6pt;">ERSS</div>
                    <div style="font-size: 10pt; font-weight: 700;">${erssScore}점</div>
                    <div style="font-size: 6pt;">${getErssRiskText(erssScore)}</div>
                </div>
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(surgeryResults.lasik?.pta < 35 ? 'low' : surgeryResults.lasik?.pta < 40 ? 'moderate' : 'high')}">
                    <div style="font-size: 6pt;">LASIK PTA</div>
                    <div style="font-size: 10pt; font-weight: 700;">${(surgeryResults.lasik?.pta || 0).toFixed(1)}%</div>
                </div>
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(surgeryResults.lasek?.pta < 35 ? 'low' : surgeryResults.lasek?.pta < 40 ? 'moderate' : 'high')}">
                    <div style="font-size: 6pt;">LASEK PTA</div>
                    <div style="font-size: 10pt; font-weight: 700;">${(surgeryResults.lasek?.pta || 0).toFixed(1)}%</div>
                </div>
            </div>
        </div>
    `;
}

function generateSurgeryRowNew(name, data) {
    if (!data) return '';
    
    let bgColor = '#dcfce7'; // green - eligible
    let textColor = '#166534';
    let text = '적합';
    
    if (data.rsb < 280 || data.pta >= 40) {
        bgColor = '#fee2e2'; textColor = '#991b1b'; text = '부적합';
    } else if (data.rsb < 300 || data.pta >= 35) {
        bgColor = '#fef3c7'; textColor = '#92400e'; text = '주의';
    }
    
    return `
        <tr>
            <td style="border: 1px solid #ddd; padding: 3px; font-weight: 600;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${data.ablation?.toFixed(1) || '-'}μm</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; ${data.rsb < 280 ? 'color:#dc2626;font-weight:600;' : ''}">${data.rsb?.toFixed(0) || '-'}μm</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; ${data.pta >= 40 ? 'color:#dc2626;font-weight:600;' : ''}">${data.pta?.toFixed(1) || '-'}%</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 600;">${text}</td>
        </tr>
    `;
}

// Search patients
function searchPatients() {
    const query = document.getElementById('search-input').value.trim();
    const resultsDiv = document.getElementById('search-results');
    
    if (!query) {
        resultsDiv.innerHTML = '<div class="search-placeholder">환자 이름 또는 등록번호를 입력하세요</div>';
        return;
    }
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const filtered = patients.filter(p => 
        (p.patientName && p.patientName.includes(query)) ||
        (p.patientId && p.patientId.includes(query))
    );
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="search-placeholder">검색 결과가 없습니다</div>';
        return;;
    }
    
    resultsDiv.innerHTML = filtered.map(p => `
        <div class="search-result-item" onclick="loadPatient('${p.patientId}')">
            <div class="search-result-name">${p.patientName || '(이름 없음)'}</div>
            <div class="search-result-info">
                등록번호: ${p.patientId || '-'} | 
                나이: ${p.age || '-'} |
                최근: ${new Date(p.updatedAt).toLocaleDateString('ko-KR')}
            </div>
        </div>
    `).join('');
}

// Load recent patients
function loadRecentPatients() {
    const listDiv = document.getElementById('recent-patients-list');
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    if (patients.length === 0) {
        listDiv.innerHTML = '<div class="search-placeholder">저장된 환자가 없습니다</div>';
        return;
    }
    
    const recent = patients
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
        .slice(0, 5);
    
    listDiv.innerHTML = recent.map(p => `
        <div class="recent-patient-item" onclick="loadPatient('${p.patientId}')">
            <span>${p.patientName || '(이름 없음)'} - ${p.patientId || '-'}</span>
            <span>${new Date(p.updatedAt).toLocaleDateString('ko-KR')}</span>
        </div>
    `).join('');
}

// Load patient data into form
function loadPatient(patientId) {
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const patient = patients.find(p => p.patientId === patientId);
    
    if (!patient) {
        showNotification('환자를 찾을 수 없습니다.', 'error');
        return;
    }
    
    // Fill form fields
    document.getElementById('patient-name').value = patient.patientName || '';
    document.getElementById('patient-id').value = patient.patientId || '';
    document.getElementById('age').value = patient.age || 25;
    document.getElementById('gender').value = patient.gender || 'male';
    
    // OD fields
    if (patient.od) {
        document.getElementById('od-sph').value = patient.od.sph || -3;
        document.getElementById('od-cyl').value = patient.od.cyl || -1;
        document.getElementById('od-axis').value = patient.od.axis || 180;
        document.getElementById('od-cct').value = patient.od.cct || 540;
        document.getElementById('od-k1').value = patient.od.k1 || 43;
        document.getElementById('od-k2').value = patient.od.k2 || 44;
        document.getElementById('od-steep-axis').value = patient.od.steepAxis || 90;
        document.getElementById('od-topography').value = patient.od.topography || 'normal';
        document.getElementById('od-optical-zone').value = patient.od.opticalZone || 6.5;
        document.getElementById('od-lasik-flap').value = patient.od.lasikFlap || 90;
        document.getElementById('od-lasek-epi').value = patient.od.lasekEpi || 55;
        document.getElementById('od-smile-cap').value = patient.od.smileCap || 120;
    }
    
    // OS fields
    if (patient.os) {
        document.getElementById('os-sph').value = patient.os.sph || -3;
        document.getElementById('os-cyl').value = patient.os.cyl || -1;
        document.getElementById('os-axis').value = patient.os.axis || 180;
        document.getElementById('os-cct').value = patient.os.cct || 535;
        document.getElementById('os-k1').value = patient.os.k1 || 43;
        document.getElementById('os-k2').value = patient.os.k2 || 44;
        document.getElementById('os-steep-axis').value = patient.os.steepAxis || 90;
        document.getElementById('os-topography').value = patient.os.topography || 'normal';
        document.getElementById('os-optical-zone').value = patient.os.opticalZone || 6.5;
        document.getElementById('os-lasik-flap').value = patient.os.lasikFlap || 90;
        document.getElementById('os-lasek-epi').value = patient.os.lasekEpi || 55;
        document.getElementById('os-smile-cap').value = patient.os.smileCap || 120;
    }
    
    toggleModal('search-modal', false);
    showNotification(`${patient.patientName || patientId} 환자 정보를 불러왔습니다.`, 'success');
    
    // Update SE displays
    if (window.calculator) {
        window.calculator.updateSE('od');
        window.calculator.updateSE('os');
    }
}

// Save patient to localStorage (enhanced version)
function savePatientData(formData, results) {
    const patientData = {
        patientName: formData.common?.patientName || document.getElementById('patient-name').value,
        patientId: formData.common?.patientId || document.getElementById('patient-id').value,
        age: formData.od?.age || parseInt(document.getElementById('age').value),
        gender: formData.od?.gender || document.getElementById('gender').value,
        od: {
            sph: formData.od?.sph,
            cyl: formData.od?.cyl,
            axis: formData.od?.axis,
            cct: formData.od?.cct,
            k1: formData.od?.k1,
            k2: formData.od?.k2,
            steepAxis: formData.od?.steepAxis,
            topography: formData.od?.topography,
            opticalZone: formData.od?.opticalZone,
            lasikFlap: formData.od?.lasikFlap,
            lasekEpi: formData.od?.lasekEpi,
            smileCap: formData.od?.smileCap
        },
        os: {
            sph: formData.os?.sph,
            cyl: formData.os?.cyl,
            axis: formData.os?.axis,
            cct: formData.os?.cct,
            k1: formData.os?.k1,
            k2: formData.os?.k2,
            steepAxis: formData.os?.steepAxis,
            topography: formData.os?.topography,
            opticalZone: formData.os?.opticalZone,
            lasikFlap: formData.os?.lasikFlap,
            lasekEpi: formData.os?.lasekEpi,
            smileCap: formData.os?.smileCap
        },
        results: results,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'anonymous'
    };
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    // Check if patient exists
    const existingIndex = patients.findIndex(p => p.patientId === patientData.patientId);
    
    if (existingIndex >= 0) {
        patientData.createdAt = patients[existingIndex].createdAt;
        patients[existingIndex] = patientData;
    } else {
        patients.push(patientData);
    }
    
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(patients));
    return patientData;
}

const CONFIG = {
    RSB_SAFE_THRESHOLD: 300,
    RSB_WARNING_THRESHOLD: 280,
    RSB_DANGER_THRESHOLD: 250,
    PTA_SAFE_THRESHOLD: 35,
    PTA_WARNING_THRESHOLD: 40,
    K_MIN_SAFE: 34,
    K_MAX_SAFE: 48,
    K_OPTIMAL_MIN: 36,
    K_OPTIMAL_MAX: 46,
    // Ablation Depth Thresholds (based on published literature)
    ABLATION_LASIK_SAFE: 90,
    ABLATION_LASIK_CAUTION: 120,
    ABLATION_LASEK_SAFE: 100,
    ABLATION_LASEK_CAUTION: 130,
    // EVO ICL Criteria (FDA & STAAR Surgical Guidelines)
    // References: FDA P030016S035C, EyeWiki, ESCRS 2024
    ICL: {
        AGE_MIN: 21,
        AGE_MAX: 45,
        SE_MIN: -20.0,      // Maximum myopia (most negative)
        SE_MAX: -3.0,       // Minimum myopia for ICL
        CYL_MAX: 4.0,       // Maximum astigmatism (Toric ICL)
        ACD_MIN: 3.00,      // Minimum ACD (mm) - FDA requirement
        ACD_MIN_INTL: 2.80, // International minimum (CE Mark)
        WTW_MIN: 10.5,      // Minimum white-to-white
        WTW_MAX: 13.0,      // Maximum white-to-white
        // ECD minimums by age and ACD (cells/mm²) - STAAR Surgical
        ECD_BY_AGE: {
            '21-25': { acd_3_0: 3875, acd_3_2: 3800, acd_3_5: 3250 },
            '26-30': { acd_3_0: 3425, acd_3_2: 3375, acd_3_5: 2900 },
            '31-35': { acd_3_0: 3025, acd_3_2: 2975, acd_3_5: 2625 },
            '36-40': { acd_3_0: 2675, acd_3_2: 2625, acd_3_5: 2350 },
            '41-45': { acd_3_0: 2350, acd_3_2: 2325, acd_3_5: 2100 },
            '>45':   { acd_3_0: 2075, acd_3_2: 2050, acd_3_5: 1900 }
        },
        // ICL size selection (based on WTW + ACD)
        SIZES: [12.1, 12.6, 13.2, 13.7]
    }
};

// AI Topography Analysis Thresholds based on published criteria
const TOPO_THRESHOLDS = {
    // Belin-Ambrosio Display (BAD-D)
    badD: { normal: 1.6, suspect: 2.6 },
    // I-S value (Inferior-Superior asymmetry)
    isValue: { normal: 1.4, suspect: 1.9 },
    // KISA% index
    kisa: { normal: 60, suspect: 100 },
    // Posterior elevation (central, best-fit sphere)
    posteriorElevation: { normal: 15, suspect: 29 },
    // Anterior elevation
    anteriorElevation: { normal: 7, suspect: 12 },
    // Thinnest pachymetry location displacement
    thinnestDisplacement: { normal: 0.5, suspect: 0.9 },
    // Pachymetric progression index (PPI)
    ppiMax: { normal: 1.2, suspect: 1.6 },
    // ARC (Ambrósio Relational Thickness)
    artMax: { normal: 400, suspect: 339 },
    // Keratoconus Index (KI)
    ki: { normal: 1.07, suspect: 1.1 },
    // Central Keratoconus Index (CKI)
    cki: { normal: 1.03, suspect: 1.05 },
    // Index of Height Asymmetry (IHA)
    iha: { normal: 19, suspect: 30 },
    // Index of Height Decentration (IHD)
    ihd: { normal: 0.014, suspect: 0.021 },
    // Index of Surface Variance (ISV)
    isv: { normal: 37, suspect: 52 },
    // Index of Vertical Asymmetry (IVA)
    iva: { normal: 0.28, suspect: 0.42 },
    // Corneal thickness at thinnest point
    tct: { normal: 490, danger: 470 },
    // Sim K astigmatism
    simKAstig: { normal: 2.0, suspect: 3.0 },
    // Max K
    maxK: { normal: 47.2, suspect: 48.7 }
};

/**
 * AI Topography Analyzer
 * Parses and analyzes Galilei G4, Pentacam, Orbscan data
 */
class TopographyAnalyzer {
    constructor() {
        this.init();
    }
    
    init() {
        // Enable analyze buttons when text is entered
        ['od', 'os'].forEach(eye => {
            const textarea = document.getElementById(`${eye}-topo-data`);
            const button = document.getElementById(`btn-analyze-${eye}`);
            
            if (textarea && button) {
                textarea.addEventListener('input', () => {
                    button.disabled = textarea.value.trim().length < 10;
                });
                
                button.addEventListener('click', () => {
                    this.analyzeTopography(eye);
                });
            }
        });
    }
    
    /**
     * Main analysis function
     */
    analyzeTopography(eye) {
        const textarea = document.getElementById(`${eye}-topo-data`);
        const resultContainer = document.getElementById(`${eye}-ai-result`);
        const button = document.getElementById(`btn-analyze-${eye}`);
        const topoSelect = document.getElementById(`${eye}-topography`);
        
        if (!textarea || !resultContainer) return;
        
        const rawData = textarea.value.trim();
        if (rawData.length < 10) return;
        
        // Show analyzing state
        button.classList.add('analyzing');
        button.innerHTML = '<span class="analyze-icon">⏳</span> 분석중...';
        
        // Simulate analysis delay for UX
        setTimeout(() => {
            try {
                const parsedData = this.parseTopographyData(rawData);
                const analysis = this.analyzeIndices(parsedData);
                this.renderAnalysisResult(resultContainer, analysis, parsedData);
                
                // Auto-update topography select based on analysis
                if (topoSelect && analysis.classification) {
                    this.updateTopographySelect(topoSelect, analysis.classification);
                }
                
            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="ai-result-content">
                        <div class="ai-classification suspect">
                            <span>⚠️</span> 분석 오류
                        </div>
                        <div class="ai-findings">
                            <div class="ai-finding-item">
                                <span class="finding-icon">❌</span>
                                <span>데이터를 파싱할 수 없습니다. 올바른 형식인지 확인해주세요.</span>
                            </div>
                            <div class="ai-finding-item">
                                <span class="finding-icon">💡</span>
                                <span>Galilei G4, Pentacam, Orbscan의 결과를 복사하여 붙여넣기 하세요.</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            button.classList.remove('analyzing');
            button.innerHTML = '<span class="analyze-icon">🔍</span> 분석';
        }, 800);
    }
    
    /**
     * Parse various topography data formats
     */
    parseTopographyData(rawData) {
        const data = {};
        const text = rawData.toLowerCase();
        
        // Helper function to extract numeric value
        const extractNumber = (pattern, text) => {
            const match = text.match(pattern);
            return match ? parseFloat(match[1]) : null;
        };
        
        // BAD-D (Belin-Ambrosio Display)
        data.badD = extractNumber(/bad[- ]?d[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                    extractNumber(/belin[- ]?ambr[oó]sio[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // I-S value
        data.isValue = extractNumber(/i[- ]?s[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                       extractNumber(/inferior[- ]?superior[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // KISA%
        data.kisa = extractNumber(/kisa[%]?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // Posterior elevation
        data.posteriorElevation = extractNumber(/post(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                                   extractNumber(/posterior[:\s]*([+-]?\d+\.?\d*)\s*[μu]?m/i, rawData);
        
        // Anterior elevation
        data.anteriorElevation = extractNumber(/ant(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // TCT / Thinnest pachymetry
        data.tct = extractNumber(/tct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/thinnest[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/min(?:imum)?[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Thinnest location (displacement from center)
        const thinnestLoc = rawData.match(/thinnest[^(]*\(([+-]?\d+\.?\d*)[,\s]+([+-]?\d+\.?\d*)\)/i);
        if (thinnestLoc) {
            const x = parseFloat(thinnestLoc[1]);
            const y = parseFloat(thinnestLoc[2]);
            data.thinnestDisplacement = Math.sqrt(x*x + y*y);
        }
        
        // Sim K values
        const simKMatch = rawData.match(/sim[- ]?k[:\s]*(\d+\.?\d*)\s*[@at]*\s*(\d+)[°]?\s*[\/,]\s*(\d+\.?\d*)\s*[@at]*\s*(\d+)/i);
        if (simKMatch) {
            data.simK1 = parseFloat(simKMatch[1]);
            data.simK1Axis = parseFloat(simKMatch[2]);
            data.simK2 = parseFloat(simKMatch[3]);
            data.simK2Axis = parseFloat(simKMatch[4]);
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Alternative K reading patterns
        if (!data.simK1) {
            data.simK1 = extractNumber(/k1[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/flat[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (!data.simK2) {
            data.simK2 = extractNumber(/k2[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/steep[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (data.simK1 && data.simK2 && !data.simKAstig) {
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Max K / Kmax
        data.maxK = extractNumber(/k[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                    extractNumber(/max[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        
        // PPI (Pachymetric Progression Index)
        data.ppiMax = extractNumber(/ppi[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/ppi[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ART (Ambrósio Relational Thickness)
        data.artMax = extractNumber(/art[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/art[:\s]*(\d+\.?\d*)/i, rawData);
        
        // KI (Keratoconus Index)
        data.ki = extractNumber(/\bki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CKI (Central Keratoconus Index)
        data.cki = extractNumber(/cki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHA (Index of Height Asymmetry)
        data.iha = extractNumber(/iha[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHD (Index of Height Decentration)
        data.ihd = extractNumber(/ihd[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ISV (Index of Surface Variance)
        data.isv = extractNumber(/isv[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IVA (Index of Vertical Asymmetry)
        data.iva = extractNumber(/iva[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CCT (Central Corneal Thickness)
        data.cct = extractNumber(/cct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/central[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Pattern recognition keywords
        data.hasInferiorSteepening = /inferior[- ]?steep/i.test(rawData);
        data.hasAsymmetricBowtie = /asymmetric[- ]?bowtie|ab[- ]?srax/i.test(rawData);
        data.hasSuspectPattern = /suspect|abnormal|keratoconus|kc|ffkc|forme[- ]?fruste/i.test(rawData);
        data.hasNormalPattern = /normal|regular|symmetric/i.test(rawData) && !data.hasSuspectPattern;
        
        return data;
    }
    
    /**
     * Analyze parsed indices and generate classification
     */
    analyzeIndices(data) {
        const findings = [];
        const indices = {};
        let normalCount = 0;
        let suspectCount = 0;
        let abnormalCount = 0;
        
        // Check BAD-D
        if (data.badD !== null) {
            indices.badD = { value: data.badD, label: 'BAD-D' };
            if (data.badD > TOPO_THRESHOLDS.badD.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `BAD-D ${data.badD.toFixed(2)} - 비정상 (기준: <${TOPO_THRESHOLDS.badD.suspect})` });
                indices.badD.status = 'danger';
            } else if (data.badD > TOPO_THRESHOLDS.badD.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `BAD-D ${data.badD.toFixed(2)} - 의심 (기준: <${TOPO_THRESHOLDS.badD.normal})` });
                indices.badD.status = 'warning';
            } else {
                normalCount++;
                indices.badD.status = 'normal';
            }
        }
        
        // Check I-S value
        if (data.isValue !== null) {
            indices.isValue = { value: data.isValue, label: 'I-S' };
            if (data.isValue > TOPO_THRESHOLDS.isValue.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `I-S ${data.isValue.toFixed(2)}D - 하방 가파름 (기준: <${TOPO_THRESHOLDS.isValue.suspect})` });
                indices.isValue.status = 'danger';
            } else if (data.isValue > TOPO_THRESHOLDS.isValue.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `I-S ${data.isValue.toFixed(2)}D - 경계 범위` });
                indices.isValue.status = 'warning';
            } else {
                normalCount++;
                indices.isValue.status = 'normal';
            }
        }
        
        // Check Posterior Elevation
        if (data.posteriorElevation !== null) {
            indices.posteriorElev = { value: data.posteriorElevation, label: 'Post.Elev' };
            if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `후면 융기 ${data.posteriorElevation}μm - 비정상 (기준: <${TOPO_THRESHOLDS.posteriorElevation.suspect})` });
                indices.posteriorElev.status = 'danger';
            } else if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `후면 융기 ${data.posteriorElevation}μm - 경계 범위` });
                indices.posteriorElev.status = 'warning';
            } else {
                normalCount++;
                indices.posteriorElev.status = 'normal';
            }
        }
        
        // Check TCT
        if (data.tct !== null) {
            indices.tct = { value: data.tct, label: 'TCT' };
            if (data.tct < TOPO_THRESHOLDS.tct.danger) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `최박점 두께 ${data.tct}μm - 매우 얇음 (기준: >${TOPO_THRESHOLDS.tct.danger})` });
                indices.tct.status = 'danger';
            } else if (data.tct < TOPO_THRESHOLDS.tct.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `최박점 두께 ${data.tct}μm - 다소 얇음` });
                indices.tct.status = 'warning';
            } else {
                normalCount++;
                indices.tct.status = 'normal';
            }
        }
        
        // Check Thinnest location displacement
        if (data.thinnestDisplacement !== null) {
            indices.thinnestLoc = { value: data.thinnestDisplacement, label: 'Thin.Loc' };
            if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `최박점 위치 편위 ${data.thinnestDisplacement.toFixed(2)}mm - 비정상` });
                indices.thinnestLoc.status = 'danger';
            } else if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `최박점 위치 편위 ${data.thinnestDisplacement.toFixed(2)}mm - 경계` });
                indices.thinnestLoc.status = 'warning';
            } else {
                normalCount++;
                indices.thinnestLoc.status = 'normal';
            }
        }
        
        // Check Sim K astigmatism
        if (data.simKAstig !== null) {
            indices.simKAstig = { value: data.simKAstig, label: 'SimK Astig' };
            if (data.simKAstig > TOPO_THRESHOLDS.simKAstig.suspect) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `Sim K 난시 ${data.simKAstig.toFixed(2)}D - 고도난시` });
                indices.simKAstig.status = 'warning';
            } else {
                normalCount++;
                indices.simKAstig.status = 'normal';
            }
        }
        
        // Check Max K
        if (data.maxK !== null) {
            indices.maxK = { value: data.maxK, label: 'Kmax' };
            if (data.maxK > TOPO_THRESHOLDS.maxK.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `Kmax ${data.maxK.toFixed(2)}D - 비정상 (기준: <${TOPO_THRESHOLDS.maxK.suspect})` });
                indices.maxK.status = 'danger';
            } else if (data.maxK > TOPO_THRESHOLDS.maxK.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `Kmax ${data.maxK.toFixed(2)}D - 경계 범위` });
                indices.maxK.status = 'warning';
            } else {
                normalCount++;
                indices.maxK.status = 'normal';
            }
        }
        
        // Check KISA
        if (data.kisa !== null) {
            indices.kisa = { value: data.kisa, label: 'KISA%' };
            if (data.kisa > TOPO_THRESHOLDS.kisa.suspect) {
                abnormalCount++;
                findings.push({ icon: '🔴', text: `KISA% ${data.kisa.toFixed(1)} - 원추각막 가능성 높음` });
                indices.kisa.status = 'danger';
            } else if (data.kisa > TOPO_THRESHOLDS.kisa.normal) {
                suspectCount++;
                findings.push({ icon: '🟡', text: `KISA% ${data.kisa.toFixed(1)} - 의심 범위` });
                indices.kisa.status = 'warning';
            } else {
                normalCount++;
                indices.kisa.status = 'normal';
            }
        }
        
        // Check pattern keywords
        if (data.hasInferiorSteepening) {
            suspectCount++;
            findings.push({ icon: '🟡', text: '하방 가파름(Inferior Steepening) 패턴 감지' });
        }
        if (data.hasAsymmetricBowtie) {
            suspectCount++;
            findings.push({ icon: '🟡', text: '비대칭 나비넥타이(Asymmetric Bowtie) 패턴 감지' });
        }
        if (data.hasSuspectPattern) {
            abnormalCount++;
            findings.push({ icon: '🔴', text: '원추각막 의심 소견 키워드 감지' });
        }
        
        // Determine classification
        let classification, classLabel, confidence;
        
        if (abnormalCount >= 2 || (abnormalCount >= 1 && suspectCount >= 2)) {
            classification = 'abnormal';
            classLabel = 'Abnormal (KC suspect)';
            confidence = Math.min(95, 70 + abnormalCount * 10 + suspectCount * 5);
        } else if (abnormalCount >= 1 || suspectCount >= 2) {
            classification = 'suspect';
            classLabel = '의심 (Suspect)';
            confidence = Math.min(90, 60 + abnormalCount * 15 + suspectCount * 10);
        } else if (suspectCount === 1) {
            classification = 'suspect';
            classLabel = '경계 (Borderline)';
            confidence = Math.min(75, 50 + suspectCount * 15);
        } else if (normalCount > 0 || data.hasNormalPattern) {
            classification = 'normal';
            classLabel = '정상 (Normal)';
            confidence = Math.min(95, 70 + normalCount * 5);
        } else {
            classification = 'unknown';
            classLabel = '판정 불가';
            confidence = 0;
        }
        
        // Add summary finding
        if (findings.length === 0) {
            findings.push({ icon: '✅', text: '분석된 지표들이 정상 범위 내에 있습니다.' });
        }
        
        return {
            classification,
            classLabel,
            confidence,
            findings,
            indices,
            stats: { normalCount, suspectCount, abnormalCount }
        };
    }
    
    /**
     * Render analysis result to container
     */
    renderAnalysisResult(container, analysis, rawData) {
        const findingsHTML = analysis.findings
            .map(f => `<div class="ai-finding-item"><span class="finding-icon">${f.icon}</span><span>${f.text}</span></div>`)
            .join('');
        
        const indicesHTML = Object.entries(analysis.indices)
            .map(([key, val]) => `
                <div class="ai-index-item">
                    <span class="ai-index-label">${val.label}</span>
                    <span class="ai-index-value ${val.status}">${typeof val.value === 'number' ? val.value.toFixed(2) : val.value}</span>
                </div>
            `).join('');
        
        container.innerHTML = `
            <div class="ai-result-content">
                <div class="ai-result-header">
                    <div class="ai-classification ${analysis.classification}">
                        <span>${analysis.classification === 'normal' ? '✅' : analysis.classification === 'abnormal' ? '🚫' : '⚠️'}</span>
                        ${analysis.classLabel}
                    </div>
                    ${analysis.confidence > 0 ? `<span class="ai-confidence">신뢰도: ${analysis.confidence}%</span>` : ''}
                </div>
                <div class="ai-findings">${findingsHTML}</div>
                ${indicesHTML ? `<div class="ai-indices">${indicesHTML}</div>` : ''}
            </div>
        `;
    }
    
    /**
     * Auto-update topography select based on AI classification
     */
    updateTopographySelect(select, classification) {
        const mapping = {
            'normal': 'normal',
            'suspect': 'inferior-steepening',
            'abnormal': 'abnormal'
        };
        
        if (mapping[classification]) {
            select.value = mapping[classification];
            // Highlight that it was auto-updated
            select.style.borderColor = '#6366f1';
            select.title = 'AI 분석에 의해 자동 설정됨';
            setTimeout(() => {
                select.style.borderColor = '';
            }, 3000);
        }
    }
}

const ERSS_CRITERIA = {
    topography: {
        'normal': 0,
        'asymmetric-bowtie': 1,
        'inferior-steepening': 2,
        'abnormal': 4
    },
    rsb: [
        { max: 239, points: 4 },
        { max: 259, points: 3 },
        { max: 279, points: 2 },
        { max: 299, points: 1 },
        { max: Infinity, points: 0 }
    ],
    age: [
        { max: 17, points: 4 },
        { max: 21, points: 3 },
        { max: 25, points: 2 },
        { max: 29, points: 1 },
        { max: Infinity, points: 0 }
    ],
    cct: [
        { max: 449, points: 4 },
        { max: 479, points: 3 },
        { max: 509, points: 2 },
        { max: Infinity, points: 0 }
    ],
    mrse: [
        { max: -14, points: 4 },
        { max: -12, points: 3 },
        { max: -10, points: 2 },
        { max: -8, points: 1 },
        { max: Infinity, points: 0 }
    ]
};

function calculateAblationDepth(correction, opticalZone) {
    const ablationDepth = (Math.pow(opticalZone, 2) * Math.abs(correction)) / 3;
    return Math.round(ablationDepth * 10) / 10;
}

/**
 * Evaluate ablation depth risk level
 */
function evaluateAblationRisk(ablationDepth, surgeryType) {
    const isLasik = surgeryType === 'lasik' || surgeryType === 'LASIK';
    
    const safeThreshold = isLasik ? CONFIG.ABLATION_LASIK_SAFE : CONFIG.ABLATION_LASEK_SAFE;
    const cautionThreshold = isLasik ? CONFIG.ABLATION_LASIK_CAUTION : CONFIG.ABLATION_LASEK_CAUTION;
    
    if (ablationDepth <= safeThreshold) {
        return {
            level: 'safe',
            class: 'success',
            icon: '✓',
            message: '안전 범위',
            detail: `절삭량 ${ablationDepth.toFixed(1)}μm은 안전 범위(≤${safeThreshold}μm) 내입니다.`
        };
    } else if (ablationDepth <= cautionThreshold) {
        return {
            level: 'caution',
            class: 'warning',
            icon: '⚠️',
            message: '주의 필요',
            detail: `절삭량 ${ablationDepth.toFixed(1)}μm은 고도근시 영역입니다. 면밀한 검토가 필요합니다. (권장: ≤${safeThreshold}μm)`
        };
    } else {
        return {
            level: 'danger',
            class: 'danger',
            icon: '🚨',
            message: '경고: 과도한 절삭',
            detail: `절삭량 ${ablationDepth.toFixed(1)}μm은 권장 상한(${cautionThreshold}μm)을 초과합니다. 확막확장증 위험이 증가하며, 대안적 수술 방법을 고려하세요. [Ref: ESCRS 2024, Santhiago et al.]`
        };
    }
}

/**
 * EVO ICL Eligibility Assessment
 * Based on FDA & STAAR Surgical Guidelines
 * References: FDA P030016S035C, EyeWiki, PMC9132105
 */
function evaluateICLEligibility(params) {
    const { age, se, cyl, acd, wtw, ecd, topography } = params;
    const criteria = [];
    let overallEligible = true;
    let hasWarnings = false;
    
    // 1. Age criterion (21-45 years)
    const agePass = age >= CONFIG.ICL.AGE_MIN && age <= CONFIG.ICL.AGE_MAX;
    criteria.push({
        name: '나이',
        value: `${age}세`,
        pass: agePass,
        requirement: `${CONFIG.ICL.AGE_MIN}-${CONFIG.ICL.AGE_MAX}세`,
        message: agePass ? '적합' : (age < CONFIG.ICL.AGE_MIN ? '21세 미만' : '45세 초과')
    });
    if (!agePass) overallEligible = false;
    
    // 2. Spherical Equivalent criterion (-3.0 to -20.0 D)
    const sePass = se <= CONFIG.ICL.SE_MAX && se >= CONFIG.ICL.SE_MIN;
    const seWarning = se > -3.0 && se <= 0; // Low myopia - consider other options
    criteria.push({
        name: '구면대응치 (SE)',
        value: `${se.toFixed(2)} D`,
        pass: sePass,
        warning: seWarning,
        requirement: `${CONFIG.ICL.SE_MIN} ~ ${CONFIG.ICL.SE_MAX} D`,
        message: sePass ? '적합' : (se > CONFIG.ICL.SE_MAX ? '근시 부족 (-3D 미만)' : '초고도근시')
    });
    if (!sePass) overallEligible = false;
    if (seWarning) hasWarnings = true;
    
    // 3. Cylinder criterion (≤4.0 D for Toric)
    const cylAbs = Math.abs(cyl);
    const cylPass = cylAbs <= CONFIG.ICL.CYL_MAX;
    criteria.push({
        name: '난시 (CYL)',
        value: `${cylAbs.toFixed(2)} D`,
        pass: cylPass,
        requirement: `≤ ${CONFIG.ICL.CYL_MAX} D`,
        message: cylPass ? (cylAbs >= 1.0 ? 'Toric ICL 권장' : '적합') : '난시 과다'
    });
    if (!cylPass) overallEligible = false;
    
    // 4. Anterior Chamber Depth criterion (≥3.0 mm)
    const acdPass = acd >= CONFIG.ICL.ACD_MIN;
    const acdWarning = acd >= CONFIG.ICL.ACD_MIN_INTL && acd < CONFIG.ICL.ACD_MIN;
    criteria.push({
        name: '전방깊이 (ACD)',
        value: `${acd.toFixed(2)} mm`,
        pass: acdPass,
        warning: acdWarning,
        requirement: `≥ ${CONFIG.ICL.ACD_MIN} mm`,
        message: acdPass ? '적합' : (acdWarning ? '경계선 (FDA 기준 미달)' : '전방 얕음')
    });
    if (!acdPass && !acdWarning) overallEligible = false;
    if (acdWarning) hasWarnings = true;
    
    // 5. White-to-White criterion
    const wtwPass = wtw >= CONFIG.ICL.WTW_MIN && wtw <= CONFIG.ICL.WTW_MAX;
    criteria.push({
        name: '백색-백색 (WTW)',
        value: `${wtw.toFixed(1)} mm`,
        pass: wtwPass,
        requirement: `${CONFIG.ICL.WTW_MIN}-${CONFIG.ICL.WTW_MAX} mm`,
        message: wtwPass ? '적합' : (wtw < CONFIG.ICL.WTW_MIN ? 'WTW 좁음' : 'WTW 넓음')
    });
    if (!wtwPass) hasWarnings = true;
    
    // 6. Endothelial Cell Density criterion (age & ACD dependent)
    const minECD = getMinimumECD(age, acd);
    const ecdPass = ecd >= minECD;
    criteria.push({
        name: '각막내피세포 (ECD)',
        value: `${ecd} /mm²`,
        pass: ecdPass,
        requirement: `≥ ${minECD} /mm²`,
        message: ecdPass ? '적합' : '내피세포 부족'
    });
    if (!ecdPass) overallEligible = false;
    
    // 7. Topography criterion
    const topoPass = topography === 'normal' || topography === 'asymmetric-bowtie';
    const topoWarning = topography === 'asymmetric-bowtie';
    criteria.push({
        name: 'Topography',
        value: getTopographyLabel(topography),
        pass: topoPass,
        warning: topoWarning,
        requirement: 'Normal 권장',
        message: topoPass ? (topoWarning ? '주의 관찰' : '적합') : '각막 이상'
    });
    if (!topoPass) hasWarnings = true;
    
    // Calculate recommended ICL size
    const recommendedSize = calculateICLSize(wtw, acd);
    
    // Determine overall status
    let status, statusClass, statusMessage;
    if (overallEligible && !hasWarnings) {
        status = 'eligible';
        statusClass = 'eligible';
        statusMessage = 'EVO ICL 적합';
    } else if (overallEligible && hasWarnings) {
        status = 'caution';
        statusClass = 'caution';
        statusMessage = 'EVO ICL 가능 (주의사항 확인)';
    } else {
        status = 'not-eligible';
        statusClass = 'not-eligible';
        statusMessage = 'EVO ICL 부적합';
    }
    
    return {
        criteria,
        overallEligible,
        hasWarnings,
        status,
        statusClass,
        statusMessage,
        recommendedSize,
        minECD
    };
}

/**
 * Get minimum ECD requirement based on age and ACD
 * Source: STAAR Surgical FDA labeling
 */
function getMinimumECD(age, acd) {
    let ageGroup;
    if (age <= 25) ageGroup = '21-25';
    else if (age <= 30) ageGroup = '26-30';
    else if (age <= 35) ageGroup = '31-35';
    else if (age <= 40) ageGroup = '36-40';
    else if (age <= 45) ageGroup = '41-45';
    else ageGroup = '>45';
    
    const ecdReqs = CONFIG.ICL.ECD_BY_AGE[ageGroup];
    
    if (acd >= 3.5) return ecdReqs.acd_3_5;
    if (acd >= 3.2) return ecdReqs.acd_3_2;
    return ecdReqs.acd_3_0;
}

/**
 * Calculate recommended ICL size based on WTW and ACD
 * Based on STAAR OCOS algorithm
 */
function calculateICLSize(wtw, acd) {
    // Basic algorithm: WTW + adjustment based on ACD
    let adjustment = 1.1; // Default for ACD ≤ 3.5mm
    if (acd > 3.5) {
        adjustment = Math.min(1.6, 1.1 + (acd - 3.5) * 0.5);
    }
    
    const calculatedSize = wtw + adjustment;
    
    // Round to nearest available size
    const sizes = CONFIG.ICL.SIZES;
    let recommendedSize = sizes[0];
    let minDiff = Math.abs(calculatedSize - sizes[0]);
    
    for (const size of sizes) {
        const diff = Math.abs(calculatedSize - size);
        if (diff < minDiff) {
            minDiff = diff;
            recommendedSize = size;
        }
    }
    
    return {
        calculated: calculatedSize.toFixed(1),
        recommended: recommendedSize,
        sizes: sizes
    };
}

/**
 * Get topography label in Korean
 */
function getTopographyLabel(topo) {
    const labels = {
        'normal': 'Normal',
        'asymmetric-bowtie': 'Asymmetric Bowtie',
        'inferior-steepening': 'Inferior Steepening',
        'abnormal': 'Abnormal (KC suspect)'
    };
    return labels[topo] || topo;
}

/**
 * Render ICL assessment results
 */
function renderICLAssessment(containerId, result) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    let html = '<div class="icl-criteria-grid">';
    
    // Render each criterion
    result.criteria.forEach(criterion => {
        const statusClass = criterion.pass ? (criterion.warning ? 'warning' : 'pass') : 'fail';
        const icon = criterion.pass ? (criterion.warning ? '⚠️' : '✓') : '✗';
        
        html += `
            <div class="icl-criterion ${statusClass}">
                <div class="icl-criterion-info">
                    <span class="icl-criterion-name">${criterion.name}</span>
                    <span class="icl-criterion-req">${criterion.requirement}</span>
                </div>
                <div class="icl-criterion-status">
                    <span class="icl-criterion-value">${criterion.value}</span>
                    <span class="icon">${icon}</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Overall result
    html += `
        <div class="icl-overall-result ${result.statusClass}">
            <div class="icl-result-title">${result.status === 'eligible' ? '✓' : result.status === 'caution' ? '⚠️' : '✗'} ${result.statusMessage}</div>
            <div class="icl-result-message">
                ${result.overallEligible ? 
                    `모든 필수 기준을 충족합니다.${result.hasWarnings ? ' (일부 주의사항 확인 필요)' : ''}` : 
                    '하나 이상의 필수 기준을 충족하지 않습니다.'}
            </div>
        </div>
    `;
    
    // Recommended ICL size (if eligible)
    if (result.overallEligible) {
        html += `
            <div class="icl-lens-size">
                <div class="size-label">권장 ICL 크기</div>
                <div class="size-value">${result.recommendedSize.recommended} mm</div>
                <div class="size-note">계산값: ${result.recommendedSize.calculated} mm (사용 가능: ${result.recommendedSize.sizes.join(', ')} mm)</div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function calculateSE(sph, cyl) {
    return sph + (cyl / 2);
}

function calculateTotalCorrection(sph, cyl) {
    return Math.abs(sph) + Math.abs(cyl);
}

function calculateRSB(cct, flapThickness, ablationDepth) {
    return cct - flapThickness - ablationDepth;
}

function calculatePTA(cct, flapThickness, ablationDepth) {
    return ((flapThickness + ablationDepth) / cct) * 100;
}

function calculatePostopK(k1, k2, sph, cyl) {
    const minK = Math.min(k1, k2);
    const se = sph + (cyl / 2);
    const postopK = minK + (se * 0.75);
    return Math.round(postopK * 100) / 100;
}

function calculateERSS(params) {
    const { age, cct, topography, rsb, mrse } = params;
    
    const breakdown = {
        topography: ERSS_CRITERIA.topography[topography] || 0,
        rsb: 0,
        age: 0,
        cct: 0,
        mrse: 0
    };
    
    for (const criterion of ERSS_CRITERIA.rsb) {
        if (rsb <= criterion.max) {
            breakdown.rsb = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.age) {
        if (age <= criterion.max) {
            breakdown.age = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.cct) {
        if (cct <= criterion.max) {
            breakdown.cct = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.mrse) {
        if (mrse <= criterion.max) {
            breakdown.mrse = criterion.points;
            break;
        }
    }
    
    const total = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
    
    let riskLevel;
    if (total <= 2) {
        riskLevel = 'low';
    } else if (total === 3) {
        riskLevel = 'moderate';
    } else {
        riskLevel = 'high';
    }
    
    return { breakdown, total, riskLevel };
}

function getWellingtonNomogramAdjustments(sph, cyl, age) {
    const recommendations = [];
    const se = calculateSE(sph, cyl);
    
    if (se <= -6.0) {
        recommendations.push({
            title: '고도근시 조정 (High Myopia)',
            text: `SE ${se.toFixed(2)}D의 고도근시입니다. Wellington nomogram에서는 고도근시 시 약간의 과소교정 경향이 있어 목표 굴절값을 -0.25 ~ -0.50D로 설정하는 것을 권장합니다.`
        });
    } else if (se >= -3.0 && se < 0) {
        recommendations.push({
            title: '경도근시 조정 (Low Myopia)',
            text: `SE ${se.toFixed(2)}D의 경도근시입니다. Wellington nomogram에서는 경도근시 시 정확한 교정이 가능하므로 목표를 plano로 설정할 수 있습니다.`
        });
    }
    
    if (Math.abs(cyl) >= 2.0) {
        recommendations.push({
            title: '고도난시 조정 (High Astigmatism)',
            text: `난시 ${cyl.toFixed(2)}D가 2D 이상입니다. 난시 교정 시 coupling effect를 고려하여 구면 교정량을 조정해야 할 수 있습니다. 일반적으로 난시 교정량의 15-20%를 구면에서 차감합니다.`
        });
    }
    
    if (age >= 40) {
        recommendations.push({
            title: '노안 고려 (Presbyopia Consideration)',
            text: `환자 나이가 ${age}세입니다. 노안이 진행 중일 수 있으므로, 근거리 시력을 위해 주시안은 plano, 비주시안은 -0.50 ~ -1.00D의 monovision을 고려할 수 있습니다.`
        });
    }
    
    if (se <= -8.0) {
        recommendations.push({
            title: '회귀 예측 (Regression Prediction)',
            text: `초고도근시(-8D 이상)에서는 수술 후 회귀가 발생할 수 있습니다. 1년 내 0.5-1.0D 정도의 회귀를 예상하고 약간의 과교정을 고려할 수 있습니다.`
        });
    }
    
    if (recommendations.length === 0) {
        recommendations.push({
            title: '표준 치료 (Standard Treatment)',
            text: `현재 굴절값(SE: ${se.toFixed(2)}D)은 표준 범위 내에 있습니다. Wellington nomogram 기본 설정으로 치료 진행이 가능합니다.`
        });
    }
    
    return recommendations;
}

/**
 * Get combined ERSS + PTA risk interpretation
 * Based on literature: Santhiago et al., Chan et al. 2018
 * 
 * @param {number} erssScore - ERSS total score
 * @param {number} ptaLasik - PTA for LASIK
 * @param {string} topography - Topography pattern
 * @returns {Object} Combined risk interpretation
 */
function getCombinedRiskInterpretation(erssScore, ptaLasik, topography) {
    // Determine PTA risk level
    let ptaLevel;
    if (ptaLasik < 35) {
        ptaLevel = 'low';
    } else if (ptaLasik < 40) {
        ptaLevel = 'moderate';
    } else {
        ptaLevel = 'high';
    }
    
    // Determine ERSS risk level
    let erssLevel;
    if (erssScore <= 2) {
        erssLevel = 'low';
    } else if (erssScore === 3) {
        erssLevel = 'moderate';
    } else {
        erssLevel = 'high';
    }
    
    // Combined interpretation matrix
    const riskMatrix = {
        'low-low': {
            level: 'low',
            title: '저위험 (Low Risk)',
            text: 'ERSS와 PTA 모두 안전 범위 내에 있습니다. 수술 적합성이 높으며, 일반적인 주의사항만 고려하면 됩니다.',
            recommendations: [
                '표준 수술 프로토콜 적용 가능',
                '정기적인 술 후 경과 관찰 권장',
                '환자에게 일반적인 위험성 설명'
            ]
        },
        'low-moderate': {
            level: 'low-moderate',
            title: '저-중등 위험 (Low-Moderate Risk)',
            text: 'ERSS는 저위험이나 PTA가 경계 수준입니다. ERSS는 보수적 경향이 있으므로, PTA 35-40% 구간에서는 신중한 접근이 필요합니다.',
            recommendations: [
                '가능하면 플랩 두께를 줄이거나 LASEK 고려',
                '광학부 크기 조정으로 절삭량 최소화 검토',
                '술 후 각막확장증 징후 면밀히 관찰'
            ]
        },
        'low-high': {
            level: 'moderate',
            title: '중등 위험 (Moderate Risk)',
            text: 'ERSS는 저위험이지만 PTA ≥40%입니다. 연구에 따르면 정상 Topography에서 PTA는 ERSS보다 강한 예측력을 보입니다. 주의가 필요합니다.',
            recommendations: [
                'LASEK/PRK로 전환 강력 권장',
                'ICL(안내렌즈삽입술) 대안 검토',
                '환자에게 위험성 충분히 설명 후 동의 필요',
                '수술 진행 시 최소 절삭량 원칙 적용'
            ]
        },
        'moderate-low': {
            level: 'low-moderate',
            title: '저-중등 위험 (Low-Moderate Risk)',
            text: 'ERSS가 중등위험(3점)이나 PTA는 안전합니다. ERSS는 보수적 평가 경향이 있어, PTA가 낮다면 실제 위험은 낮을 수 있습니다.',
            recommendations: [
                'Topography 패턴 재확인 필수',
                '가족력 및 눈 비비는 습관 확인',
                '경계심을 갖고 수술 진행 가능',
                '술 후 장기 추적 관찰 계획 수립'
            ]
        },
        'moderate-moderate': {
            level: 'moderate',
            title: '중등 위험 (Moderate Risk)',
            text: 'ERSS와 PTA 모두 경계 수준입니다. 두 지표가 일치하므로 신중한 접근이 필요합니다.',
            recommendations: [
                'LASEK/PRK 우선 고려',
                '각막 단층촬영(Tomography) 추가 검사',
                '각막 생체역학 검사(ORA, Corvis ST) 권장',
                '위험-이익 충분히 설명 후 환자 결정'
            ]
        },
        'moderate-high': {
            level: 'high',
            title: '고위험 (High Risk)',
            text: 'ERSS 중등위험에 PTA ≥40%입니다. 각막확장증 위험이 유의하게 높습니다.',
            recommendations: [
                'LASIK 비권장 - LASEK 또는 ICL 권장',
                '수술 전 Cross-linking 병행 고려',
                '환자에게 대안 수술 적극 권유',
                '부득이한 경우 최소 교정량 원칙'
            ]
        },
        'high-low': {
            level: 'moderate',
            title: '중등 위험 (Moderate Risk)',
            text: 'ERSS 고위험이나 PTA는 안전합니다. ERSS의 보수적 특성상 실제 위험은 낮을 수 있으나, ERSS 점수 구성 요소를 개별 확인하세요.',
            recommendations: [
                'ERSS 고득점 요인 개별 분석 (Topography가 주요인인지 확인)',
                'Topography 이상이 원인이면 LASIK 재고',
                '나이/CCT/MRSE가 주요인이면 상대적 안전',
                '추가 검사로 확인 후 결정'
            ]
        },
        'high-moderate': {
            level: 'high',
            title: '고위험 (High Risk)',
            text: 'ERSS 고위험에 PTA도 경계 수준입니다. 복합적인 위험 요소가 있습니다.',
            recommendations: [
                'LASIK 강력 비권장',
                'LASEK도 신중히 접근',
                'ICL 또는 안경/렌즈 교정 권장',
                '수술 진행 시 반드시 informed consent'
            ]
        },
        'high-high': {
            level: 'very-high',
            title: '매우 고위험 (Very High Risk)',
            text: 'ERSS와 PTA 모두 고위험입니다. 각막확장증 발생 위험이 매우 높아 각막굴절수술을 권장하지 않습니다.',
            recommendations: [
                '각막굴절수술(LASIK/LASEK/SMILE) 금기',
                'ICL(안내렌즈삽입술) 강력 권장',
                '안경 또는 콘택트렌즈 교정 유지',
                '원추각막 정밀검사 권장'
            ]
        }
    };
    
    const key = `${erssLevel}-${ptaLevel}`;
    const interpretation = riskMatrix[key] || riskMatrix['moderate-moderate'];
    
    return {
        erssLevel,
        ptaLevel,
        ...interpretation
    };
}

function determineSurgeryEligibility(rsb, pta, topography, erssTotal) {
    if (topography === 'abnormal') {
        return { status: 'not-eligible', message: '비적합 (각막이상)' };
    }
    
    if (rsb < CONFIG.RSB_DANGER_THRESHOLD) {
        return { status: 'not-eligible', message: `비적합 (RSB < ${CONFIG.RSB_DANGER_THRESHOLD}μm)` };
    }
    
    if (pta >= CONFIG.PTA_WARNING_THRESHOLD) {
        return { status: 'not-eligible', message: `비적합 (PTA ≥ ${CONFIG.PTA_WARNING_THRESHOLD}%)` };
    }
    
    if (erssTotal >= 4) {
        return { status: 'not-eligible', message: '비적합 (ERSS ≥ 4)' };
    }
    
    if (rsb < CONFIG.RSB_SAFE_THRESHOLD || pta >= CONFIG.PTA_SAFE_THRESHOLD || erssTotal === 3) {
        return { status: 'caution', message: '주의 필요' };
    }
    
    return { status: 'eligible', message: '적합' };
}

/**
 * Generate combined ERSS + PTA risk interpretation guide
 * Based on published literature (Santhiago et al., Chan et al., Randleman et al.)
 */
function generateCombinedRiskGuide(erssResult, ptaLasik, ptaLasek, topography) {
    const erss = erssResult.total;
    const guides = [];
    
    // Determine the overall risk category based on combined assessment
    const isNormalTopography = topography === 'normal';
    const isAbnormalTopography = topography === 'abnormal';
    const isSuspiciousTopography = topography === 'asymmetric-bowtie' || topography === 'inferior-steepening';
    
    // Case 1: Abnormal Topography - Highest priority risk factor
    if (isAbnormalTopography) {
        guides.push({
            type: 'high-risk',
            icon: '🚫',
            title: '절대적 금기',
            condition: 'Abnormal Topography (KC suspect/FFKC)',
            text: '비정상 각막 지형도는 ERSS에서 가장 중요한 단일 위험요소입니다. Randleman 연구에서 ectasia 발생 눈의 69%가 비정상 topography를 보였습니다.',
            recommendation: '권고: 시력교정술 금기. Cross-linking 또는 다른 치료 옵션 고려.'
        });
        return guides;
    }
    
    // Case 2: High ERSS + High PTA
    if (erss >= 4 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: '⛔',
            title: '고위험 - 복합 위험요소',
            condition: `ERSS ≥ 4 (현재: ${erss}) + PTA ≥ 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSS와 PTA 모두 고위험 범위입니다. 두 지표가 동시에 높을 경우 ectasia 발생 위험이 크게 증가합니다.',
            recommendation: '권고: LASIK 부적합. LASEK/PRK 또는 ICL 등 대안 고려.'
        });
    }
    // Case 3: High ERSS but Low PTA with Normal Topography
    else if (erss >= 4 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: '⚠️',
            title: '주의 - ERSS 과대평가 가능성',
            condition: `ERSS ≥ 4 (현재: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), 정상 Topography`,
            text: 'Binder & Trattler (2010) 연구에 따르면, 정상 topography에서 ERSS가 높더라도 실제 ectasia 발생률은 매우 낮았습니다. ERSS가 위험을 과대평가할 수 있습니다.',
            recommendation: '권고: 신중한 평가 필요. Tomography(Pentacam 등) 추가 검사 권장.'
        });
    }
    // Case 4: Low ERSS but High PTA
    else if (erss <= 2 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: '⚠️',
            title: '주의 - PTA 단독 고위험',
            condition: `ERSS ≤ 2 (현재: ${erss}), PTA ≥ 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'Santhiago 연구에서 PTA ≥ 40%는 ERSS보다 ectasia 예측에 더 강한 상관관계를 보였습니다. ERSS가 낮더라도 높은 PTA는 위험 신호입니다.',
            recommendation: '권고: LASIK 대신 LASEK/PRK 권장 (더 낮은 PTA).'
        });
    }
    // Case 5: Moderate ERSS + Moderate PTA
    else if (erss === 3 && ptaLasik >= 35 && ptaLasik < 40) {
        guides.push({
            type: 'moderate-risk',
            icon: '⚡',
            title: '중등도 위험 - 경계 범위',
            condition: `ERSS = 3, PTA 35-40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSS 3점은 "주의" 범위이며, PTA도 경계 수준입니다. 다기관 연구에서 이 범위는 개별 사례별 판단이 필요한 영역입니다.',
            recommendation: '권고: 추가 검사(Tomography, Biomechanics) 후 결정. LASEK이 더 안전할 수 있음.'
        });
    }
    // Case 6: Low ERSS + Low PTA + Normal Topography
    else if (erss <= 2 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'low-risk',
            icon: '✅',
            title: '저위험 - 양호한 조건',
            condition: `ERSS ≤ 2 (현재: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), 정상 Topography`,
            text: 'ERSS, PTA, Topography 모두 양호합니다. 다기관 연구에서 이 조합은 ectasia 발생 위험이 가장 낮은 그룹입니다.',
            recommendation: '권고: LASIK 적합. 표준 수술 프로토콜 적용 가능.'
        });
    }
    // Case 7: Suspicious Topography
    else if (isSuspiciousTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: '🔍',
            title: '추가 검사 필요 - 의심 소견',
            condition: `Suspicious Topography (${topography === 'asymmetric-bowtie' ? 'Asymmetric Bowtie' : 'Inferior Steepening/SRA'})`,
            text: '의심스러운 topography 패턴은 subclinical keratoconus의 가능성을 시사합니다. ERSS와 PTA 수치와 무관하게 추가 평가가 필요합니다.',
            recommendation: '권고: Pentacam, Corneal Biomechanics 검사 필수. 가족력/눈 비비는 습관 확인.'
        });
    }
    // Default moderate case
    else {
        guides.push({
            type: 'moderate-risk',
            icon: '📋',
            title: '개별 평가 필요',
            condition: `ERSS: ${erss}, PTA(LASIK): ${ptaLasik.toFixed(1)}%`,
            text: '복합 지표가 명확한 범주에 해당하지 않습니다. 개별 위험요소를 종합적으로 고려해야 합니다.',
            recommendation: '권고: 전문의 상담 및 추가 검사 권장.'
        });
    }
    
    // Add LASEK comparison if relevant
    if (ptaLasek < ptaLasik && ptaLasik >= 35) {
        guides.push({
            type: 'low-risk',
            icon: '💡',
            title: 'LASEK/PRK 대안 고려',
            condition: `LASEK PTA: ${ptaLasek.toFixed(1)}% vs LASIK PTA: ${ptaLasik.toFixed(1)}%`,
            text: `LASEK은 플랩이 없어 PTA가 ${(ptaLasik - ptaLasek).toFixed(1)}% 낮습니다. 경계 범위의 환자에서 LASEK이 더 안전한 선택일 수 있습니다.`,
            recommendation: '권고: LASEK/PRK로 전환 시 ectasia 위험 감소 기대.'
        });
    }
    
    return guides;
}

class RefractiveCalculator {
    constructor() {
        this.form = document.getElementById('patient-form');
        this.resultsContainer = document.getElementById('results-container');
        this.resultsTemplate = document.getElementById('results-template');
        this.currentEye = 'od'; // 현재 활성 탭
        this.results = {}; // 양안 결과 저장
        this.init();
    }
    
    init() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.calculate();
        });
        
        // 양안 SE 실시간 업데이트
        ['od', 'os'].forEach(eye => {
            const sphInput = document.getElementById(`${eye}-sph`);
            const cylInput = document.getElementById(`${eye}-cyl`);
            
            [sphInput, cylInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => this.updateSE(eye));
                }
            });
        });
        
        // OD→OS 복사 버튼
        const copyBtn = document.getElementById('copy-od-to-os');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => this.copyODtoOS());
        }
        
        // 테마 토글
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => this.toggleTheme());
        
        // Tab 키 이동 개선 - Enter 키로도 다음 필드 이동
        this.setupTabNavigation();
        
        this.loadTheme();
        this.updateSE('od');
        this.updateSE('os');
    }
    
    setupTabNavigation() {
        // 입력 필드에서 Enter 키를 누르면 Tab처럼 다음 필드로 이동
        const inputs = this.form.querySelectorAll('input, select');
        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextInput = inputs[index + 1];
                    if (nextInput) {
                        nextInput.focus();
                        if (nextInput.select) nextInput.select();
                    } else {
                        // 마지막 필드에서 Enter 시 계산 실행
                        this.calculate();
                    }
                }
            });
            
            // 숫자 입력 필드에서 포커스 시 전체 선택
            if (input.type === 'number') {
                input.addEventListener('focus', () => {
                    input.select();
                });
            }
        });
    }
    
    copyODtoOS() {
        const fields = [
            'sph', 'cyl', 'axis', 'cct', 'k1', 'k2', 'steep-axis', 'topography',
            'optical-zone', 'lasik-flap', 'lasek-epi', 'smile-cap'
        ];
        fields.forEach(field => {
            const odValue = document.getElementById(`od-${field}`)?.value;
            const osInput = document.getElementById(`os-${field}`);
            if (odValue !== undefined && osInput) {
                osInput.value = odValue;
            }
        });
        this.updateSE('os');
    }
    
    updateSE(eye) {
        const sph = parseFloat(document.getElementById(`${eye}-sph`)?.value) || 0;
        const cyl = parseFloat(document.getElementById(`${eye}-cyl`)?.value) || 0;
        const se = calculateSE(sph, cyl);
        const seDisplay = document.getElementById(`${eye}-se-display`);
        if (seDisplay) {
            seDisplay.textContent = `${se.toFixed(2)} D`;
        }
    }
    
    getFormData() {
        const formData = new FormData(this.form);
        const common = {
            patientName: formData.get('patient-name') || '',
            patientId: formData.get('patient-id') || '',
            age: parseInt(formData.get('age')),
            gender: formData.get('gender')
        };
        
        return {
            common,
            od: {
                eye: 'OD',
                sph: parseFloat(formData.get('od-sph')),
                cyl: parseFloat(formData.get('od-cyl')),
                axis: parseInt(formData.get('od-axis')),
                cct: parseInt(formData.get('od-cct')),
                acd: parseFloat(formData.get('od-acd')) || 3.2,
                wtw: parseFloat(formData.get('od-wtw')) || 11.8,
                ecd: parseInt(formData.get('od-ecd')) || 2800,
                k1: parseFloat(formData.get('od-k1')),
                k2: parseFloat(formData.get('od-k2')),
                steepAxis: parseInt(formData.get('od-steep-axis')),
                topography: formData.get('od-topography'),
                opticalZone: parseFloat(formData.get('od-optical-zone')),
                lasikFlap: parseInt(formData.get('od-lasik-flap')),
                lasekEpi: parseInt(formData.get('od-lasek-epi')),
                smileCap: parseInt(formData.get('od-smile-cap')),
                ...common
            },
            os: {
                eye: 'OS',
                sph: parseFloat(formData.get('os-sph')),
                cyl: parseFloat(formData.get('os-cyl')),
                axis: parseInt(formData.get('os-axis')),
                cct: parseInt(formData.get('os-cct')),
                acd: parseFloat(formData.get('os-acd')) || 3.15,
                wtw: parseFloat(formData.get('os-wtw')) || 11.7,
                ecd: parseInt(formData.get('os-ecd')) || 2750,
                k1: parseFloat(formData.get('os-k1')),
                k2: parseFloat(formData.get('os-k2')),
                steepAxis: parseInt(formData.get('os-steep-axis')),
                topography: formData.get('os-topography'),
                opticalZone: parseFloat(formData.get('os-optical-zone')),
                lasikFlap: parseInt(formData.get('os-lasik-flap')),
                lasekEpi: parseInt(formData.get('os-lasek-epi')),
                smileCap: parseInt(formData.get('os-smile-cap')),
                ...common
            }
        };
    }
    
    calculateForEye(data) {
        const se = calculateSE(data.sph, data.cyl);
        const totalCorrection = calculateTotalCorrection(data.sph, data.cyl);
        const ablationDepth = calculateAblationDepth(totalCorrection, data.opticalZone);
        
        const surgeryResults = {
            lasik: {
                name: 'LASIK',
                flapThickness: data.lasikFlap,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasikFlap, ablationDepth),
                pta: calculatePTA(data.cct, data.lasikFlap, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasik')
            },
            lasek: {
                name: 'LASEK/PRK',
                flapThickness: data.lasekEpi,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasekEpi, ablationDepth),
                pta: calculatePTA(data.cct, data.lasekEpi, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasek')
            },
            smile: {
                name: 'SMILE',
                flapThickness: data.smileCap,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.smileCap, ablationDepth),
                pta: calculatePTA(data.cct, data.smileCap, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasik')
            }
        };
        
        // ICL Eligibility Assessment
        const iclResult = evaluateICLEligibility({
            age: data.age,
            se: se,
            cyl: data.cyl,
            acd: data.acd,
            wtw: data.wtw,
            ecd: data.ecd,
            topography: data.topography
        });
        
        const preopK = Math.min(data.k1, data.k2);
        const postopK = calculatePostopK(data.k1, data.k2, data.sph, data.cyl);
        
        const erssResult = calculateERSS({
            age: data.age,
            cct: data.cct,
            topography: data.topography,
            rsb: surgeryResults.lasik.rsb,
            mrse: se
        });
        
        Object.keys(surgeryResults).forEach(key => {
            const result = surgeryResults[key];
            if (key === 'smile') {
                result.eligibility = { status: 'pending', message: '준비중' };
            } else {
                result.eligibility = determineSurgeryEligibility(
                    result.rsb,
                    result.pta,
                    data.topography,
                    erssResult.total
                );
            }
        });
        
        const nomogramRecommendations = getWellingtonNomogramAdjustments(
            data.sph,
            data.cyl,
            data.age
        );
        
        const combinedRiskInterpretation = getCombinedRiskInterpretation(
            erssResult.total,
            surgeryResults.lasik.pta,
            data.topography
        );
        
        const combinedRiskGuide = generateCombinedRiskGuide(
            erssResult,
            surgeryResults.lasik.pta,
            surgeryResults.lasek.pta,
            data.topography
        );
        
        return {
            surgeryResults,
            preopK,
            postopK,
            erssResult,
            nomogramRecommendations,
            combinedRiskInterpretation,
            combinedRiskGuide,
            iclResult,
            se,
            data
        };
    }
    
    calculate() {
        const formData = this.getFormData();
        
        // 양안 각각 계산
        this.results = {
            od: this.calculateForEye(formData.od),
            os: this.calculateForEye(formData.os)
        };
        
        this.renderResults();
    }
    
    renderResults() {
        const template = this.resultsTemplate.content.cloneNode(true);
        
        // 양안 탭 이벤트 설정
        const eyeTabs = template.querySelectorAll('.eye-tab');
        eyeTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const eye = e.currentTarget.dataset.eye;
                this.switchEyeTab(eye);
            });
        });
        
        // 양안 각각 렌더링
        ['od', 'os'].forEach(eye => {
            this.renderEyeResults(template, eye, this.results[eye]);
        });
        
        this.resultsContainer.innerHTML = '';
        this.resultsContainer.appendChild(template);
        
        this.setupActionButtons();
    }
    
    renderEyeResults(template, eye, results) {
        // Summary cards - including ICL
        ['lasik', 'lasek', 'smile', 'icl'].forEach(key => {
            const summaryItem = template.querySelector(`#summary-${key}-${eye}`);
            if (summaryItem) {
                if (key === 'icl') {
                    // ICL summary
                    const iclResult = results.iclResult;
                    summaryItem.classList.add(iclResult.status);
                    summaryItem.querySelector('.surgery-status').textContent = iclResult.statusMessage;
                } else {
                    const result = results.surgeryResults[key];
                    summaryItem.classList.add(result.eligibility.status);
                    summaryItem.querySelector('.surgery-status').textContent = result.eligibility.message;
                }
            }
        });
        
        // Render ICL Assessment
        renderICLAssessment(`icl-assessment-${eye}`, results.iclResult);
        
        // Ablation table
        const tableBody = template.querySelector(`#ablation-table-body-${eye}`);
        if (tableBody) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                const row = document.createElement('tr');
                
                // Ablation risk class
                let ablationClass = 'success';
                if (result.ablationRisk) {
                    if (result.ablationRisk.level === 'caution') ablationClass = 'warning';
                    if (result.ablationRisk.level === 'danger') ablationClass = 'danger';
                }
                
                let rsbClass = 'success';
                if (result.rsb < CONFIG.RSB_WARNING_THRESHOLD) rsbClass = 'warning';
                if (result.rsb < CONFIG.RSB_DANGER_THRESHOLD) rsbClass = 'danger';
                
                let ptaClass = 'success';
                if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) ptaClass = 'warning';
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) ptaClass = 'danger';
                
                const ablationIcon = result.ablationRisk ? result.ablationRisk.icon : '';
                
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td class="${ablationClass}" title="${result.ablationRisk ? result.ablationRisk.detail : ''}">${ablationIcon} ${result.ablationDepth.toFixed(1)}</td>
                    <td class="${rsbClass}">${result.rsb.toFixed(1)}</td>
                    <td class="${ptaClass}">${result.pta.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add ablation warning message if needed
            const lasikRisk = results.surgeryResults.lasik?.ablationRisk;
            const lasekRisk = results.surgeryResults.lasek?.ablationRisk;
            
            if ((lasikRisk && lasikRisk.level !== 'safe') || (lasekRisk && lasekRisk.level !== 'safe')) {
                const warningRow = document.createElement('tr');
                warningRow.className = 'ablation-warning-row';
                const riskToShow = lasikRisk?.level === 'danger' ? lasikRisk : 
                                   lasekRisk?.level === 'danger' ? lasekRisk :
                                   lasikRisk?.level === 'caution' ? lasikRisk : lasekRisk;
                warningRow.innerHTML = `
                    <td colspan="4" class="${riskToShow.class}" style="font-size: 0.75rem; padding: 8px;">
                        ${riskToShow.icon} <strong>${riskToShow.message}</strong>: ${riskToShow.detail}
                    </td>
                `;
                tableBody.appendChild(warningRow);
            }
        }
        
        // K values
        const preopK = template.querySelector(`#preop-k-${eye}`);
        const postopK = template.querySelector(`#postop-k-${eye}`);
        if (preopK) preopK.textContent = `${results.preopK.toFixed(2)} D`;
        if (postopK) postopK.textContent = `${results.postopK.toFixed(2)} D`;
        
        // K warning
        const kWarning = template.querySelector(`#k-warning-${eye}`);
        if (kWarning) {
            if (results.postopK < CONFIG.K_OPTIMAL_MIN) {
                kWarning.textContent = `⚠️ 수술 후 각막이 과도하게 편평해질 수 있습니다 (K < ${CONFIG.K_OPTIMAL_MIN}D).`;
                kWarning.classList.add('warning');
            } else if (results.postopK < CONFIG.K_MIN_SAFE) {
                kWarning.textContent = `❌ 수술 후 각막 굴절력이 너무 낮습니다 (K < ${CONFIG.K_MIN_SAFE}D).`;
                kWarning.classList.add('warning');
            } else {
                kWarning.textContent = `✓ 수술 후 예상 K값이 안전 범위 내에 있습니다.`;
            }
        }
        
        // ERSS breakdown
        const erssBreakdown = template.querySelector(`#erss-breakdown-${eye}`);
        if (erssBreakdown) {
            const labels = {
                topography: 'Topography',
                rsb: 'RSB',
                age: 'Age',
                cct: 'CCT',
                mrse: 'MRSE'
            };
            
            Object.entries(results.erssResult.breakdown).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'erss-item';
                item.innerHTML = `
                    <span class="erss-item-label">${labels[key]}</span>
                    <span class="erss-item-score">${value}</span>
                `;
                erssBreakdown.appendChild(item);
            });
        }
        
        // ERSS total
        const erssTotal = template.querySelector(`#erss-total-score-${eye}`);
        if (erssTotal) erssTotal.textContent = results.erssResult.total;
        
        const riskLevel = template.querySelector(`#erss-risk-level-${eye}`);
        if (riskLevel) {
            riskLevel.textContent = results.erssResult.riskLevel === 'low' ? 'Low Risk' :
                results.erssResult.riskLevel === 'moderate' ? 'Moderate Risk' : 'High Risk';
            riskLevel.classList.add(results.erssResult.riskLevel);
        }
        
        // PTA display
        const ptaDisplay = template.querySelector(`#pta-display-${eye}`);
        if (ptaDisplay) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                let ptaClass = 'safe';
                let ptaStatus = '안전';
                
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) {
                    ptaClass = 'danger';
                    ptaStatus = '위험';
                } else if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) {
                    ptaClass = 'caution';
                    ptaStatus = '주의';
                }
                
                const item = document.createElement('div');
                item.className = `pta-item ${ptaClass}`;
                item.innerHTML = `
                    <div class="pta-surgery">${result.name}</div>
                    <div class="pta-value">${result.pta.toFixed(1)}%</div>
                    <div class="pta-status">${ptaStatus}</div>
                `;
                ptaDisplay.appendChild(item);
            });
        }
        
        // Combined risk matrix
        this.renderCombinedRiskMatrix(template, eye, results);
        
        // Nomogram info
        const nomogramInfo = template.querySelector(`#nomogram-info-${eye}`);
        if (nomogramInfo) {
            results.nomogramRecommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'nomogram-item';
                item.innerHTML = `
                    <div class="nomogram-title">${rec.title}</div>
                    <div class="nomogram-text">${rec.text}</div>
                `;
                nomogramInfo.appendChild(item);
            });
        }
    }
    
    renderCombinedRiskMatrix(template, eye, results) {
        const interpretation = results.combinedRiskInterpretation;
        const lasikPta = results.surgeryResults.lasik.pta;
        const erssScore = results.erssResult.total;
        
        const matrixContainer = template.querySelector(`#combined-risk-matrix-${eye}`);
        if (matrixContainer) {
            const matrixHTML = `
                <div class="matrix-cell matrix-header"></div>
                <div class="matrix-cell matrix-header">PTA &lt;35%<br>(저위험)</div>
                <div class="matrix-cell matrix-header">PTA 35-40%<br>(중등위험)</div>
                <div class="matrix-cell matrix-header">PTA ≥40%<br>(고위험)</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 0-2<br>(저위험)</div>
                <div class="matrix-cell risk-low ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'low')}">저위험</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'moderate')}">저-중등</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'high')}">중등위험</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 3<br>(중등위험)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'low')}">저-중등</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'moderate')}">중등위험</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'high')}">고위험</div>
                
                <div class="matrix-cell matrix-row-header">ERSS ≥4<br>(고위험)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'low')}">중등위험</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'moderate')}">고위험</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'high')}">매우 고위험</div>
            `;
            matrixContainer.innerHTML = matrixHTML;
        }
        
        const guideContainer = template.querySelector(`#interpretation-guide-${eye}`);
        if (guideContainer && interpretation) {
            let badgeClass = 'low';
            if (interpretation.level === 'moderate' || interpretation.level === 'low-moderate') {
                badgeClass = 'moderate';
            } else if (interpretation.level === 'high' || interpretation.level === 'very-high') {
                badgeClass = 'high';
            }
            
            const recommendationsHTML = interpretation.recommendations
                .map(rec => `<li>${rec}</li>`)
                .join('');
            
            guideContainer.innerHTML = `
                <div class="interpretation-title">
                    ${interpretation.title}
                    <span class="interpretation-badge ${badgeClass}">
                        ERSS ${erssScore}점 + PTA ${lasikPta.toFixed(1)}%
                    </span>
                </div>
                <div class="interpretation-text">${interpretation.text}</div>
                <div class="interpretation-recommendations">
                    <h5>권장 사항</h5>
                    <ul class="recommendation-list">
                        ${recommendationsHTML}
                    </ul>
                </div>
            `;
        }
    }
    
    getMatrixHighlight(erssScore, pta, erssLevel, ptaLevel) {
        let currentErssLevel;
        if (erssScore <= 2) currentErssLevel = 'low';
        else if (erssScore === 3) currentErssLevel = 'moderate';
        else currentErssLevel = 'high';
        
        let currentPtaLevel;
        if (pta < 35) currentPtaLevel = 'low';
        else if (pta < 40) currentPtaLevel = 'moderate';
        else currentPtaLevel = 'high';
        
        if (currentErssLevel === erssLevel && currentPtaLevel === ptaLevel) {
            return 'current-position';
        }
        return '';
    }
    
    switchEyeTab(eye) {
        this.currentEye = eye;
        
        // 탭 버튼 상태 업데이트
        document.querySelectorAll('.eye-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.eye === eye);
        });
        
        // 결과 콘텐츠 표시/숨김
        document.querySelectorAll('.eye-results-content').forEach(content => {
            content.classList.toggle('active', content.id === `results-${eye}`);
        });
    }
    
    setupActionButtons() {
        document.getElementById('btn-print')?.addEventListener('click', () => {
            printPatientReport();
        });
        
        document.getElementById('btn-save')?.addEventListener('click', () => {
            this.saveResults();
        });
        
        document.getElementById('btn-new')?.addEventListener('click', () => {
            this.form.reset();
            this.resultsContainer.innerHTML = `
                <div class="results-placeholder">
                    <div class="placeholder-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                            <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <p>환자 정보를 입력하고<br><strong>계산하기</strong> 버튼을 클릭하세요</p>
                </div>
            `;
            this.updateSE('od');
            this.updateSE('os');
        });
    }
    
    saveResults() {
        const formData = this.getFormData();
        const results = this.results;
        
        // Use enhanced save function
        const savedPatient = savePatientData(formData, results);
        
        showNotification(`${savedPatient.patientName || savedPatient.patientId || '환자'} 데이터가 저장되었습니다.`, 'success');
        console.log('Saved patient:', savedPatient);
    }
    
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }
    
    loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Show login screen initially
    showLoginScreen();
    
    // Initialize calculator
    window.calculator = new RefractiveCalculator();
    new TopographyAnalyzer();
    
    // Check for Firebase auth state (if Firebase is configured)
    if (!DEMO_MODE && typeof auth !== 'undefined') {
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserApprovalFirebase(user.email).then(approved => {
                    if (approved || user.email === ADMIN_EMAIL) {
                        currentUser = user;
                        updateAuthUI();
                    }
                });
            }
        });
    }
});
    </script>
</body>
</html>