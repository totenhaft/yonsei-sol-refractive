<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬ | Refractive Surgery Eligibility Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ============================================
   Refractive Surgery Eligibility Checker
   Medical-Grade Professional UI
   ============================================ */

:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --bg-accent: #e0f2fe;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    --text-inverse: #ffffff;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-focus: #0ea5e9;
    --accent-primary: #0284c7;
    --accent-secondary: #0ea5e9;
    --accent-light: #e0f2fe;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --info: #2563eb;
    --info-light: #dbeafe;
    --font-sans: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'JetBrains Mono', 'Consolas', monospace;
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-accent: #0c4a6e;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --text-inverse: #0f172a;
    --border-light: #334155;
    --border-medium: #475569;
    --border-focus: #38bdf8;
    --accent-primary: #38bdf8;
    --accent-secondary: #0ea5e9;
    --accent-light: #0c4a6e;
    --success-light: #064e3b;
    --warning-light: #78350f;
    --danger-light: #7f1d1d;
    --info-light: #1e3a8a;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    padding: var(--space-md) var(--space-xl);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
}

.header-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.logo-icon {
    width: 40px;
    height: 40px;
    color: var(--accent-primary);
}

.logo-text h1 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.02em;
}

.logo-text .subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-weight: 400;
}

.btn-icon {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.btn-icon:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-icon svg {
    width: 20px;
    height: 20px;
}

.icon-moon { display: none; }
[data-theme="dark"] .icon-sun { display: none; }
[data-theme="dark"] .icon-moon { display: block; }

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding: var(--space-md);
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

.panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* Input panel - full width, compact */
.input-panel {
    width: 100%;
}

.input-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
}

.input-panel .panel-header h2 {
    font-size: 1rem;
}

.input-panel .form-grid {
    padding: var(--space-sm) var(--space-md);
    gap: var(--space-sm);
}

/* Results panel */
.results-panel {
    width: 100%;
}

.results-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    user-select: none;
}

.results-panel .panel-header:hover {
    background: var(--bg-tertiary);
}

.results-panel .panel-header h2 {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.results-panel .panel-header h2::before {
    content: 'â–¼';
    font-size: 0.625rem;
    transition: transform var(--transition-fast);
}

.results-panel.collapsed .panel-header h2::before {
    transform: rotate(-90deg);
}

.results-panel.collapsed .results-container {
    display: none;
}

.panel-header {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, var(--bg-accent), transparent);
}

.panel-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.panel-badge {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--accent-primary);
    background: var(--accent-light);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.form-grid {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    overflow-y: auto;
    flex: 1;
}

.form-section {
    padding: var(--space-lg);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

.section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
}

.section-icon { font-size: 1rem; }

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.form-row.triple { grid-template-columns: repeat(3, 1fr); }

@media (max-width: 600px) {
    .form-row, .form-row.triple { grid-template-columns: 1fr; }
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.form-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-group input,
.form-group select {
    height: 44px;
    padding: 0 var(--space-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 1rem;
    font-family: var(--font-mono);
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-light);
}

.form-group input::-webkit-inner-spin-button { opacity: 1; }

.calculated-field {
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px dashed var(--border-medium);
}

.calc-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.btn-primary {
    height: 52px;
    padding: 0 var(--space-xl);
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: var(--text-inverse);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
    height: 44px;
    padding: 0 var(--space-lg);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
}

.btn-secondary:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-focus);
}

.btn-secondary svg {
    width: 18px;
    height: 18px;
}

.btn-calculate { margin-top: var(--space-md); }

.results-container {
    flex: 1;
    padding: var(--space-xl);
    overflow-y: auto;
}

.results-placeholder {
    height: 100%;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-tertiary);
}

.placeholder-icon {
    width: 80px;
    height: 80px;
    margin-bottom: var(--space-lg);
    opacity: 0.5;
}

.placeholder-icon svg {
    width: 100%;
    height: 100%;
}

.results-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.card-header {
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: var(--font-mono);
}

.summary-card {
    background: linear-gradient(135deg, var(--accent-light), var(--bg-tertiary));
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    padding: var(--space-lg);
}

.summary-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    transition: all var(--transition-fast);
}

.summary-item.eligible {
    border-color: var(--success);
    background: var(--success-light);
}

.summary-item.caution {
    border-color: var(--warning);
    background: var(--warning-light);
}

.summary-item.not-eligible {
    border-color: var(--danger);
    background: var(--danger-light);
}

.summary-item.pending {
    border-color: var(--text-tertiary);
    background: var(--bg-tertiary);
}

.summary-item.pending .surgery-status {
    color: var(--text-tertiary);
}

.surgery-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
}

.surgery-status { font-size: 0.8125rem; font-weight: 500; }
.summary-item.eligible .surgery-status { color: var(--success); }
.summary-item.caution .surgery-status { color: var(--warning); }
.summary-item.not-eligible .surgery-status { color: var(--danger); }

.table-container {
    padding: var(--space-md);
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table th,
.data-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.data-table th {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    font-family: var(--font-mono);
    color: var(--text-primary);
}

.data-table tbody tr:hover { background: var(--bg-secondary); }
.data-table .warning { color: var(--warning); font-weight: 600; }
.data-table .danger { color: var(--danger); font-weight: 600; }
.data-table .success { color: var(--success); font-weight: 600; }

.k-values-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-xl);
}

.k-value-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    min-width: 140px;
}

.k-value-item.highlight {
    background: var(--accent-light);
    border: 2px solid var(--accent-primary);
}

.k-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.k-value {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.k-arrow {
    font-size: 1.5rem;
    color: var(--accent-primary);
}

.k-note {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-align: center;
    border-top: 1px solid var(--border-light);
}

.k-note.warning {
    background: var(--warning-light);
    color: var(--warning);
}

.risk-section {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-light);
}

.risk-section:last-child { border-bottom: none; }

.risk-section h4 {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}

.erss-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.erss-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
}

.erss-item-label { color: var(--text-secondary); }

.erss-item-score {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--text-primary);
}

.erss-total {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.erss-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.erss-score {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.erss-risk-level {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.erss-risk-level.low { background: var(--success-light); color: var(--success); }
.erss-risk-level.moderate { background: var(--warning-light); color: var(--warning); }
.erss-risk-level.high { background: var(--danger-light); color: var(--danger); }

.pta-display {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.pta-item {
    text-align: center;
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
}

.pta-item.safe { border-color: var(--success); }
.pta-item.caution { border-color: var(--warning); }
.pta-item.danger { border-color: var(--danger); }

.pta-surgery {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.pta-value {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
}

.pta-item.safe .pta-value { color: var(--success); }
.pta-item.caution .pta-value { color: var(--warning); }
.pta-item.danger .pta-value { color: var(--danger); }

.pta-status {
    font-size: 0.6875rem;
    margin-top: var(--space-xs);
}

.nomogram-info { padding: var(--space-lg); }

.nomogram-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--accent-primary);
    margin-bottom: var(--space-sm);
}

.nomogram-item:last-child { margin-bottom: 0; }

.nomogram-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.nomogram-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.erss-note {
    margin-top: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--warning-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--warning);
}

.combined-risk-guide {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.risk-guide-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--border-light);
}

.risk-guide-item.low-risk {
    border-left-color: var(--success);
    background: var(--success-light);
}

.risk-guide-item.moderate-risk {
    border-left-color: var(--warning);
    background: var(--warning-light);
}

.risk-guide-item.high-risk {
    border-left-color: var(--danger);
    background: var(--danger-light);
}

.risk-guide-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

.risk-guide-icon {
    font-size: 1.25rem;
}

.risk-guide-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.risk-guide-condition {
    font-size: 0.75rem;
    font-family: var(--font-mono);
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    display: inline-block;
}

.risk-guide-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.risk-guide-recommendation {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px dashed var(--border-light);
    font-size: 0.8125rem;
    font-weight: 500;
}

.risk-guide-item.low-risk .risk-guide-recommendation {
    color: var(--success);
}

.risk-guide-item.moderate-risk .risk-guide-recommendation {
    color: var(--warning);
}

.risk-guide-item.high-risk .risk-guide-recommendation {
    color: var(--danger);
}

/* Combined Risk Interpretation */
.combined-risk-section {
    padding: var(--space-lg);
}

.combined-risk-matrix {
    display: grid;
    grid-template-columns: auto repeat(3, 1fr);
    gap: 2px;
    margin-bottom: var(--space-lg);
    background: var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.matrix-cell {
    padding: var(--space-sm) var(--space-md);
    text-align: center;
    font-size: 0.75rem;
    background: var(--bg-secondary);
}

.matrix-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.matrix-row-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    text-align: left;
}

.matrix-cell.risk-low {
    background: var(--success-light);
    color: var(--success);
    font-weight: 500;
}

.matrix-cell.risk-moderate {
    background: var(--warning-light);
    color: var(--warning);
    font-weight: 500;
}

.matrix-cell.risk-high {
    background: var(--danger-light);
    color: var(--danger);
    font-weight: 500;
}

.matrix-cell.current-position {
    outline: 3px solid var(--accent-primary);
    outline-offset: -3px;
    font-weight: 700;
}

.interpretation-guide {
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.interpretation-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.interpretation-badge {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 600;
}

.interpretation-badge.low {
    background: var(--success-light);
    color: var(--success);
}

.interpretation-badge.moderate {
    background: var(--warning-light);
    color: var(--warning);
}

.interpretation-badge.high {
    background: var(--danger-light);
    color: var(--danger);
}

.interpretation-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.interpretation-recommendations {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.interpretation-recommendations h5 {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.recommendation-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recommendation-list li {
    font-size: 0.8125rem;
    color: var(--text-primary);
    padding: var(--space-xs) 0;
    padding-left: var(--space-lg);
    position: relative;
}

.recommendation-list li::before {
    content: "â†’";
    position: absolute;
    left: 0;
    color: var(--accent-primary);
}

.clinical-note {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--info-light);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--info);
}

.note-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.note-content {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.note-content strong {
    color: var(--text-primary);
}

.reference {
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    font-style: italic;
}

.result-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.footer {
    padding: var(--space-lg) var(--space-xl);
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-light);
    text-align: center;
}

.footer p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.footer-small {
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

@media print {
    .header, .footer, .input-panel, .result-actions { display: none; }
    .main-content { display: block; }
    .results-panel { box-shadow: none; border: none; }
    .result-card { break-inside: avoid; margin-bottom: 1rem; }
}

@media (max-width: 768px) {
    .header { padding: var(--space-sm) var(--space-md); }
    .main-content { padding: var(--space-md); gap: var(--space-md); }
    .panel-header { padding: var(--space-md); }
    .form-grid { padding: var(--space-md); }
    .summary-grid { grid-template-columns: 1fr; }
    .pta-display { grid-template-columns: 1fr; }
    .k-values-display { flex-direction: column; gap: var(--space-md); }
    .k-arrow { transform: rotate(90deg); }
    .result-actions { flex-direction: column; }
    .result-actions button { width: 100%; }
    .eye-panels { flex-direction: column; }
}

/* Bilateral Eye Input Styles */
.eye-panels-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

@media (max-width: 800px) {
    .eye-panels-container {
        grid-template-columns: 1fr;
    }
}

.eye-panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    overflow: visible;
}

.eye-panel.right-eye {
    border-color: #3b82f6;
}

.eye-panel.left-eye {
    border-color: #22c55e;
}

.eye-panel-header {
    padding: var(--space-xs) var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-weight: 600;
    font-size: 0.875rem;
}

.eye-panel.right-eye .eye-panel-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.eye-panel.left-eye .eye-panel-header {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.eye-icon {
    font-size: 0.875rem;
}

.eye-panel-content {
    padding: var(--space-sm) var(--space-md);
}

.eye-panel .form-section {
    padding: 0;
    margin-bottom: var(--space-sm);
    border: none;
    background: transparent;
}

.eye-panel .form-section:last-child {
    margin-bottom: 0;
}

.eye-panel .section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: var(--space-xs) 0;
    margin-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

/* Compact form layout for eye panels */
.form-row-compact {
    display: flex;
    gap: 4px;
    margin-bottom: 4px;
    flex-wrap: nowrap;
}

.form-group.compact {
    flex: 1;
    min-width: 45px;
}

.form-group.compact label {
    font-size: 0.5625rem;
    margin-bottom: 1px;
    display: block;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.input-with-unit {
    display: flex;
    align-items: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.input-with-unit input {
    flex: 1;
    border: none;
    padding: 4px 6px;
    font-size: 0.75rem;
    min-width: 0;
    background: transparent;
    font-family: var(--font-mono);
}

.input-with-unit input:focus {
    outline: none;
    box-shadow: none;
}

.input-with-unit:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15);
}

.input-with-unit .unit {
    padding: 4px 4px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    font-size: 0.5625rem;
    font-family: var(--font-mono);
    border-left: 1px solid var(--border-light);
    white-space: nowrap;
}

.select-compact {
    padding: 4px 6px;
    font-size: 0.75rem;
    width: 100%;
}

.eye-panel select {
    padding: 4px 6px;
    font-size: 0.75rem;
}

/* Four column layout for patient info */
.form-row.four-col {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr 1fr;
    gap: var(--space-md);
}

@media (max-width: 768px) {
    .form-row.four-col {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Patient info section */
.patient-info-section {
    background: var(--bg-accent);
    border: 1px solid var(--accent-primary);
    padding: var(--space-sm) var(--space-md);
}

.patient-info-section .shared-section-title {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

.patient-info-section .form-row {
    gap: var(--space-sm);
}

.patient-info-section input,
.patient-info-section select {
    padding: 6px 8px;
    font-size: 0.8125rem;
}

/* Calculated field */
.calculated-field {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px var(--space-xs);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: 2px;
}

.calc-label {
    font-size: 0.625rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
}

/* Form actions */
.form-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: var(--space-sm);
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.form-actions .tabindex-hint {
    margin: 0;
    font-size: 0.6875rem;
}

.btn-calculate {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.875rem;
}

/* AI Analysis Section Styles */
.ai-analysis-section {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    border: 1px solid #6366f1;
    color: white;
    padding: var(--space-sm) var(--space-md);
}

[data-theme="light"] .ai-analysis-section {
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    border-color: #a5b4fc;
    color: var(--text-primary);
}

.ai-analysis-section .shared-section-title {
    color: white;
    border-bottom-color: rgba(255,255,255,0.2);
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

[data-theme="light"] .ai-analysis-section .shared-section-title {
    color: #4338ca;
    border-bottom-color: #c7d2fe;
}

.beta-badge {
    font-size: 0.5rem;
    padding: 1px 4px;
    background: #f59e0b;
    color: #000;
    border-radius: 3px;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin-left: var(--space-xs);
}

.section-description {
    font-size: 0.6875rem;
    color: rgba(255,255,255,0.8);
    margin-bottom: var(--space-sm);
}

[data-theme="light"] .section-description {
    color: #6366f1;
}

.ai-analysis-panels {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

@media (max-width: 800px) {
    .ai-analysis-panels {
        grid-template-columns: 1fr;
    }
}

.ai-panel {
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

[data-theme="light"] .ai-panel {
    background: white;
    border: 1px solid #c7d2fe;
}

.ai-panel.right-eye .ai-panel-header {
    background: rgba(59, 130, 246, 0.3);
    border-left: 3px solid #3b82f6;
}

.ai-panel.left-eye .ai-panel-header {
    background: rgba(34, 197, 94, 0.3);
    border-left: 3px solid #22c55e;
}

[data-theme="light"] .ai-panel.right-eye .ai-panel-header {
    background: #dbeafe;
}

[data-theme="light"] .ai-panel.left-eye .ai-panel-header {
    background: #dcfce7;
}

.ai-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    font-weight: 600;
    font-size: 0.75rem;
}

.ai-panel-content {
    padding: var(--space-sm);
}

.topo-textarea {
    width: 100%;
    min-height: 80px;
    padding: var(--space-xs);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius-sm);
    background: rgba(0,0,0,0.2);
    color: white;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    resize: vertical;
    margin-bottom: var(--space-xs);
}

[data-theme="light"] .topo-textarea {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: var(--text-primary);
}

.topo-textarea::placeholder {
    color: rgba(255,255,255,0.5);
    font-size: 0.5625rem;
}

[data-theme="light"] .topo-textarea::placeholder {
    color: #94a3b8;
}

.topo-textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}

.btn-analyze {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-analyze:hover:not(:disabled) {
    background: #4f46e5;
}

.btn-analyze:disabled {
    background: #475569;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-analyze.analyzing {
    background: #f59e0b;
}

.btn-analyze.analyzing .analyze-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.ai-result {
    min-height: 60px;
    padding: var(--space-xs);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result {
    background: #f1f5f9;
}

.ai-result-placeholder {
    color: rgba(255,255,255,0.5);
    text-align: center;
    padding: var(--space-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result-placeholder {
    color: #94a3b8;
}

.ai-result-content {
    color: white;
}

[data-theme="light"] .ai-result-content {
    color: var(--text-primary);
}

.ai-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-result-header {
    border-bottom-color: #e2e8f0;
}

.ai-classification {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.6875rem;
}

.ai-classification.normal {
    background: var(--success-light);
    color: var(--success);
}

.ai-classification.suspect {
    background: var(--warning-light);
    color: var(--warning);
}

.ai-classification.abnormal {
    background: var(--danger-light);
    color: var(--danger);
}

.ai-confidence {
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.6);
}

[data-theme="light"] .ai-confidence {
    color: var(--text-tertiary);
}

.ai-findings {
    margin-top: var(--space-xs);
}

.ai-finding-item {
    display: flex;
    align-items: flex-start;
    gap: 2px;
    padding: 1px 0;
    font-size: 0.625rem;
    line-height: 1.3;
}

.finding-icon {
    flex-shrink: 0;
    font-size: 0.625rem;
}

.ai-indices {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px;
    margin-top: var(--space-xs);
    padding-top: var(--space-xs);
    border-top: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-indices {
    border-top-color: #e2e8f0;
}

.ai-index-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.5625rem;
    padding: 1px 2px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
}

[data-theme="light"] .ai-index-item {
    background: #e2e8f0;
}

.ai-index-label {
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-index-label {
    color: var(--text-secondary);
}

.ai-index-value {
    font-family: var(--font-mono);
    font-weight: 600;
}

.ai-index-value.normal { color: var(--success); }
.ai-index-value.warning { color: var(--warning); }
.ai-index-value.danger { color: var(--danger); }

.ai-disclaimer {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-disclaimer {
    background: #fef3c7;
    color: #92400e;
}

.disclaimer-icon {
    flex-shrink: 0;
}

.copy-button {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.copy-button:hover {
    background: var(--accent-light);
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.shared-section {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-sm);
}

.shared-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--accent-primary);
}

.eye-se-display {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-family: var(--font-mono);
}

.eye-se-display.right { color: #3b82f6; }
.eye-se-display.left { color: #22c55e; }

/* Eye Tab Results Styles */
.eye-tabs {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
}

.eye-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
}

.eye-tab:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.eye-tab.active {
    background: var(--bg-secondary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

.eye-tab.right-tab.active {
    border-left: 3px solid #3b82f6;
}

.eye-tab.left-tab.active {
    border-left: 3px solid #22c55e;
}

.eye-results-content {
    display: none;
}

.eye-results-content.active {
    display: block;
}

/* Focus/Keyboard navigation styles */
.tabindex-hint {
    display: block;
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

input:focus, select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-overlay.active { display: flex; }
.modal {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
.modal.modal-lg { max-width: 600px; }
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-light);
}
.modal-header h3 { margin: 0; font-size: 1rem; }
.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--text-secondary);
}
.modal-body { padding: var(--space-md); }
.login-error {
    color: var(--danger);
    font-size: 0.75rem;
    margin-bottom: var(--space-sm);
    min-height: 1rem;
}
.demo-notice {
    margin-top: var(--space-md);
    padding: var(--space-sm);
    background: var(--warning-light);
    color: var(--warning);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    text-align: center;
}
.search-box {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}
.search-box input { flex: 1; }
.search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-md);
}
.search-placeholder {
    padding: var(--space-lg);
    text-align: center;
    color: var(--text-tertiary);
    font-size: 0.8125rem;
}
.search-result-item {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background var(--transition-fast);
}
.search-result-item:hover { background: var(--bg-tertiary); }
.search-result-item:last-child { border-bottom: none; }
.search-result-name { font-weight: 600; font-size: 0.875rem; }
.search-result-info { font-size: 0.6875rem; color: var(--text-secondary); }
.recent-patients h4 {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    color: var(--text-secondary);
}
#recent-patients-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}
.recent-patient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
}
.recent-patient-item:hover { background: var(--border-light); }

/* User info in header */
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.user-email {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.btn-logout {
    padding: 2px 8px;
    font-size: 0.625rem;
    background: var(--danger-light);
    color: var(--danger);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
}

/* Header buttons */
.header-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--text-primary);
    transition: all var(--transition-fast);
}
.header-btn:hover {
    background: var(--accent-light);
    border-color: var(--accent-primary);
}

/* Logo image style */
.logo-img {
    height: 40px;
    width: auto;
}

/* Login Screen (Full Page) */
.login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #0c4a6e 0%, #0369a1 50%, #0284c7 100%);
    padding: var(--space-lg);
}

.login-box {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    padding: var(--space-2xl);
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-logo {
    margin-bottom: var(--space-lg);
}

.login-logo img {
    height: 80px;
    width: auto;
    margin-bottom: var(--space-md);
}

.login-logo h1 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.login-logo p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.login-box .form-group {
    text-align: left;
    margin-bottom: var(--space-md);
}

.login-box .form-group label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
    color: var(--text-primary);
}

.login-box .form-group input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-size: 1rem;
}

.login-box .form-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15);
}

.login-box .btn-login {
    width: 100%;
    padding: var(--space-md);
    background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-top: var(--space-md);
}

.login-box .btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -10px rgba(2, 132, 199, 0.5);
}

.login-error-msg {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: var(--space-sm);
    min-height: 1.25rem;
}

.login-footer {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-light);
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

/* Hide app when not logged in */
.app-container {
    display: none;
}

.app-container.logged-in {
    display: flex;
}

.login-screen.hidden {
    display: none;
}

/* Print Styles */
@media print {
    html, body {
        height: auto !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    body * {
        visibility: hidden;
    }
    
    .print-container, .print-container * {
        visibility: visible;
    }
    
    .print-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 210mm;
        padding: 8mm;
        background: white;
        overflow: visible !important;
        height: auto !important;
    }
    
    .no-print, .login-screen, .app-container, .modal-overlay {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    @page {
        size: A4;
        margin: 10mm;
    }
}

.print-container {
    font-family: var(--font-sans);
    font-size: 9pt;
    line-height: 1.4;
    color: #000;
    background: white;
}

.print-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #0284c7;
    padding-bottom: 8px;
    margin-bottom: 12px;
}

.print-header h1 {
    font-size: 14pt;
    color: #0284c7;
    margin: 0;
}

.print-header .clinic-name {
    font-size: 10pt;
    color: #666;
}

.print-patient-info {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    background: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 12px;
}

.print-patient-info .info-item {
    display: flex;
    flex-direction: column;
}

.print-patient-info .info-label {
    font-size: 7pt;
    color: #666;
}

.print-patient-info .info-value {
    font-size: 9pt;
    font-weight: 600;
}

.print-eye-section {
    margin-bottom: 12px;
}

.print-eye-title {
    font-size: 11pt;
    font-weight: 700;
    padding: 4px 8px;
    margin-bottom: 8px;
    border-radius: 4px;
}

.print-eye-title.od {
    background: #dbeafe;
    color: #1e40af;
}

.print-eye-title.os {
    background: #dcfce7;
    color: #166534;
}

.print-data-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.print-data-box {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 6px;
}

.print-data-box h4 {
    font-size: 8pt;
    color: #666;
    margin: 0 0 4px 0;
    padding-bottom: 4px;
    border-bottom: 1px solid #eee;
}

.print-data-row {
    display: flex;
    justify-content: space-between;
    font-size: 8pt;
    padding: 2px 0;
}

.print-data-row .label {
    color: #666;
}

.print-data-row .value {
    font-weight: 600;
    font-family: var(--font-mono);
}

.print-data-row .value.safe { color: #059669; }
.print-data-row .value.warning { color: #d97706; }
.print-data-row .value.danger { color: #dc2626; }

.print-surgery-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8pt;
    margin-top: 4px;
}

.print-surgery-table th,
.print-surgery-table td {
    border: 1px solid #ddd;
    padding: 4px;
    text-align: center;
}

.print-surgery-table th {
    background: #f5f5f5;
    font-weight: 600;
}

.print-surgery-table .eligible { background: #dcfce7; color: #166534; }
.print-surgery-table .caution { background: #fef3c7; color: #92400e; }
.print-surgery-table .not-eligible { background: #fee2e2; color: #991b1b; }

.print-risk-section {
    margin-top: 8px;
    padding: 8px;
    background: #fafafa;
    border-radius: 4px;
}

.print-risk-title {
    font-size: 9pt;
    font-weight: 600;
    margin-bottom: 6px;
}

.print-risk-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.print-risk-item {
    text-align: center;
    padding: 6px;
    border-radius: 4px;
}

.print-risk-item.low { background: #dcfce7; }
.print-risk-item.moderate { background: #fef3c7; }
.print-risk-item.high { background: #fee2e2; }

.print-risk-item .risk-label {
    font-size: 7pt;
    color: #666;
}

.print-risk-item .risk-value {
    font-size: 11pt;
    font-weight: 700;
}

.print-footer {
    margin-top: 8px;
    padding-top: 6px;
    border-top: 1px solid #ddd;
    font-size: 7pt;
    color: #999;
    text-align: center;
}

.print-disclaimer {
    background: #fff3cd;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 6pt;
    color: #856404;
    margin-top: 6px;
}

/* New Print Layout - Side by Side */
.print-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.print-eye-column {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
}

.print-eye-column.od {
    border-color: #3b82f6;
}

.print-eye-column.os {
    border-color: #22c55e;
}

.print-section-title {
    font-size: 8pt;
    font-weight: 600;
    color: #666;
    margin: 6px 0 4px 0;
    padding-bottom: 2px;
    border-bottom: 1px solid #eee;
}

.print-compact-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 7pt;
    margin-bottom: 6px;
}

.print-compact-table th,
.print-compact-table td {
    border: 1px solid #ddd;
    padding: 2px 4px;
    text-align: center;
}

.print-compact-table th {
    background: #f5f5f5;
    font-weight: 600;
}

.print-mini-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    margin-bottom: 6px;
}

.print-mini-item {
    display: flex;
    justify-content: space-between;
    font-size: 7pt;
    padding: 2px 4px;
    background: #f9f9f9;
    border-radius: 2px;
}

.print-mini-item .label {
    color: #666;
}

.print-mini-item .value {
    font-weight: 600;
    font-family: var(--font-mono);
}

.print-risk-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 7pt;
    font-weight: 600;
    margin: 2px;
}

.print-risk-badge.low { background: #dcfce7; color: #166534; }
.print-risk-badge.moderate { background: #fef3c7; color: #92400e; }
.print-risk-badge.high { background: #fee2e2; color: #991b1b; }

/* Google Login Button */
.btn-google {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    width: 100%;
    padding: var(--space-md);
    background: white;
    color: #444;
    border: 1px solid #ddd;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-md);
}

.btn-google:hover {
    background: #f5f5f5;
    border-color: #ccc;
}

.btn-google svg {
    width: 20px;
    height: 20px;
}

.login-divider {
    display: flex;
    align-items: center;
    margin: var(--space-md) 0;
    color: var(--text-tertiary);
    font-size: 0.75rem;
}

.login-divider::before,
.login-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-light);
}

.login-divider span {
    padding: 0 var(--space-md);
}

/* Login Tabs */
.login-tabs {
    display: flex;
    margin-bottom: var(--space-lg);
    border-bottom: 2px solid var(--border-light);
}

.login-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    background: none;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--transition-fast);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.login-tab.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
}

.login-tab:hover:not(.active) {
    color: var(--text-secondary);
}

.login-form-container {
    display: none;
}

.login-form-container.active {
    display: block;
}

.signup-notice {
    background: var(--info-light);
    color: var(--info);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-bottom: var(--space-md);
    text-align: center;
}

.pending-notice {
    background: var(--warning-light);
    color: var(--warning);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    text-align: center;
}

.pending-notice h3 {
    margin: 0 0 var(--space-sm) 0;
    font-size: 1rem;
}

.pending-notice p {
    margin: 0;
    font-size: 0.875rem;
}

/* ============================================
   EX500 Nomogram Calculator Styles
   ============================================ */

.nomogram-panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    margin-top: var(--space-md);
}

.nomogram-panel .panel-header {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    padding: var(--space-md) var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nomogram-panel .panel-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
}

.nomogram-panel .panel-badge {
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.nomogram-container {
    padding: var(--space-lg);
}

.nomogram-input-section {
    margin-bottom: var(--space-lg);
}

.nomogram-eye-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
}

@media (max-width: 768px) {
    .nomogram-eye-panels {
        grid-template-columns: 1fr;
    }
}

.nomogram-eye-panel {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    border: 2px solid transparent;
}

.nomogram-eye-panel.od {
    border-color: #3b82f6;
}

.nomogram-eye-panel.os {
    border-color: #22c55e;
}

.nomogram-eye-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
    font-weight: 600;
    font-size: 1rem;
}

.nomogram-eye-panel.od .nomogram-eye-header span {
    color: #3b82f6;
}

.nomogram-eye-panel.os .nomogram-eye-header span {
    color: #22c55e;
}

.btn-copy-from-main {
    background: var(--bg-secondary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-sm);
    padding: 4px 10px;
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
}

.btn-copy-from-main:hover {
    background: var(--accent-light);
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.nomogram-input-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
}

.nomogram-input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.nomogram-input-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.nomogram-input-group .input-with-unit input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    background: var(--bg-secondary);
}

.nomogram-input-group select {
    padding: 8px 10px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    background: var(--bg-secondary);
    cursor: pointer;
}

.nomogram-common-settings {
    display: flex;
    gap: var(--space-md);
    align-items: flex-end;
    flex-wrap: wrap;
    background: var(--bg-accent);
    padding: var(--space-md);
    border-radius: var(--radius-md);
}

.nomogram-common-settings .nomogram-input-group {
    flex: 1;
    min-width: 150px;
}

.btn-calculate-nomogram {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.btn-calculate-nomogram:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
}

.nomogram-results-section {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    min-height: 300px;
}

.nomogram-results-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--text-tertiary);
    text-align: center;
}

.nomogram-results-placeholder .placeholder-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
}

/* Nomogram 결과 카드 */
.nomogram-result-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
}

@media (max-width: 768px) {
    .nomogram-result-cards {
        grid-template-columns: 1fr;
    }
}

.nomogram-result-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    border: 2px solid transparent;
}

.nomogram-result-card.od {
    border-color: #3b82f6;
}

.nomogram-result-card.os {
    border-color: #22c55e;
}

.nomogram-result-header {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nomogram-result-card.od .nomogram-result-header {
    color: #3b82f6;
}

.nomogram-result-card.os .nomogram-result-header {
    color: #22c55e;
}

.nomogram-mode-badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 12px;
    background: var(--accent-light);
    color: var(--accent-primary);
}

.nomogram-warning {
    background: var(--warning-light);
    color: var(--warning);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.nomogram-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    margin-bottom: var(--space-md);
}

.nomogram-table th,
.nomogram-table td {
    padding: 10px 8px;
    text-align: center;
    border: 1px solid var(--border-light);
}

.nomogram-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.nomogram-table .highlight {
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    font-weight: 700;
}

.nomogram-table .value-changed {
    color: #7c3aed;
    font-weight: 700;
}

.nomogram-table .value-unchanged {
    color: var(--text-tertiary);
}

.nomogram-age-adjustment {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    margin-top: var(--space-sm);
}

.nomogram-age-adjustment .age-label {
    font-weight: 600;
    color: var(--accent-primary);
}

.nomogram-seq-check {
    background: var(--success-light);
    color: var(--success);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-sm);
}

.nomogram-seq-check.error {
    background: var(--danger-light);
    color: var(--danger);
}

.nomogram-actions {
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: center;
}

.btn-print-nomogram {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-print-nomogram:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
}

.btn-print-nomogram:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Nomogram 인쇄 스타일 */
.nomogram-print-container {
    font-family: var(--font-sans);
    font-size: 10pt;
    color: #000;
    background: white;
    padding: 15mm;
    max-width: 210mm;
}

.nomogram-print-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid #7c3aed;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.nomogram-print-header h1 {
    font-size: 16pt;
    color: #7c3aed;
    margin: 0;
}

.nomogram-print-header .clinic-info {
    text-align: right;
    font-size: 9pt;
    color: #666;
}

.nomogram-print-patient {
    background: #f5f5f5;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: flex;
    gap: 30px;
}

.nomogram-print-patient .info-item {
    display: flex;
    gap: 8px;
}

.nomogram-print-patient .label {
    color: #666;
    font-size: 9pt;
}

.nomogram-print-patient .value {
    font-weight: 600;
}

.nomogram-print-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.nomogram-print-eye {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px;
}

.nomogram-print-eye.od {
    border-color: #3b82f6;
}

.nomogram-print-eye.os {
    border-color: #22c55e;
}

.nomogram-print-eye h3 {
    margin: 0 0 15px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.nomogram-print-eye.od h3 {
    color: #3b82f6;
}

.nomogram-print-eye.os h3 {
    color: #22c55e;
}

.nomogram-print-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 9pt;
    margin-bottom: 15px;
}

.nomogram-print-table th,
.nomogram-print-table td {
    padding: 6px 8px;
    border: 1px solid #ddd;
    text-align: center;
}

.nomogram-print-table th {
    background: #f5f5f5;
    font-weight: 600;
}

.nomogram-print-table .modified {
    background: #ede9fe;
    font-weight: 700;
    color: #7c3aed;
}

.nomogram-print-notes {
    background: #f0f9ff;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 8pt;
    color: #0369a1;
    margin-top: 10px;
}

.nomogram-print-footer {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    font-size: 8pt;
    color: #999;
    text-align: center;
}

.nomogram-print-disclaimer {
    background: #fff3cd;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 7pt;
    color: #856404;
    margin-top: 10px;
}
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ (ë©”ì¸) -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <img src="logo.jpg" alt="ì—°ì„¸ì†”ì•ˆê³¼" onerror="this.style.display='none'">
                <h1>ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬</h1>
                <p>ì—°ì„¸ì†”ì•ˆê³¼ YONSEI SOL EYE CLINIC</p>
            </div>
            
            <!-- ë¡œê·¸ì¸/íšŒì›ê°€ìž… íƒ­ -->
            <div class="login-tabs">
                <button type="button" class="login-tab active" onclick="switchLoginTab('login')">ë¡œê·¸ì¸</button>
                <button type="button" class="login-tab" onclick="switchLoginTab('signup')">íšŒì›ê°€ìž…</button>
            </div>
            
            <!-- ë¡œê·¸ì¸ í¼ -->
            <div class="login-form-container active" id="login-form-container">
                <!-- êµ¬ê¸€ ë¡œê·¸ì¸ -->
                <button type="button" class="btn-google" onclick="handleGoogleLogin()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
                
                <div class="login-divider"><span>ë˜ëŠ” ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</span></div>
                
                <form onsubmit="handleLogin(); return false;">
                    <div class="form-group">
                        <label for="login-email">ì´ë©”ì¼</label>
                        <input type="email" id="login-email" placeholder="example@yonsei-sol.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥" required>
                    </div>
                    <div class="login-error-msg" id="login-error"></div>
                    <button type="submit" class="btn-login">ðŸ” ë¡œê·¸ì¸</button>
                </form>
            </div>
            
            <!-- íšŒì›ê°€ìž… í¼ -->
            <div class="login-form-container" id="signup-form-container">
                <div class="signup-notice">
                    â„¹ï¸ íšŒì›ê°€ìž… í›„ ê´€ë¦¬ìž ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                    ìŠ¹ì¸ ì™„ë£Œ ì‹œ ì´ë©”ì¼ë¡œ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.
                </div>
                
                <!-- êµ¬ê¸€ë¡œ íšŒì›ê°€ìž… -->
                <button type="button" class="btn-google" onclick="handleGoogleSignup()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google ê³„ì •ìœ¼ë¡œ íšŒì›ê°€ìž…
                </button>
                
                <div class="login-divider"><span>ë˜ëŠ” ì´ë©”ì¼ë¡œ íšŒì›ê°€ìž…</span></div>
                
                <form onsubmit="handleSignup(); return false;">
                    <div class="form-group">
                        <label for="signup-name">ì´ë¦„</label>
                        <input type="text" id="signup-name" placeholder="í™ê¸¸ë™" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">ì´ë©”ì¼</label>
                        <input type="email" id="signup-email" placeholder="example@yonsei-sol.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="signup-password" placeholder="6ìž ì´ìƒ" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="signup-password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ ìž¬ìž…ë ¥" required>
                    </div>
                    <div class="login-error-msg" id="signup-error"></div>
                    <button type="submit" class="btn-login">ðŸ“ íšŒì›ê°€ìž… ì‹ ì²­</button>
                </form>
            </div>
            
            <!-- ìŠ¹ì¸ ëŒ€ê¸° í™”ë©´ -->
            <div class="login-form-container" id="pending-form-container">
                <div class="pending-notice">
                    <h3>â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</h3>
                    <p>íšŒì›ê°€ìž… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ìž ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <p style="margin-top:10px;font-size:0.75rem;color:#666;">
                        ë¬¸ì˜: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="04706b70616a6c656270446369656d682a676b69">[email&#160;protected]</a>
                    </p>
                </div>
                <button type="button" class="btn-login" style="margin-top:var(--space-md);" onclick="switchLoginTab('login')">
                    ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
            
            <div class="login-footer">
                Â© 2024 ì—°ì„¸ì†”ì•ˆê³¼. All rights reserved.<br>
                ê´€ë¦¬ìž ë¬¸ì˜: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="11657e65747f7970776551767c70787d3f727e7c">[email&#160;protected]</a>
            </div>
        </div>
    </div>

    <!-- í™˜ìž ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>ðŸ” í™˜ìž ê²€ìƒ‰</h3>
                <button class="modal-close" onclick="toggleModal('search-modal', false)">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="í™˜ìž ì´ë¦„ ë˜ëŠ” ë“±ë¡ë²ˆí˜¸ ìž…ë ¥..." onkeyup="if(event.key==='Enter')searchPatients()">
                    <button class="btn-primary" onclick="searchPatients()">ê²€ìƒ‰</button>
                </div>
                <div class="search-results" id="search-results">
                    <div class="search-placeholder">í™˜ìž ì´ë¦„ ë˜ëŠ” ë“±ë¡ë²ˆí˜¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <div class="recent-patients">
                    <h4>ðŸ“‹ ìµœê·¼ í™˜ìž</h4>
                    <div id="recent-patients-list">
                        <div class="search-placeholder">ì €ìž¥ëœ í™˜ìžê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¸ì‡„ ì»¨í…Œì´ë„ˆ -->
    <div id="print-container" class="print-container" style="display:none;"></div>

    <div class="app-container" id="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.jpg" alt="ì—°ì„¸ì†”ì•ˆê³¼" class="logo-img" onerror="this.style.display='none'">
                    <div class="logo-text">
                        <h1>ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬</h1>
                        <span class="subtitle">ì—°ì„¸ì†”ì•ˆê³¼ YONSEI SOL EYE CLINIC</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="toggleModal('search-modal', true)" title="í™˜ìž ê²€ìƒ‰">
                        ðŸ” í™˜ìž ê²€ìƒ‰
                    </button>
                    <div id="auth-container">
                        <button class="header-btn" onclick="toggleModal('login-modal', true)" id="login-btn">
                            ðŸ” ë¡œê·¸ì¸
                        </button>
                    </div>
                    <button class="btn-icon" id="theme-toggle" title="í…Œë§ˆ ë³€ê²½">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section class="panel input-panel">
                <div class="panel-header">
                    <h2>í™˜ìž ì •ë³´ ìž…ë ¥</h2>
                    <span class="panel-badge">Patient Data (OD/OS)</span>
                </div>
                
                <form id="patient-form" class="form-grid">
                    <!-- í™˜ìž ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
                    <div class="shared-section patient-info-section">
                        <div class="shared-section-title">
                            <span>ðŸ‘¤</span>
                            í™˜ìž ì •ë³´
                        </div>
                        <div class="form-row four-col">
                            <div class="form-group">
                                <label for="patient-name">í™˜ìž ì´ë¦„</label>
                                <input type="text" id="patient-name" name="patient-name" placeholder="í™ê¸¸ë™" tabindex="1">
                            </div>
                            <div class="form-group">
                                <label for="patient-id">ë“±ë¡ë²ˆí˜¸</label>
                                <input type="text" id="patient-id" name="patient-id" placeholder="12345678" tabindex="2">
                            </div>
                            <div class="form-group">
                                <label for="age">ë‚˜ì´ (ì„¸)</label>
                                <input type="number" id="age" name="age" min="18" max="80" value="25" required tabindex="3">
                            </div>
                            <div class="form-group">
                                <label for="gender">ì„±ë³„</label>
                                <select id="gender" name="gender" tabindex="4">
                                    <option value="male">ë‚¨ì„±</option>
                                    <option value="female">ì—¬ì„±</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ì–‘ì•ˆ ìž…ë ¥ íŒ¨ë„ -->
                    <div class="eye-panels-container">
                        <!-- ìš°ì•ˆ (OD) -->
                        <div class="eye-panel right-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">ðŸ‘ï¸</span>
                                ìš°ì•ˆ (OD)
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">êµ´ì ˆ ê²€ì‚¬</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-sph" name="od-sph" step="0.25" min="-20" max="10" value="-3.00" required tabindex="10">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cyl" name="od-cyl" step="0.25" min="-6" max="0" value="-1.00" required tabindex="11">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-axis" name="od-axis" min="1" max="180" value="180" required tabindex="12">
                                                <span class="unit">Â°</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display right" id="od-se-display">-3.50 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ê°ë§‰ ê²€ì‚¬</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cct" name="od-cct" min="400" max="700" value="540" required tabindex="13">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k1" name="od-k1" step="0.01" min="35" max="50" value="43.00" required tabindex="14">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k2" name="od-k2" step="0.01" min="35" max="50" value="44.00" required tabindex="15">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-steep-axis" name="od-steep-axis" min="1" max="180" value="90" tabindex="16">
                                                <span class="unit">Â°</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="od-topography" name="od-topography" tabindex="17">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ìˆ˜ìˆ  íŒŒë¼ë¯¸í„°</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-optical-zone">OZ</label>
                                            <select id="od-optical-zone" name="od-optical-zone" tabindex="18" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasik-flap" name="od-lasik-flap" min="80" max="160" value="90" tabindex="19">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasek-epi" name="od-lasek-epi" min="40" max="80" value="55" tabindex="20">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-smile-cap" name="od-smile-cap" min="100" max="160" value="120" tabindex="21">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì¢Œì•ˆ (OS) -->
                        <div class="eye-panel left-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">ðŸ‘ï¸</span>
                                ì¢Œì•ˆ (OS)
                                <button type="button" class="copy-button" id="copy-od-to-os" style="margin-left: auto;">
                                    â† OD ë³µì‚¬
                                </button>
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">êµ´ì ˆ ê²€ì‚¬</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-sph" name="os-sph" step="0.25" min="-20" max="10" value="-3.25" required tabindex="30">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cyl" name="os-cyl" step="0.25" min="-6" max="0" value="-0.75" required tabindex="31">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-axis" name="os-axis" min="1" max="180" value="175" required tabindex="32">
                                                <span class="unit">Â°</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display left" id="os-se-display">-3.63 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ê°ë§‰ ê²€ì‚¬</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cct" name="os-cct" min="400" max="700" value="535" required tabindex="33">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k1" name="os-k1" step="0.01" min="35" max="50" value="43.25" required tabindex="34">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k2" name="os-k2" step="0.01" min="35" max="50" value="44.25" required tabindex="35">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-steep-axis" name="os-steep-axis" min="1" max="180" value="85" tabindex="36">
                                                <span class="unit">Â°</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="os-topography" name="os-topography" tabindex="37">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ìˆ˜ìˆ  íŒŒë¼ë¯¸í„°</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-optical-zone">OZ</label>
                                            <select id="os-optical-zone" name="os-optical-zone" tabindex="38" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasik-flap" name="os-lasik-flap" min="80" max="160" value="90" tabindex="39">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasek-epi" name="os-lasek-epi" min="40" max="80" value="55" tabindex="40">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-smile-cap" name="os-smile-cap" min="100" max="160" value="120" tabindex="41">
                                                <span class="unit">Î¼m</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Topography ë¶„ì„ ì„¹ì…˜ -->
                    <div class="shared-section ai-analysis-section">
                        <div class="shared-section-title">
                            <span>ðŸ¤–</span>
                            AI ê°ë§‰ ì§€í˜•ë„ ë¶„ì„
                            <span class="beta-badge">BETA</span>
                        </div>
                        <p class="section-description">
                            Galilei G4, Pentacam, Orbscan ë“±ì˜ ê²€ì‚¬ ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ AIê°€ ìžë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
                        </p>
                        
                        <div class="ai-analysis-panels">
                            <!-- ìš°ì•ˆ AI ë¶„ì„ -->
                            <div class="ai-panel right-eye">
                                <div class="ai-panel-header">
                                    <span>ðŸ‘ï¸ OD</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-od" disabled>
                                        <span class="analyze-icon">ðŸ”</span> ë¶„ì„
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="od-topo-data" 
                                        name="od-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 ë˜ëŠ” Pentacam ê²°ê³¼ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”...

ì˜ˆì‹œ ë°ì´í„°:
- Sim K: 43.5 @ 180 / 44.2 @ 90
- TCT: 512 Î¼m
- Thinnest: 508 Î¼m at (0.2, -0.3)
- BAD-D: 1.2
- I-S: 0.8
- KISA: 32%
- Posterior Elevation: 12 Î¼m
..."
                                        tabindex="22"
                                    ></textarea>
                                    <div class="ai-result" id="od-ai-result">
                                        <div class="ai-result-placeholder">
                                            ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ì¢Œì•ˆ AI ë¶„ì„ -->
                            <div class="ai-panel left-eye">
                                <div class="ai-panel-header">
                                    <span>ðŸ‘ï¸ OS</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-os" disabled>
                                        <span class="analyze-icon">ðŸ”</span> ë¶„ì„
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="os-topo-data" 
                                        name="os-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 ë˜ëŠ” Pentacam ê²°ê³¼ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”..."
                                        tabindex="42"
                                    ></textarea>
                                    <div class="ai-result" id="os-ai-result">
                                        <div class="ai-result-placeholder">
                                            ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ai-disclaimer">
                            <span class="disclaimer-icon">âš ï¸</span>
                            <span>AI ë¶„ì„ì€ ì°¸ê³ ìš©ì´ë©°, ìµœì¢… íŒë‹¨ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ê°€ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤. 
                            ì§€ì› ìž¥ë¹„: Galilei G4, Pentacam, Orbscan, Topcon, Nidek OPD</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <span class="tabindex-hint">ðŸ’¡ Tab í‚¤ ë˜ëŠ” Enter í‚¤ë¡œ ë‹¤ìŒ ìž…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™</span>
                        <button type="submit" class="btn-primary btn-calculate" tabindex="50">
                            <span class="btn-text">ì–‘ì•ˆ ê³„ì‚°í•˜ê¸°</span>
                            <span class="btn-icon-right">â†’</span>
                        </button>
                    </div>
                </form>
            </section>

            <section class="panel results-panel" id="results-panel">
                <div class="panel-header" onclick="document.getElementById('results-panel').classList.toggle('collapsed')">
                    <h2>ê²€ì‚¬ ê²°ê³¼</h2>
                    <span class="panel-badge">Results (OD/OS)</span>
                </div>

                <div id="results-container" class="results-container">
                    <div class="results-placeholder">
                        <div class="placeholder-icon">
                            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                                <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <p>í™˜ìž ì •ë³´ë¥¼ ìž…ë ¥í•˜ê³ <br><strong>ì–‘ì•ˆ ê³„ì‚°í•˜ê¸°</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </section>

            <!-- EX500 Nomogram Calculator Section -->
            <section class="panel nomogram-panel" id="nomogram-panel">
                <div class="panel-header">
                    <h2>🎯 EX500 Nomogram Calculator</h2>
                    <span class="panel-badge">Alcon WaveLight EX500</span>
                </div>

                <div class="nomogram-container">
                    <!-- Nomogram 입력 섹션 -->
                    <div class="nomogram-input-section">
                        <div class="nomogram-eye-panels">
                            <!-- 우안 입력 -->
                            <div class="nomogram-eye-panel od">
                                <div class="nomogram-eye-header">
                                    <span>👁️ 우안 (OD)</span>
                                    <button type="button" class="btn-copy-from-main" onclick="copyFromMainForm('od')">
                                        ↑ 메인 폼에서 복사
                                    </button>
                                </div>
                                <div class="nomogram-input-grid">
                                    <div class="nomogram-input-group">
                                        <label>Manifest SPH</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-od-sph" step="0.25" value="-3.00">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Manifest CYL</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-od-cyl" step="0.25" value="-1.00">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Manifest AXIS</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-od-axis" min="1" max="180" value="180">
                                            <span class="unit">°</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Measured CYL (Topolyzer)</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-od-measured-cyl" step="0.25" value="-1.25">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Measured AXIS</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-od-measured-axis" min="1" max="180" value="178">
                                            <span class="unit">°</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 좌안 입력 -->
                            <div class="nomogram-eye-panel os">
                                <div class="nomogram-eye-header">
                                    <span>👁️ 좌안 (OS)</span>
                                    <button type="button" class="btn-copy-from-main" onclick="copyFromMainForm('os')">
                                        ↑ 메인 폼에서 복사
                                    </button>
                                </div>
                                <div class="nomogram-input-grid">
                                    <div class="nomogram-input-group">
                                        <label>Manifest SPH</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-os-sph" step="0.25" value="-3.25">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Manifest CYL</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-os-cyl" step="0.25" value="-0.75">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Manifest AXIS</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-os-axis" min="1" max="180" value="175">
                                            <span class="unit">°</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Measured CYL (Topolyzer)</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-os-measured-cyl" step="0.25" value="-1.00">
                                            <span class="unit">D</span>
                                        </div>
                                    </div>
                                    <div class="nomogram-input-group">
                                        <label>Measured AXIS</label>
                                        <div class="input-with-unit">
                                            <input type="number" id="nomo-os-measured-axis" min="1" max="180" value="173">
                                            <span class="unit">°</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 공통 설정 -->
                        <div class="nomogram-common-settings">
                            <div class="nomogram-input-group">
                                <label>환자 나이</label>
                                <div class="input-with-unit">
                                    <input type="number" id="nomo-age" min="18" max="80" value="25">
                                    <span class="unit">세</span>
                                </div>
                            </div>
                            <div class="nomogram-input-group">
                                <label>수술 모드</label>
                                <select id="nomo-mode">
                                    <option value="streamlight">Streamlight / CustomQ (WFO)</option>
                                    <option value="contoura">Contoura Vision (TG)</option>
                                </select>
                            </div>
                            <button type="button" class="btn-calculate-nomogram" onclick="calculateNomogram()">
                                🎯 Nomogram 계산
                            </button>
                        </div>
                    </div>

                    <!-- Nomogram 결과 섹션 -->
                    <div class="nomogram-results-section" id="nomogram-results">
                        <div class="nomogram-results-placeholder">
                            <div class="placeholder-icon">🎯</div>
                            <p>Manifest 값과 Measured 값을 입력하고<br><strong>Nomogram 계산</strong> 버튼을 클릭하세요</p>
                        </div>
                    </div>
                </div>

                <!-- Nomogram 출력 버튼 -->
                <div class="nomogram-actions">
                    <button type="button" class="btn-print-nomogram" onclick="printNomogramReport()" id="btn-print-nomogram" disabled>
                        🖨️ Nomogram 결과 출력
                    </button>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>âš ï¸ ë³¸ í”„ë¡œê·¸ëž¨ì€ ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ìˆ˜ìˆ  ê²°ì •ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
            <p class="footer-small">Munnerlyn's Formula ê¸°ë°˜ | Randleman ERSS & PTA í‰ê°€</p>
        </footer>
    </div>

    <template id="results-template">
        <div class="results-content">
            <!-- ì–‘ì•ˆ íƒ­ -->
            <div class="eye-tabs">
                <button type="button" class="eye-tab right-tab active" data-eye="od">
                    <span>ðŸ‘ï¸</span> ìš°ì•ˆ (OD)
                </button>
                <button type="button" class="eye-tab left-tab" data-eye="os">
                    <span>ðŸ‘ï¸</span> ì¢Œì•ˆ (OS)
                </button>
            </div>

            <!-- ìš°ì•ˆ ê²°ê³¼ -->
            <div class="eye-results-content active" id="results-od">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>ìš°ì•ˆ (OD) ì¢…í•© í‰ê°€</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-od">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-od">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-od">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ì ˆì‚­ëŸ‰ ë° ìž”ì—¬ê°ë§‰ (OD)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>ìˆ˜ìˆ </th><th>ì ˆì‚­ëŸ‰</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-od"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ìˆ˜ìˆ  í›„ ì˜ˆìƒ Kê°’ (OD)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">ìˆ˜ìˆ  ì „</span>
                            <span class="k-value" id="preop-k-od"></span>
                        </div>
                        <div class="k-arrow">â†’</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">ìˆ˜ìˆ  í›„</span>
                            <span class="k-value" id="postop-k-od"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-od"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ìœ„í—˜ë„ í‰ê°€ (OD)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-od"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-od"></span>
                            <span class="erss-risk-level" id="erss-risk-level-od"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ë³µí•© ìœ„í—˜ë„ í•´ì„ (OD)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-od"></div>
                        <div class="interpretation-guide" id="interpretation-guide-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram ê¶Œìž¥ (OD)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-od"></div>
                </div>
            </div>

            <!-- ì¢Œì•ˆ ê²°ê³¼ -->
            <div class="eye-results-content" id="results-os">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>ì¢Œì•ˆ (OS) ì¢…í•© í‰ê°€</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-os">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-os">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-os">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ì ˆì‚­ëŸ‰ ë° ìž”ì—¬ê°ë§‰ (OS)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>ìˆ˜ìˆ </th><th>ì ˆì‚­ëŸ‰</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-os"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ìˆ˜ìˆ  í›„ ì˜ˆìƒ Kê°’ (OS)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">ìˆ˜ìˆ  ì „</span>
                            <span class="k-value" id="preop-k-os"></span>
                        </div>
                        <div class="k-arrow">â†’</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">ìˆ˜ìˆ  í›„</span>
                            <span class="k-value" id="postop-k-os"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-os"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ìœ„í—˜ë„ í‰ê°€ (OS)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-os"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-os"></span>
                            <span class="erss-risk-level" id="erss-risk-level-os"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ë³µí•© ìœ„í—˜ë„ í•´ì„ (OS)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-os"></div>
                        <div class="interpretation-guide" id="interpretation-guide-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram ê¶Œìž¥ (OS)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-os"></div>
                </div>
            </div>

            <div class="clinical-note" style="margin-top: var(--space-lg);">
                <div class="note-icon">â„¹ï¸</div>
                <div class="note-content">
                    <strong>ì°¸ê³ :</strong> ERSSëŠ” ë³´ìˆ˜ì  í‰ê°€ ê²½í–¥ì´ ìžˆìŠµë‹ˆë‹¤. PTAëŠ” ì •ìƒ Topographyì—ì„œ ë” ê°•í•œ ì˜ˆì¸¡ë ¥ì„ ë³´ìž…ë‹ˆë‹¤.
                    <span class="reference">(Santhiago et al., Chan et al. 2018)</span>
                </div>
            </div>

            <div class="result-actions">
                <button class="btn-secondary" id="btn-print">ðŸ–¨ï¸ ì¸ì‡„</button>
                <button class="btn-secondary" id="btn-save">ðŸ’¾ ì €ìž¥</button>
                <button class="btn-primary" id="btn-new">ðŸ”„ ìƒˆ ê²€ì‚¬</button>
            </div>
        </div>
    </template>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============================================
// ì—°ì„¸ì†”ì•ˆê³¼ ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬
// Firebase & Authentication Module
// ============================================

// Demo mode flag (set to false when Firebase is configured)
const DEMO_MODE = true;
const LOCAL_STORAGE_KEY = 'yonsei_sol_patients';
const PENDING_USERS_KEY = 'yonsei_sol_pending_users';
const APPROVED_USERS_KEY = 'yonsei_sol_approved_users';
const ADMIN_EMAIL = 'totenhaft@gmail.com';

// Current user state
let currentUser = null;

// Switch login/signup tabs
function switchLoginTab(tab) {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.login-form-container').forEach(f => f.classList.remove('active'));
    
    if (tab === 'login') {
        document.querySelector('.login-tab:first-child').classList.add('active');
        document.getElementById('login-form-container').classList.add('active');
    } else if (tab === 'signup') {
        document.querySelector('.login-tab:last-child').classList.add('active');
        document.getElementById('signup-form-container').classList.add('active');
    } else if (tab === 'pending') {
        document.getElementById('pending-form-container').classList.add('active');
    }
}

// Show/hide login screen
function showLoginScreen() {
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app-container').classList.remove('logged-in');
}

function hideLoginScreen() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-container').classList.add('logged-in');
}

// Update auth UI based on login state
function updateAuthUI() {
    const authContainer = document.getElementById('auth-container');
    if (!authContainer) return;
    
    if (currentUser) {
        hideLoginScreen();
        authContainer.innerHTML = `
            <div class="user-info">
                <span class="user-email">${currentUser.email}</span>
                <button class="btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        `;
    } else {
        showLoginScreen();
        authContainer.innerHTML = `
            <button class="header-btn" onclick="showLoginScreen()" id="login-btn">
                ðŸ” ë¡œê·¸ì¸
            </button>
        `;
    }
}

// Check if user is approved
function isUserApproved(email) {
    // Admin is always approved
    if (email === ADMIN_EMAIL) return true;
    
    const approvedUsers = JSON.parse(localStorage.getItem(APPROVED_USERS_KEY) || '[]');
    return approvedUsers.includes(email.toLowerCase());
}

// Check if user is pending
function isUserPending(email) {
    const pendingUsers = JSON.parse(localStorage.getItem(PENDING_USERS_KEY) || '[]');
    return pendingUsers.some(u => u.email.toLowerCase() === email.toLowerCase());
}

// Add user to pending list
function addPendingUser(name, email) {
    const pendingUsers = JSON.parse(localStorage.getItem(PENDING_USERS_KEY) || '[]');
    if (!pendingUsers.some(u => u.email.toLowerCase() === email.toLowerCase())) {
        pendingUsers.push({
            name: name,
            email: email.toLowerCase(),
            requestedAt: new Date().toISOString()
        });
        localStorage.setItem(PENDING_USERS_KEY, JSON.stringify(pendingUsers));
    }
}

// Modal toggle function
function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (show) {
            modal.classList.add('active');
            if (modalId === 'search-modal') {
                loadRecentPatients();
            }
        } else {
            modal.classList.remove('active');
        }
    }
}

// Close modal when clicking overlay
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
    }
});

// Handle email login
function handleLogin() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorDiv = document.getElementById('login-error');
    
    if (!email || !password) {
        errorDiv.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”.';
        return;
    }
    
    if (DEMO_MODE) {
        // Demo mode: check approval status
        if (!isUserApproved(email) && email !== ADMIN_EMAIL) {
            if (isUserPending(email)) {
                errorDiv.textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤. ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
            } else {
                errorDiv.textContent = 'ë“±ë¡ë˜ì§€ ì•Šì€ ê³„ì •ìž…ë‹ˆë‹¤. íšŒì›ê°€ìž…ì„ í•´ì£¼ì„¸ìš”.';
            }
            return;
        }
        currentUser = { email: email };
        updateAuthUI();
        showNotification('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
    } else {
        // Firebase authentication
        if (typeof auth !== 'undefined') {
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Check if approved
                    return checkUserApprovalFirebase(userCredential.user.email)
                        .then(approved => {
                            if (approved || userCredential.user.email === ADMIN_EMAIL) {
                                currentUser = userCredential.user;
                                updateAuthUI();
                                showNotification('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                            } else {
                                auth.signOut();
                                errorDiv.textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤. ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    if (error.code === 'auth/user-not-found') {
                        errorDiv.textContent = 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ìž…ë‹ˆë‹¤.';
                    } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        errorDiv.textContent = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    } else {
                        errorDiv.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
                    }
                });
        } else {
            errorDiv.textContent = 'Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
    }
}

// Handle Google login
function handleGoogleLogin() {
    if (DEMO_MODE) {
        const email = prompt('ë°ëª¨ ëª¨ë“œ: Google ë¡œê·¸ì¸ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.\nì´ë©”ì¼ì„ ìž…ë ¥í•˜ì„¸ìš”:');
        if (email) {
            if (!isUserApproved(email) && email !== ADMIN_EMAIL) {
                if (isUserPending(email)) {
                    document.getElementById('login-error').textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤.';
                } else {
                    document.getElementById('login-error').textContent = 'ë“±ë¡ë˜ì§€ ì•Šì€ ê³„ì •ìž…ë‹ˆë‹¤.';
                }
                return;
            }
            currentUser = { email: email };
            updateAuthUI();
            showNotification('Google ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        }
    } else {
        if (typeof auth !== 'undefined' && typeof firebase !== 'undefined') {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    return checkUserApprovalFirebase(result.user.email)
                        .then(approved => {
                            if (approved || result.user.email === ADMIN_EMAIL) {
                                currentUser = result.user;
                                updateAuthUI();
                                showNotification('Google ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                            } else {
                                auth.signOut();
                                document.getElementById('login-error').textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤. ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                            }
                        });
                })
                .catch((error) => {
                    console.error('Google login error:', error);
                    document.getElementById('login-error').textContent = 'Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
                });
        } else {
            document.getElementById('login-error').textContent = 'Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
    }
}

// Handle signup
function handleSignup() {
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const passwordConfirm = document.getElementById('signup-password-confirm').value;
    const errorDiv = document.getElementById('signup-error');
    
    if (!name || !email || !password) {
        errorDiv.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš”.';
        return;
    }
    
    if (password !== passwordConfirm) {
        errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìž ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
        return;
    }
    
    if (DEMO_MODE) {
        // Demo mode: add to pending list
        if (isUserPending(email)) {
            errorDiv.textContent = 'ì´ë¯¸ ê°€ìž… ì‹ ì²­ëœ ì´ë©”ì¼ìž…ë‹ˆë‹¤.';
            return;
        }
        addPendingUser(name, email);
        showNotification('íšŒì›ê°€ìž… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        switchLoginTab('pending');
    } else {
        if (typeof auth !== 'undefined') {
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Update display name
                    return userCredential.user.updateProfile({ displayName: name })
                        .then(() => {
                            // Add to pending users in Firestore
                            return db.collection('pendingUsers').doc(email.toLowerCase()).set({
                                name: name,
                                email: email.toLowerCase(),
                                requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .then(() => {
                            auth.signOut();
                            showNotification('íšŒì›ê°€ìž… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            switchLoginTab('pending');
                        });
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        errorDiv.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ìž…ë‹ˆë‹¤.';
                    } else {
                        errorDiv.textContent = 'íšŒì›ê°€ìž… ì‹¤íŒ¨: ' + error.message;
                    }
                });
        } else {
            errorDiv.textContent = 'Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
    }
}

// Handle Google signup
function handleGoogleSignup() {
    if (DEMO_MODE) {
        const email = prompt('ë°ëª¨ ëª¨ë“œ: Google íšŒì›ê°€ìž…ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.\nì´ë©”ì¼ì„ ìž…ë ¥í•˜ì„¸ìš”:');
        const name = prompt('ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”:');
        if (email && name) {
            if (isUserPending(email)) {
                document.getElementById('signup-error').textContent = 'ì´ë¯¸ ê°€ìž… ì‹ ì²­ëœ ì´ë©”ì¼ìž…ë‹ˆë‹¤.';
                return;
            }
            addPendingUser(name, email);
            showNotification('íšŒì›ê°€ìž… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            switchLoginTab('pending');
        }
    } else {
        if (typeof auth !== 'undefined' && typeof firebase !== 'undefined') {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    // Add to pending users
                    return db.collection('pendingUsers').doc(user.email.toLowerCase()).set({
                        name: user.displayName || user.email,
                        email: user.email.toLowerCase(),
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        auth.signOut();
                        showNotification('íšŒì›ê°€ìž… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        switchLoginTab('pending');
                    });
                })
                .catch((error) => {
                    console.error('Google signup error:', error);
                    document.getElementById('signup-error').textContent = 'Google íšŒì›ê°€ìž… ì‹¤íŒ¨: ' + error.message;
                });
        } else {
            document.getElementById('signup-error').textContent = 'Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
    }
}

// Check user approval in Firebase
async function checkUserApprovalFirebase(email) {
    if (email === ADMIN_EMAIL) return true;
    
    try {
        const doc = await db.collection('approvedUsers').doc(email.toLowerCase()).get();
        return doc.exists;
    } catch (error) {
        console.error('Check approval error:', error);
        return false;
    }
}

// Handle logout
function handleLogout() {
    if (!DEMO_MODE && typeof auth !== 'undefined') {
        auth.signOut().catch(console.error);
    }
    currentUser = null;
    updateAuthUI();
    showNotification('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0284c7'};
        color: white;
        border-radius: 8px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Print patient report - NEW IMPROVED VERSION
function printPatientReport() {
    if (!window.calculator || !window.calculator.results) {
        showNotification('ë¨¼ì € ê³„ì‚°ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const results = window.calculator.results;
    const patientName = document.getElementById('patient-name').value || 'í™˜ìž';
    const patientId = document.getElementById('patient-id').value || '00000000';
    const age = document.getElementById('age').value || '-';
    const gender = document.getElementById('gender').value === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';
    const printDate = new Date().toLocaleString('ko-KR');
    
    // Set document title for PDF filename
    document.title = `${patientName}_${patientId}`;
    
    const odData = results.od?.data || {};
    const osData = results.os?.data || {};
    const odResults = results.od?.surgeryResults || {};
    const osResults = results.os?.surgeryResults || {};
    const odErss = results.od?.erssResult || {};
    const osErss = results.os?.erssResult || {};
    
    // Get eligibility status
    const getEligibility = (surgeryResult) => {
        if (!surgeryResult) return { text: '-', class: 'neutral' };
        if (surgeryResult.rsb < 280 || surgeryResult.pta >= 40) {
            return { text: 'ë¶€ì í•©', class: 'danger' };
        } else if (surgeryResult.rsb < 300 || surgeryResult.pta >= 35) {
            return { text: 'ì£¼ì˜', class: 'warning' };
        }
        return { text: 'ì í•©', class: 'success' };
    };
    
    const odLasikElig = getEligibility(odResults.lasik);
    const odLasekElig = getEligibility(odResults.lasek);
    const osLasikElig = getEligibility(osResults.lasik);
    const osLasekElig = getEligibility(osResults.lasek);
    
    const getErssRiskText = (score) => score <= 2 ? 'ì €ìœ„í—˜' : score === 3 ? 'ì¤‘ë“±ë„' : 'ê³ ìœ„í—˜';
    const getStatusStyle = (status) => {
        if (status === 'success') return 'background:#dcfce7;color:#166534;';
        if (status === 'warning') return 'background:#fef3c7;color:#92400e;';
        if (status === 'danger') return 'background:#fee2e2;color:#991b1b;';
        return 'background:#f3f4f6;color:#6b7280;';
    };
    
    const printHTML = `
        <div style="font-family: 'Noto Sans KR', -apple-system, sans-serif; font-size: 9pt; color: #000; padding: 0; max-width: 210mm; margin: 0 auto;">
            <!-- í—¤ë” -->
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #0284c7; padding-bottom: 8px; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 16pt; font-weight: 700; color: #0284c7;">ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬ ê²°ê³¼</div>
                    <div style="font-size: 10pt; color: #666;">ì—°ì„¸ì†”ì•ˆê³¼ YONSEI SOL EYE CLINIC</div>
                </div>
                <div style="text-align: right; font-size: 8pt; color: #666;">
                    ê²€ì‚¬ì¼ì‹œ: ${printDate}<br>
                    ë‹´ë‹¹ìž: ${currentUser?.email || '-'}
                </div>
            </div>
            
            <!-- í™˜ìž ì •ë³´ -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #0284c7;">
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">í™˜ìžëª…</div>
                    <div style="font-size: 12pt; font-weight: 700;">${patientName}</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">ë“±ë¡ë²ˆí˜¸</div>
                    <div style="font-size: 12pt; font-weight: 700;">${patientId}</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">ë‚˜ì´</div>
                    <div style="font-size: 12pt; font-weight: 700;">${age}ì„¸</div>
                </div>
                <div>
                    <div style="font-size: 7pt; color: #666; margin-bottom: 2px;">ì„±ë³„</div>
                    <div style="font-size: 12pt; font-weight: 700;">${gender}</div>
                </div>
            </div>
            
            <!-- ========== ì¢…í•© í‰ê°€ ========== -->
            <div style="background: #1e3a5f; color: white; padding: 8px 12px; border-radius: 6px 6px 0 0; font-weight: 700; font-size: 11pt;">
                ðŸ“‹ ì¢…í•© í‰ê°€ (Summary)
            </div>
            <div style="border: 2px solid #1e3a5f; border-top: none; border-radius: 0 0 6px 6px; padding: 12px; margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                    <thead>
                        <tr style="background: #f8fafc;">
                            <th style="border: 1px solid #ddd; padding: 8px; width: 15%;"></th>
                            <th style="border: 1px solid #ddd; padding: 8px; width: 42.5%; background: #dbeafe; color: #1e40af;">ðŸ‘ ìš°ì•ˆ (OD)</th>
                            <th style="border: 1px solid #ddd; padding: 8px; width: 42.5%; background: #dcfce7; color: #166534;">ðŸ‘ ì¢Œì•ˆ (OS)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">LASIK</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(odLasikElig.class)}">${odLasikElig.text}</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(osLasikElig.class)}">${osLasikElig.text}</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">LASEK/PRK</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(odLasekElig.class)}">${odLasekElig.text}</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 10pt; ${getStatusStyle(osLasekElig.class)}">${osLasekElig.text}</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; background: #f8fafc;">ERSS</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <strong style="font-size: 11pt;">${odErss.total || 0}ì </strong>
                                <span style="margin-left: 6px; font-size: 8pt; color: #666;">(${getErssRiskText(odErss.total || 0)})</span>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                <strong style="font-size: 11pt;">${osErss.total || 0}ì </strong>
                                <span style="margin-left: 6px; font-size: 8pt; color: #666;">(${getErssRiskText(osErss.total || 0)})</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ========== ì–‘ì•ˆ ë°ì´í„° (ì¢Œìš° ë°°ì¹˜) ========== -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <!-- ìš°ì•ˆ (OD) -->
                <div style="border: 2px solid #3b82f6; border-radius: 6px; overflow: hidden;">
                    <div style="background: #3b82f6; color: white; padding: 8px 12px; font-weight: 700; font-size: 11pt;">
                        ðŸ‘ ìš°ì•ˆ (OD) ìƒì„¸ ë°ì´í„°
                    </div>
                    <div style="padding: 10px;">
                        ${generateDetailedEyeSection(odData, odResults, odErss)}
                    </div>
                </div>
                
                <!-- ì¢Œì•ˆ (OS) -->
                <div style="border: 2px solid #22c55e; border-radius: 6px; overflow: hidden;">
                    <div style="background: #22c55e; color: white; padding: 8px 12px; font-weight: 700; font-size: 11pt;">
                        ðŸ‘ ì¢Œì•ˆ (OS) ìƒì„¸ ë°ì´í„°
                    </div>
                    <div style="padding: 10px;">
                        ${generateDetailedEyeSection(osData, osResults, osErss)}
                    </div>
                </div>
            </div>
            
            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div style="background: #fef3c7; padding: 10px 15px; border-radius: 6px; margin-top: 15px; font-size: 8pt; color: #92400e; border: 1px solid #f59e0b;">
                âš ï¸ <strong>ì£¼ì˜ì‚¬í•­:</strong> ë³¸ ê²€ì‚¬ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ìˆ˜ìˆ  ê²°ì •ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ ìƒë‹´ í›„ ê²°ì •í•˜ì‹œê¸° ë°”ëžë‹ˆë‹¤. 
                ê°ë§‰ ë‘ê»˜, êµ´ì ˆë ¥, ì§€í˜•ë„ íŒ¨í„´ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ íŒë‹¨ë©ë‹ˆë‹¤.
            </div>
            
            <!-- í‘¸í„° -->
            <div style="text-align: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 7pt; color: #999;">
                Â© ì—°ì„¸ì†”ì•ˆê³¼ YONSEI SOL EYE CLINIC | Munnerlyn's Formula ê¸°ë°˜ ê³„ì‚° | Randleman ERSS & PTA ìœ„í—˜ë„ í‰ê°€
            </div>
        </div>
    `;
    
    const printContainer = document.getElementById('print-container');
    printContainer.innerHTML = printHTML;
    printContainer.style.display = 'block';
    
    // Hide other elements before printing
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        window.print();
        setTimeout(() => {
            printContainer.style.display = 'none';
            printContainer.innerHTML = '';
            document.body.style.overflow = '';
            // Reset document title
            document.title = 'ì‹œë ¥êµì •ìˆ  ì í•©ì„± ê²€ì‚¬ | Refractive Surgery Eligibility Checker';
        }, 500);
    }, 300);
}

// Generate detailed eye section for print (SMILE ì œì™¸)
function generateDetailedEyeSection(data, surgeryResults, erssResult) {
    const se = (data.sph || 0) + ((data.cyl || 0) / 2);
    const avgK = ((data.k1 || 0) + (data.k2 || 0)) / 2;
    const erssScore = erssResult.total || 0;
    
    const getErssRiskText = (score) => score <= 2 ? 'ì €ìœ„í—˜' : score === 3 ? 'ì¤‘ë“±ë„' : 'ê³ ìœ„í—˜';
    const getRiskStyle = (level) => {
        if (level === 'low') return 'background:#dcfce7;color:#166534;';
        if (level === 'moderate') return 'background:#fef3c7;color:#92400e;';
        return 'background:#fee2e2;color:#991b1b;';
    };
    const getErssLevel = (score) => score <= 2 ? 'low' : score === 3 ? 'moderate' : 'high';
    const getPtaLevel = (pta) => pta < 35 ? 'low' : pta < 40 ? 'moderate' : 'high';
    
    return `
        <!-- ìž…ë ¥ ë°ì´í„° -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <!-- êµ´ì ˆ ê²€ì‚¬ -->
            <div style="background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0;">ðŸ“Š êµ´ì ˆ ê²€ì‚¬</div>
                <table style="width: 100%; font-size: 8pt;">
                    <tr><td style="color: #666;">SPH</td><td style="text-align: right; font-weight: 600;">${(data.sph || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">CYL</td><td style="text-align: right; font-weight: 600;">${(data.cyl || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">AXIS</td><td style="text-align: right; font-weight: 600;">${data.axis || 0}Â°</td></tr>
                    <tr style="background: #e0f2fe;"><td style="color: #0369a1; font-weight: 600;">SE</td><td style="text-align: right; font-weight: 700; color: #0369a1;">${se.toFixed(2)} D</td></tr>
                </table>
            </div>
            
            <!-- ê°ë§‰ ê²€ì‚¬ -->
            <div style="background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0;">ðŸ”¬ ê°ë§‰ ê²€ì‚¬</div>
                <table style="width: 100%; font-size: 8pt;">
                    <tr><td style="color: #666;">CCT</td><td style="text-align: right; font-weight: 600;">${data.cct || 0} Î¼m</td></tr>
                    <tr><td style="color: #666;">K1</td><td style="text-align: right; font-weight: 600;">${(data.k1 || 0).toFixed(2)} D</td></tr>
                    <tr><td style="color: #666;">K2</td><td style="text-align: right; font-weight: 600;">${(data.k2 || 0).toFixed(2)} D</td></tr>
                    <tr style="background: #e0f2fe;"><td style="color: #0369a1; font-weight: 600;">Avg K</td><td style="text-align: right; font-weight: 700; color: #0369a1;">${avgK.toFixed(2)} D</td></tr>
                </table>
            </div>
        </div>
        
        <!-- ìˆ˜ìˆ ë³„ ê²°ê³¼ (SMILE ì œì™¸) -->
        <div style="margin-bottom: 10px;">
            <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px;">ðŸ”ª ìˆ˜ìˆ ë³„ ê³„ì‚° ê²°ê³¼</div>
            <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="border: 1px solid #ddd; padding: 5px;">ìˆ˜ìˆ </th>
                        <th style="border: 1px solid #ddd; padding: 5px;">ì ˆì‚­ëŸ‰</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">RSB</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">PTA</th>
                        <th style="border: 1px solid #ddd; padding: 5px;">íŒì •</th>
                    </tr>
                </thead>
                <tbody>
                    ${generatePrintSurgeryRow('LASIK', surgeryResults.lasik)}
                    ${generatePrintSurgeryRow('LASEK/PRK', surgeryResults.lasek)}
                </tbody>
            </table>
        </div>
        
        <!-- ìœ„í—˜ë„ í‰ê°€ -->
        <div style="background: #fafafa; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
            <div style="font-size: 8pt; font-weight: 600; color: #475569; margin-bottom: 6px;">âš ï¸ ìœ„í—˜ë„ í‰ê°€</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getErssLevel(erssScore))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">ERSS Score</div>
                    <div style="font-size: 12pt; font-weight: 700;">${erssScore}ì </div>
                    <div style="font-size: 7pt;">${getErssRiskText(erssScore)}</div>
                </div>
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getPtaLevel(surgeryResults.lasik?.pta || 0))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">LASIK PTA</div>
                    <div style="font-size: 12pt; font-weight: 700;">${(surgeryResults.lasik?.pta || 0).toFixed(1)}%</div>
                </div>
                <div style="text-align: center; padding: 6px; border-radius: 4px; ${getRiskStyle(getPtaLevel(surgeryResults.lasek?.pta || 0))}">
                    <div style="font-size: 7pt; margin-bottom: 2px;">LASEK PTA</div>
                    <div style="font-size: 12pt; font-weight: 700;">${(surgeryResults.lasek?.pta || 0).toFixed(1)}%</div>
                </div>
            </div>
        </div>
    `;
}

// Generate surgery row for print (improved)
function generatePrintSurgeryRow(name, data) {
    if (!data) return '';
    
    let bgColor = '#dcfce7';
    let textColor = '#166534';
    let text = 'ì í•©';
    
    if (data.rsb < 280 || data.pta >= 40) {
        bgColor = '#fee2e2'; textColor = '#991b1b'; text = 'ë¶€ì í•©';
    } else if (data.rsb < 300 || data.pta >= 35) {
        bgColor = '#fef3c7'; textColor = '#92400e'; text = 'ì£¼ì˜';
    }
    
    const rsbStyle = data.rsb < 280 ? 'color:#dc2626;font-weight:700;' : data.rsb < 300 ? 'color:#d97706;font-weight:600;' : '';
    const ptaStyle = data.pta >= 40 ? 'color:#dc2626;font-weight:700;' : data.pta >= 35 ? 'color:#d97706;font-weight:600;' : '';
    
    // Ablation depth warning
    const ablation = data.ablation || data.ablationDepth || 0;
    const isLasik = name.toUpperCase().includes('LASIK');
    const safeLimit = isLasik ? 90 : 100;
    const cautionLimit = isLasik ? 120 : 130;
    
    let ablationStyle = '';
    let ablationIcon = '';
    if (ablation > cautionLimit) {
        ablationStyle = 'color:#dc2626;font-weight:700;';
        ablationIcon = 'ðŸš¨';
    } else if (ablation > safeLimit) {
        ablationStyle = 'color:#d97706;font-weight:600;';
        ablationIcon = 'âš ï¸';
    }
    
    return `
        <tr>
            <td style="border: 1px solid #ddd; padding: 5px; font-weight: 600;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${ablationStyle}">${ablationIcon} ${ablation.toFixed(1)} Î¼m</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${rsbStyle}">${data.rsb?.toFixed(0) || '-'} Î¼m</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; ${ptaStyle}">${data.pta?.toFixed(1) || '-'}%</td>
            <td style="border: 1px solid #ddd; padding: 5px; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 700;">${text}</td>
        </tr>
    `;
}

function generateEyeSection(data, surgeryResults, erssResult) {
    const se = (data.sph || 0) + ((data.cyl || 0) / 2);
    const avgK = ((data.k1 || 0) + (data.k2 || 0)) / 2;
    const erssScore = erssResult.total || 0;
    
    const getErssRiskClass = (score) => score <= 2 ? 'low' : score === 3 ? 'moderate' : 'high';
    const getErssRiskText = (score) => score <= 2 ? 'ì €ìœ„í—˜' : score === 3 ? 'ì¤‘ë“±ë„' : 'ê³ ìœ„í—˜';
    const getRiskBadgeStyle = (level) => {
        if (level === 'low') return 'background:#dcfce7;color:#166534;';
        if (level === 'moderate') return 'background:#fef3c7;color:#92400e;';
        return 'background:#fee2e2;color:#991b1b;';
    };
    
    return `
        <!-- êµ´ì ˆ/ê°ë§‰ ê²€ì‚¬ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
            <div style="background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">êµ´ì ˆ ê²€ì‚¬</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 7pt;">
                    <div>SPH: <strong>${(data.sph || 0).toFixed(2)}D</strong></div>
                    <div>CYL: <strong>${(data.cyl || 0).toFixed(2)}D</strong></div>
                    <div>AXIS: <strong>${data.axis || 0}Â°</strong></div>
                    <div style="color:#0284c7;">SE: <strong>${se.toFixed(2)}D</strong></div>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
                <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">ê°ë§‰ ê²€ì‚¬</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 7pt;">
                    <div>CCT: <strong>${data.cct || 0}Î¼m</strong></div>
                    <div>Avg K: <strong>${avgK.toFixed(2)}D</strong></div>
                    <div>K1: <strong>${(data.k1 || 0).toFixed(2)}D</strong></div>
                    <div>K2: <strong>${(data.k2 || 0).toFixed(2)}D</strong></div>
                </div>
            </div>
        </div>
        
        <!-- ìˆ˜ìˆ ë³„ ê²°ê³¼ í…Œì´ë¸” -->
        <table style="width: 100%; border-collapse: collapse; font-size: 7pt; margin-bottom: 8px;">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th style="border: 1px solid #ddd; padding: 3px;">ìˆ˜ìˆ </th>
                    <th style="border: 1px solid #ddd; padding: 3px;">ì ˆì‚­ëŸ‰</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">RSB</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">PTA</th>
                    <th style="border: 1px solid #ddd; padding: 3px;">ì í•©ì„±</th>
                </tr>
            </thead>
            <tbody>
                ${generateSurgeryRowNew('LASIK', surgeryResults.lasik)}
                ${generateSurgeryRowNew('LASEK', surgeryResults.lasek)}
                ${generateSurgeryRowNew('SMILE', surgeryResults.smile)}
            </tbody>
        </table>
        
        <!-- ìœ„í—˜ë„ í‰ê°€ -->
        <div style="background: #fafafa; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0;">
            <div style="font-size: 7pt; font-weight: 600; color: #475569; margin-bottom: 4px;">ìœ„í—˜ë„ í‰ê°€</div>
            <div style="display: flex; gap: 6px; justify-content: center;">
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(getErssRiskClass(erssScore))}">
                    <div style="font-size: 6pt;">ERSS</div>
                    <div style="font-size: 10pt; font-weight: 700;">${erssScore}ì </div>
                    <div style="font-size: 6pt;">${getErssRiskText(erssScore)}</div>
                </div>
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(surgeryResults.lasik?.pta < 35 ? 'low' : surgeryResults.lasik?.pta < 40 ? 'moderate' : 'high')}">
                    <div style="font-size: 6pt;">LASIK PTA</div>
                    <div style="font-size: 10pt; font-weight: 700;">${(surgeryResults.lasik?.pta || 0).toFixed(1)}%</div>
                </div>
                <div style="text-align: center; padding: 4px 8px; border-radius: 4px; ${getRiskBadgeStyle(surgeryResults.lasek?.pta < 35 ? 'low' : surgeryResults.lasek?.pta < 40 ? 'moderate' : 'high')}">
                    <div style="font-size: 6pt;">LASEK PTA</div>
                    <div style="font-size: 10pt; font-weight: 700;">${(surgeryResults.lasek?.pta || 0).toFixed(1)}%</div>
                </div>
            </div>
        </div>
    `;
}

function generateSurgeryRowNew(name, data) {
    if (!data) return '';
    
    let bgColor = '#dcfce7'; // green - eligible
    let textColor = '#166534';
    let text = 'ì í•©';
    
    if (data.rsb < 280 || data.pta >= 40) {
        bgColor = '#fee2e2'; textColor = '#991b1b'; text = 'ë¶€ì í•©';
    } else if (data.rsb < 300 || data.pta >= 35) {
        bgColor = '#fef3c7'; textColor = '#92400e'; text = 'ì£¼ì˜';
    }
    
    return `
        <tr>
            <td style="border: 1px solid #ddd; padding: 3px; font-weight: 600;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center;">${data.ablation?.toFixed(1) || '-'}Î¼m</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; ${data.rsb < 280 ? 'color:#dc2626;font-weight:600;' : ''}">${data.rsb?.toFixed(0) || '-'}Î¼m</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; ${data.pta >= 40 ? 'color:#dc2626;font-weight:600;' : ''}">${data.pta?.toFixed(1) || '-'}%</td>
            <td style="border: 1px solid #ddd; padding: 3px; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 600;">${text}</td>
        </tr>
    `;
}

// Search patients
function searchPatients() {
    const query = document.getElementById('search-input').value.trim();
    const resultsDiv = document.getElementById('search-results');
    
    if (!query) {
        resultsDiv.innerHTML = '<div class="search-placeholder">í™˜ìž ì´ë¦„ ë˜ëŠ” ë“±ë¡ë²ˆí˜¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”</div>';
        return;
    }
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const filtered = patients.filter(p => 
        (p.patientName && p.patientName.includes(query)) ||
        (p.patientId && p.patientId.includes(query))
    );
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="search-placeholder">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;;
    }
    
    resultsDiv.innerHTML = filtered.map(p => `
        <div class="search-result-item" onclick="loadPatient('${p.patientId}')">
            <div class="search-result-name">${p.patientName || '(ì´ë¦„ ì—†ìŒ)'}</div>
            <div class="search-result-info">
                ë“±ë¡ë²ˆí˜¸: ${p.patientId || '-'} | 
                ë‚˜ì´: ${p.age || '-'} |
                ìµœê·¼: ${new Date(p.updatedAt).toLocaleDateString('ko-KR')}
            </div>
        </div>
    `).join('');
}

// Load recent patients
function loadRecentPatients() {
    const listDiv = document.getElementById('recent-patients-list');
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    if (patients.length === 0) {
        listDiv.innerHTML = '<div class="search-placeholder">ì €ìž¥ëœ í™˜ìžê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    
    const recent = patients
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
        .slice(0, 5);
    
    listDiv.innerHTML = recent.map(p => `
        <div class="recent-patient-item" onclick="loadPatient('${p.patientId}')">
            <span>${p.patientName || '(ì´ë¦„ ì—†ìŒ)'} - ${p.patientId || '-'}</span>
            <span>${new Date(p.updatedAt).toLocaleDateString('ko-KR')}</span>
        </div>
    `).join('');
}

// Load patient data into form
function loadPatient(patientId) {
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const patient = patients.find(p => p.patientId === patientId);
    
    if (!patient) {
        showNotification('í™˜ìžë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // Fill form fields
    document.getElementById('patient-name').value = patient.patientName || '';
    document.getElementById('patient-id').value = patient.patientId || '';
    document.getElementById('age').value = patient.age || 25;
    document.getElementById('gender').value = patient.gender || 'male';
    
    // OD fields
    if (patient.od) {
        document.getElementById('od-sph').value = patient.od.sph || -3;
        document.getElementById('od-cyl').value = patient.od.cyl || -1;
        document.getElementById('od-axis').value = patient.od.axis || 180;
        document.getElementById('od-cct').value = patient.od.cct || 540;
        document.getElementById('od-k1').value = patient.od.k1 || 43;
        document.getElementById('od-k2').value = patient.od.k2 || 44;
        document.getElementById('od-steep-axis').value = patient.od.steepAxis || 90;
        document.getElementById('od-topography').value = patient.od.topography || 'normal';
        document.getElementById('od-optical-zone').value = patient.od.opticalZone || 6.5;
        document.getElementById('od-lasik-flap').value = patient.od.lasikFlap || 90;
        document.getElementById('od-lasek-epi').value = patient.od.lasekEpi || 55;
        document.getElementById('od-smile-cap').value = patient.od.smileCap || 120;
    }
    
    // OS fields
    if (patient.os) {
        document.getElementById('os-sph').value = patient.os.sph || -3;
        document.getElementById('os-cyl').value = patient.os.cyl || -1;
        document.getElementById('os-axis').value = patient.os.axis || 180;
        document.getElementById('os-cct').value = patient.os.cct || 535;
        document.getElementById('os-k1').value = patient.os.k1 || 43;
        document.getElementById('os-k2').value = patient.os.k2 || 44;
        document.getElementById('os-steep-axis').value = patient.os.steepAxis || 90;
        document.getElementById('os-topography').value = patient.os.topography || 'normal';
        document.getElementById('os-optical-zone').value = patient.os.opticalZone || 6.5;
        document.getElementById('os-lasik-flap').value = patient.os.lasikFlap || 90;
        document.getElementById('os-lasek-epi').value = patient.os.lasekEpi || 55;
        document.getElementById('os-smile-cap').value = patient.os.smileCap || 120;
    }
    
    toggleModal('search-modal', false);
    showNotification(`${patient.patientName || patientId} í™˜ìž ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
    
    // Update SE displays
    if (window.calculator) {
        window.calculator.updateSE('od');
        window.calculator.updateSE('os');
    }
}

// Save patient to localStorage (enhanced version)
function savePatientData(formData, results) {
    const patientData = {
        patientName: formData.common?.patientName || document.getElementById('patient-name').value,
        patientId: formData.common?.patientId || document.getElementById('patient-id').value,
        age: formData.od?.age || parseInt(document.getElementById('age').value),
        gender: formData.od?.gender || document.getElementById('gender').value,
        od: {
            sph: formData.od?.sph,
            cyl: formData.od?.cyl,
            axis: formData.od?.axis,
            cct: formData.od?.cct,
            k1: formData.od?.k1,
            k2: formData.od?.k2,
            steepAxis: formData.od?.steepAxis,
            topography: formData.od?.topography,
            opticalZone: formData.od?.opticalZone,
            lasikFlap: formData.od?.lasikFlap,
            lasekEpi: formData.od?.lasekEpi,
            smileCap: formData.od?.smileCap
        },
        os: {
            sph: formData.os?.sph,
            cyl: formData.os?.cyl,
            axis: formData.os?.axis,
            cct: formData.os?.cct,
            k1: formData.os?.k1,
            k2: formData.os?.k2,
            steepAxis: formData.os?.steepAxis,
            topography: formData.os?.topography,
            opticalZone: formData.os?.opticalZone,
            lasikFlap: formData.os?.lasikFlap,
            lasekEpi: formData.os?.lasekEpi,
            smileCap: formData.os?.smileCap
        },
        results: results,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'anonymous'
    };
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    // Check if patient exists
    const existingIndex = patients.findIndex(p => p.patientId === patientData.patientId);
    
    if (existingIndex >= 0) {
        patientData.createdAt = patients[existingIndex].createdAt;
        patients[existingIndex] = patientData;
    } else {
        patients.push(patientData);
    }
    
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(patients));
    return patientData;
}

const CONFIG = {
    RSB_SAFE_THRESHOLD: 300,
    RSB_WARNING_THRESHOLD: 280,
    RSB_DANGER_THRESHOLD: 250,
    PTA_SAFE_THRESHOLD: 35,
    PTA_WARNING_THRESHOLD: 40,
    K_MIN_SAFE: 34,
    K_MAX_SAFE: 48,
    K_OPTIMAL_MIN: 36,
    K_OPTIMAL_MAX: 46,
    // Ablation Depth Thresholds (based on published literature)
    // References: 
    // - EyeWiki Ectasia Risk: >100Î¼m excessive ablation
    // - ESCRS 2024 (Dr. Ang): max 120Î¼m for LASIK
    // - Santhiago et al. 2014: ectasia group mean 94Î¼m
    ABLATION_LASIK_SAFE: 90,      // Safe threshold for LASIK
    ABLATION_LASIK_CAUTION: 120,  // Caution threshold - ESCRS guideline
    ABLATION_LASEK_SAFE: 100,     // Safe threshold for LASEK/PRK
    ABLATION_LASEK_CAUTION: 130,  // Caution threshold for LASEK/PRK
};

// AI Topography Analysis Thresholds based on published criteria
const TOPO_THRESHOLDS = {
    // Belin-Ambrosio Display (BAD-D)
    badD: { normal: 1.6, suspect: 2.6 },
    // I-S value (Inferior-Superior asymmetry)
    isValue: { normal: 1.4, suspect: 1.9 },
    // KISA% index
    kisa: { normal: 60, suspect: 100 },
    // Posterior elevation (central, best-fit sphere)
    posteriorElevation: { normal: 15, suspect: 29 },
    // Anterior elevation
    anteriorElevation: { normal: 7, suspect: 12 },
    // Thinnest pachymetry location displacement
    thinnestDisplacement: { normal: 0.5, suspect: 0.9 },
    // Pachymetric progression index (PPI)
    ppiMax: { normal: 1.2, suspect: 1.6 },
    // ARC (AmbrÃ³sio Relational Thickness)
    artMax: { normal: 400, suspect: 339 },
    // Keratoconus Index (KI)
    ki: { normal: 1.07, suspect: 1.1 },
    // Central Keratoconus Index (CKI)
    cki: { normal: 1.03, suspect: 1.05 },
    // Index of Height Asymmetry (IHA)
    iha: { normal: 19, suspect: 30 },
    // Index of Height Decentration (IHD)
    ihd: { normal: 0.014, suspect: 0.021 },
    // Index of Surface Variance (ISV)
    isv: { normal: 37, suspect: 52 },
    // Index of Vertical Asymmetry (IVA)
    iva: { normal: 0.28, suspect: 0.42 },
    // Corneal thickness at thinnest point
    tct: { normal: 490, danger: 470 },
    // Sim K astigmatism
    simKAstig: { normal: 2.0, suspect: 3.0 },
    // Max K
    maxK: { normal: 47.2, suspect: 48.7 }
};

/**
 * AI Topography Analyzer
 * Parses and analyzes Galilei G4, Pentacam, Orbscan data
 */
class TopographyAnalyzer {
    constructor() {
        this.init();
    }
    
    init() {
        // Enable analyze buttons when text is entered
        ['od', 'os'].forEach(eye => {
            const textarea = document.getElementById(`${eye}-topo-data`);
            const button = document.getElementById(`btn-analyze-${eye}`);
            
            if (textarea && button) {
                textarea.addEventListener('input', () => {
                    button.disabled = textarea.value.trim().length < 10;
                });
                
                button.addEventListener('click', () => {
                    this.analyzeTopography(eye);
                });
            }
        });
    }
    
    /**
     * Main analysis function
     */
    analyzeTopography(eye) {
        const textarea = document.getElementById(`${eye}-topo-data`);
        const resultContainer = document.getElementById(`${eye}-ai-result`);
        const button = document.getElementById(`btn-analyze-${eye}`);
        const topoSelect = document.getElementById(`${eye}-topography`);
        
        if (!textarea || !resultContainer) return;
        
        const rawData = textarea.value.trim();
        if (rawData.length < 10) return;
        
        // Show analyzing state
        button.classList.add('analyzing');
        button.innerHTML = '<span class="analyze-icon">â³</span> ë¶„ì„ì¤‘...';
        
        // Simulate analysis delay for UX
        setTimeout(() => {
            try {
                const parsedData = this.parseTopographyData(rawData);
                const analysis = this.analyzeIndices(parsedData);
                this.renderAnalysisResult(resultContainer, analysis, parsedData);
                
                // Auto-update topography select based on analysis
                if (topoSelect && analysis.classification) {
                    this.updateTopographySelect(topoSelect, analysis.classification);
                }
                
            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="ai-result-content">
                        <div class="ai-classification suspect">
                            <span>âš ï¸</span> ë¶„ì„ ì˜¤ë¥˜
                        </div>
                        <div class="ai-findings">
                            <div class="ai-finding-item">
                                <span class="finding-icon">âŒ</span>
                                <span>ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>
                            </div>
                            <div class="ai-finding-item">
                                <span class="finding-icon">ðŸ’¡</span>
                                <span>Galilei G4, Pentacam, Orbscanì˜ ê²°ê³¼ë¥¼ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            button.classList.remove('analyzing');
            button.innerHTML = '<span class="analyze-icon">ðŸ”</span> ë¶„ì„';
        }, 800);
    }
    
    /**
     * Parse various topography data formats
     */
    parseTopographyData(rawData) {
        const data = {};
        const text = rawData.toLowerCase();
        
        // Helper function to extract numeric value
        const extractNumber = (pattern, text) => {
            const match = text.match(pattern);
            return match ? parseFloat(match[1]) : null;
        };
        
        // BAD-D (Belin-Ambrosio Display)
        data.badD = extractNumber(/bad[- ]?d[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                    extractNumber(/belin[- ]?ambr[oÃ³]sio[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // I-S value
        data.isValue = extractNumber(/i[- ]?s[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                       extractNumber(/inferior[- ]?superior[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // KISA%
        data.kisa = extractNumber(/kisa[%]?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // Posterior elevation
        data.posteriorElevation = extractNumber(/post(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                                   extractNumber(/posterior[:\s]*([+-]?\d+\.?\d*)\s*[Î¼u]?m/i, rawData);
        
        // Anterior elevation
        data.anteriorElevation = extractNumber(/ant(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // TCT / Thinnest pachymetry
        data.tct = extractNumber(/tct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/thinnest[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/min(?:imum)?[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Thinnest location (displacement from center)
        const thinnestLoc = rawData.match(/thinnest[^(]*\(([+-]?\d+\.?\d*)[,\s]+([+-]?\d+\.?\d*)\)/i);
        if (thinnestLoc) {
            const x = parseFloat(thinnestLoc[1]);
            const y = parseFloat(thinnestLoc[2]);
            data.thinnestDisplacement = Math.sqrt(x*x + y*y);
        }
        
        // Sim K values
        const simKMatch = rawData.match(/sim[- ]?k[:\s]*(\d+\.?\d*)\s*[@at]*\s*(\d+)[Â°]?\s*[\/,]\s*(\d+\.?\d*)\s*[@at]*\s*(\d+)/i);
        if (simKMatch) {
            data.simK1 = parseFloat(simKMatch[1]);
            data.simK1Axis = parseFloat(simKMatch[2]);
            data.simK2 = parseFloat(simKMatch[3]);
            data.simK2Axis = parseFloat(simKMatch[4]);
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Alternative K reading patterns
        if (!data.simK1) {
            data.simK1 = extractNumber(/k1[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/flat[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (!data.simK2) {
            data.simK2 = extractNumber(/k2[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/steep[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (data.simK1 && data.simK2 && !data.simKAstig) {
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Max K / Kmax
        data.maxK = extractNumber(/k[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                    extractNumber(/max[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        
        // PPI (Pachymetric Progression Index)
        data.ppiMax = extractNumber(/ppi[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/ppi[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ART (AmbrÃ³sio Relational Thickness)
        data.artMax = extractNumber(/art[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/art[:\s]*(\d+\.?\d*)/i, rawData);
        
        // KI (Keratoconus Index)
        data.ki = extractNumber(/\bki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CKI (Central Keratoconus Index)
        data.cki = extractNumber(/cki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHA (Index of Height Asymmetry)
        data.iha = extractNumber(/iha[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHD (Index of Height Decentration)
        data.ihd = extractNumber(/ihd[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ISV (Index of Surface Variance)
        data.isv = extractNumber(/isv[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IVA (Index of Vertical Asymmetry)
        data.iva = extractNumber(/iva[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CCT (Central Corneal Thickness)
        data.cct = extractNumber(/cct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/central[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Pattern recognition keywords
        data.hasInferiorSteepening = /inferior[- ]?steep/i.test(rawData);
        data.hasAsymmetricBowtie = /asymmetric[- ]?bowtie|ab[- ]?srax/i.test(rawData);
        data.hasSuspectPattern = /suspect|abnormal|keratoconus|kc|ffkc|forme[- ]?fruste/i.test(rawData);
        data.hasNormalPattern = /normal|regular|symmetric/i.test(rawData) && !data.hasSuspectPattern;
        
        return data;
    }
    
    /**
     * Analyze parsed indices and generate classification
     */
    analyzeIndices(data) {
        const findings = [];
        const indices = {};
        let normalCount = 0;
        let suspectCount = 0;
        let abnormalCount = 0;
        
        // Check BAD-D
        if (data.badD !== null) {
            indices.badD = { value: data.badD, label: 'BAD-D' };
            if (data.badD > TOPO_THRESHOLDS.badD.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `BAD-D ${data.badD.toFixed(2)} - ë¹„ì •ìƒ (ê¸°ì¤€: <${TOPO_THRESHOLDS.badD.suspect})` });
                indices.badD.status = 'danger';
            } else if (data.badD > TOPO_THRESHOLDS.badD.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `BAD-D ${data.badD.toFixed(2)} - ì˜ì‹¬ (ê¸°ì¤€: <${TOPO_THRESHOLDS.badD.normal})` });
                indices.badD.status = 'warning';
            } else {
                normalCount++;
                indices.badD.status = 'normal';
            }
        }
        
        // Check I-S value
        if (data.isValue !== null) {
            indices.isValue = { value: data.isValue, label: 'I-S' };
            if (data.isValue > TOPO_THRESHOLDS.isValue.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `I-S ${data.isValue.toFixed(2)}D - í•˜ë°© ê°€íŒŒë¦„ (ê¸°ì¤€: <${TOPO_THRESHOLDS.isValue.suspect})` });
                indices.isValue.status = 'danger';
            } else if (data.isValue > TOPO_THRESHOLDS.isValue.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `I-S ${data.isValue.toFixed(2)}D - ê²½ê³„ ë²”ìœ„` });
                indices.isValue.status = 'warning';
            } else {
                normalCount++;
                indices.isValue.status = 'normal';
            }
        }
        
        // Check Posterior Elevation
        if (data.posteriorElevation !== null) {
            indices.posteriorElev = { value: data.posteriorElevation, label: 'Post.Elev' };
            if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `í›„ë©´ ìœµê¸° ${data.posteriorElevation}Î¼m - ë¹„ì •ìƒ (ê¸°ì¤€: <${TOPO_THRESHOLDS.posteriorElevation.suspect})` });
                indices.posteriorElev.status = 'danger';
            } else if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `í›„ë©´ ìœµê¸° ${data.posteriorElevation}Î¼m - ê²½ê³„ ë²”ìœ„` });
                indices.posteriorElev.status = 'warning';
            } else {
                normalCount++;
                indices.posteriorElev.status = 'normal';
            }
        }
        
        // Check TCT
        if (data.tct !== null) {
            indices.tct = { value: data.tct, label: 'TCT' };
            if (data.tct < TOPO_THRESHOLDS.tct.danger) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `ìµœë°•ì  ë‘ê»˜ ${data.tct}Î¼m - ë§¤ìš° ì–‡ìŒ (ê¸°ì¤€: >${TOPO_THRESHOLDS.tct.danger})` });
                indices.tct.status = 'danger';
            } else if (data.tct < TOPO_THRESHOLDS.tct.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `ìµœë°•ì  ë‘ê»˜ ${data.tct}Î¼m - ë‹¤ì†Œ ì–‡ìŒ` });
                indices.tct.status = 'warning';
            } else {
                normalCount++;
                indices.tct.status = 'normal';
            }
        }
        
        // Check Thinnest location displacement
        if (data.thinnestDisplacement !== null) {
            indices.thinnestLoc = { value: data.thinnestDisplacement, label: 'Thin.Loc' };
            if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `ìµœë°•ì  ìœ„ì¹˜ íŽ¸ìœ„ ${data.thinnestDisplacement.toFixed(2)}mm - ë¹„ì •ìƒ` });
                indices.thinnestLoc.status = 'danger';
            } else if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `ìµœë°•ì  ìœ„ì¹˜ íŽ¸ìœ„ ${data.thinnestDisplacement.toFixed(2)}mm - ê²½ê³„` });
                indices.thinnestLoc.status = 'warning';
            } else {
                normalCount++;
                indices.thinnestLoc.status = 'normal';
            }
        }
        
        // Check Sim K astigmatism
        if (data.simKAstig !== null) {
            indices.simKAstig = { value: data.simKAstig, label: 'SimK Astig' };
            if (data.simKAstig > TOPO_THRESHOLDS.simKAstig.suspect) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `Sim K ë‚œì‹œ ${data.simKAstig.toFixed(2)}D - ê³ ë„ë‚œì‹œ` });
                indices.simKAstig.status = 'warning';
            } else {
                normalCount++;
                indices.simKAstig.status = 'normal';
            }
        }
        
        // Check Max K
        if (data.maxK !== null) {
            indices.maxK = { value: data.maxK, label: 'Kmax' };
            if (data.maxK > TOPO_THRESHOLDS.maxK.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `Kmax ${data.maxK.toFixed(2)}D - ë¹„ì •ìƒ (ê¸°ì¤€: <${TOPO_THRESHOLDS.maxK.suspect})` });
                indices.maxK.status = 'danger';
            } else if (data.maxK > TOPO_THRESHOLDS.maxK.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `Kmax ${data.maxK.toFixed(2)}D - ê²½ê³„ ë²”ìœ„` });
                indices.maxK.status = 'warning';
            } else {
                normalCount++;
                indices.maxK.status = 'normal';
            }
        }
        
        // Check KISA
        if (data.kisa !== null) {
            indices.kisa = { value: data.kisa, label: 'KISA%' };
            if (data.kisa > TOPO_THRESHOLDS.kisa.suspect) {
                abnormalCount++;
                findings.push({ icon: 'ðŸ”´', text: `KISA% ${data.kisa.toFixed(1)} - ì›ì¶”ê°ë§‰ ê°€ëŠ¥ì„± ë†’ìŒ` });
                indices.kisa.status = 'danger';
            } else if (data.kisa > TOPO_THRESHOLDS.kisa.normal) {
                suspectCount++;
                findings.push({ icon: 'ðŸŸ¡', text: `KISA% ${data.kisa.toFixed(1)} - ì˜ì‹¬ ë²”ìœ„` });
                indices.kisa.status = 'warning';
            } else {
                normalCount++;
                indices.kisa.status = 'normal';
            }
        }
        
        // Check pattern keywords
        if (data.hasInferiorSteepening) {
            suspectCount++;
            findings.push({ icon: 'ðŸŸ¡', text: 'í•˜ë°© ê°€íŒŒë¦„(Inferior Steepening) íŒ¨í„´ ê°ì§€' });
        }
        if (data.hasAsymmetricBowtie) {
            suspectCount++;
            findings.push({ icon: 'ðŸŸ¡', text: 'ë¹„ëŒ€ì¹­ ë‚˜ë¹„ë„¥íƒ€ì´(Asymmetric Bowtie) íŒ¨í„´ ê°ì§€' });
        }
        if (data.hasSuspectPattern) {
            abnormalCount++;
            findings.push({ icon: 'ðŸ”´', text: 'ì›ì¶”ê°ë§‰ ì˜ì‹¬ ì†Œê²¬ í‚¤ì›Œë“œ ê°ì§€' });
        }
        
        // Determine classification
        let classification, classLabel, confidence;
        
        if (abnormalCount >= 2 || (abnormalCount >= 1 && suspectCount >= 2)) {
            classification = 'abnormal';
            classLabel = 'Abnormal (KC suspect)';
            confidence = Math.min(95, 70 + abnormalCount * 10 + suspectCount * 5);
        } else if (abnormalCount >= 1 || suspectCount >= 2) {
            classification = 'suspect';
            classLabel = 'ì˜ì‹¬ (Suspect)';
            confidence = Math.min(90, 60 + abnormalCount * 15 + suspectCount * 10);
        } else if (suspectCount === 1) {
            classification = 'suspect';
            classLabel = 'ê²½ê³„ (Borderline)';
            confidence = Math.min(75, 50 + suspectCount * 15);
        } else if (normalCount > 0 || data.hasNormalPattern) {
            classification = 'normal';
            classLabel = 'ì •ìƒ (Normal)';
            confidence = Math.min(95, 70 + normalCount * 5);
        } else {
            classification = 'unknown';
            classLabel = 'íŒì • ë¶ˆê°€';
            confidence = 0;
        }
        
        // Add summary finding
        if (findings.length === 0) {
            findings.push({ icon: 'âœ…', text: 'ë¶„ì„ëœ ì§€í‘œë“¤ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìžˆìŠµë‹ˆë‹¤.' });
        }
        
        return {
            classification,
            classLabel,
            confidence,
            findings,
            indices,
            stats: { normalCount, suspectCount, abnormalCount }
        };
    }
    
    /**
     * Render analysis result to container
     */
    renderAnalysisResult(container, analysis, rawData) {
        const findingsHTML = analysis.findings
            .map(f => `<div class="ai-finding-item"><span class="finding-icon">${f.icon}</span><span>${f.text}</span></div>`)
            .join('');
        
        const indicesHTML = Object.entries(analysis.indices)
            .map(([key, val]) => `
                <div class="ai-index-item">
                    <span class="ai-index-label">${val.label}</span>
                    <span class="ai-index-value ${val.status}">${typeof val.value === 'number' ? val.value.toFixed(2) : val.value}</span>
                </div>
            `).join('');
        
        container.innerHTML = `
            <div class="ai-result-content">
                <div class="ai-result-header">
                    <div class="ai-classification ${analysis.classification}">
                        <span>${analysis.classification === 'normal' ? 'âœ…' : analysis.classification === 'abnormal' ? 'ðŸš«' : 'âš ï¸'}</span>
                        ${analysis.classLabel}
                    </div>
                    ${analysis.confidence > 0 ? `<span class="ai-confidence">ì‹ ë¢°ë„: ${analysis.confidence}%</span>` : ''}
                </div>
                <div class="ai-findings">${findingsHTML}</div>
                ${indicesHTML ? `<div class="ai-indices">${indicesHTML}</div>` : ''}
            </div>
        `;
    }
    
    /**
     * Auto-update topography select based on AI classification
     */
    updateTopographySelect(select, classification) {
        const mapping = {
            'normal': 'normal',
            'suspect': 'inferior-steepening',
            'abnormal': 'abnormal'
        };
        
        if (mapping[classification]) {
            select.value = mapping[classification];
            // Highlight that it was auto-updated
            select.style.borderColor = '#6366f1';
            select.title = 'AI ë¶„ì„ì— ì˜í•´ ìžë™ ì„¤ì •ë¨';
            setTimeout(() => {
                select.style.borderColor = '';
            }, 3000);
        }
    }
}

const ERSS_CRITERIA = {
    topography: {
        'normal': 0,
        'asymmetric-bowtie': 1,
        'inferior-steepening': 2,
        'abnormal': 4
    },
    rsb: [
        { max: 239, points: 4 },
        { max: 259, points: 3 },
        { max: 279, points: 2 },
        { max: 299, points: 1 },
        { max: Infinity, points: 0 }
    ],
    age: [
        { max: 17, points: 4 },
        { max: 21, points: 3 },
        { max: 25, points: 2 },
        { max: 29, points: 1 },
        { max: Infinity, points: 0 }
    ],
    cct: [
        { max: 449, points: 4 },
        { max: 479, points: 3 },
        { max: 509, points: 2 },
        { max: Infinity, points: 0 }
    ],
    mrse: [
        { max: -14, points: 4 },
        { max: -12, points: 3 },
        { max: -10, points: 2 },
        { max: -8, points: 1 },
        { max: Infinity, points: 0 }
    ]
};

function calculateAblationDepth(correction, opticalZone) {
    const ablationDepth = (Math.pow(opticalZone, 2) * Math.abs(correction)) / 3;
    return Math.round(ablationDepth * 10) / 10;
}

/**
 * Evaluate ablation depth risk level
 * Based on published literature:
 * - EyeWiki: >100Î¼m excessive ablation increases ectasia risk
 * - ESCRS 2024 (Dr. Ang): max 120Î¼m for LASIK
 * - Santhiago et al. 2014: ectasia group mean ablation 94Î¼m
 */
function evaluateAblationRisk(ablationDepth, surgeryType) {
    const isLasik = surgeryType === 'lasik' || surgeryType === 'LASIK';
    
    const safeThreshold = isLasik ? CONFIG.ABLATION_LASIK_SAFE : CONFIG.ABLATION_LASEK_SAFE;
    const cautionThreshold = isLasik ? CONFIG.ABLATION_LASIK_CAUTION : CONFIG.ABLATION_LASEK_CAUTION;
    
    if (ablationDepth <= safeThreshold) {
        return {
            level: 'safe',
            class: 'success',
            icon: 'âœ“',
            message: 'ì•ˆì „ ë²”ìœ„',
            detail: `ì ˆì‚­ëŸ‰ ${ablationDepth.toFixed(1)}Î¼mì€ ì•ˆì „ ë²”ìœ„(â‰¤${safeThreshold}Î¼m) ë‚´ìž…ë‹ˆë‹¤.`
        };
    } else if (ablationDepth <= cautionThreshold) {
        return {
            level: 'caution',
            class: 'warning',
            icon: 'âš ï¸',
            message: 'ì£¼ì˜ í•„ìš”',
            detail: `ì ˆì‚­ëŸ‰ ${ablationDepth.toFixed(1)}Î¼mì€ ê³ ë„ê·¼ì‹œ ì˜ì—­ìž…ë‹ˆë‹¤. ë©´ë°€í•œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ê¶Œìž¥: â‰¤${safeThreshold}Î¼m)`
        };
    } else {
        return {
            level: 'danger',
            class: 'danger',
            icon: 'ðŸš¨',
            message: 'ê²½ê³ : ê³¼ë„í•œ ì ˆì‚­',
            detail: `ì ˆì‚­ëŸ‰ ${ablationDepth.toFixed(1)}Î¼mì€ ê¶Œìž¥ ìƒí•œ(${cautionThreshold}Î¼m)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤. í™•ë§‰í™•ìž¥ì¦ ìœ„í—˜ì´ ì¦ê°€í•˜ë©°, ëŒ€ì•ˆì  ìˆ˜ìˆ  ë°©ë²•ì„ ê³ ë ¤í•˜ì„¸ìš”. [Ref: ESCRS 2024, Santhiago et al.]`
        };
    }
}

function calculateSE(sph, cyl) {
    return sph + (cyl / 2);
}

function calculateTotalCorrection(sph, cyl) {
    return Math.abs(sph) + Math.abs(cyl);
}

function calculateRSB(cct, flapThickness, ablationDepth) {
    return cct - flapThickness - ablationDepth;
}

function calculatePTA(cct, flapThickness, ablationDepth) {
    return ((flapThickness + ablationDepth) / cct) * 100;
}

function calculatePostopK(k1, k2, sph, cyl) {
    const minK = Math.min(k1, k2);
    const se = sph + (cyl / 2);
    const postopK = minK + (se * 0.75);
    return Math.round(postopK * 100) / 100;
}

function calculateERSS(params) {
    const { age, cct, topography, rsb, mrse } = params;
    
    const breakdown = {
        topography: ERSS_CRITERIA.topography[topography] || 0,
        rsb: 0,
        age: 0,
        cct: 0,
        mrse: 0
    };
    
    for (const criterion of ERSS_CRITERIA.rsb) {
        if (rsb <= criterion.max) {
            breakdown.rsb = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.age) {
        if (age <= criterion.max) {
            breakdown.age = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.cct) {
        if (cct <= criterion.max) {
            breakdown.cct = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.mrse) {
        if (mrse <= criterion.max) {
            breakdown.mrse = criterion.points;
            break;
        }
    }
    
    const total = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
    
    let riskLevel;
    if (total <= 2) {
        riskLevel = 'low';
    } else if (total === 3) {
        riskLevel = 'moderate';
    } else {
        riskLevel = 'high';
    }
    
    return { breakdown, total, riskLevel };
}

function getWellingtonNomogramAdjustments(sph, cyl, age) {
    const recommendations = [];
    const se = calculateSE(sph, cyl);
    
    if (se <= -6.0) {
        recommendations.push({
            title: 'ê³ ë„ê·¼ì‹œ ì¡°ì • (High Myopia)',
            text: `SE ${se.toFixed(2)}Dì˜ ê³ ë„ê·¼ì‹œìž…ë‹ˆë‹¤. Wellington nomogramì—ì„œëŠ” ê³ ë„ê·¼ì‹œ ì‹œ ì•½ê°„ì˜ ê³¼ì†Œêµì • ê²½í–¥ì´ ìžˆì–´ ëª©í‘œ êµ´ì ˆê°’ì„ -0.25 ~ -0.50Dë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì„ ê¶Œìž¥í•©ë‹ˆë‹¤.`
        });
    } else if (se >= -3.0 && se < 0) {
        recommendations.push({
            title: 'ê²½ë„ê·¼ì‹œ ì¡°ì • (Low Myopia)',
            text: `SE ${se.toFixed(2)}Dì˜ ê²½ë„ê·¼ì‹œìž…ë‹ˆë‹¤. Wellington nomogramì—ì„œëŠ” ê²½ë„ê·¼ì‹œ ì‹œ ì •í™•í•œ êµì •ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ëª©í‘œë¥¼ planoë¡œ ì„¤ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.`
        });
    }
    
    if (Math.abs(cyl) >= 2.0) {
        recommendations.push({
            title: 'ê³ ë„ë‚œì‹œ ì¡°ì • (High Astigmatism)',
            text: `ë‚œì‹œ ${cyl.toFixed(2)}Dê°€ 2D ì´ìƒìž…ë‹ˆë‹¤. ë‚œì‹œ êµì • ì‹œ coupling effectë¥¼ ê³ ë ¤í•˜ì—¬ êµ¬ë©´ êµì •ëŸ‰ì„ ì¡°ì •í•´ì•¼ í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ë‚œì‹œ êµì •ëŸ‰ì˜ 15-20%ë¥¼ êµ¬ë©´ì—ì„œ ì°¨ê°í•©ë‹ˆë‹¤.`
        });
    }
    
    if (age >= 40) {
        recommendations.push({
            title: 'ë…¸ì•ˆ ê³ ë ¤ (Presbyopia Consideration)',
            text: `í™˜ìž ë‚˜ì´ê°€ ${age}ì„¸ìž…ë‹ˆë‹¤. ë…¸ì•ˆì´ ì§„í–‰ ì¤‘ì¼ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ, ê·¼ê±°ë¦¬ ì‹œë ¥ì„ ìœ„í•´ ì£¼ì‹œì•ˆì€ plano, ë¹„ì£¼ì‹œì•ˆì€ -0.50 ~ -1.00Dì˜ monovisionì„ ê³ ë ¤í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.`
        });
    }
    
    if (se <= -8.0) {
        recommendations.push({
            title: 'íšŒê·€ ì˜ˆì¸¡ (Regression Prediction)',
            text: `ì´ˆê³ ë„ê·¼ì‹œ(-8D ì´ìƒ)ì—ì„œëŠ” ìˆ˜ìˆ  í›„ íšŒê·€ê°€ ë°œìƒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. 1ë…„ ë‚´ 0.5-1.0D ì •ë„ì˜ íšŒê·€ë¥¼ ì˜ˆìƒí•˜ê³  ì•½ê°„ì˜ ê³¼êµì •ì„ ê³ ë ¤í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.`
        });
    }
    
    if (recommendations.length === 0) {
        recommendations.push({
            title: 'í‘œì¤€ ì¹˜ë£Œ (Standard Treatment)',
            text: `í˜„ìž¬ êµ´ì ˆê°’(SE: ${se.toFixed(2)}D)ì€ í‘œì¤€ ë²”ìœ„ ë‚´ì— ìžˆìŠµë‹ˆë‹¤. Wellington nomogram ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì¹˜ë£Œ ì§„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
        });
    }
    
    return recommendations;
}

/**
 * Get combined ERSS + PTA risk interpretation
 * Based on literature: Santhiago et al., Chan et al. 2018
 * 
 * @param {number} erssScore - ERSS total score
 * @param {number} ptaLasik - PTA for LASIK
 * @param {string} topography - Topography pattern
 * @returns {Object} Combined risk interpretation
 */
function getCombinedRiskInterpretation(erssScore, ptaLasik, topography) {
    // Determine PTA risk level
    let ptaLevel;
    if (ptaLasik < 35) {
        ptaLevel = 'low';
    } else if (ptaLasik < 40) {
        ptaLevel = 'moderate';
    } else {
        ptaLevel = 'high';
    }
    
    // Determine ERSS risk level
    let erssLevel;
    if (erssScore <= 2) {
        erssLevel = 'low';
    } else if (erssScore === 3) {
        erssLevel = 'moderate';
    } else {
        erssLevel = 'high';
    }
    
    // Combined interpretation matrix
    const riskMatrix = {
        'low-low': {
            level: 'low',
            title: 'ì €ìœ„í—˜ (Low Risk)',
            text: 'ERSSì™€ PTA ëª¨ë‘ ì•ˆì „ ë²”ìœ„ ë‚´ì— ìžˆìŠµë‹ˆë‹¤. ìˆ˜ìˆ  ì í•©ì„±ì´ ë†’ìœ¼ë©°, ì¼ë°˜ì ì¸ ì£¼ì˜ì‚¬í•­ë§Œ ê³ ë ¤í•˜ë©´ ë©ë‹ˆë‹¤.',
            recommendations: [
                'í‘œì¤€ ìˆ˜ìˆ  í”„ë¡œí† ì½œ ì ìš© ê°€ëŠ¥',
                'ì •ê¸°ì ì¸ ìˆ  í›„ ê²½ê³¼ ê´€ì°° ê¶Œìž¥',
                'í™˜ìžì—ê²Œ ì¼ë°˜ì ì¸ ìœ„í—˜ì„± ì„¤ëª…'
            ]
        },
        'low-moderate': {
            level: 'low-moderate',
            title: 'ì €-ì¤‘ë“± ìœ„í—˜ (Low-Moderate Risk)',
            text: 'ERSSëŠ” ì €ìœ„í—˜ì´ë‚˜ PTAê°€ ê²½ê³„ ìˆ˜ì¤€ìž…ë‹ˆë‹¤. ERSSëŠ” ë³´ìˆ˜ì  ê²½í–¥ì´ ìžˆìœ¼ë¯€ë¡œ, PTA 35-40% êµ¬ê°„ì—ì„œëŠ” ì‹ ì¤‘í•œ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.',
            recommendations: [
                'ê°€ëŠ¥í•˜ë©´ í”Œëž© ë‘ê»˜ë¥¼ ì¤„ì´ê±°ë‚˜ LASEK ê³ ë ¤',
                'ê´‘í•™ë¶€ í¬ê¸° ì¡°ì •ìœ¼ë¡œ ì ˆì‚­ëŸ‰ ìµœì†Œí™” ê²€í† ',
                'ìˆ  í›„ ê°ë§‰í™•ìž¥ì¦ ì§•í›„ ë©´ë°€ížˆ ê´€ì°°'
            ]
        },
        'low-high': {
            level: 'moderate',
            title: 'ì¤‘ë“± ìœ„í—˜ (Moderate Risk)',
            text: 'ERSSëŠ” ì €ìœ„í—˜ì´ì§€ë§Œ PTA â‰¥40%ìž…ë‹ˆë‹¤. ì—°êµ¬ì— ë”°ë¥´ë©´ ì •ìƒ Topographyì—ì„œ PTAëŠ” ERSSë³´ë‹¤ ê°•í•œ ì˜ˆì¸¡ë ¥ì„ ë³´ìž…ë‹ˆë‹¤. ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.',
            recommendations: [
                'LASEK/PRKë¡œ ì „í™˜ ê°•ë ¥ ê¶Œìž¥',
                'ICL(ì•ˆë‚´ë Œì¦ˆì‚½ìž…ìˆ ) ëŒ€ì•ˆ ê²€í† ',
                'í™˜ìžì—ê²Œ ìœ„í—˜ì„± ì¶©ë¶„ížˆ ì„¤ëª… í›„ ë™ì˜ í•„ìš”',
                'ìˆ˜ìˆ  ì§„í–‰ ì‹œ ìµœì†Œ ì ˆì‚­ëŸ‰ ì›ì¹™ ì ìš©'
            ]
        },
        'moderate-low': {
            level: 'low-moderate',
            title: 'ì €-ì¤‘ë“± ìœ„í—˜ (Low-Moderate Risk)',
            text: 'ERSSê°€ ì¤‘ë“±ìœ„í—˜(3ì )ì´ë‚˜ PTAëŠ” ì•ˆì „í•©ë‹ˆë‹¤. ERSSëŠ” ë³´ìˆ˜ì  í‰ê°€ ê²½í–¥ì´ ìžˆì–´, PTAê°€ ë‚®ë‹¤ë©´ ì‹¤ì œ ìœ„í—˜ì€ ë‚®ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.',
            recommendations: [
                'Topography íŒ¨í„´ ìž¬í™•ì¸ í•„ìˆ˜',
                'ê°€ì¡±ë ¥ ë° ëˆˆ ë¹„ë¹„ëŠ” ìŠµê´€ í™•ì¸',
                'ê²½ê³„ì‹¬ì„ ê°–ê³  ìˆ˜ìˆ  ì§„í–‰ ê°€ëŠ¥',
                'ìˆ  í›„ ìž¥ê¸° ì¶”ì  ê´€ì°° ê³„íš ìˆ˜ë¦½'
            ]
        },
        'moderate-moderate': {
            level: 'moderate',
            title: 'ì¤‘ë“± ìœ„í—˜ (Moderate Risk)',
            text: 'ERSSì™€ PTA ëª¨ë‘ ê²½ê³„ ìˆ˜ì¤€ìž…ë‹ˆë‹¤. ë‘ ì§€í‘œê°€ ì¼ì¹˜í•˜ë¯€ë¡œ ì‹ ì¤‘í•œ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.',
            recommendations: [
                'LASEK/PRK ìš°ì„  ê³ ë ¤',
                'ê°ë§‰ ë‹¨ì¸µì´¬ì˜(Tomography) ì¶”ê°€ ê²€ì‚¬',
                'ê°ë§‰ ìƒì²´ì—­í•™ ê²€ì‚¬(ORA, Corvis ST) ê¶Œìž¥',
                'ìœ„í—˜-ì´ìµ ì¶©ë¶„ížˆ ì„¤ëª… í›„ í™˜ìž ê²°ì •'
            ]
        },
        'moderate-high': {
            level: 'high',
            title: 'ê³ ìœ„í—˜ (High Risk)',
            text: 'ERSS ì¤‘ë“±ìœ„í—˜ì— PTA â‰¥40%ìž…ë‹ˆë‹¤. ê°ë§‰í™•ìž¥ì¦ ìœ„í—˜ì´ ìœ ì˜í•˜ê²Œ ë†’ìŠµë‹ˆë‹¤.',
            recommendations: [
                'LASIK ë¹„ê¶Œìž¥ - LASEK ë˜ëŠ” ICL ê¶Œìž¥',
                'ìˆ˜ìˆ  ì „ Cross-linking ë³‘í–‰ ê³ ë ¤',
                'í™˜ìžì—ê²Œ ëŒ€ì•ˆ ìˆ˜ìˆ  ì ê·¹ ê¶Œìœ ',
                'ë¶€ë“ì´í•œ ê²½ìš° ìµœì†Œ êµì •ëŸ‰ ì›ì¹™'
            ]
        },
        'high-low': {
            level: 'moderate',
            title: 'ì¤‘ë“± ìœ„í—˜ (Moderate Risk)',
            text: 'ERSS ê³ ìœ„í—˜ì´ë‚˜ PTAëŠ” ì•ˆì „í•©ë‹ˆë‹¤. ERSSì˜ ë³´ìˆ˜ì  íŠ¹ì„±ìƒ ì‹¤ì œ ìœ„í—˜ì€ ë‚®ì„ ìˆ˜ ìžˆìœ¼ë‚˜, ERSS ì ìˆ˜ êµ¬ì„± ìš”ì†Œë¥¼ ê°œë³„ í™•ì¸í•˜ì„¸ìš”.',
            recommendations: [
                'ERSS ê³ ë“ì  ìš”ì¸ ê°œë³„ ë¶„ì„ (Topographyê°€ ì£¼ìš”ì¸ì¸ì§€ í™•ì¸)',
                'Topography ì´ìƒì´ ì›ì¸ì´ë©´ LASIK ìž¬ê³ ',
                'ë‚˜ì´/CCT/MRSEê°€ ì£¼ìš”ì¸ì´ë©´ ìƒëŒ€ì  ì•ˆì „',
                'ì¶”ê°€ ê²€ì‚¬ë¡œ í™•ì¸ í›„ ê²°ì •'
            ]
        },
        'high-moderate': {
            level: 'high',
            title: 'ê³ ìœ„í—˜ (High Risk)',
            text: 'ERSS ê³ ìœ„í—˜ì— PTAë„ ê²½ê³„ ìˆ˜ì¤€ìž…ë‹ˆë‹¤. ë³µí•©ì ì¸ ìœ„í—˜ ìš”ì†Œê°€ ìžˆìŠµë‹ˆë‹¤.',
            recommendations: [
                'LASIK ê°•ë ¥ ë¹„ê¶Œìž¥',
                'LASEKë„ ì‹ ì¤‘ížˆ ì ‘ê·¼',
                'ICL ë˜ëŠ” ì•ˆê²½/ë Œì¦ˆ êµì • ê¶Œìž¥',
                'ìˆ˜ìˆ  ì§„í–‰ ì‹œ ë°˜ë“œì‹œ informed consent'
            ]
        },
        'high-high': {
            level: 'very-high',
            title: 'ë§¤ìš° ê³ ìœ„í—˜ (Very High Risk)',
            text: 'ERSSì™€ PTA ëª¨ë‘ ê³ ìœ„í—˜ìž…ë‹ˆë‹¤. ê°ë§‰í™•ìž¥ì¦ ë°œìƒ ìœ„í—˜ì´ ë§¤ìš° ë†’ì•„ ê°ë§‰êµ´ì ˆìˆ˜ìˆ ì„ ê¶Œìž¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            recommendations: [
                'ê°ë§‰êµ´ì ˆìˆ˜ìˆ (LASIK/LASEK/SMILE) ê¸ˆê¸°',
                'ICL(ì•ˆë‚´ë Œì¦ˆì‚½ìž…ìˆ ) ê°•ë ¥ ê¶Œìž¥',
                'ì•ˆê²½ ë˜ëŠ” ì½˜íƒíŠ¸ë Œì¦ˆ êµì • ìœ ì§€',
                'ì›ì¶”ê°ë§‰ ì •ë°€ê²€ì‚¬ ê¶Œìž¥'
            ]
        }
    };
    
    const key = `${erssLevel}-${ptaLevel}`;
    const interpretation = riskMatrix[key] || riskMatrix['moderate-moderate'];
    
    return {
        erssLevel,
        ptaLevel,
        ...interpretation
    };
}

function determineSurgeryEligibility(rsb, pta, topography, erssTotal) {
    if (topography === 'abnormal') {
        return { status: 'not-eligible', message: 'ë¹„ì í•© (ê°ë§‰ì´ìƒ)' };
    }
    
    if (rsb < CONFIG.RSB_DANGER_THRESHOLD) {
        return { status: 'not-eligible', message: `ë¹„ì í•© (RSB < ${CONFIG.RSB_DANGER_THRESHOLD}Î¼m)` };
    }
    
    if (pta >= CONFIG.PTA_WARNING_THRESHOLD) {
        return { status: 'not-eligible', message: `ë¹„ì í•© (PTA â‰¥ ${CONFIG.PTA_WARNING_THRESHOLD}%)` };
    }
    
    if (erssTotal >= 4) {
        return { status: 'not-eligible', message: 'ë¹„ì í•© (ERSS â‰¥ 4)' };
    }
    
    if (rsb < CONFIG.RSB_SAFE_THRESHOLD || pta >= CONFIG.PTA_SAFE_THRESHOLD || erssTotal === 3) {
        return { status: 'caution', message: 'ì£¼ì˜ í•„ìš”' };
    }
    
    return { status: 'eligible', message: 'ì í•©' };
}

/**
 * Generate combined ERSS + PTA risk interpretation guide
 * Based on published literature (Santhiago et al., Chan et al., Randleman et al.)
 */
function generateCombinedRiskGuide(erssResult, ptaLasik, ptaLasek, topography) {
    const erss = erssResult.total;
    const guides = [];
    
    // Determine the overall risk category based on combined assessment
    const isNormalTopography = topography === 'normal';
    const isAbnormalTopography = topography === 'abnormal';
    const isSuspiciousTopography = topography === 'asymmetric-bowtie' || topography === 'inferior-steepening';
    
    // Case 1: Abnormal Topography - Highest priority risk factor
    if (isAbnormalTopography) {
        guides.push({
            type: 'high-risk',
            icon: 'ðŸš«',
            title: 'ì ˆëŒ€ì  ê¸ˆê¸°',
            condition: 'Abnormal Topography (KC suspect/FFKC)',
            text: 'ë¹„ì •ìƒ ê°ë§‰ ì§€í˜•ë„ëŠ” ERSSì—ì„œ ê°€ìž¥ ì¤‘ìš”í•œ ë‹¨ì¼ ìœ„í—˜ìš”ì†Œìž…ë‹ˆë‹¤. Randleman ì—°êµ¬ì—ì„œ ectasia ë°œìƒ ëˆˆì˜ 69%ê°€ ë¹„ì •ìƒ topographyë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : ì‹œë ¥êµì •ìˆ  ê¸ˆê¸°. Cross-linking ë˜ëŠ” ë‹¤ë¥¸ ì¹˜ë£Œ ì˜µì…˜ ê³ ë ¤.'
        });
        return guides;
    }
    
    // Case 2: High ERSS + High PTA
    if (erss >= 4 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: 'â›”',
            title: 'ê³ ìœ„í—˜ - ë³µí•© ìœ„í—˜ìš”ì†Œ',
            condition: `ERSS â‰¥ 4 (í˜„ìž¬: ${erss}) + PTA â‰¥ 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSSì™€ PTA ëª¨ë‘ ê³ ìœ„í—˜ ë²”ìœ„ìž…ë‹ˆë‹¤. ë‘ ì§€í‘œê°€ ë™ì‹œì— ë†’ì„ ê²½ìš° ectasia ë°œìƒ ìœ„í—˜ì´ í¬ê²Œ ì¦ê°€í•©ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : LASIK ë¶€ì í•©. LASEK/PRK ë˜ëŠ” ICL ë“± ëŒ€ì•ˆ ê³ ë ¤.'
        });
    }
    // Case 3: High ERSS but Low PTA with Normal Topography
    else if (erss >= 4 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: 'âš ï¸',
            title: 'ì£¼ì˜ - ERSS ê³¼ëŒ€í‰ê°€ ê°€ëŠ¥ì„±',
            condition: `ERSS â‰¥ 4 (í˜„ìž¬: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), ì •ìƒ Topography`,
            text: 'Binder & Trattler (2010) ì—°êµ¬ì— ë”°ë¥´ë©´, ì •ìƒ topographyì—ì„œ ERSSê°€ ë†’ë”ë¼ë„ ì‹¤ì œ ectasia ë°œìƒë¥ ì€ ë§¤ìš° ë‚®ì•˜ìŠµë‹ˆë‹¤. ERSSê°€ ìœ„í—˜ì„ ê³¼ëŒ€í‰ê°€í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : ì‹ ì¤‘í•œ í‰ê°€ í•„ìš”. Tomography(Pentacam ë“±) ì¶”ê°€ ê²€ì‚¬ ê¶Œìž¥.'
        });
    }
    // Case 4: Low ERSS but High PTA
    else if (erss <= 2 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: 'âš ï¸',
            title: 'ì£¼ì˜ - PTA ë‹¨ë… ê³ ìœ„í—˜',
            condition: `ERSS â‰¤ 2 (í˜„ìž¬: ${erss}), PTA â‰¥ 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'Santhiago ì—°êµ¬ì—ì„œ PTA â‰¥ 40%ëŠ” ERSSë³´ë‹¤ ectasia ì˜ˆì¸¡ì— ë” ê°•í•œ ìƒê´€ê´€ê³„ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. ERSSê°€ ë‚®ë”ë¼ë„ ë†’ì€ PTAëŠ” ìœ„í—˜ ì‹ í˜¸ìž…ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : LASIK ëŒ€ì‹  LASEK/PRK ê¶Œìž¥ (ë” ë‚®ì€ PTA).'
        });
    }
    // Case 5: Moderate ERSS + Moderate PTA
    else if (erss === 3 && ptaLasik >= 35 && ptaLasik < 40) {
        guides.push({
            type: 'moderate-risk',
            icon: 'âš¡',
            title: 'ì¤‘ë“±ë„ ìœ„í—˜ - ê²½ê³„ ë²”ìœ„',
            condition: `ERSS = 3, PTA 35-40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSS 3ì ì€ "ì£¼ì˜" ë²”ìœ„ì´ë©°, PTAë„ ê²½ê³„ ìˆ˜ì¤€ìž…ë‹ˆë‹¤. ë‹¤ê¸°ê´€ ì—°êµ¬ì—ì„œ ì´ ë²”ìœ„ëŠ” ê°œë³„ ì‚¬ë¡€ë³„ íŒë‹¨ì´ í•„ìš”í•œ ì˜ì—­ìž…ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : ì¶”ê°€ ê²€ì‚¬(Tomography, Biomechanics) í›„ ê²°ì •. LASEKì´ ë” ì•ˆì „í•  ìˆ˜ ìžˆìŒ.'
        });
    }
    // Case 6: Low ERSS + Low PTA + Normal Topography
    else if (erss <= 2 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'low-risk',
            icon: 'âœ…',
            title: 'ì €ìœ„í—˜ - ì–‘í˜¸í•œ ì¡°ê±´',
            condition: `ERSS â‰¤ 2 (í˜„ìž¬: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), ì •ìƒ Topography`,
            text: 'ERSS, PTA, Topography ëª¨ë‘ ì–‘í˜¸í•©ë‹ˆë‹¤. ë‹¤ê¸°ê´€ ì—°êµ¬ì—ì„œ ì´ ì¡°í•©ì€ ectasia ë°œìƒ ìœ„í—˜ì´ ê°€ìž¥ ë‚®ì€ ê·¸ë£¹ìž…ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : LASIK ì í•©. í‘œì¤€ ìˆ˜ìˆ  í”„ë¡œí† ì½œ ì ìš© ê°€ëŠ¥.'
        });
    }
    // Case 7: Suspicious Topography
    else if (isSuspiciousTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: 'ðŸ”',
            title: 'ì¶”ê°€ ê²€ì‚¬ í•„ìš” - ì˜ì‹¬ ì†Œê²¬',
            condition: `Suspicious Topography (${topography === 'asymmetric-bowtie' ? 'Asymmetric Bowtie' : 'Inferior Steepening/SRA'})`,
            text: 'ì˜ì‹¬ìŠ¤ëŸ¬ìš´ topography íŒ¨í„´ì€ subclinical keratoconusì˜ ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤. ERSSì™€ PTA ìˆ˜ì¹˜ì™€ ë¬´ê´€í•˜ê²Œ ì¶”ê°€ í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : Pentacam, Corneal Biomechanics ê²€ì‚¬ í•„ìˆ˜. ê°€ì¡±ë ¥/ëˆˆ ë¹„ë¹„ëŠ” ìŠµê´€ í™•ì¸.'
        });
    }
    // Default moderate case
    else {
        guides.push({
            type: 'moderate-risk',
            icon: 'ðŸ“‹',
            title: 'ê°œë³„ í‰ê°€ í•„ìš”',
            condition: `ERSS: ${erss}, PTA(LASIK): ${ptaLasik.toFixed(1)}%`,
            text: 'ë³µí•© ì§€í‘œê°€ ëª…í™•í•œ ë²”ì£¼ì— í•´ë‹¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°œë³„ ìœ„í—˜ìš”ì†Œë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.',
            recommendation: 'ê¶Œê³ : ì „ë¬¸ì˜ ìƒë‹´ ë° ì¶”ê°€ ê²€ì‚¬ ê¶Œìž¥.'
        });
    }
    
    // Add LASEK comparison if relevant
    if (ptaLasek < ptaLasik && ptaLasik >= 35) {
        guides.push({
            type: 'low-risk',
            icon: 'ðŸ’¡',
            title: 'LASEK/PRK ëŒ€ì•ˆ ê³ ë ¤',
            condition: `LASEK PTA: ${ptaLasek.toFixed(1)}% vs LASIK PTA: ${ptaLasik.toFixed(1)}%`,
            text: `LASEKì€ í”Œëž©ì´ ì—†ì–´ PTAê°€ ${(ptaLasik - ptaLasek).toFixed(1)}% ë‚®ìŠµë‹ˆë‹¤. ê²½ê³„ ë²”ìœ„ì˜ í™˜ìžì—ì„œ LASEKì´ ë” ì•ˆì „í•œ ì„ íƒì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.`,
            recommendation: 'ê¶Œê³ : LASEK/PRKë¡œ ì „í™˜ ì‹œ ectasia ìœ„í—˜ ê°ì†Œ ê¸°ëŒ€.'
        });
    }
    
    return guides;
}

class RefractiveCalculator {
    constructor() {
        this.form = document.getElementById('patient-form');
        this.resultsContainer = document.getElementById('results-container');
        this.resultsTemplate = document.getElementById('results-template');
        this.currentEye = 'od'; // í˜„ìž¬ í™œì„± íƒ­
        this.results = {}; // ì–‘ì•ˆ ê²°ê³¼ ì €ìž¥
        this.init();
    }
    
    init() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.calculate();
        });
        
        // ì–‘ì•ˆ SE ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        ['od', 'os'].forEach(eye => {
            const sphInput = document.getElementById(`${eye}-sph`);
            const cylInput = document.getElementById(`${eye}-cyl`);
            
            [sphInput, cylInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => this.updateSE(eye));
                }
            });
        });
        
        // ODâ†’OS ë³µì‚¬ ë²„íŠ¼
        const copyBtn = document.getElementById('copy-od-to-os');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => this.copyODtoOS());
        }
        
        // í…Œë§ˆ í† ê¸€
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => this.toggleTheme());
        
        // Tab í‚¤ ì´ë™ ê°œì„  - Enter í‚¤ë¡œë„ ë‹¤ìŒ í•„ë“œ ì´ë™
        this.setupTabNavigation();
        
        this.loadTheme();
        this.updateSE('od');
        this.updateSE('os');
    }
    
    setupTabNavigation() {
        // ìž…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¥¼ ëˆ„ë¥´ë©´ Tabì²˜ëŸ¼ ë‹¤ìŒ í•„ë“œë¡œ ì´ë™
        const inputs = this.form.querySelectorAll('input, select');
        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextInput = inputs[index + 1];
                    if (nextInput) {
                        nextInput.focus();
                        if (nextInput.select) nextInput.select();
                    } else {
                        // ë§ˆì§€ë§‰ í•„ë“œì—ì„œ Enter ì‹œ ê³„ì‚° ì‹¤í–‰
                        this.calculate();
                    }
                }
            });
            
            // ìˆ«ìž ìž…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ ì‹œ ì „ì²´ ì„ íƒ
            if (input.type === 'number') {
                input.addEventListener('focus', () => {
                    input.select();
                });
            }
        });
    }
    
    copyODtoOS() {
        const fields = [
            'sph', 'cyl', 'axis', 'cct', 'k1', 'k2', 'steep-axis', 'topography',
            'optical-zone', 'lasik-flap', 'lasek-epi', 'smile-cap'
        ];
        fields.forEach(field => {
            const odValue = document.getElementById(`od-${field}`)?.value;
            const osInput = document.getElementById(`os-${field}`);
            if (odValue !== undefined && osInput) {
                osInput.value = odValue;
            }
        });
        this.updateSE('os');
    }
    
    updateSE(eye) {
        const sph = parseFloat(document.getElementById(`${eye}-sph`)?.value) || 0;
        const cyl = parseFloat(document.getElementById(`${eye}-cyl`)?.value) || 0;
        const se = calculateSE(sph, cyl);
        const seDisplay = document.getElementById(`${eye}-se-display`);
        if (seDisplay) {
            seDisplay.textContent = `${se.toFixed(2)} D`;
        }
    }
    
    getFormData() {
        const formData = new FormData(this.form);
        const common = {
            patientName: formData.get('patient-name') || '',
            patientId: formData.get('patient-id') || '',
            age: parseInt(formData.get('age')),
            gender: formData.get('gender')
        };
        
        return {
            common,
            od: {
                eye: 'OD',
                sph: parseFloat(formData.get('od-sph')),
                cyl: parseFloat(formData.get('od-cyl')),
                axis: parseInt(formData.get('od-axis')),
                cct: parseInt(formData.get('od-cct')),
                k1: parseFloat(formData.get('od-k1')),
                k2: parseFloat(formData.get('od-k2')),
                steepAxis: parseInt(formData.get('od-steep-axis')),
                topography: formData.get('od-topography'),
                opticalZone: parseFloat(formData.get('od-optical-zone')),
                lasikFlap: parseInt(formData.get('od-lasik-flap')),
                lasekEpi: parseInt(formData.get('od-lasek-epi')),
                smileCap: parseInt(formData.get('od-smile-cap')),
                ...common
            },
            os: {
                eye: 'OS',
                sph: parseFloat(formData.get('os-sph')),
                cyl: parseFloat(formData.get('os-cyl')),
                axis: parseInt(formData.get('os-axis')),
                cct: parseInt(formData.get('os-cct')),
                k1: parseFloat(formData.get('os-k1')),
                k2: parseFloat(formData.get('os-k2')),
                steepAxis: parseInt(formData.get('os-steep-axis')),
                topography: formData.get('os-topography'),
                opticalZone: parseFloat(formData.get('os-optical-zone')),
                lasikFlap: parseInt(formData.get('os-lasik-flap')),
                lasekEpi: parseInt(formData.get('os-lasek-epi')),
                smileCap: parseInt(formData.get('os-smile-cap')),
                ...common
            }
        };
    }
    
    calculateForEye(data) {
        const se = calculateSE(data.sph, data.cyl);
        const totalCorrection = calculateTotalCorrection(data.sph, data.cyl);
        const ablationDepth = calculateAblationDepth(totalCorrection, data.opticalZone);
        
        const surgeryResults = {
            lasik: {
                name: 'LASIK',
                flapThickness: data.lasikFlap,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasikFlap, ablationDepth),
                pta: calculatePTA(data.cct, data.lasikFlap, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasik')
            },
            lasek: {
                name: 'LASEK/PRK',
                flapThickness: data.lasekEpi,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasekEpi, ablationDepth),
                pta: calculatePTA(data.cct, data.lasekEpi, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasek')
            },
            smile: {
                name: 'SMILE',
                flapThickness: data.smileCap,
                ablation: ablationDepth,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.smileCap, ablationDepth),
                pta: calculatePTA(data.cct, data.smileCap, ablationDepth),
                ablationRisk: evaluateAblationRisk(ablationDepth, 'lasik') // SMILE uses similar thresholds
            }
        };
        
        const preopK = Math.min(data.k1, data.k2);
        const postopK = calculatePostopK(data.k1, data.k2, data.sph, data.cyl);
        
        const erssResult = calculateERSS({
            age: data.age,
            cct: data.cct,
            topography: data.topography,
            rsb: surgeryResults.lasik.rsb,
            mrse: se
        });
        
        Object.keys(surgeryResults).forEach(key => {
            const result = surgeryResults[key];
            if (key === 'smile') {
                result.eligibility = { status: 'pending', message: 'ì¤€ë¹„ì¤‘' };
            } else {
                result.eligibility = determineSurgeryEligibility(
                    result.rsb,
                    result.pta,
                    data.topography,
                    erssResult.total
                );
            }
        });
        
        const nomogramRecommendations = getWellingtonNomogramAdjustments(
            data.sph,
            data.cyl,
            data.age
        );
        
        const combinedRiskInterpretation = getCombinedRiskInterpretation(
            erssResult.total,
            surgeryResults.lasik.pta,
            data.topography
        );
        
        const combinedRiskGuide = generateCombinedRiskGuide(
            erssResult,
            surgeryResults.lasik.pta,
            surgeryResults.lasek.pta,
            data.topography
        );
        
        return {
            surgeryResults,
            preopK,
            postopK,
            erssResult,
            nomogramRecommendations,
            combinedRiskInterpretation,
            combinedRiskGuide,
            se,
            data
        };
    }
    
    calculate() {
        const formData = this.getFormData();
        
        // ì–‘ì•ˆ ê°ê° ê³„ì‚°
        this.results = {
            od: this.calculateForEye(formData.od),
            os: this.calculateForEye(formData.os)
        };
        
        this.renderResults();
    }
    
    renderResults() {
        const template = this.resultsTemplate.content.cloneNode(true);
        
        // ì–‘ì•ˆ íƒ­ ì´ë²¤íŠ¸ ì„¤ì •
        const eyeTabs = template.querySelectorAll('.eye-tab');
        eyeTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const eye = e.currentTarget.dataset.eye;
                this.switchEyeTab(eye);
            });
        });
        
        // ì–‘ì•ˆ ê°ê° ë Œë”ë§
        ['od', 'os'].forEach(eye => {
            this.renderEyeResults(template, eye, this.results[eye]);
        });
        
        this.resultsContainer.innerHTML = '';
        this.resultsContainer.appendChild(template);
        
        this.setupActionButtons();
    }
    
    renderEyeResults(template, eye, results) {
        // Summary cards
        ['lasik', 'lasek', 'smile'].forEach(key => {
            const summaryItem = template.querySelector(`#summary-${key}-${eye}`);
            if (summaryItem) {
                const result = results.surgeryResults[key];
                summaryItem.classList.add(result.eligibility.status);
                summaryItem.querySelector('.surgery-status').textContent = result.eligibility.message;
            }
        });
        
        // Ablation table
        const tableBody = template.querySelector(`#ablation-table-body-${eye}`);
        if (tableBody) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                const row = document.createElement('tr');
                
                // Ablation risk class
                let ablationClass = 'success';
                if (result.ablationRisk) {
                    if (result.ablationRisk.level === 'caution') ablationClass = 'warning';
                    if (result.ablationRisk.level === 'danger') ablationClass = 'danger';
                }
                
                let rsbClass = 'success';
                if (result.rsb < CONFIG.RSB_WARNING_THRESHOLD) rsbClass = 'warning';
                if (result.rsb < CONFIG.RSB_DANGER_THRESHOLD) rsbClass = 'danger';
                
                let ptaClass = 'success';
                if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) ptaClass = 'warning';
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) ptaClass = 'danger';
                
                const ablationIcon = result.ablationRisk ? result.ablationRisk.icon : '';
                
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td class="${ablationClass}" title="${result.ablationRisk ? result.ablationRisk.detail : ''}">${ablationIcon} ${result.ablationDepth.toFixed(1)}</td>
                    <td class="${rsbClass}">${result.rsb.toFixed(1)}</td>
                    <td class="${ptaClass}">${result.pta.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add ablation warning message if needed
            const lasikRisk = results.surgeryResults.lasik?.ablationRisk;
            const lasekRisk = results.surgeryResults.lasek?.ablationRisk;
            
            if ((lasikRisk && lasikRisk.level !== 'safe') || (lasekRisk && lasekRisk.level !== 'safe')) {
                const warningRow = document.createElement('tr');
                warningRow.className = 'ablation-warning-row';
                const riskToShow = lasikRisk?.level === 'danger' ? lasikRisk : 
                                   lasekRisk?.level === 'danger' ? lasekRisk :
                                   lasikRisk?.level === 'caution' ? lasikRisk : lasekRisk;
                warningRow.innerHTML = `
                    <td colspan="4" class="${riskToShow.class}" style="font-size: 0.75rem; padding: 8px;">
                        ${riskToShow.icon} <strong>${riskToShow.message}</strong>: ${riskToShow.detail}
                    </td>
                `;
                tableBody.appendChild(warningRow);
            }
        }
        
        // K values
        const preopK = template.querySelector(`#preop-k-${eye}`);
        const postopK = template.querySelector(`#postop-k-${eye}`);
        if (preopK) preopK.textContent = `${results.preopK.toFixed(2)} D`;
        if (postopK) postopK.textContent = `${results.postopK.toFixed(2)} D`;
        
        // K warning
        const kWarning = template.querySelector(`#k-warning-${eye}`);
        if (kWarning) {
            if (results.postopK < CONFIG.K_OPTIMAL_MIN) {
                kWarning.textContent = `âš ï¸ ìˆ˜ìˆ  í›„ ê°ë§‰ì´ ê³¼ë„í•˜ê²Œ íŽ¸í‰í•´ì§ˆ ìˆ˜ ìžˆìŠµë‹ˆë‹¤ (K < ${CONFIG.K_OPTIMAL_MIN}D).`;
                kWarning.classList.add('warning');
            } else if (results.postopK < CONFIG.K_MIN_SAFE) {
                kWarning.textContent = `âŒ ìˆ˜ìˆ  í›„ ê°ë§‰ êµ´ì ˆë ¥ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤ (K < ${CONFIG.K_MIN_SAFE}D).`;
                kWarning.classList.add('warning');
            } else {
                kWarning.textContent = `âœ“ ìˆ˜ìˆ  í›„ ì˜ˆìƒ Kê°’ì´ ì•ˆì „ ë²”ìœ„ ë‚´ì— ìžˆìŠµë‹ˆë‹¤.`;
            }
        }
        
        // ERSS breakdown
        const erssBreakdown = template.querySelector(`#erss-breakdown-${eye}`);
        if (erssBreakdown) {
            const labels = {
                topography: 'Topography',
                rsb: 'RSB',
                age: 'Age',
                cct: 'CCT',
                mrse: 'MRSE'
            };
            
            Object.entries(results.erssResult.breakdown).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'erss-item';
                item.innerHTML = `
                    <span class="erss-item-label">${labels[key]}</span>
                    <span class="erss-item-score">${value}</span>
                `;
                erssBreakdown.appendChild(item);
            });
        }
        
        // ERSS total
        const erssTotal = template.querySelector(`#erss-total-score-${eye}`);
        if (erssTotal) erssTotal.textContent = results.erssResult.total;
        
        const riskLevel = template.querySelector(`#erss-risk-level-${eye}`);
        if (riskLevel) {
            riskLevel.textContent = results.erssResult.riskLevel === 'low' ? 'Low Risk' :
                results.erssResult.riskLevel === 'moderate' ? 'Moderate Risk' : 'High Risk';
            riskLevel.classList.add(results.erssResult.riskLevel);
        }
        
        // PTA display
        const ptaDisplay = template.querySelector(`#pta-display-${eye}`);
        if (ptaDisplay) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                let ptaClass = 'safe';
                let ptaStatus = 'ì•ˆì „';
                
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) {
                    ptaClass = 'danger';
                    ptaStatus = 'ìœ„í—˜';
                } else if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) {
                    ptaClass = 'caution';
                    ptaStatus = 'ì£¼ì˜';
                }
                
                const item = document.createElement('div');
                item.className = `pta-item ${ptaClass}`;
                item.innerHTML = `
                    <div class="pta-surgery">${result.name}</div>
                    <div class="pta-value">${result.pta.toFixed(1)}%</div>
                    <div class="pta-status">${ptaStatus}</div>
                `;
                ptaDisplay.appendChild(item);
            });
        }
        
        // Combined risk matrix
        this.renderCombinedRiskMatrix(template, eye, results);
        
        // Nomogram info
        const nomogramInfo = template.querySelector(`#nomogram-info-${eye}`);
        if (nomogramInfo) {
            results.nomogramRecommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'nomogram-item';
                item.innerHTML = `
                    <div class="nomogram-title">${rec.title}</div>
                    <div class="nomogram-text">${rec.text}</div>
                `;
                nomogramInfo.appendChild(item);
            });
        }
    }
    
    renderCombinedRiskMatrix(template, eye, results) {
        const interpretation = results.combinedRiskInterpretation;
        const lasikPta = results.surgeryResults.lasik.pta;
        const erssScore = results.erssResult.total;
        
        const matrixContainer = template.querySelector(`#combined-risk-matrix-${eye}`);
        if (matrixContainer) {
            const matrixHTML = `
                <div class="matrix-cell matrix-header"></div>
                <div class="matrix-cell matrix-header">PTA &lt;35%<br>(ì €ìœ„í—˜)</div>
                <div class="matrix-cell matrix-header">PTA 35-40%<br>(ì¤‘ë“±ìœ„í—˜)</div>
                <div class="matrix-cell matrix-header">PTA â‰¥40%<br>(ê³ ìœ„í—˜)</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 0-2<br>(ì €ìœ„í—˜)</div>
                <div class="matrix-cell risk-low ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'low')}">ì €ìœ„í—˜</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'moderate')}">ì €-ì¤‘ë“±</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'high')}">ì¤‘ë“±ìœ„í—˜</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 3<br>(ì¤‘ë“±ìœ„í—˜)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'low')}">ì €-ì¤‘ë“±</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'moderate')}">ì¤‘ë“±ìœ„í—˜</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'high')}">ê³ ìœ„í—˜</div>
                
                <div class="matrix-cell matrix-row-header">ERSS â‰¥4<br>(ê³ ìœ„í—˜)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'low')}">ì¤‘ë“±ìœ„í—˜</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'moderate')}">ê³ ìœ„í—˜</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'high')}">ë§¤ìš° ê³ ìœ„í—˜</div>
            `;
            matrixContainer.innerHTML = matrixHTML;
        }
        
        const guideContainer = template.querySelector(`#interpretation-guide-${eye}`);
        if (guideContainer && interpretation) {
            let badgeClass = 'low';
            if (interpretation.level === 'moderate' || interpretation.level === 'low-moderate') {
                badgeClass = 'moderate';
            } else if (interpretation.level === 'high' || interpretation.level === 'very-high') {
                badgeClass = 'high';
            }
            
            const recommendationsHTML = interpretation.recommendations
                .map(rec => `<li>${rec}</li>`)
                .join('');
            
            guideContainer.innerHTML = `
                <div class="interpretation-title">
                    ${interpretation.title}
                    <span class="interpretation-badge ${badgeClass}">
                        ERSS ${erssScore}ì  + PTA ${lasikPta.toFixed(1)}%
                    </span>
                </div>
                <div class="interpretation-text">${interpretation.text}</div>
                <div class="interpretation-recommendations">
                    <h5>ê¶Œìž¥ ì‚¬í•­</h5>
                    <ul class="recommendation-list">
                        ${recommendationsHTML}
                    </ul>
                </div>
            `;
        }
    }
    
    getMatrixHighlight(erssScore, pta, erssLevel, ptaLevel) {
        let currentErssLevel;
        if (erssScore <= 2) currentErssLevel = 'low';
        else if (erssScore === 3) currentErssLevel = 'moderate';
        else currentErssLevel = 'high';
        
        let currentPtaLevel;
        if (pta < 35) currentPtaLevel = 'low';
        else if (pta < 40) currentPtaLevel = 'moderate';
        else currentPtaLevel = 'high';
        
        if (currentErssLevel === erssLevel && currentPtaLevel === ptaLevel) {
            return 'current-position';
        }
        return '';
    }
    
    switchEyeTab(eye) {
        this.currentEye = eye;
        
        // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.eye-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.eye === eye);
        });
        
        // ê²°ê³¼ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
        document.querySelectorAll('.eye-results-content').forEach(content => {
            content.classList.toggle('active', content.id === `results-${eye}`);
        });
    }
    
    setupActionButtons() {
        document.getElementById('btn-print')?.addEventListener('click', () => {
            printPatientReport();
        });
        
        document.getElementById('btn-save')?.addEventListener('click', () => {
            this.saveResults();
        });
        
        document.getElementById('btn-new')?.addEventListener('click', () => {
            this.form.reset();
            this.resultsContainer.innerHTML = `
                <div class="results-placeholder">
                    <div class="placeholder-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                            <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <p>í™˜ìž ì •ë³´ë¥¼ ìž…ë ¥í•˜ê³ <br><strong>ê³„ì‚°í•˜ê¸°</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                </div>
            `;
            this.updateSE('od');
            this.updateSE('os');
        });
    }
    
    saveResults() {
        const formData = this.getFormData();
        const results = this.results;
        
        // Use enhanced save function
        const savedPatient = savePatientData(formData, results);
        
        showNotification(`${savedPatient.patientName || savedPatient.patientId || 'í™˜ìž'} ë°ì´í„°ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        console.log('Saved patient:', savedPatient);
    }
    
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }
    
    loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
}

// ============================================
// EX500 Nomogram Calculator Functions
// ============================================

/**
 * 메인 폼에서 Nomogram 입력란으로 값 복사
 */
function copyFromMainForm(eye) {
    const prefix = eye === 'od' ? 'od' : 'os';
    
    // SPH, CYL, AXIS 복사
    const sph = document.getElementById(`${prefix}-sph`)?.value || -3;
    const cyl = document.getElementById(`${prefix}-cyl`)?.value || -1;
    const axis = document.getElementById(`${prefix}-axis`)?.value || 180;
    
    document.getElementById(`nomo-${prefix}-sph`).value = sph;
    document.getElementById(`nomo-${prefix}-cyl`).value = cyl;
    document.getElementById(`nomo-${prefix}-axis`).value = axis;
    
    // 나이 복사
    const age = document.getElementById('age')?.value || 25;
    document.getElementById('nomo-age').value = age;
    
    showNotification(`${eye.toUpperCase()} 값이 복사되었습니다.`, 'success');
}

/**
 * Streamlight/CustomQ(WFO) 모드 Nomogram 계산
 * 기본적으로 Manifest Refraction 사용, 나이별 조정만 적용
 */
function calculateStreamlightNomogram(manifestSph, manifestCyl, manifestAxis, age) {
    // 나이별 SPH 조정 (Wellington Nomogram 기반)
    let sphAdjustment = 0;
    let ageNote = '';
    
    if (age < 25) {
        // 젊은 환자: 약간 과교정 (근시 퇴행 대비)
        sphAdjustment = -0.25; // 더 많이 깎음
        ageNote = '20대 초반: +0.25D 과교정 권장 (조절력 보상, 퇴행 대비)';
    } else if (age >= 25 && age < 35) {
        // 표준
        sphAdjustment = 0;
        ageNote = '25-34세: 표준 교정';
    } else if (age >= 35 && age < 40) {
        // 노안 시작 전
        sphAdjustment = 0;
        ageNote = '35-39세: 표준 교정, 노안 고려 상담 필요';
    } else if (age >= 40 && age < 45) {
        // 노안 시작
        sphAdjustment = 0.25; // 덜 깎음
        ageNote = '40-44세: -0.25D 저교정 권장 (노안 고려)';
    } else {
        // 45세 이상
        sphAdjustment = 0.25;
        ageNote = '45세 이상: -0.25D 저교정 권장 (노안, monovision 고려)';
    }
    
    // 고도근시 조정 (SE > -6D인 경우)
    const se = manifestSph + (manifestCyl / 2);
    let highMyopiaAdjustment = 0;
    let highMyopiaNote = '';
    
    if (se < -6) {
        // EX500은 고도근시에서 "hot" 작동 → 과교정 경향
        highMyopiaAdjustment = Math.abs(se) * 0.05; // 5% 감소
        highMyopiaNote = `고도근시 (SE: ${se.toFixed(2)}D): ${(highMyopiaAdjustment).toFixed(2)}D 감소 적용`;
    } else if (se > -3) {
        // 저도근시에서 "cold" 작동 → 저교정 경향
        highMyopiaAdjustment = -0.12; // 약간 더 깎음
        highMyopiaNote = `저도근시 (SE: ${se.toFixed(2)}D): 0.12D 추가 적용`;
    }
    
    // 최종 Modified 값 계산
    const modifiedSph = parseFloat(manifestSph) + sphAdjustment + highMyopiaAdjustment;
    const modifiedCyl = parseFloat(manifestCyl); // CYL은 변경 없음
    const modifiedAxis = parseFloat(manifestAxis); // Axis도 변경 없음
    
    return {
        mode: 'Streamlight/CustomQ (WFO)',
        manifest: {
            sph: parseFloat(manifestSph),
            cyl: parseFloat(manifestCyl),
            axis: parseFloat(manifestAxis),
            se: se
        },
        modified: {
            sph: Math.round(modifiedSph * 4) / 4, // 0.25D 단위로 반올림
            cyl: modifiedCyl,
            axis: modifiedAxis,
            se: Math.round(modifiedSph * 4) / 4 + (modifiedCyl / 2)
        },
        adjustments: {
            age: sphAdjustment,
            highMyopia: highMyopiaAdjustment,
            total: sphAdjustment + highMyopiaAdjustment
        },
        notes: {
            age: ageNote,
            highMyopia: highMyopiaNote
        },
        seqMatch: true, // WFO에서는 항상 SEQ 일치
        warning: null
    };
}

/**
 * Contoura Vision (Topography-Guided) 모드 Nomogram 계산
 * Alcon Training Card 기반 프로토콜
 */
function calculateContouraVisionNomogram(manifestSph, manifestCyl, manifestAxis, measuredCyl, measuredAxis, age) {
    const refSph = parseFloat(manifestSph);
    const refCyl = parseFloat(manifestCyl);
    const refAxis = parseFloat(manifestAxis);
    const measCyl = parseFloat(measuredCyl);
    const measAxis = parseFloat(measuredAxis);
    
    // Axis 차이 계산
    let axisDiff = Math.abs(refAxis - measAxis);
    if (axisDiff > 90) axisDiff = 180 - axisDiff;
    
    // CYL 차이 계산
    const cylDiff = Math.abs(measCyl) - Math.abs(refCyl);
    
    // Warning 체크 (WFO 권장 조건)
    let warning = null;
    if (Math.abs(cylDiff) > 1.25) {
        warning = `⚠️ CYL 차이 ${Math.abs(cylDiff).toFixed(2)}D > 1.25D: WFO 권장`;
    } else if (Math.abs(refCyl) >= 2.0 && axisDiff > 5) {
        warning = `⚠️ Axis 차이 ${axisDiff}° > 5° (CYL≥2D): WFO 권장`;
    } else if (Math.abs(refCyl) < 2.0 && axisDiff > 10) {
        warning = `⚠️ Axis 차이 ${axisDiff}° > 10° (CYL<2D): WFO 권장`;
    }
    
    // STEP 1: Axis 설정 - Measured Axis 사용
    const modifiedAxis = measAxis;
    
    // STEP 2: CYL 설정
    let modifiedCyl;
    if (Math.abs(refCyl) >= Math.abs(measCyl)) {
        // Refraction CYL ≥ Measured CYL: Measured CYL 사용
        modifiedCyl = measCyl;
    } else {
        // Refraction CYL < Measured CYL: 차이의 절반을 Refraction CYL에 추가
        const halfDiff = (Math.abs(measCyl) - Math.abs(refCyl)) / 2;
        modifiedCyl = refCyl - halfDiff; // 더 음수 방향으로 (더 큰 CYL)
    }
    
    // STEP 3: SPH 설정 (SEQ 유지)
    // Manifest SEQ = Modified SEQ를 유지하기 위해 SPH 조정
    const manifestSeq = refSph + (refCyl / 2);
    let modifiedSph;
    
    if (Math.abs(refCyl) >= Math.abs(measCyl)) {
        // STEP 3.a: Refraction CYL ≥ Measured CYL
        // SPH = Refraction SPH + (Refraction CYL - Measured CYL) / 2
        const cylDiffHalf = (Math.abs(refCyl) - Math.abs(measCyl)) / 2;
        modifiedSph = refSph - cylDiffHalf; // 근시이므로 더 음수 방향
    } else {
        // STEP 3.b: Refraction CYL < Measured CYL
        // SPH = Refraction SPH - (Measured CYL - Refraction CYL) / 4
        const cylDiffQuarter = (Math.abs(measCyl) - Math.abs(refCyl)) / 4;
        modifiedSph = refSph + cylDiffQuarter; // 더 양수 방향 (덜 깎음)
    }
    
    // 나이별 추가 조정
    let ageAdjustment = 0;
    let ageNote = '';
    
    if (age < 25) {
        ageAdjustment = -0.12;
        ageNote = '20대 초반: 추가 0.12D 과교정 권장';
    } else if (age >= 40) {
        ageAdjustment = 0.12;
        ageNote = '40세 이상: 0.12D 저교정 권장 (노안 고려)';
    }
    
    // 최종 Modified SPH (나이 조정 적용)
    const finalModifiedSph = modifiedSph + ageAdjustment;
    const modifiedSeq = finalModifiedSph + (modifiedCyl / 2);
    
    // SEQ 일치 확인
    const seqDiff = Math.abs(manifestSeq - modifiedSeq);
    const seqMatch = seqDiff < 0.13; // 0.125D 이내면 일치
    
    return {
        mode: 'Contoura Vision (TG)',
        manifest: {
            sph: refSph,
            cyl: refCyl,
            axis: refAxis,
            se: manifestSeq
        },
        measured: {
            cyl: measCyl,
            axis: measAxis
        },
        modified: {
            sph: Math.round(finalModifiedSph * 4) / 4,
            cyl: Math.round(modifiedCyl * 4) / 4,
            axis: modifiedAxis,
            se: Math.round((finalModifiedSph + modifiedCyl/2) * 4) / 4
        },
        adjustments: {
            age: ageAdjustment,
            cylMethod: Math.abs(refCyl) >= Math.abs(measCyl) ? '2.a' : '2.b',
            sphMethod: Math.abs(refCyl) >= Math.abs(measCyl) ? '3.a' : '3.b'
        },
        notes: {
            age: ageNote,
            axis: `Axis: Manifest ${refAxis}° → Measured ${measAxis}° 사용`,
            cyl: Math.abs(refCyl) >= Math.abs(measCyl) 
                ? `CYL: Measured CYL (${measCyl}D) 사용`
                : `CYL: Refraction + ½차이 = ${modifiedCyl.toFixed(2)}D`,
            sph: Math.abs(refCyl) >= Math.abs(measCyl)
                ? `SPH: +½(CYL차이) = ${modifiedSph.toFixed(2)}D`
                : `SPH: -¼(CYL차이) = ${modifiedSph.toFixed(2)}D`
        },
        seqMatch: seqMatch,
        seqDiff: seqDiff,
        warning: warning
    };
}

/**
 * Nomogram 계산 실행
 */
function calculateNomogram() {
    const mode = document.getElementById('nomo-mode').value;
    const age = parseInt(document.getElementById('nomo-age').value);
    
    // 양안 데이터 수집
    const odData = {
        sph: parseFloat(document.getElementById('nomo-od-sph').value),
        cyl: parseFloat(document.getElementById('nomo-od-cyl').value),
        axis: parseFloat(document.getElementById('nomo-od-axis').value),
        measuredCyl: parseFloat(document.getElementById('nomo-od-measured-cyl').value),
        measuredAxis: parseFloat(document.getElementById('nomo-od-measured-axis').value)
    };
    
    const osData = {
        sph: parseFloat(document.getElementById('nomo-os-sph').value),
        cyl: parseFloat(document.getElementById('nomo-os-cyl').value),
        axis: parseFloat(document.getElementById('nomo-os-axis').value),
        measuredCyl: parseFloat(document.getElementById('nomo-os-measured-cyl').value),
        measuredAxis: parseFloat(document.getElementById('nomo-os-measured-axis').value)
    };
    
    // 계산 실행
    let odResult, osResult;
    
    if (mode === 'streamlight') {
        odResult = calculateStreamlightNomogram(odData.sph, odData.cyl, odData.axis, age);
        osResult = calculateStreamlightNomogram(osData.sph, osData.cyl, osData.axis, age);
    } else {
        odResult = calculateContouraVisionNomogram(
            odData.sph, odData.cyl, odData.axis,
            odData.measuredCyl, odData.measuredAxis, age
        );
        osResult = calculateContouraVisionNomogram(
            osData.sph, osData.cyl, osData.axis,
            osData.measuredCyl, osData.measuredAxis, age
        );
    }
    
    // 결과 저장 (출력용)
    window.nomogramResults = {
        od: odResult,
        os: osResult,
        age: age,
        mode: mode,
        timestamp: new Date().toISOString()
    };
    
    // 결과 렌더링
    renderNomogramResults(odResult, osResult, mode);
    
    // 출력 버튼 활성화
    document.getElementById('btn-print-nomogram').disabled = false;
}

/**
 * Nomogram 결과 렌더링
 */
function renderNomogramResults(odResult, osResult, mode) {
    const container = document.getElementById('nomogram-results');
    
    container.innerHTML = `
        <div class="nomogram-result-cards">
            ${renderNomogramEyeResult('od', '우안 (OD)', odResult, mode)}
            ${renderNomogramEyeResult('os', '좌안 (OS)', osResult, mode)}
        </div>
    `;
}

/**
 * 개별 눈 Nomogram 결과 렌더링
 */
function renderNomogramEyeResult(eye, eyeLabel, result, mode) {
    const warningHtml = result.warning ? `
        <div class="nomogram-warning">
            ${result.warning}
        </div>
    ` : '';
    
    const measuredRowHtml = mode === 'contoura' ? `
        <tr>
            <td>Measured (Topolyzer)</td>
            <td class="value-unchanged">-</td>
            <td>${result.measured.cyl.toFixed(2)}</td>
            <td>${result.measured.axis}°</td>
            <td class="value-unchanged">-</td>
        </tr>
    ` : '';
    
    const methodNotesHtml = mode === 'contoura' ? `
        <div class="nomogram-age-adjustment">
            <div><strong>적용 방법:</strong></div>
            <div>• ${result.notes.axis}</div>
            <div>• ${result.notes.cyl}</div>
            <div>• ${result.notes.sph}</div>
        </div>
    ` : '';
    
    const seqCheckClass = result.seqMatch ? '' : 'error';
    const seqCheckIcon = result.seqMatch ? '✓' : '⚠️';
    const seqCheckText = result.seqMatch 
        ? `SEQ 일치 확인: Manifest ${result.manifest.se.toFixed(2)}D ≈ Modified ${result.modified.se.toFixed(2)}D`
        : `SEQ 불일치 주의: Manifest ${result.manifest.se.toFixed(2)}D ≠ Modified ${result.modified.se.toFixed(2)}D (차이: ${result.seqDiff?.toFixed(2) || 0}D)`;
    
    return `
        <div class="nomogram-result-card ${eye}">
            <div class="nomogram-result-header">
                <span>👁️ ${eyeLabel}</span>
                <span class="nomogram-mode-badge">${result.mode}</span>
            </div>
            
            ${warningHtml}
            
            <table class="nomogram-table">
                <thead>
                    <tr>
                        <th>구분</th>
                        <th>SPH</th>
                        <th>CYL</th>
                        <th>AXIS</th>
                        <th>SEQ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Manifest Refraction</td>
                        <td>${result.manifest.sph.toFixed(2)}</td>
                        <td>${result.manifest.cyl.toFixed(2)}</td>
                        <td>${result.manifest.axis}°</td>
                        <td>${result.manifest.se.toFixed(2)}</td>
                    </tr>
                    ${measuredRowHtml}
                    <tr class="highlight">
                        <td><strong>Modified (입력값)</strong></td>
                        <td class="${result.manifest.sph !== result.modified.sph ? 'value-changed' : ''}">${result.modified.sph.toFixed(2)}</td>
                        <td class="${result.manifest.cyl !== result.modified.cyl ? 'value-changed' : ''}">${result.modified.cyl.toFixed(2)}</td>
                        <td class="${result.manifest.axis !== result.modified.axis ? 'value-changed' : ''}">${result.modified.axis}°</td>
                        <td>${result.modified.se.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="nomogram-age-adjustment">
                <span class="age-label">📅 나이 조정:</span>
                ${result.notes.age || '표준 교정'}
                ${result.notes.highMyopia ? `<br><span class="age-label">📊 굴절력 조정:</span> ${result.notes.highMyopia}` : ''}
            </div>
            
            ${methodNotesHtml}
            
            <div class="nomogram-seq-check ${seqCheckClass}">
                <span>${seqCheckIcon}</span>
                <span>${seqCheckText}</span>
            </div>
        </div>
    `;
}

/**
 * Nomogram 결과 인쇄
 */
function printNomogramReport() {
    if (!window.nomogramResults) {
        showNotification('먼저 Nomogram을 계산해주세요.', 'warning');
        return;
    }
    
    const results = window.nomogramResults;
    const patientName = document.getElementById('patient-name')?.value || '';
    const patientId = document.getElementById('patient-id')?.value || '';
    const age = results.age;
    
    const printContent = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <title>EX500 Nomogram Report</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
                    font-size: 10pt;
                    color: #000;
                    background: white;
                    padding: 15mm;
                    max-width: 210mm;
                    margin: 0 auto;
                }
                .header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 3px solid #7c3aed;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                .header h1 {
                    font-size: 16pt;
                    color: #7c3aed;
                }
                .header .clinic-info {
                    text-align: right;
                    font-size: 9pt;
                    color: #666;
                }
                .patient-info {
                    background: #f5f5f5;
                    padding: 10px 15px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                    display: flex;
                    gap: 30px;
                    flex-wrap: wrap;
                }
                .patient-info .item {
                    display: flex;
                    gap: 8px;
                }
                .patient-info .label {
                    color: #666;
                    font-size: 9pt;
                }
                .patient-info .value {
                    font-weight: 600;
                }
                .mode-badge {
                    background: #ede9fe;
                    color: #7c3aed;
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-size: 9pt;
                    font-weight: 600;
                }
                .eyes-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 20px;
                }
                .eye-box {
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                }
                .eye-box.od { border-color: #3b82f6; }
                .eye-box.os { border-color: #22c55e; }
                .eye-box h3 {
                    margin: 0 0 15px 0;
                    padding-bottom: 8px;
                    border-bottom: 1px solid #eee;
                }
                .eye-box.od h3 { color: #3b82f6; }
                .eye-box.os h3 { color: #22c55e; }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 9pt;
                    margin-bottom: 12px;
                }
                th, td {
                    padding: 6px 8px;
                    border: 1px solid #ddd;
                    text-align: center;
                }
                th {
                    background: #f5f5f5;
                    font-weight: 600;
                }
                .modified-row {
                    background: #ede9fe;
                    font-weight: 700;
                }
                .modified-row .changed {
                    color: #7c3aed;
                }
                .notes {
                    background: #f0f9ff;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 8pt;
                    color: #0369a1;
                    margin-top: 10px;
                }
                .warning {
                    background: #fef3c7;
                    color: #92400e;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 8pt;
                    margin-bottom: 10px;
                }
                .footer {
                    margin-top: 20px;
                    padding-top: 15px;
                    border-top: 1px solid #ddd;
                    font-size: 8pt;
                    color: #999;
                    text-align: center;
                }
                .disclaimer {
                    background: #fff3cd;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 7pt;
                    color: #856404;
                    margin-top: 15px;
                }
                @media print {
                    body { padding: 10mm; }
                    @page { size: A4; margin: 10mm; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>🎯 EX500 Nomogram Report</h1>
                <div class="clinic-info">
                    <div>연세솔안과</div>
                    <div>YONSEI SOL EYE CLINIC</div>
                    <div>${new Date().toLocaleDateString('ko-KR')}</div>
                </div>
            </div>
            
            <div class="patient-info">
                <div class="item">
                    <span class="label">환자명:</span>
                    <span class="value">${patientName || '-'}</span>
                </div>
                <div class="item">
                    <span class="label">등록번호:</span>
                    <span class="value">${patientId || '-'}</span>
                </div>
                <div class="item">
                    <span class="label">나이:</span>
                    <span class="value">${age}세</span>
                </div>
                <div class="item">
                    <span class="label">수술 모드:</span>
                    <span class="mode-badge">${results.mode === 'streamlight' ? 'Streamlight/CustomQ (WFO)' : 'Contoura Vision (TG)'}</span>
                </div>
            </div>
            
            <div class="eyes-grid">
                ${generatePrintEyeSection('od', '우안 (OD)', results.od, results.mode)}
                ${generatePrintEyeSection('os', '좌안 (OS)', results.os, results.mode)}
            </div>
            
            <div class="disclaimer">
                ⚠️ 본 Nomogram은 Alcon WaveLight EX500 레이저에 최적화되어 있으며, Wellington Nomogram 및 Contoura Vision Advisory Board 권고를 기반으로 합니다.
                최종 수술 파라미터는 반드시 집도의의 임상적 판단에 따라 결정해야 합니다.
            </div>
            
            <div class="footer">
                Generated by Refractive Surgery Calculator | ${new Date().toLocaleString('ko-KR')}
            </div>
            
            <script>
                window.onload = function() {
                    window.print();
                };
            </script>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
}

/**
 * 인쇄용 눈 섹션 생성
 */
function generatePrintEyeSection(eye, eyeLabel, result, mode) {
    const warningHtml = result.warning ? `
        <div class="warning">${result.warning}</div>
    ` : '';
    
    const measuredRow = mode === 'contoura' ? `
        <tr>
            <td>Measured (Topolyzer)</td>
            <td>-</td>
            <td>${result.measured.cyl.toFixed(2)}</td>
            <td>${result.measured.axis}°</td>
            <td>-</td>
        </tr>
    ` : '';
    
    const sphChanged = result.manifest.sph !== result.modified.sph;
    const cylChanged = result.manifest.cyl !== result.modified.cyl;
    const axisChanged = result.manifest.axis !== result.modified.axis;
    
    return `
        <div class="eye-box ${eye}">
            <h3>👁️ ${eyeLabel}</h3>
            
            ${warningHtml}
            
            <table>
                <thead>
                    <tr>
                        <th>구분</th>
                        <th>SPH</th>
                        <th>CYL</th>
                        <th>AXIS</th>
                        <th>SEQ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Manifest Refraction</td>
                        <td>${result.manifest.sph.toFixed(2)}</td>
                        <td>${result.manifest.cyl.toFixed(2)}</td>
                        <td>${result.manifest.axis}°</td>
                        <td>${result.manifest.se.toFixed(2)}</td>
                    </tr>
                    ${measuredRow}
                    <tr class="modified-row">
                        <td><strong>Modified (입력값)</strong></td>
                        <td class="${sphChanged ? 'changed' : ''}">${result.modified.sph.toFixed(2)}</td>
                        <td class="${cylChanged ? 'changed' : ''}">${result.modified.cyl.toFixed(2)}</td>
                        <td class="${axisChanged ? 'changed' : ''}">${result.modified.axis}°</td>
                        <td>${result.modified.se.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="notes">
                <strong>📅 나이 조정:</strong> ${result.notes.age || '표준 교정'}<br>
                ${result.notes.highMyopia ? `<strong>📊 굴절력 조정:</strong> ${result.notes.highMyopia}<br>` : ''}
                ${mode === 'contoura' ? `
                    <strong>📐 Contoura 방법:</strong><br>
                    • ${result.notes.axis}<br>
                    • ${result.notes.cyl}<br>
                    • ${result.notes.sph}
                ` : ''}
            </div>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', () => {
    // Show login screen initially
    showLoginScreen();
    
    // Initialize calculator
    window.calculator = new RefractiveCalculator();
    new TopographyAnalyzer();
    
    // Check for Firebase auth state (if Firebase is configured)
    if (!DEMO_MODE && typeof auth !== 'undefined') {
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserApprovalFirebase(user.email).then(approved => {
                    if (approved || user.email === ADMIN_EMAIL) {
                        currentUser = user;
                        updateAuthUI();
                    }
                });
            }
        });
    }
});
    </script>
</body>
</html>