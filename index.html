<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏãúÎ†•ÍµêÏ†ïÏà† Ï†ÅÌï©ÏÑ± Í≤ÄÏÇ¨ | Refractive Surgery Eligibility Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ============================================
   Refractive Surgery Eligibility Checker
   Medical-Grade Professional UI
   ============================================ */

:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --bg-accent: #e0f2fe;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    --text-inverse: #ffffff;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-focus: #0ea5e9;
    --accent-primary: #0284c7;
    --accent-secondary: #0ea5e9;
    --accent-light: #e0f2fe;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --info: #2563eb;
    --info-light: #dbeafe;
    --font-sans: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'JetBrains Mono', 'Consolas', monospace;
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-accent: #0c4a6e;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --text-inverse: #0f172a;
    --border-light: #334155;
    --border-medium: #475569;
    --border-focus: #38bdf8;
    --accent-primary: #38bdf8;
    --accent-secondary: #0ea5e9;
    --accent-light: #0c4a6e;
    --success-light: #064e3b;
    --warning-light: #78350f;
    --danger-light: #7f1d1d;
    --info-light: #1e3a8a;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    padding: var(--space-md) var(--space-xl);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
}

.header-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.logo-icon {
    width: 40px;
    height: 40px;
    color: var(--accent-primary);
}

.logo-text h1 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.02em;
}

.logo-text .subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-weight: 400;
}

.btn-icon {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.btn-icon:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-icon svg {
    width: 20px;
    height: 20px;
}

.icon-moon { display: none; }
[data-theme="dark"] .icon-sun { display: none; }
[data-theme="dark"] .icon-moon { display: block; }

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding: var(--space-md);
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

.panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* Input panel - full width, compact */
.input-panel {
    width: 100%;
}

.input-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
}

.input-panel .panel-header h2 {
    font-size: 1rem;
}

.input-panel .form-grid {
    padding: var(--space-sm) var(--space-md);
    gap: var(--space-sm);
}

/* Results panel */
.results-panel {
    width: 100%;
}

.results-panel .panel-header {
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    user-select: none;
}

.results-panel .panel-header:hover {
    background: var(--bg-tertiary);
}

.results-panel .panel-header h2 {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.results-panel .panel-header h2::before {
    content: '‚ñº';
    font-size: 0.625rem;
    transition: transform var(--transition-fast);
}

.results-panel.collapsed .panel-header h2::before {
    transform: rotate(-90deg);
}

.results-panel.collapsed .results-container {
    display: none;
}

.panel-header {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, var(--bg-accent), transparent);
}

.panel-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.panel-badge {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--accent-primary);
    background: var(--accent-light);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.form-grid {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    overflow-y: auto;
    flex: 1;
}

.form-section {
    padding: var(--space-lg);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

.section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
}

.section-icon { font-size: 1rem; }

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.form-row.triple { grid-template-columns: repeat(3, 1fr); }

@media (max-width: 600px) {
    .form-row, .form-row.triple { grid-template-columns: 1fr; }
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.form-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-group input,
.form-group select {
    height: 44px;
    padding: 0 var(--space-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 1rem;
    font-family: var(--font-mono);
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-light);
}

.form-group input::-webkit-inner-spin-button { opacity: 1; }

.calculated-field {
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px dashed var(--border-medium);
}

.calc-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-primary);
}

.btn-primary {
    height: 52px;
    padding: 0 var(--space-xl);
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: var(--text-inverse);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
    height: 44px;
    padding: 0 var(--space-lg);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
}

.btn-secondary:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-focus);
}

.btn-secondary svg {
    width: 18px;
    height: 18px;
}

.btn-calculate { margin-top: var(--space-md); }

.results-container {
    flex: 1;
    padding: var(--space-xl);
    overflow-y: auto;
}

.results-placeholder {
    height: 100%;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-tertiary);
}

.placeholder-icon {
    width: 80px;
    height: 80px;
    margin-bottom: var(--space-lg);
    opacity: 0.5;
}

.placeholder-icon svg {
    width: 100%;
    height: 100%;
}

.results-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.card-header {
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
}

.card-subtitle {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: var(--font-mono);
}

.summary-card {
    background: linear-gradient(135deg, var(--accent-light), var(--bg-tertiary));
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    padding: var(--space-lg);
}

.summary-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    transition: all var(--transition-fast);
}

.summary-item.eligible {
    border-color: var(--success);
    background: var(--success-light);
}

.summary-item.caution {
    border-color: var(--warning);
    background: var(--warning-light);
}

.summary-item.not-eligible {
    border-color: var(--danger);
    background: var(--danger-light);
}

.summary-item.pending {
    border-color: var(--text-tertiary);
    background: var(--bg-tertiary);
}

.summary-item.pending .surgery-status {
    color: var(--text-tertiary);
}

.surgery-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
}

.surgery-status { font-size: 0.8125rem; font-weight: 500; }
.summary-item.eligible .surgery-status { color: var(--success); }
.summary-item.caution .surgery-status { color: var(--warning); }
.summary-item.not-eligible .surgery-status { color: var(--danger); }

.table-container {
    padding: var(--space-md);
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table th,
.data-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.data-table th {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    font-family: var(--font-mono);
    color: var(--text-primary);
}

.data-table tbody tr:hover { background: var(--bg-secondary); }
.data-table .warning { color: var(--warning); font-weight: 600; }
.data-table .danger { color: var(--danger); font-weight: 600; }
.data-table .success { color: var(--success); font-weight: 600; }

.k-values-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-xl);
}

.k-value-item {
    text-align: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    min-width: 140px;
}

.k-value-item.highlight {
    background: var(--accent-light);
    border: 2px solid var(--accent-primary);
}

.k-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.k-value {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.k-arrow {
    font-size: 1.5rem;
    color: var(--accent-primary);
}

.k-note {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-align: center;
    border-top: 1px solid var(--border-light);
}

.k-note.warning {
    background: var(--warning-light);
    color: var(--warning);
}

.risk-section {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-light);
}

.risk-section:last-child { border-bottom: none; }

.risk-section h4 {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}

.erss-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.erss-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
}

.erss-item-label { color: var(--text-secondary); }

.erss-item-score {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--text-primary);
}

.erss-total {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.erss-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.erss-score {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.erss-risk-level {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.erss-risk-level.low { background: var(--success-light); color: var(--success); }
.erss-risk-level.moderate { background: var(--warning-light); color: var(--warning); }
.erss-risk-level.high { background: var(--danger-light); color: var(--danger); }

.pta-display {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.pta-item {
    text-align: center;
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
}

.pta-item.safe { border-color: var(--success); }
.pta-item.caution { border-color: var(--warning); }
.pta-item.danger { border-color: var(--danger); }

.pta-surgery {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.pta-value {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
}

.pta-item.safe .pta-value { color: var(--success); }
.pta-item.caution .pta-value { color: var(--warning); }
.pta-item.danger .pta-value { color: var(--danger); }

.pta-status {
    font-size: 0.6875rem;
    margin-top: var(--space-xs);
}

.nomogram-info { padding: var(--space-lg); }

.nomogram-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--accent-primary);
    margin-bottom: var(--space-sm);
}

.nomogram-item:last-child { margin-bottom: 0; }

.nomogram-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.nomogram-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.erss-note {
    margin-top: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--warning-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--warning);
}

.combined-risk-guide {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.risk-guide-item {
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--border-light);
}

.risk-guide-item.low-risk {
    border-left-color: var(--success);
    background: var(--success-light);
}

.risk-guide-item.moderate-risk {
    border-left-color: var(--warning);
    background: var(--warning-light);
}

.risk-guide-item.high-risk {
    border-left-color: var(--danger);
    background: var(--danger-light);
}

.risk-guide-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

.risk-guide-icon {
    font-size: 1.25rem;
}

.risk-guide-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
}

.risk-guide-condition {
    font-size: 0.75rem;
    font-family: var(--font-mono);
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    display: inline-block;
}

.risk-guide-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.risk-guide-recommendation {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px dashed var(--border-light);
    font-size: 0.8125rem;
    font-weight: 500;
}

.risk-guide-item.low-risk .risk-guide-recommendation {
    color: var(--success);
}

.risk-guide-item.moderate-risk .risk-guide-recommendation {
    color: var(--warning);
}

.risk-guide-item.high-risk .risk-guide-recommendation {
    color: var(--danger);
}

/* Combined Risk Interpretation */
.combined-risk-section {
    padding: var(--space-lg);
}

.combined-risk-matrix {
    display: grid;
    grid-template-columns: auto repeat(3, 1fr);
    gap: 2px;
    margin-bottom: var(--space-lg);
    background: var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.matrix-cell {
    padding: var(--space-sm) var(--space-md);
    text-align: center;
    font-size: 0.75rem;
    background: var(--bg-secondary);
}

.matrix-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.matrix-row-header {
    font-weight: 600;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    text-align: left;
}

.matrix-cell.risk-low {
    background: var(--success-light);
    color: var(--success);
    font-weight: 500;
}

.matrix-cell.risk-moderate {
    background: var(--warning-light);
    color: var(--warning);
    font-weight: 500;
}

.matrix-cell.risk-high {
    background: var(--danger-light);
    color: var(--danger);
    font-weight: 500;
}

.matrix-cell.current-position {
    outline: 3px solid var(--accent-primary);
    outline-offset: -3px;
    font-weight: 700;
}

.interpretation-guide {
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.interpretation-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.interpretation-badge {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 600;
}

.interpretation-badge.low {
    background: var(--success-light);
    color: var(--success);
}

.interpretation-badge.moderate {
    background: var(--warning-light);
    color: var(--warning);
}

.interpretation-badge.high {
    background: var(--danger-light);
    color: var(--danger);
}

.interpretation-text {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.interpretation-recommendations {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.interpretation-recommendations h5 {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.recommendation-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recommendation-list li {
    font-size: 0.8125rem;
    color: var(--text-primary);
    padding: var(--space-xs) 0;
    padding-left: var(--space-lg);
    position: relative;
}

.recommendation-list li::before {
    content: "‚Üí";
    position: absolute;
    left: 0;
    color: var(--accent-primary);
}

.clinical-note {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--info-light);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--info);
}

.note-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.note-content {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.note-content strong {
    color: var(--text-primary);
}

.reference {
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    font-style: italic;
}

.result-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
}

.footer {
    padding: var(--space-lg) var(--space-xl);
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-light);
    text-align: center;
}

.footer p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.footer-small {
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

@media print {
    .header, .footer, .input-panel, .result-actions { display: none; }
    .main-content { display: block; }
    .results-panel { box-shadow: none; border: none; }
    .result-card { break-inside: avoid; margin-bottom: 1rem; }
}

@media (max-width: 768px) {
    .header { padding: var(--space-sm) var(--space-md); }
    .main-content { padding: var(--space-md); gap: var(--space-md); }
    .panel-header { padding: var(--space-md); }
    .form-grid { padding: var(--space-md); }
    .summary-grid { grid-template-columns: 1fr; }
    .pta-display { grid-template-columns: 1fr; }
    .k-values-display { flex-direction: column; gap: var(--space-md); }
    .k-arrow { transform: rotate(90deg); }
    .result-actions { flex-direction: column; }
    .result-actions button { width: 100%; }
    .eye-panels { flex-direction: column; }
}

/* Bilateral Eye Input Styles */
.eye-panels-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

@media (max-width: 800px) {
    .eye-panels-container {
        grid-template-columns: 1fr;
    }
}

.eye-panel {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border-light);
    overflow: visible;
}

.eye-panel.right-eye {
    border-color: #3b82f6;
}

.eye-panel.left-eye {
    border-color: #22c55e;
}

.eye-panel-header {
    padding: var(--space-xs) var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-weight: 600;
    font-size: 0.875rem;
}

.eye-panel.right-eye .eye-panel-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.eye-panel.left-eye .eye-panel-header {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.eye-icon {
    font-size: 0.875rem;
}

.eye-panel-content {
    padding: var(--space-sm) var(--space-md);
}

.eye-panel .form-section {
    padding: 0;
    margin-bottom: var(--space-sm);
    border: none;
    background: transparent;
}

.eye-panel .form-section:last-child {
    margin-bottom: 0;
}

.eye-panel .section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: var(--space-xs) 0;
    margin-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

/* Compact form layout for eye panels */
.form-row-compact {
    display: flex;
    gap: 4px;
    margin-bottom: 4px;
    flex-wrap: nowrap;
}

.form-group.compact {
    flex: 1;
    min-width: 45px;
}

.form-group.compact label {
    font-size: 0.5625rem;
    margin-bottom: 1px;
    display: block;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.input-with-unit {
    display: flex;
    align-items: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.input-with-unit input {
    flex: 1;
    border: none;
    padding: 4px 6px;
    font-size: 0.75rem;
    min-width: 0;
    background: transparent;
    font-family: var(--font-mono);
}

.input-with-unit input:focus {
    outline: none;
    box-shadow: none;
}

.input-with-unit:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15);
}

.input-with-unit .unit {
    padding: 4px 4px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    font-size: 0.5625rem;
    font-family: var(--font-mono);
    border-left: 1px solid var(--border-light);
    white-space: nowrap;
}

.select-compact {
    padding: 4px 6px;
    font-size: 0.75rem;
    width: 100%;
}

.eye-panel select {
    padding: 4px 6px;
    font-size: 0.75rem;
}

/* Four column layout for patient info */
.form-row.four-col {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr 1fr;
    gap: var(--space-md);
}

@media (max-width: 768px) {
    .form-row.four-col {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Patient info section */
.patient-info-section {
    background: var(--bg-accent);
    border: 1px solid var(--accent-primary);
    padding: var(--space-sm) var(--space-md);
}

.patient-info-section .shared-section-title {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

.patient-info-section .form-row {
    gap: var(--space-sm);
}

.patient-info-section input,
.patient-info-section select {
    padding: 6px 8px;
    font-size: 0.8125rem;
}

/* Calculated field */
.calculated-field {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px var(--space-xs);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: 2px;
}

.calc-label {
    font-size: 0.625rem;
    color: var(--text-secondary);
}

.calc-value {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
}

/* Form actions */
.form-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    margin-top: var(--space-sm);
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.form-actions .tabindex-hint {
    margin: 0;
    font-size: 0.6875rem;
}

.btn-calculate {
    padding: var(--space-sm) var(--space-lg);
    font-size: 0.875rem;
}

/* AI Analysis Section Styles */
.ai-analysis-section {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    border: 1px solid #6366f1;
    color: white;
    padding: var(--space-sm) var(--space-md);
}

[data-theme="light"] .ai-analysis-section {
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    border-color: #a5b4fc;
    color: var(--text-primary);
}

.ai-analysis-section .shared-section-title {
    color: white;
    border-bottom-color: rgba(255,255,255,0.2);
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
}

[data-theme="light"] .ai-analysis-section .shared-section-title {
    color: #4338ca;
    border-bottom-color: #c7d2fe;
}

.beta-badge {
    font-size: 0.5rem;
    padding: 1px 4px;
    background: #f59e0b;
    color: #000;
    border-radius: 3px;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin-left: var(--space-xs);
}

.section-description {
    font-size: 0.6875rem;
    color: rgba(255,255,255,0.8);
    margin-bottom: var(--space-sm);
}

[data-theme="light"] .section-description {
    color: #6366f1;
}

.ai-analysis-panels {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

@media (max-width: 800px) {
    .ai-analysis-panels {
        grid-template-columns: 1fr;
    }
}

.ai-panel {
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

[data-theme="light"] .ai-panel {
    background: white;
    border: 1px solid #c7d2fe;
}

.ai-panel.right-eye .ai-panel-header {
    background: rgba(59, 130, 246, 0.3);
    border-left: 3px solid #3b82f6;
}

.ai-panel.left-eye .ai-panel-header {
    background: rgba(34, 197, 94, 0.3);
    border-left: 3px solid #22c55e;
}

[data-theme="light"] .ai-panel.right-eye .ai-panel-header {
    background: #dbeafe;
}

[data-theme="light"] .ai-panel.left-eye .ai-panel-header {
    background: #dcfce7;
}

.ai-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    font-weight: 600;
    font-size: 0.75rem;
}

.ai-panel-content {
    padding: var(--space-sm);
}

.topo-textarea {
    width: 100%;
    min-height: 80px;
    padding: var(--space-xs);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius-sm);
    background: rgba(0,0,0,0.2);
    color: white;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    resize: vertical;
    margin-bottom: var(--space-xs);
}

[data-theme="light"] .topo-textarea {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: var(--text-primary);
}

.topo-textarea::placeholder {
    color: rgba(255,255,255,0.5);
    font-size: 0.5625rem;
}

[data-theme="light"] .topo-textarea::placeholder {
    color: #94a3b8;
}

.topo-textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}

.btn-analyze {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-analyze:hover:not(:disabled) {
    background: #4f46e5;
}

.btn-analyze:disabled {
    background: #475569;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-analyze.analyzing {
    background: #f59e0b;
}

.btn-analyze.analyzing .analyze-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.ai-result {
    min-height: 60px;
    padding: var(--space-xs);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result {
    background: #f1f5f9;
}

.ai-result-placeholder {
    color: rgba(255,255,255,0.5);
    text-align: center;
    padding: var(--space-sm);
    font-size: 0.625rem;
}

[data-theme="light"] .ai-result-placeholder {
    color: #94a3b8;
}

.ai-result-content {
    color: white;
}

[data-theme="light"] .ai-result-content {
    color: var(--text-primary);
}

.ai-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-result-header {
    border-bottom-color: #e2e8f0;
}

.ai-classification {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.6875rem;
}

.ai-classification.normal {
    background: var(--success-light);
    color: var(--success);
}

.ai-classification.suspect {
    background: var(--warning-light);
    color: var(--warning);
}

.ai-classification.abnormal {
    background: var(--danger-light);
    color: var(--danger);
}

.ai-confidence {
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.6);
}

[data-theme="light"] .ai-confidence {
    color: var(--text-tertiary);
}

.ai-findings {
    margin-top: var(--space-xs);
}

.ai-finding-item {
    display: flex;
    align-items: flex-start;
    gap: 2px;
    padding: 1px 0;
    font-size: 0.625rem;
    line-height: 1.3;
}

.finding-icon {
    flex-shrink: 0;
    font-size: 0.625rem;
}

.ai-indices {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px;
    margin-top: var(--space-xs);
    padding-top: var(--space-xs);
    border-top: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .ai-indices {
    border-top-color: #e2e8f0;
}

.ai-index-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.5625rem;
    padding: 1px 2px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
}

[data-theme="light"] .ai-index-item {
    background: #e2e8f0;
}

.ai-index-label {
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-index-label {
    color: var(--text-secondary);
}

.ai-index-value {
    font-family: var(--font-mono);
    font-weight: 600;
}

.ai-index-value.normal { color: var(--success); }
.ai-index-value.warning { color: var(--warning); }
.ai-index-value.danger { color: var(--danger); }

.ai-disclaimer {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: rgba(0,0,0,0.2);
    border-radius: var(--radius-sm);
    font-size: 0.5625rem;
    color: rgba(255,255,255,0.7);
}

[data-theme="light"] .ai-disclaimer {
    background: #fef3c7;
    color: #92400e;
}

.disclaimer-icon {
    flex-shrink: 0;
}

.copy-button {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.copy-button:hover {
    background: var(--accent-light);
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.shared-section {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-sm);
}

.shared-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--accent-primary);
}

.eye-se-display {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-family: var(--font-mono);
}

.eye-se-display.right { color: #3b82f6; }
.eye-se-display.left { color: #22c55e; }

/* Eye Tab Results Styles */
.eye-tabs {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
}

.eye-tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
}

.eye-tab:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.eye-tab.active {
    background: var(--bg-secondary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

.eye-tab.right-tab.active {
    border-left: 3px solid #3b82f6;
}

.eye-tab.left-tab.active {
    border-left: 3px solid #22c55e;
}

.eye-results-content {
    display: none;
}

.eye-results-content.active {
    display: block;
}

/* Focus/Keyboard navigation styles */
.tabindex-hint {
    display: block;
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

input:focus, select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-overlay.active { display: flex; }
.modal {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
.modal.modal-lg { max-width: 600px; }
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-light);
}
.modal-header h3 { margin: 0; font-size: 1rem; }
.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--text-secondary);
}
.modal-body { padding: var(--space-md); }
.login-error {
    color: var(--danger);
    font-size: 0.75rem;
    margin-bottom: var(--space-sm);
    min-height: 1rem;
}
.demo-notice {
    margin-top: var(--space-md);
    padding: var(--space-sm);
    background: var(--warning-light);
    color: var(--warning);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    text-align: center;
}
.search-box {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}
.search-box input { flex: 1; }
.search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-md);
}
.search-placeholder {
    padding: var(--space-lg);
    text-align: center;
    color: var(--text-tertiary);
    font-size: 0.8125rem;
}
.search-result-item {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background var(--transition-fast);
}
.search-result-item:hover { background: var(--bg-tertiary); }
.search-result-item:last-child { border-bottom: none; }
.search-result-name { font-weight: 600; font-size: 0.875rem; }
.search-result-info { font-size: 0.6875rem; color: var(--text-secondary); }
.recent-patients h4 {
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
    color: var(--text-secondary);
}
#recent-patients-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}
.recent-patient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
}
.recent-patient-item:hover { background: var(--border-light); }

/* User info in header */
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.user-email {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.btn-logout {
    padding: 2px 8px;
    font-size: 0.625rem;
    background: var(--danger-light);
    color: var(--danger);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
}

/* Header buttons */
.header-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--text-primary);
    transition: all var(--transition-fast);
}
.header-btn:hover {
    background: var(--accent-light);
    border-color: var(--accent-primary);
}

/* Logo image style */
.logo-img {
    height: 40px;
    width: auto;
}
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div class="modal-overlay" id="login-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîê Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</h3>
                <button class="modal-close" onclick="toggleModal('login-modal', false)">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="login-email">Ïù¥Î©îÏùº</label>
                    <input type="email" id="login-email" placeholder="example@yonsei-sol.com">
                </div>
                <div class="form-group">
                    <label for="login-password">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="login-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•">
                </div>
                <div class="login-error" id="login-error"></div>
                <button class="btn-primary" onclick="handleLogin()" style="width:100%">Î°úÍ∑∏Ïù∏</button>
                <p class="demo-notice">üîî Îç∞Î™® Î™®ÎìúÏóêÏÑúÎäî ÏïÑÎ¨¥ Ïù¥Î©îÏùº/ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Î°úÍ∑∏Ïù∏ Í∞ÄÎä•Ìï©ÎãàÎã§.<br>Firebase ÏÑ§Ï†ï ÌõÑ Ïã§Ï†ú Ïù∏Ï¶ùÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§.</p>
            </div>
        </div>
    </div>

    <!-- ÌôòÏûê Í≤ÄÏÉâ Î™®Îã¨ -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üîç ÌôòÏûê Í≤ÄÏÉâ</h3>
                <button class="modal-close" onclick="toggleModal('search-modal', false)">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ÌôòÏûê Ïù¥Î¶Ñ ÎòêÎäî Îì±Î°ùÎ≤àÌò∏ ÏûÖÎ†•..." onkeyup="if(event.key==='Enter')searchPatients()">
                    <button class="btn-primary" onclick="searchPatients()">Í≤ÄÏÉâ</button>
                </div>
                <div class="search-results" id="search-results">
                    <div class="search-placeholder">ÌôòÏûê Ïù¥Î¶Ñ ÎòêÎäî Îì±Î°ùÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
                </div>
                <div class="recent-patients">
                    <h4>üìã ÏµúÍ∑º ÌôòÏûê</h4>
                    <div id="recent-patients-list">
                        <div class="search-placeholder">Ï†ÄÏû•Îêú ÌôòÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.jpg" alt="Ïó∞ÏÑ∏ÏÜîÏïàÍ≥º" class="logo-img" onerror="this.style.display='none'">
                    <div class="logo-text">
                        <h1>ÏãúÎ†•ÍµêÏ†ïÏà† Ï†ÅÌï©ÏÑ± Í≤ÄÏÇ¨</h1>
                        <span class="subtitle">Ïó∞ÏÑ∏ÏÜîÏïàÍ≥º YONSEI SOL EYE CLINIC</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="toggleModal('search-modal', true)" title="ÌôòÏûê Í≤ÄÏÉâ">
                        üîç ÌôòÏûê Í≤ÄÏÉâ
                    </button>
                    <div id="auth-container">
                        <button class="header-btn" onclick="toggleModal('login-modal', true)" id="login-btn">
                            üîê Î°úÍ∑∏Ïù∏
                        </button>
                    </div>
                    <button class="btn-icon" id="theme-toggle" title="ÌÖåÎßà Î≥ÄÍ≤Ω">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section class="panel input-panel">
                <div class="panel-header">
                    <h2>ÌôòÏûê Ï†ïÎ≥¥ ÏûÖÎ†•</h2>
                    <span class="panel-badge">Patient Data (OD/OS)</span>
                </div>
                
                <form id="patient-form" class="form-grid">
                    <!-- ÌôòÏûê Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="shared-section patient-info-section">
                        <div class="shared-section-title">
                            <span>üë§</span>
                            ÌôòÏûê Ï†ïÎ≥¥
                        </div>
                        <div class="form-row four-col">
                            <div class="form-group">
                                <label for="patient-name">ÌôòÏûê Ïù¥Î¶Ñ</label>
                                <input type="text" id="patient-name" name="patient-name" placeholder="ÌôçÍ∏∏Îèô" tabindex="1">
                            </div>
                            <div class="form-group">
                                <label for="patient-id">Îì±Î°ùÎ≤àÌò∏</label>
                                <input type="text" id="patient-id" name="patient-id" placeholder="12345678" tabindex="2">
                            </div>
                            <div class="form-group">
                                <label for="age">ÎÇòÏù¥ (ÏÑ∏)</label>
                                <input type="number" id="age" name="age" min="18" max="80" value="25" required tabindex="3">
                            </div>
                            <div class="form-group">
                                <label for="gender">ÏÑ±Î≥Ñ</label>
                                <select id="gender" name="gender" tabindex="4">
                                    <option value="male">ÎÇ®ÏÑ±</option>
                                    <option value="female">Ïó¨ÏÑ±</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÏñëÏïà ÏûÖÎ†• Ìå®ÎÑê -->
                    <div class="eye-panels-container">
                        <!-- Ïö∞Ïïà (OD) -->
                        <div class="eye-panel right-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">üëÅÔ∏è</span>
                                Ïö∞Ïïà (OD)
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">Íµ¥Ï†à Í≤ÄÏÇ¨</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-sph" name="od-sph" step="0.25" min="-20" max="10" value="-3.00" required tabindex="10">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cyl" name="od-cyl" step="0.25" min="-6" max="0" value="-1.00" required tabindex="11">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-axis" name="od-axis" min="1" max="180" value="180" required tabindex="12">
                                                <span class="unit">¬∞</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display right" id="od-se-display">-3.50 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Í∞ÅÎßâ Í≤ÄÏÇ¨</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-cct" name="od-cct" min="400" max="700" value="540" required tabindex="13">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k1" name="od-k1" step="0.01" min="35" max="50" value="43.00" required tabindex="14">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-k2" name="od-k2" step="0.01" min="35" max="50" value="44.00" required tabindex="15">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-steep-axis" name="od-steep-axis" min="1" max="180" value="90" tabindex="16">
                                                <span class="unit">¬∞</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="od-topography" name="od-topography" tabindex="17">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ÏàòÏà† ÌååÎùºÎØ∏ÌÑ∞</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-optical-zone">OZ</label>
                                            <select id="od-optical-zone" name="od-optical-zone" tabindex="18" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="od-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasik-flap" name="od-lasik-flap" min="80" max="160" value="90" tabindex="19">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-lasek-epi" name="od-lasek-epi" min="40" max="80" value="55" tabindex="20">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="od-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="od-smile-cap" name="od-smile-cap" min="100" max="160" value="120" tabindex="21">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ï¢åÏïà (OS) -->
                        <div class="eye-panel left-eye">
                            <div class="eye-panel-header">
                                <span class="eye-icon">üëÅÔ∏è</span>
                                Ï¢åÏïà (OS)
                                <button type="button" class="copy-button" id="copy-od-to-os" style="margin-left: auto;">
                                    ‚Üê OD Î≥µÏÇ¨
                                </button>
                            </div>
                            <div class="eye-panel-content">
                                <div class="form-section">
                                    <h3 class="section-title">Íµ¥Ï†à Í≤ÄÏÇ¨</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-sph">SPH</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-sph" name="os-sph" step="0.25" min="-20" max="10" value="-3.25" required tabindex="30">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-cyl">CYL</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cyl" name="os-cyl" step="0.25" min="-6" max="0" value="-0.75" required tabindex="31">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-axis">AXIS</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-axis" name="os-axis" min="1" max="180" value="175" required tabindex="32">
                                                <span class="unit">¬∞</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calculated-field">
                                        <span class="calc-label">SE:</span>
                                        <span class="calc-value eye-se-display left" id="os-se-display">-3.63 D</span>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Í∞ÅÎßâ Í≤ÄÏÇ¨</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-cct">CCT</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-cct" name="os-cct" min="400" max="700" value="535" required tabindex="33">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-k1">K1</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k1" name="os-k1" step="0.01" min="35" max="50" value="43.25" required tabindex="34">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-k2">K2</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-k2" name="os-k2" step="0.01" min="35" max="50" value="44.25" required tabindex="35">
                                                <span class="unit">D</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-steep-axis">Axis</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-steep-axis" name="os-steep-axis" min="1" max="180" value="85" tabindex="36">
                                                <span class="unit">¬∞</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">Topography</h3>
                                    <div class="form-group">
                                        <select id="os-topography" name="os-topography" tabindex="37">
                                            <option value="normal">Normal</option>
                                            <option value="asymmetric-bowtie">Asymmetric Bowtie</option>
                                            <option value="inferior-steepening">Inferior Steepening</option>
                                            <option value="abnormal">Abnormal (KC suspect)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3 class="section-title">ÏàòÏà† ÌååÎùºÎØ∏ÌÑ∞</h3>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-optical-zone">OZ</label>
                                            <select id="os-optical-zone" name="os-optical-zone" tabindex="38" class="select-compact">
                                                <option value="6.0">6.0</option>
                                                <option value="6.1">6.1</option>
                                                <option value="6.2">6.2</option>
                                                <option value="6.3">6.3</option>
                                                <option value="6.4">6.4</option>
                                                <option value="6.5" selected>6.5</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row-compact">
                                        <div class="form-group compact">
                                            <label for="os-lasik-flap">Flap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasik-flap" name="os-lasik-flap" min="80" max="160" value="90" tabindex="39">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-lasek-epi">Epi</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-lasek-epi" name="os-lasek-epi" min="40" max="80" value="55" tabindex="40">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                        <div class="form-group compact">
                                            <label for="os-smile-cap">Cap</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="os-smile-cap" name="os-smile-cap" min="100" max="160" value="120" tabindex="41">
                                                <span class="unit">Œºm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Topography Î∂ÑÏÑù ÏÑπÏÖò -->
                    <div class="shared-section ai-analysis-section">
                        <div class="shared-section-title">
                            <span>ü§ñ</span>
                            AI Í∞ÅÎßâ ÏßÄÌòïÎèÑ Î∂ÑÏÑù
                            <span class="beta-badge">BETA</span>
                        </div>
                        <p class="section-description">
                            Galilei G4, Pentacam, Orbscan Îì±Ïùò Í≤ÄÏÇ¨ Í≤∞Í≥ºÎ•º Î∂ôÏó¨ÎÑ£ÏúºÎ©¥ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Î∂ÑÏÑùÌï©ÎãàÎã§.
                        </p>
                        
                        <div class="ai-analysis-panels">
                            <!-- Ïö∞Ïïà AI Î∂ÑÏÑù -->
                            <div class="ai-panel right-eye">
                                <div class="ai-panel-header">
                                    <span>üëÅÔ∏è OD</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-od" disabled>
                                        <span class="analyze-icon">üîç</span> Î∂ÑÏÑù
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="od-topo-data" 
                                        name="od-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 ÎòêÎäî Pentacam Í≤∞Í≥ºÎ•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî...

ÏòàÏãú Îç∞Ïù¥ÌÑ∞:
- Sim K: 43.5 @ 180 / 44.2 @ 90
- TCT: 512 Œºm
- Thinnest: 508 Œºm at (0.2, -0.3)
- BAD-D: 1.2
- I-S: 0.8
- KISA: 32%
- Posterior Elevation: 12 Œºm
..."
                                        tabindex="22"
                                    ></textarea>
                                    <div class="ai-result" id="od-ai-result">
                                        <div class="ai-result-placeholder">
                                            Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£Í≥† Î∂ÑÏÑù Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ï¢åÏïà AI Î∂ÑÏÑù -->
                            <div class="ai-panel left-eye">
                                <div class="ai-panel-header">
                                    <span>üëÅÔ∏è OS</span>
                                    <button type="button" class="btn-analyze" id="btn-analyze-os" disabled>
                                        <span class="analyze-icon">üîç</span> Î∂ÑÏÑù
                                    </button>
                                </div>
                                <div class="ai-panel-content">
                                    <textarea 
                                        id="os-topo-data" 
                                        name="os-topo-data" 
                                        class="topo-textarea"
                                        placeholder="Galilei G4 ÎòêÎäî Pentacam Í≤∞Í≥ºÎ•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî..."
                                        tabindex="42"
                                    ></textarea>
                                    <div class="ai-result" id="os-ai-result">
                                        <div class="ai-result-placeholder">
                                            Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£Í≥† Î∂ÑÏÑù Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ai-disclaimer">
                            <span class="disclaimer-icon">‚ö†Ô∏è</span>
                            <span>AI Î∂ÑÏÑùÏùÄ Ï∞∏Í≥†Ïö©Ïù¥Î©∞, ÏµúÏ¢Ö ÌåêÎã®ÏùÄ Î∞òÎìúÏãú Ï†ÑÎ¨∏ÏùòÍ∞Ä ÏàòÌñâÌï¥Ïïº Ìï©ÎãàÎã§. 
                            ÏßÄÏõê Ïû•ÎπÑ: Galilei G4, Pentacam, Orbscan, Topcon, Nidek OPD</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <span class="tabindex-hint">üí° Tab ÌÇ§ ÎòêÎäî Enter ÌÇ§Î°ú Îã§Ïùå ÏûÖÎ†•Ïπ∏ÏúºÎ°ú Ïù¥Îèô</span>
                        <button type="submit" class="btn-primary btn-calculate" tabindex="50">
                            <span class="btn-text">ÏñëÏïà Í≥ÑÏÇ∞ÌïòÍ∏∞</span>
                            <span class="btn-icon-right">‚Üí</span>
                        </button>
                    </div>
                </form>
            </section>

            <section class="panel results-panel" id="results-panel">
                <div class="panel-header" onclick="document.getElementById('results-panel').classList.toggle('collapsed')">
                    <h2>Í≤ÄÏÇ¨ Í≤∞Í≥º</h2>
                    <span class="panel-badge">Results (OD/OS)</span>
                </div>

                <div id="results-container" class="results-container">
                    <div class="results-placeholder">
                        <div class="placeholder-icon">
                            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                                <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <p>ÌôòÏûê Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÍ≥†<br><strong>ÏñëÏïà Í≥ÑÏÇ∞ÌïòÍ∏∞</strong> Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>‚ö†Ô∏è Î≥∏ ÌîÑÎ°úÍ∑∏Îû®ÏùÄ Ï∞∏Í≥†Ïö©Ïù¥Î©∞, ÏµúÏ¢Ö ÏàòÏà† Í≤∞Ï†ïÏùÄ Î∞òÎìúÏãú Ï†ÑÎ¨∏ÏùòÏôÄ ÏÉÅÎã¥ÌïòÏÑ∏Ïöî.</p>
            <p class="footer-small">Munnerlyn's Formula Í∏∞Î∞ò | Randleman ERSS & PTA ÌèâÍ∞Ä</p>
        </footer>
    </div>

    <template id="results-template">
        <div class="results-content">
            <!-- ÏñëÏïà ÌÉ≠ -->
            <div class="eye-tabs">
                <button type="button" class="eye-tab right-tab active" data-eye="od">
                    <span>üëÅÔ∏è</span> Ïö∞Ïïà (OD)
                </button>
                <button type="button" class="eye-tab left-tab" data-eye="os">
                    <span>üëÅÔ∏è</span> Ï¢åÏïà (OS)
                </button>
            </div>

            <!-- Ïö∞Ïïà Í≤∞Í≥º -->
            <div class="eye-results-content active" id="results-od">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>Ïö∞Ïïà (OD) Ï¢ÖÌï© ÌèâÍ∞Ä</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-od">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-od">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-od">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Ï†àÏÇ≠Îüâ Î∞è ÏûîÏó¨Í∞ÅÎßâ (OD)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>ÏàòÏà†</th><th>Ï†àÏÇ≠Îüâ</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-od"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ÏàòÏà† ÌõÑ ÏòàÏÉÅ KÍ∞í (OD)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">ÏàòÏà† Ï†Ñ</span>
                            <span class="k-value" id="preop-k-od"></span>
                        </div>
                        <div class="k-arrow">‚Üí</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">ÏàòÏà† ÌõÑ</span>
                            <span class="k-value" id="postop-k-od"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-od"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ÏúÑÌóòÎèÑ ÌèâÍ∞Ä (OD)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-od"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-od"></span>
                            <span class="erss-risk-level" id="erss-risk-level-od"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Î≥µÌï© ÏúÑÌóòÎèÑ Ìï¥ÏÑù (OD)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-od"></div>
                        <div class="interpretation-guide" id="interpretation-guide-od"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram Í∂åÏû• (OD)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-od"></div>
                </div>
            </div>

            <!-- Ï¢åÏïà Í≤∞Í≥º -->
            <div class="eye-results-content" id="results-os">
                <div class="result-card summary-card">
                    <div class="card-header">
                        <h3>Ï¢åÏïà (OS) Ï¢ÖÌï© ÌèâÍ∞Ä</h3>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item" id="summary-lasik-os">
                            <div class="surgery-name">LASIK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-lasek-os">
                            <div class="surgery-name">LASEK/PRK</div>
                            <div class="surgery-status"></div>
                        </div>
                        <div class="summary-item" id="summary-smile-os">
                            <div class="surgery-name">SMILE</div>
                            <div class="surgery-status"></div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Ï†àÏÇ≠Îüâ Î∞è ÏûîÏó¨Í∞ÅÎßâ (OS)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr><th>ÏàòÏà†</th><th>Ï†àÏÇ≠Îüâ</th><th>RSB</th><th>PTA</th></tr>
                            </thead>
                            <tbody id="ablation-table-body-os"></tbody>
                        </table>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ÏàòÏà† ÌõÑ ÏòàÏÉÅ KÍ∞í (OS)</h3>
                    </div>
                    <div class="k-values-display">
                        <div class="k-value-item">
                            <span class="k-label">ÏàòÏà† Ï†Ñ</span>
                            <span class="k-value" id="preop-k-os"></span>
                        </div>
                        <div class="k-arrow">‚Üí</div>
                        <div class="k-value-item highlight">
                            <span class="k-label">ÏàòÏà† ÌõÑ</span>
                            <span class="k-value" id="postop-k-os"></span>
                        </div>
                    </div>
                    <div class="k-note" id="k-warning-os"></div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>ÏúÑÌóòÎèÑ ÌèâÍ∞Ä (OS)</h3>
                    </div>
                    <div class="risk-section">
                        <h4>ERSS Score</h4>
                        <div class="erss-breakdown" id="erss-breakdown-os"></div>
                        <div class="erss-total">
                            <span class="erss-label">Total:</span>
                            <span class="erss-score" id="erss-total-score-os"></span>
                            <span class="erss-risk-level" id="erss-risk-level-os"></span>
                        </div>
                    </div>
                    <div class="risk-section">
                        <h4>PTA</h4>
                        <div class="pta-display" id="pta-display-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Î≥µÌï© ÏúÑÌóòÎèÑ Ìï¥ÏÑù (OS)</h3>
                    </div>
                    <div class="combined-risk-section">
                        <div class="combined-risk-matrix" id="combined-risk-matrix-os"></div>
                        <div class="interpretation-guide" id="interpretation-guide-os"></div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="card-header">
                        <h3>Nomogram Í∂åÏû• (OS)</h3>
                    </div>
                    <div class="nomogram-info" id="nomogram-info-os"></div>
                </div>
            </div>

            <div class="clinical-note" style="margin-top: var(--space-lg);">
                <div class="note-icon">‚ÑπÔ∏è</div>
                <div class="note-content">
                    <strong>Ï∞∏Í≥†:</strong> ERSSÎäî Î≥¥ÏàòÏ†Å ÌèâÍ∞Ä Í≤ΩÌñ•Ïù¥ ÏûàÏäµÎãàÎã§. PTAÎäî Ï†ïÏÉÅ TopographyÏóêÏÑú Îçî Í∞ïÌïú ÏòàÏ∏°Î†•ÏùÑ Î≥¥ÏûÖÎãàÎã§.
                    <span class="reference">(Santhiago et al., Chan et al. 2018)</span>
                </div>
            </div>

            <div class="result-actions">
                <button class="btn-secondary" id="btn-print">üñ®Ô∏è Ïù∏ÏáÑ</button>
                <button class="btn-secondary" id="btn-save">üíæ Ï†ÄÏû•</button>
                <button class="btn-primary" id="btn-new">üîÑ ÏÉà Í≤ÄÏÇ¨</button>
            </div>
        </div>
    </template>

    <script>
// ============================================
// Ïó∞ÏÑ∏ÏÜîÏïàÍ≥º ÏãúÎ†•ÍµêÏ†ïÏà† Ï†ÅÌï©ÏÑ± Í≤ÄÏÇ¨
// Firebase & Authentication Module
// ============================================

// Firebase ÏÑ§Ï†ï
const firebaseConfig = {
  apiKey: "AIzaSyDjXsLII4yWswECOjbSXDhrEvKDhV2WpUY",
  authDomain: "refractive-surgery-check.firebaseapp.com",
  projectId: "refractive-surgery-check",
  storageBucket: "refractive-surgery-check.firebasestorage.app",
  messagingSenderId: "877429462758",
  appId: "1:877429462758:web:5115613120c61c7742cd27"
};

// Firebase Ï¥àÍ∏∞Ìôî
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Demo mode OFF (Firebase ÏÇ¨Ïö©)
const DEMO_MODE = false;
const LOCAL_STORAGE_KEY = 'yonsei_sol_patients';

// Current user state
let currentUser = null;

// Modal toggle function
function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (show) {
            modal.classList.add('active');
            if (modalId === 'search-modal') {
                loadRecentPatients();
            }
        } else {
            modal.classList.remove('active');
        }
    }
}

// Close modal when clicking overlay
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
    }
});

// Handle login
async function handleLogin() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorDiv = document.getElementById('login-error');
    
    if (!email || !password) {
        errorDiv.textContent = 'Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
        return;
    }
    
    if (DEMO_MODE) {
        currentUser = { email: email };
        updateAuthUI();
        toggleModal('login-modal', false);
        showNotification('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ (Îç∞Î™® Î™®Îìú)', 'success');
    } else {
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            currentUser = userCredential.user;
            updateAuthUI();
            toggleModal('login-modal', false);
            showNotification('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!', 'success');
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/user-not-found') {
                errorDiv.textContent = 'Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùºÏûÖÎãàÎã§.';
            } else if (error.code === 'auth/wrong-password') {
                errorDiv.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.';
            } else if (error.code === 'auth/invalid-credential') {
                errorDiv.textContent = 'Ïù¥Î©îÏùº ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.';
            } else {
                errorDiv.textContent = 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + error.message;
            }
        }
    }
}

// Handle logout
async function handleLogout() {
    if (!DEMO_MODE) {
        try {
            await auth.signOut();
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    currentUser = null;
    updateAuthUI();
    showNotification('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.', 'info');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0284c7'};
        color: white;
        border-radius: 8px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Search patients
function searchPatients() {
    const query = document.getElementById('search-input').value.trim();
    const resultsDiv = document.getElementById('search-results');
    
    if (!query) {
        resultsDiv.innerHTML = '<div class="search-placeholder">ÌôòÏûê Ïù¥Î¶Ñ ÎòêÎäî Îì±Î°ùÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>';
        return;
    }
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const filtered = patients.filter(p => 
        (p.patientName && p.patientName.includes(query)) ||
        (p.patientId && p.patientId.includes(query))
    );
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="search-placeholder">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map(p => `
        <div class="search-result-item" onclick="loadPatient('${p.patientId}')">
            <div class="search-result-name">${p.patientName || '(Ïù¥Î¶Ñ ÏóÜÏùå)'}</div>
            <div class="search-result-info">
                Îì±Î°ùÎ≤àÌò∏: ${p.patientId || '-'} | 
                ÎÇòÏù¥: ${p.age || '-'} |
                ÏµúÍ∑º: ${new Date(p.updatedAt).toLocaleDateString('ko-KR')}
            </div>
        </div>
    `).join('');
}

// Load recent patients
function loadRecentPatients() {
    const listDiv = document.getElementById('recent-patients-list');
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    if (patients.length === 0) {
        listDiv.innerHTML = '<div class="search-placeholder">Ï†ÄÏû•Îêú ÌôòÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
    }
    
    const recent = patients
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
        .slice(0, 5);
    
    listDiv.innerHTML = recent.map(p => `
        <div class="recent-patient-item" onclick="loadPatient('${p.patientId}')">
            <span>${p.patientName || '(Ïù¥Î¶Ñ ÏóÜÏùå)'} - ${p.patientId || '-'}</span>
            <span>${new Date(p.updatedAt).toLocaleDateString('ko-KR')}</span>
        </div>
    `).join('');
}

// Load patient data into form
function loadPatient(patientId) {
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    const patient = patients.find(p => p.patientId === patientId);
    
    if (!patient) {
        showNotification('ÌôòÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
        return;
    }
    
    // Fill form fields
    document.getElementById('patient-name').value = patient.patientName || '';
    document.getElementById('patient-id').value = patient.patientId || '';
    document.getElementById('age').value = patient.age || 25;
    document.getElementById('gender').value = patient.gender || 'male';
    
    // OD fields
    if (patient.od) {
        document.getElementById('od-sph').value = patient.od.sph || -3;
        document.getElementById('od-cyl').value = patient.od.cyl || -1;
        document.getElementById('od-axis').value = patient.od.axis || 180;
        document.getElementById('od-cct').value = patient.od.cct || 540;
        document.getElementById('od-k1').value = patient.od.k1 || 43;
        document.getElementById('od-k2').value = patient.od.k2 || 44;
        document.getElementById('od-steep-axis').value = patient.od.steepAxis || 90;
        document.getElementById('od-topography').value = patient.od.topography || 'normal';
        document.getElementById('od-optical-zone').value = patient.od.opticalZone || 6.5;
        document.getElementById('od-lasik-flap').value = patient.od.lasikFlap || 90;
        document.getElementById('od-lasek-epi').value = patient.od.lasekEpi || 55;
        document.getElementById('od-smile-cap').value = patient.od.smileCap || 120;
    }
    
    // OS fields
    if (patient.os) {
        document.getElementById('os-sph').value = patient.os.sph || -3;
        document.getElementById('os-cyl').value = patient.os.cyl || -1;
        document.getElementById('os-axis').value = patient.os.axis || 180;
        document.getElementById('os-cct').value = patient.os.cct || 535;
        document.getElementById('os-k1').value = patient.os.k1 || 43;
        document.getElementById('os-k2').value = patient.os.k2 || 44;
        document.getElementById('os-steep-axis').value = patient.os.steepAxis || 90;
        document.getElementById('os-topography').value = patient.os.topography || 'normal';
        document.getElementById('os-optical-zone').value = patient.os.opticalZone || 6.5;
        document.getElementById('os-lasik-flap').value = patient.os.lasikFlap || 90;
        document.getElementById('os-lasek-epi').value = patient.os.lasekEpi || 55;
        document.getElementById('os-smile-cap').value = patient.os.smileCap || 120;
    }
    
    toggleModal('search-modal', false);
    showNotification(`${patient.patientName || patientId} ÌôòÏûê Ï†ïÎ≥¥Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.`, 'success');
    
    // Update SE displays
    if (window.calculator) {
        window.calculator.updateSE('od');
        window.calculator.updateSE('os');
    }
}

// Save patient to localStorage (enhanced version)
function savePatientData(formData, results) {
    const patientData = {
        patientName: formData.common?.patientName || document.getElementById('patient-name').value,
        patientId: formData.common?.patientId || document.getElementById('patient-id').value,
        age: formData.od?.age || parseInt(document.getElementById('age').value),
        gender: formData.od?.gender || document.getElementById('gender').value,
        od: {
            sph: formData.od?.sph,
            cyl: formData.od?.cyl,
            axis: formData.od?.axis,
            cct: formData.od?.cct,
            k1: formData.od?.k1,
            k2: formData.od?.k2,
            steepAxis: formData.od?.steepAxis,
            topography: formData.od?.topography,
            opticalZone: formData.od?.opticalZone,
            lasikFlap: formData.od?.lasikFlap,
            lasekEpi: formData.od?.lasekEpi,
            smileCap: formData.od?.smileCap
        },
        os: {
            sph: formData.os?.sph,
            cyl: formData.os?.cyl,
            axis: formData.os?.axis,
            cct: formData.os?.cct,
            k1: formData.os?.k1,
            k2: formData.os?.k2,
            steepAxis: formData.os?.steepAxis,
            topography: formData.os?.topography,
            opticalZone: formData.os?.opticalZone,
            lasikFlap: formData.os?.lasikFlap,
            lasekEpi: formData.os?.lasekEpi,
            smileCap: formData.os?.smileCap
        },
        results: results,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: currentUser?.email || 'anonymous'
    };
    
    const patients = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
    
    // Check if patient exists
    const existingIndex = patients.findIndex(p => p.patientId === patientData.patientId);
    
    if (existingIndex >= 0) {
        patientData.createdAt = patients[existingIndex].createdAt;
        patients[existingIndex] = patientData;
    } else {
        patients.push(patientData);
    }
    
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(patients));
    return patientData;
}

const CONFIG = {
    RSB_SAFE_THRESHOLD: 300,
    RSB_WARNING_THRESHOLD: 280,
    RSB_DANGER_THRESHOLD: 250,
    PTA_SAFE_THRESHOLD: 35,
    PTA_WARNING_THRESHOLD: 40,
    K_MIN_SAFE: 34,
    K_MAX_SAFE: 48,
    K_OPTIMAL_MIN: 36,
    K_OPTIMAL_MAX: 46,
};

// AI Topography Analysis Thresholds based on published criteria
const TOPO_THRESHOLDS = {
    // Belin-Ambrosio Display (BAD-D)
    badD: { normal: 1.6, suspect: 2.6 },
    // I-S value (Inferior-Superior asymmetry)
    isValue: { normal: 1.4, suspect: 1.9 },
    // KISA% index
    kisa: { normal: 60, suspect: 100 },
    // Posterior elevation (central, best-fit sphere)
    posteriorElevation: { normal: 15, suspect: 29 },
    // Anterior elevation
    anteriorElevation: { normal: 7, suspect: 12 },
    // Thinnest pachymetry location displacement
    thinnestDisplacement: { normal: 0.5, suspect: 0.9 },
    // Pachymetric progression index (PPI)
    ppiMax: { normal: 1.2, suspect: 1.6 },
    // ARC (Ambr√≥sio Relational Thickness)
    artMax: { normal: 400, suspect: 339 },
    // Keratoconus Index (KI)
    ki: { normal: 1.07, suspect: 1.1 },
    // Central Keratoconus Index (CKI)
    cki: { normal: 1.03, suspect: 1.05 },
    // Index of Height Asymmetry (IHA)
    iha: { normal: 19, suspect: 30 },
    // Index of Height Decentration (IHD)
    ihd: { normal: 0.014, suspect: 0.021 },
    // Index of Surface Variance (ISV)
    isv: { normal: 37, suspect: 52 },
    // Index of Vertical Asymmetry (IVA)
    iva: { normal: 0.28, suspect: 0.42 },
    // Corneal thickness at thinnest point
    tct: { normal: 490, danger: 470 },
    // Sim K astigmatism
    simKAstig: { normal: 2.0, suspect: 3.0 },
    // Max K
    maxK: { normal: 47.2, suspect: 48.7 }
};

/**
 * AI Topography Analyzer
 * Parses and analyzes Galilei G4, Pentacam, Orbscan data
 */
class TopographyAnalyzer {
    constructor() {
        this.init();
    }
    
    init() {
        // Enable analyze buttons when text is entered
        ['od', 'os'].forEach(eye => {
            const textarea = document.getElementById(`${eye}-topo-data`);
            const button = document.getElementById(`btn-analyze-${eye}`);
            
            if (textarea && button) {
                textarea.addEventListener('input', () => {
                    button.disabled = textarea.value.trim().length < 10;
                });
                
                button.addEventListener('click', () => {
                    this.analyzeTopography(eye);
                });
            }
        });
    }
    
    /**
     * Main analysis function
     */
    analyzeTopography(eye) {
        const textarea = document.getElementById(`${eye}-topo-data`);
        const resultContainer = document.getElementById(`${eye}-ai-result`);
        const button = document.getElementById(`btn-analyze-${eye}`);
        const topoSelect = document.getElementById(`${eye}-topography`);
        
        if (!textarea || !resultContainer) return;
        
        const rawData = textarea.value.trim();
        if (rawData.length < 10) return;
        
        // Show analyzing state
        button.classList.add('analyzing');
        button.innerHTML = '<span class="analyze-icon">‚è≥</span> Î∂ÑÏÑùÏ§ë...';
        
        // Simulate analysis delay for UX
        setTimeout(() => {
            try {
                const parsedData = this.parseTopographyData(rawData);
                const analysis = this.analyzeIndices(parsedData);
                this.renderAnalysisResult(resultContainer, analysis, parsedData);
                
                // Auto-update topography select based on analysis
                if (topoSelect && analysis.classification) {
                    this.updateTopographySelect(topoSelect, analysis.classification);
                }
                
            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="ai-result-content">
                        <div class="ai-classification suspect">
                            <span>‚ö†Ô∏è</span> Î∂ÑÏÑù Ïò§Î•ò
                        </div>
                        <div class="ai-findings">
                            <div class="ai-finding-item">
                                <span class="finding-icon">‚ùå</span>
                                <span>Îç∞Ïù¥ÌÑ∞Î•º ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Ïò¨Î∞îÎ•∏ ÌòïÏãùÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</span>
                            </div>
                            <div class="ai-finding-item">
                                <span class="finding-icon">üí°</span>
                                <span>Galilei G4, Pentacam, OrbscanÏùò Í≤∞Í≥ºÎ•º Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî.</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            button.classList.remove('analyzing');
            button.innerHTML = '<span class="analyze-icon">üîç</span> Î∂ÑÏÑù';
        }, 800);
    }
    
    /**
     * Parse various topography data formats
     */
    parseTopographyData(rawData) {
        const data = {};
        const text = rawData.toLowerCase();
        
        // Helper function to extract numeric value
        const extractNumber = (pattern, text) => {
            const match = text.match(pattern);
            return match ? parseFloat(match[1]) : null;
        };
        
        // BAD-D (Belin-Ambrosio Display)
        data.badD = extractNumber(/bad[- ]?d[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                    extractNumber(/belin[- ]?ambr[o√≥]sio[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // I-S value
        data.isValue = extractNumber(/i[- ]?s[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                       extractNumber(/inferior[- ]?superior[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // KISA%
        data.kisa = extractNumber(/kisa[%]?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // Posterior elevation
        data.posteriorElevation = extractNumber(/post(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData) ||
                                   extractNumber(/posterior[:\s]*([+-]?\d+\.?\d*)\s*[Œºu]?m/i, rawData);
        
        // Anterior elevation
        data.anteriorElevation = extractNumber(/ant(?:erior)?[- ]?elev(?:ation)?[:\s]*([+-]?\d+\.?\d*)/i, rawData);
        
        // TCT / Thinnest pachymetry
        data.tct = extractNumber(/tct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/thinnest[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/min(?:imum)?[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Thinnest location (displacement from center)
        const thinnestLoc = rawData.match(/thinnest[^(]*\(([+-]?\d+\.?\d*)[,\s]+([+-]?\d+\.?\d*)\)/i);
        if (thinnestLoc) {
            const x = parseFloat(thinnestLoc[1]);
            const y = parseFloat(thinnestLoc[2]);
            data.thinnestDisplacement = Math.sqrt(x*x + y*y);
        }
        
        // Sim K values
        const simKMatch = rawData.match(/sim[- ]?k[:\s]*(\d+\.?\d*)\s*[@at]*\s*(\d+)[¬∞]?\s*[\/,]\s*(\d+\.?\d*)\s*[@at]*\s*(\d+)/i);
        if (simKMatch) {
            data.simK1 = parseFloat(simKMatch[1]);
            data.simK1Axis = parseFloat(simKMatch[2]);
            data.simK2 = parseFloat(simKMatch[3]);
            data.simK2Axis = parseFloat(simKMatch[4]);
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Alternative K reading patterns
        if (!data.simK1) {
            data.simK1 = extractNumber(/k1[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/flat[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (!data.simK2) {
            data.simK2 = extractNumber(/k2[:\s]*(\d+\.?\d*)/i, rawData) ||
                         extractNumber(/steep[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        }
        if (data.simK1 && data.simK2 && !data.simKAstig) {
            data.simKAstig = Math.abs(data.simK2 - data.simK1);
        }
        
        // Max K / Kmax
        data.maxK = extractNumber(/k[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                    extractNumber(/max[- ]?k[:\s]*(\d+\.?\d*)/i, rawData);
        
        // PPI (Pachymetric Progression Index)
        data.ppiMax = extractNumber(/ppi[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/ppi[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ART (Ambr√≥sio Relational Thickness)
        data.artMax = extractNumber(/art[- ]?max[:\s]*(\d+\.?\d*)/i, rawData) ||
                      extractNumber(/art[:\s]*(\d+\.?\d*)/i, rawData);
        
        // KI (Keratoconus Index)
        data.ki = extractNumber(/\bki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CKI (Central Keratoconus Index)
        data.cki = extractNumber(/cki[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHA (Index of Height Asymmetry)
        data.iha = extractNumber(/iha[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IHD (Index of Height Decentration)
        data.ihd = extractNumber(/ihd[:\s]*(\d+\.?\d*)/i, rawData);
        
        // ISV (Index of Surface Variance)
        data.isv = extractNumber(/isv[:\s]*(\d+\.?\d*)/i, rawData);
        
        // IVA (Index of Vertical Asymmetry)
        data.iva = extractNumber(/iva[:\s]*(\d+\.?\d*)/i, rawData);
        
        // CCT (Central Corneal Thickness)
        data.cct = extractNumber(/cct[:\s]*(\d+)/i, rawData) ||
                   extractNumber(/central[- ]?pachy[:\s]*(\d+)/i, rawData);
        
        // Pattern recognition keywords
        data.hasInferiorSteepening = /inferior[- ]?steep/i.test(rawData);
        data.hasAsymmetricBowtie = /asymmetric[- ]?bowtie|ab[- ]?srax/i.test(rawData);
        data.hasSuspectPattern = /suspect|abnormal|keratoconus|kc|ffkc|forme[- ]?fruste/i.test(rawData);
        data.hasNormalPattern = /normal|regular|symmetric/i.test(rawData) && !data.hasSuspectPattern;
        
        return data;
    }
    
    /**
     * Analyze parsed indices and generate classification
     */
    analyzeIndices(data) {
        const findings = [];
        const indices = {};
        let normalCount = 0;
        let suspectCount = 0;
        let abnormalCount = 0;
        
        // Check BAD-D
        if (data.badD !== null) {
            indices.badD = { value: data.badD, label: 'BAD-D' };
            if (data.badD > TOPO_THRESHOLDS.badD.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `BAD-D ${data.badD.toFixed(2)} - ÎπÑÏ†ïÏÉÅ (Í∏∞Ï§Ä: <${TOPO_THRESHOLDS.badD.suspect})` });
                indices.badD.status = 'danger';
            } else if (data.badD > TOPO_THRESHOLDS.badD.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `BAD-D ${data.badD.toFixed(2)} - ÏùòÏã¨ (Í∏∞Ï§Ä: <${TOPO_THRESHOLDS.badD.normal})` });
                indices.badD.status = 'warning';
            } else {
                normalCount++;
                indices.badD.status = 'normal';
            }
        }
        
        // Check I-S value
        if (data.isValue !== null) {
            indices.isValue = { value: data.isValue, label: 'I-S' };
            if (data.isValue > TOPO_THRESHOLDS.isValue.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `I-S ${data.isValue.toFixed(2)}D - ÌïòÎ∞© Í∞ÄÌååÎ¶Ñ (Í∏∞Ï§Ä: <${TOPO_THRESHOLDS.isValue.suspect})` });
                indices.isValue.status = 'danger';
            } else if (data.isValue > TOPO_THRESHOLDS.isValue.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `I-S ${data.isValue.toFixed(2)}D - Í≤ΩÍ≥Ñ Î≤îÏúÑ` });
                indices.isValue.status = 'warning';
            } else {
                normalCount++;
                indices.isValue.status = 'normal';
            }
        }
        
        // Check Posterior Elevation
        if (data.posteriorElevation !== null) {
            indices.posteriorElev = { value: data.posteriorElevation, label: 'Post.Elev' };
            if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `ÌõÑÎ©¥ ÏúµÍ∏∞ ${data.posteriorElevation}Œºm - ÎπÑÏ†ïÏÉÅ (Í∏∞Ï§Ä: <${TOPO_THRESHOLDS.posteriorElevation.suspect})` });
                indices.posteriorElev.status = 'danger';
            } else if (data.posteriorElevation > TOPO_THRESHOLDS.posteriorElevation.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `ÌõÑÎ©¥ ÏúµÍ∏∞ ${data.posteriorElevation}Œºm - Í≤ΩÍ≥Ñ Î≤îÏúÑ` });
                indices.posteriorElev.status = 'warning';
            } else {
                normalCount++;
                indices.posteriorElev.status = 'normal';
            }
        }
        
        // Check TCT
        if (data.tct !== null) {
            indices.tct = { value: data.tct, label: 'TCT' };
            if (data.tct < TOPO_THRESHOLDS.tct.danger) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `ÏµúÎ∞ïÏ†ê ÎëêÍªò ${data.tct}Œºm - Îß§Ïö∞ ÏñáÏùå (Í∏∞Ï§Ä: >${TOPO_THRESHOLDS.tct.danger})` });
                indices.tct.status = 'danger';
            } else if (data.tct < TOPO_THRESHOLDS.tct.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `ÏµúÎ∞ïÏ†ê ÎëêÍªò ${data.tct}Œºm - Îã§ÏÜå ÏñáÏùå` });
                indices.tct.status = 'warning';
            } else {
                normalCount++;
                indices.tct.status = 'normal';
            }
        }
        
        // Check Thinnest location displacement
        if (data.thinnestDisplacement !== null) {
            indices.thinnestLoc = { value: data.thinnestDisplacement, label: 'Thin.Loc' };
            if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `ÏµúÎ∞ïÏ†ê ÏúÑÏπò Ìé∏ÏúÑ ${data.thinnestDisplacement.toFixed(2)}mm - ÎπÑÏ†ïÏÉÅ` });
                indices.thinnestLoc.status = 'danger';
            } else if (data.thinnestDisplacement > TOPO_THRESHOLDS.thinnestDisplacement.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `ÏµúÎ∞ïÏ†ê ÏúÑÏπò Ìé∏ÏúÑ ${data.thinnestDisplacement.toFixed(2)}mm - Í≤ΩÍ≥Ñ` });
                indices.thinnestLoc.status = 'warning';
            } else {
                normalCount++;
                indices.thinnestLoc.status = 'normal';
            }
        }
        
        // Check Sim K astigmatism
        if (data.simKAstig !== null) {
            indices.simKAstig = { value: data.simKAstig, label: 'SimK Astig' };
            if (data.simKAstig > TOPO_THRESHOLDS.simKAstig.suspect) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `Sim K ÎÇúÏãú ${data.simKAstig.toFixed(2)}D - Í≥†ÎèÑÎÇúÏãú` });
                indices.simKAstig.status = 'warning';
            } else {
                normalCount++;
                indices.simKAstig.status = 'normal';
            }
        }
        
        // Check Max K
        if (data.maxK !== null) {
            indices.maxK = { value: data.maxK, label: 'Kmax' };
            if (data.maxK > TOPO_THRESHOLDS.maxK.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `Kmax ${data.maxK.toFixed(2)}D - ÎπÑÏ†ïÏÉÅ (Í∏∞Ï§Ä: <${TOPO_THRESHOLDS.maxK.suspect})` });
                indices.maxK.status = 'danger';
            } else if (data.maxK > TOPO_THRESHOLDS.maxK.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `Kmax ${data.maxK.toFixed(2)}D - Í≤ΩÍ≥Ñ Î≤îÏúÑ` });
                indices.maxK.status = 'warning';
            } else {
                normalCount++;
                indices.maxK.status = 'normal';
            }
        }
        
        // Check KISA
        if (data.kisa !== null) {
            indices.kisa = { value: data.kisa, label: 'KISA%' };
            if (data.kisa > TOPO_THRESHOLDS.kisa.suspect) {
                abnormalCount++;
                findings.push({ icon: 'üî¥', text: `KISA% ${data.kisa.toFixed(1)} - ÏõêÏ∂îÍ∞ÅÎßâ Í∞ÄÎä•ÏÑ± ÎÜíÏùå` });
                indices.kisa.status = 'danger';
            } else if (data.kisa > TOPO_THRESHOLDS.kisa.normal) {
                suspectCount++;
                findings.push({ icon: 'üü°', text: `KISA% ${data.kisa.toFixed(1)} - ÏùòÏã¨ Î≤îÏúÑ` });
                indices.kisa.status = 'warning';
            } else {
                normalCount++;
                indices.kisa.status = 'normal';
            }
        }
        
        // Check pattern keywords
        if (data.hasInferiorSteepening) {
            suspectCount++;
            findings.push({ icon: 'üü°', text: 'ÌïòÎ∞© Í∞ÄÌååÎ¶Ñ(Inferior Steepening) Ìå®ÌÑ¥ Í∞êÏßÄ' });
        }
        if (data.hasAsymmetricBowtie) {
            suspectCount++;
            findings.push({ icon: 'üü°', text: 'ÎπÑÎåÄÏπ≠ ÎÇòÎπÑÎÑ•ÌÉÄÏù¥(Asymmetric Bowtie) Ìå®ÌÑ¥ Í∞êÏßÄ' });
        }
        if (data.hasSuspectPattern) {
            abnormalCount++;
            findings.push({ icon: 'üî¥', text: 'ÏõêÏ∂îÍ∞ÅÎßâ ÏùòÏã¨ ÏÜåÍ≤¨ ÌÇ§ÏõåÎìú Í∞êÏßÄ' });
        }
        
        // Determine classification
        let classification, classLabel, confidence;
        
        if (abnormalCount >= 2 || (abnormalCount >= 1 && suspectCount >= 2)) {
            classification = 'abnormal';
            classLabel = 'Abnormal (KC suspect)';
            confidence = Math.min(95, 70 + abnormalCount * 10 + suspectCount * 5);
        } else if (abnormalCount >= 1 || suspectCount >= 2) {
            classification = 'suspect';
            classLabel = 'ÏùòÏã¨ (Suspect)';
            confidence = Math.min(90, 60 + abnormalCount * 15 + suspectCount * 10);
        } else if (suspectCount === 1) {
            classification = 'suspect';
            classLabel = 'Í≤ΩÍ≥Ñ (Borderline)';
            confidence = Math.min(75, 50 + suspectCount * 15);
        } else if (normalCount > 0 || data.hasNormalPattern) {
            classification = 'normal';
            classLabel = 'Ï†ïÏÉÅ (Normal)';
            confidence = Math.min(95, 70 + normalCount * 5);
        } else {
            classification = 'unknown';
            classLabel = 'ÌåêÏ†ï Î∂àÍ∞Ä';
            confidence = 0;
        }
        
        // Add summary finding
        if (findings.length === 0) {
            findings.push({ icon: '‚úÖ', text: 'Î∂ÑÏÑùÎêú ÏßÄÌëúÎì§Ïù¥ Ï†ïÏÉÅ Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏäµÎãàÎã§.' });
        }
        
        return {
            classification,
            classLabel,
            confidence,
            findings,
            indices,
            stats: { normalCount, suspectCount, abnormalCount }
        };
    }
    
    /**
     * Render analysis result to container
     */
    renderAnalysisResult(container, analysis, rawData) {
        const findingsHTML = analysis.findings
            .map(f => `<div class="ai-finding-item"><span class="finding-icon">${f.icon}</span><span>${f.text}</span></div>`)
            .join('');
        
        const indicesHTML = Object.entries(analysis.indices)
            .map(([key, val]) => `
                <div class="ai-index-item">
                    <span class="ai-index-label">${val.label}</span>
                    <span class="ai-index-value ${val.status}">${typeof val.value === 'number' ? val.value.toFixed(2) : val.value}</span>
                </div>
            `).join('');
        
        container.innerHTML = `
            <div class="ai-result-content">
                <div class="ai-result-header">
                    <div class="ai-classification ${analysis.classification}">
                        <span>${analysis.classification === 'normal' ? '‚úÖ' : analysis.classification === 'abnormal' ? 'üö´' : '‚ö†Ô∏è'}</span>
                        ${analysis.classLabel}
                    </div>
                    ${analysis.confidence > 0 ? `<span class="ai-confidence">Ïã†Î¢∞ÎèÑ: ${analysis.confidence}%</span>` : ''}
                </div>
                <div class="ai-findings">${findingsHTML}</div>
                ${indicesHTML ? `<div class="ai-indices">${indicesHTML}</div>` : ''}
            </div>
        `;
    }
    
    /**
     * Auto-update topography select based on AI classification
     */
    updateTopographySelect(select, classification) {
        const mapping = {
            'normal': 'normal',
            'suspect': 'inferior-steepening',
            'abnormal': 'abnormal'
        };
        
        if (mapping[classification]) {
            select.value = mapping[classification];
            // Highlight that it was auto-updated
            select.style.borderColor = '#6366f1';
            select.title = 'AI Î∂ÑÏÑùÏóê ÏùòÌï¥ ÏûêÎèô ÏÑ§Ï†ïÎê®';
            setTimeout(() => {
                select.style.borderColor = '';
            }, 3000);
        }
    }
}

const ERSS_CRITERIA = {
    topography: {
        'normal': 0,
        'asymmetric-bowtie': 1,
        'inferior-steepening': 2,
        'abnormal': 4
    },
    rsb: [
        { max: 239, points: 4 },
        { max: 259, points: 3 },
        { max: 279, points: 2 },
        { max: 299, points: 1 },
        { max: Infinity, points: 0 }
    ],
    age: [
        { max: 17, points: 4 },
        { max: 21, points: 3 },
        { max: 25, points: 2 },
        { max: 29, points: 1 },
        { max: Infinity, points: 0 }
    ],
    cct: [
        { max: 449, points: 4 },
        { max: 479, points: 3 },
        { max: 509, points: 2 },
        { max: Infinity, points: 0 }
    ],
    mrse: [
        { max: -14, points: 4 },
        { max: -12, points: 3 },
        { max: -10, points: 2 },
        { max: -8, points: 1 },
        { max: Infinity, points: 0 }
    ]
};

function calculateAblationDepth(correction, opticalZone) {
    const ablationDepth = (Math.pow(opticalZone, 2) * Math.abs(correction)) / 3;
    return Math.round(ablationDepth * 10) / 10;
}

function calculateSE(sph, cyl) {
    return sph + (cyl / 2);
}

function calculateTotalCorrection(sph, cyl) {
    return Math.abs(sph) + Math.abs(cyl);
}

function calculateRSB(cct, flapThickness, ablationDepth) {
    return cct - flapThickness - ablationDepth;
}

function calculatePTA(cct, flapThickness, ablationDepth) {
    return ((flapThickness + ablationDepth) / cct) * 100;
}

function calculatePostopK(k1, k2, sph, cyl) {
    const minK = Math.min(k1, k2);
    const se = sph + (cyl / 2);
    const postopK = minK + (se * 0.75);
    return Math.round(postopK * 100) / 100;
}

function calculateERSS(params) {
    const { age, cct, topography, rsb, mrse } = params;
    
    const breakdown = {
        topography: ERSS_CRITERIA.topography[topography] || 0,
        rsb: 0,
        age: 0,
        cct: 0,
        mrse: 0
    };
    
    for (const criterion of ERSS_CRITERIA.rsb) {
        if (rsb <= criterion.max) {
            breakdown.rsb = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.age) {
        if (age <= criterion.max) {
            breakdown.age = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.cct) {
        if (cct <= criterion.max) {
            breakdown.cct = criterion.points;
            break;
        }
    }
    
    for (const criterion of ERSS_CRITERIA.mrse) {
        if (mrse <= criterion.max) {
            breakdown.mrse = criterion.points;
            break;
        }
    }
    
    const total = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
    
    let riskLevel;
    if (total <= 2) {
        riskLevel = 'low';
    } else if (total === 3) {
        riskLevel = 'moderate';
    } else {
        riskLevel = 'high';
    }
    
    return { breakdown, total, riskLevel };
}

function getWellingtonNomogramAdjustments(sph, cyl, age) {
    const recommendations = [];
    const se = calculateSE(sph, cyl);
    
    if (se <= -6.0) {
        recommendations.push({
            title: 'Í≥†ÎèÑÍ∑ºÏãú Ï°∞Ï†ï (High Myopia)',
            text: `SE ${se.toFixed(2)}DÏùò Í≥†ÎèÑÍ∑ºÏãúÏûÖÎãàÎã§. Wellington nomogramÏóêÏÑúÎäî Í≥†ÎèÑÍ∑ºÏãú Ïãú ÏïΩÍ∞ÑÏùò Í≥ºÏÜåÍµêÏ†ï Í≤ΩÌñ•Ïù¥ ÏûàÏñ¥ Î™©Ìëú Íµ¥Ï†àÍ∞íÏùÑ -0.25 ~ -0.50DÎ°ú ÏÑ§Ï†ïÌïòÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`
        });
    } else if (se >= -3.0 && se < 0) {
        recommendations.push({
            title: 'Í≤ΩÎèÑÍ∑ºÏãú Ï°∞Ï†ï (Low Myopia)',
            text: `SE ${se.toFixed(2)}DÏùò Í≤ΩÎèÑÍ∑ºÏãúÏûÖÎãàÎã§. Wellington nomogramÏóêÏÑúÎäî Í≤ΩÎèÑÍ∑ºÏãú Ïãú Ï†ïÌôïÌïú ÍµêÏ†ïÏù¥ Í∞ÄÎä•ÌïòÎØÄÎ°ú Î™©ÌëúÎ•º planoÎ°ú ÏÑ§Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.`
        });
    }
    
    if (Math.abs(cyl) >= 2.0) {
        recommendations.push({
            title: 'Í≥†ÎèÑÎÇúÏãú Ï°∞Ï†ï (High Astigmatism)',
            text: `ÎÇúÏãú ${cyl.toFixed(2)}DÍ∞Ä 2D Ïù¥ÏÉÅÏûÖÎãàÎã§. ÎÇúÏãú ÍµêÏ†ï Ïãú coupling effectÎ•º Í≥†Î†§ÌïòÏó¨ Íµ¨Î©¥ ÍµêÏ†ïÎüâÏùÑ Ï°∞Ï†ïÌï¥Ïïº Ìï† Ïàò ÏûàÏäµÎãàÎã§. ÏùºÎ∞òÏ†ÅÏúºÎ°ú ÎÇúÏãú ÍµêÏ†ïÎüâÏùò 15-20%Î•º Íµ¨Î©¥ÏóêÏÑú Ï∞®Í∞êÌï©ÎãàÎã§.`
        });
    }
    
    if (age >= 40) {
        recommendations.push({
            title: 'ÎÖ∏Ïïà Í≥†Î†§ (Presbyopia Consideration)',
            text: `ÌôòÏûê ÎÇòÏù¥Í∞Ä ${age}ÏÑ∏ÏûÖÎãàÎã§. ÎÖ∏ÏïàÏù¥ ÏßÑÌñâ Ï§ëÏùº Ïàò ÏûàÏúºÎØÄÎ°ú, Í∑ºÍ±∞Î¶¨ ÏãúÎ†•ÏùÑ ÏúÑÌï¥ Ï£ºÏãúÏïàÏùÄ plano, ÎπÑÏ£ºÏãúÏïàÏùÄ -0.50 ~ -1.00DÏùò monovisionÏùÑ Í≥†Î†§Ìï† Ïàò ÏûàÏäµÎãàÎã§.`
        });
    }
    
    if (se <= -8.0) {
        recommendations.push({
            title: 'ÌöåÍ∑Ä ÏòàÏ∏° (Regression Prediction)',
            text: `Ï¥àÍ≥†ÎèÑÍ∑ºÏãú(-8D Ïù¥ÏÉÅ)ÏóêÏÑúÎäî ÏàòÏà† ÌõÑ ÌöåÍ∑ÄÍ∞Ä Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§. 1ÎÖÑ ÎÇ¥ 0.5-1.0D Ï†ïÎèÑÏùò ÌöåÍ∑ÄÎ•º ÏòàÏÉÅÌïòÍ≥† ÏïΩÍ∞ÑÏùò Í≥ºÍµêÏ†ïÏùÑ Í≥†Î†§Ìï† Ïàò ÏûàÏäµÎãàÎã§.`
        });
    }
    
    if (recommendations.length === 0) {
        recommendations.push({
            title: 'ÌëúÏ§Ä ÏπòÎ£å (Standard Treatment)',
            text: `ÌòÑÏû¨ Íµ¥Ï†àÍ∞í(SE: ${se.toFixed(2)}D)ÏùÄ ÌëúÏ§Ä Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏäµÎãàÎã§. Wellington nomogram Í∏∞Î≥∏ ÏÑ§Ï†ïÏúºÎ°ú ÏπòÎ£å ÏßÑÌñâÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.`
        });
    }
    
    return recommendations;
}

/**
 * Get combined ERSS + PTA risk interpretation
 * Based on literature: Santhiago et al., Chan et al. 2018
 * 
 * @param {number} erssScore - ERSS total score
 * @param {number} ptaLasik - PTA for LASIK
 * @param {string} topography - Topography pattern
 * @returns {Object} Combined risk interpretation
 */
function getCombinedRiskInterpretation(erssScore, ptaLasik, topography) {
    // Determine PTA risk level
    let ptaLevel;
    if (ptaLasik < 35) {
        ptaLevel = 'low';
    } else if (ptaLasik < 40) {
        ptaLevel = 'moderate';
    } else {
        ptaLevel = 'high';
    }
    
    // Determine ERSS risk level
    let erssLevel;
    if (erssScore <= 2) {
        erssLevel = 'low';
    } else if (erssScore === 3) {
        erssLevel = 'moderate';
    } else {
        erssLevel = 'high';
    }
    
    // Combined interpretation matrix
    const riskMatrix = {
        'low-low': {
            level: 'low',
            title: 'Ï†ÄÏúÑÌóò (Low Risk)',
            text: 'ERSSÏôÄ PTA Î™®Îëê ÏïàÏ†Ñ Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏäµÎãàÎã§. ÏàòÏà† Ï†ÅÌï©ÏÑ±Ïù¥ ÎÜíÏúºÎ©∞, ÏùºÎ∞òÏ†ÅÏù∏ Ï£ºÏùòÏÇ¨Ìï≠Îßå Í≥†Î†§ÌïòÎ©¥ Îê©ÎãàÎã§.',
            recommendations: [
                'ÌëúÏ§Ä ÏàòÏà† ÌîÑÎ°úÌÜ†ÏΩú Ï†ÅÏö© Í∞ÄÎä•',
                'Ï†ïÍ∏∞Ï†ÅÏù∏ Ïà† ÌõÑ Í≤ΩÍ≥º Í¥ÄÏ∞∞ Í∂åÏû•',
                'ÌôòÏûêÏóêÍ≤å ÏùºÎ∞òÏ†ÅÏù∏ ÏúÑÌóòÏÑ± ÏÑ§Î™Ö'
            ]
        },
        'low-moderate': {
            level: 'low-moderate',
            title: 'Ï†Ä-Ï§ëÎì± ÏúÑÌóò (Low-Moderate Risk)',
            text: 'ERSSÎäî Ï†ÄÏúÑÌóòÏù¥ÎÇò PTAÍ∞Ä Í≤ΩÍ≥Ñ ÏàòÏ§ÄÏûÖÎãàÎã§. ERSSÎäî Î≥¥ÏàòÏ†Å Í≤ΩÌñ•Ïù¥ ÏûàÏúºÎØÄÎ°ú, PTA 35-40% Íµ¨Í∞ÑÏóêÏÑúÎäî Ïã†Ï§ëÌïú Ï†ëÍ∑ºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.',
            recommendations: [
                'Í∞ÄÎä•ÌïòÎ©¥ ÌîåÎû© ÎëêÍªòÎ•º Ï§ÑÏù¥Í±∞ÎÇò LASEK Í≥†Î†§',
                'Í¥ëÌïôÎ∂Ä ÌÅ¨Í∏∞ Ï°∞Ï†ïÏúºÎ°ú Ï†àÏÇ≠Îüâ ÏµúÏÜåÌôî Í≤ÄÌÜ†',
                'Ïà† ÌõÑ Í∞ÅÎßâÌôïÏû•Ï¶ù ÏßïÌõÑ Î©¥Î∞ÄÌûà Í¥ÄÏ∞∞'
            ]
        },
        'low-high': {
            level: 'moderate',
            title: 'Ï§ëÎì± ÏúÑÌóò (Moderate Risk)',
            text: 'ERSSÎäî Ï†ÄÏúÑÌóòÏù¥ÏßÄÎßå PTA ‚â•40%ÏûÖÎãàÎã§. Ïó∞Íµ¨Ïóê Îî∞Î•¥Î©¥ Ï†ïÏÉÅ TopographyÏóêÏÑú PTAÎäî ERSSÎ≥¥Îã§ Í∞ïÌïú ÏòàÏ∏°Î†•ÏùÑ Î≥¥ÏûÖÎãàÎã§. Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.',
            recommendations: [
                'LASEK/PRKÎ°ú Ï†ÑÌôò Í∞ïÎ†• Í∂åÏû•',
                'ICL(ÏïàÎÇ¥Î†åÏ¶àÏÇΩÏûÖÏà†) ÎåÄÏïà Í≤ÄÌÜ†',
                'ÌôòÏûêÏóêÍ≤å ÏúÑÌóòÏÑ± Ï∂©Î∂ÑÌûà ÏÑ§Î™Ö ÌõÑ ÎèôÏùò ÌïÑÏöî',
                'ÏàòÏà† ÏßÑÌñâ Ïãú ÏµúÏÜå Ï†àÏÇ≠Îüâ ÏõêÏπô Ï†ÅÏö©'
            ]
        },
        'moderate-low': {
            level: 'low-moderate',
            title: 'Ï†Ä-Ï§ëÎì± ÏúÑÌóò (Low-Moderate Risk)',
            text: 'ERSSÍ∞Ä Ï§ëÎì±ÏúÑÌóò(3Ï†ê)Ïù¥ÎÇò PTAÎäî ÏïàÏ†ÑÌï©ÎãàÎã§. ERSSÎäî Î≥¥ÏàòÏ†Å ÌèâÍ∞Ä Í≤ΩÌñ•Ïù¥ ÏûàÏñ¥, PTAÍ∞Ä ÎÇÆÎã§Î©¥ Ïã§Ï†ú ÏúÑÌóòÏùÄ ÎÇÆÏùÑ Ïàò ÏûàÏäµÎãàÎã§.',
            recommendations: [
                'Topography Ìå®ÌÑ¥ Ïû¨ÌôïÏù∏ ÌïÑÏàò',
                'Í∞ÄÏ°±Î†• Î∞è Îàà ÎπÑÎπÑÎäî ÏäµÍ¥Ä ÌôïÏù∏',
                'Í≤ΩÍ≥ÑÏã¨ÏùÑ Í∞ñÍ≥† ÏàòÏà† ÏßÑÌñâ Í∞ÄÎä•',
                'Ïà† ÌõÑ Ïû•Í∏∞ Ï∂îÏ†Å Í¥ÄÏ∞∞ Í≥ÑÌöç ÏàòÎ¶Ω'
            ]
        },
        'moderate-moderate': {
            level: 'moderate',
            title: 'Ï§ëÎì± ÏúÑÌóò (Moderate Risk)',
            text: 'ERSSÏôÄ PTA Î™®Îëê Í≤ΩÍ≥Ñ ÏàòÏ§ÄÏûÖÎãàÎã§. Îëê ÏßÄÌëúÍ∞Ä ÏùºÏπòÌïòÎØÄÎ°ú Ïã†Ï§ëÌïú Ï†ëÍ∑ºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.',
            recommendations: [
                'LASEK/PRK Ïö∞ÏÑ† Í≥†Î†§',
                'Í∞ÅÎßâ Îã®Ï∏µÏ¥¨ÏòÅ(Tomography) Ï∂îÍ∞Ä Í≤ÄÏÇ¨',
                'Í∞ÅÎßâ ÏÉùÏ≤¥Ïó≠Ìïô Í≤ÄÏÇ¨(ORA, Corvis ST) Í∂åÏû•',
                'ÏúÑÌóò-Ïù¥Ïùµ Ï∂©Î∂ÑÌûà ÏÑ§Î™Ö ÌõÑ ÌôòÏûê Í≤∞Ï†ï'
            ]
        },
        'moderate-high': {
            level: 'high',
            title: 'Í≥†ÏúÑÌóò (High Risk)',
            text: 'ERSS Ï§ëÎì±ÏúÑÌóòÏóê PTA ‚â•40%ÏûÖÎãàÎã§. Í∞ÅÎßâÌôïÏû•Ï¶ù ÏúÑÌóòÏù¥ Ïú†ÏùòÌïòÍ≤å ÎÜíÏäµÎãàÎã§.',
            recommendations: [
                'LASIK ÎπÑÍ∂åÏû• - LASEK ÎòêÎäî ICL Í∂åÏû•',
                'ÏàòÏà† Ï†Ñ Cross-linking Î≥ëÌñâ Í≥†Î†§',
                'ÌôòÏûêÏóêÍ≤å ÎåÄÏïà ÏàòÏà† Ï†ÅÍ∑π Í∂åÏú†',
                'Î∂ÄÎìùÏù¥Ìïú Í≤ΩÏö∞ ÏµúÏÜå ÍµêÏ†ïÎüâ ÏõêÏπô'
            ]
        },
        'high-low': {
            level: 'moderate',
            title: 'Ï§ëÎì± ÏúÑÌóò (Moderate Risk)',
            text: 'ERSS Í≥†ÏúÑÌóòÏù¥ÎÇò PTAÎäî ÏïàÏ†ÑÌï©ÎãàÎã§. ERSSÏùò Î≥¥ÏàòÏ†Å ÌäπÏÑ±ÏÉÅ Ïã§Ï†ú ÏúÑÌóòÏùÄ ÎÇÆÏùÑ Ïàò ÏûàÏúºÎÇò, ERSS Ï†êÏàò Íµ¨ÏÑ± ÏöîÏÜåÎ•º Í∞úÎ≥Ñ ÌôïÏù∏ÌïòÏÑ∏Ïöî.',
            recommendations: [
                'ERSS Í≥†ÎìùÏ†ê ÏöîÏù∏ Í∞úÎ≥Ñ Î∂ÑÏÑù (TopographyÍ∞Ä Ï£ºÏöîÏù∏Ïù∏ÏßÄ ÌôïÏù∏)',
                'Topography Ïù¥ÏÉÅÏù¥ ÏõêÏù∏Ïù¥Î©¥ LASIK Ïû¨Í≥†',
                'ÎÇòÏù¥/CCT/MRSEÍ∞Ä Ï£ºÏöîÏù∏Ïù¥Î©¥ ÏÉÅÎåÄÏ†Å ÏïàÏ†Ñ',
                'Ï∂îÍ∞Ä Í≤ÄÏÇ¨Î°ú ÌôïÏù∏ ÌõÑ Í≤∞Ï†ï'
            ]
        },
        'high-moderate': {
            level: 'high',
            title: 'Í≥†ÏúÑÌóò (High Risk)',
            text: 'ERSS Í≥†ÏúÑÌóòÏóê PTAÎèÑ Í≤ΩÍ≥Ñ ÏàòÏ§ÄÏûÖÎãàÎã§. Î≥µÌï©Ï†ÅÏù∏ ÏúÑÌóò ÏöîÏÜåÍ∞Ä ÏûàÏäµÎãàÎã§.',
            recommendations: [
                'LASIK Í∞ïÎ†• ÎπÑÍ∂åÏû•',
                'LASEKÎèÑ Ïã†Ï§ëÌûà Ï†ëÍ∑º',
                'ICL ÎòêÎäî ÏïàÍ≤Ω/Î†åÏ¶à ÍµêÏ†ï Í∂åÏû•',
                'ÏàòÏà† ÏßÑÌñâ Ïãú Î∞òÎìúÏãú informed consent'
            ]
        },
        'high-high': {
            level: 'very-high',
            title: 'Îß§Ïö∞ Í≥†ÏúÑÌóò (Very High Risk)',
            text: 'ERSSÏôÄ PTA Î™®Îëê Í≥†ÏúÑÌóòÏûÖÎãàÎã§. Í∞ÅÎßâÌôïÏû•Ï¶ù Î∞úÏÉù ÏúÑÌóòÏù¥ Îß§Ïö∞ ÎÜíÏïÑ Í∞ÅÎßâÍµ¥Ï†àÏàòÏà†ÏùÑ Í∂åÏû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§.',
            recommendations: [
                'Í∞ÅÎßâÍµ¥Ï†àÏàòÏà†(LASIK/LASEK/SMILE) Í∏àÍ∏∞',
                'ICL(ÏïàÎÇ¥Î†åÏ¶àÏÇΩÏûÖÏà†) Í∞ïÎ†• Í∂åÏû•',
                'ÏïàÍ≤Ω ÎòêÎäî ÏΩòÌÉùÌä∏Î†åÏ¶à ÍµêÏ†ï Ïú†ÏßÄ',
                'ÏõêÏ∂îÍ∞ÅÎßâ Ï†ïÎ∞ÄÍ≤ÄÏÇ¨ Í∂åÏû•'
            ]
        }
    };
    
    const key = `${erssLevel}-${ptaLevel}`;
    const interpretation = riskMatrix[key] || riskMatrix['moderate-moderate'];
    
    return {
        erssLevel,
        ptaLevel,
        ...interpretation
    };
}

function determineSurgeryEligibility(rsb, pta, topography, erssTotal) {
    if (topography === 'abnormal') {
        return { status: 'not-eligible', message: 'ÎπÑÏ†ÅÌï© (Í∞ÅÎßâÏù¥ÏÉÅ)' };
    }
    
    if (rsb < CONFIG.RSB_DANGER_THRESHOLD) {
        return { status: 'not-eligible', message: `ÎπÑÏ†ÅÌï© (RSB < ${CONFIG.RSB_DANGER_THRESHOLD}Œºm)` };
    }
    
    if (pta >= CONFIG.PTA_WARNING_THRESHOLD) {
        return { status: 'not-eligible', message: `ÎπÑÏ†ÅÌï© (PTA ‚â• ${CONFIG.PTA_WARNING_THRESHOLD}%)` };
    }
    
    if (erssTotal >= 4) {
        return { status: 'not-eligible', message: 'ÎπÑÏ†ÅÌï© (ERSS ‚â• 4)' };
    }
    
    if (rsb < CONFIG.RSB_SAFE_THRESHOLD || pta >= CONFIG.PTA_SAFE_THRESHOLD || erssTotal === 3) {
        return { status: 'caution', message: 'Ï£ºÏùò ÌïÑÏöî' };
    }
    
    return { status: 'eligible', message: 'Ï†ÅÌï©' };
}

/**
 * Generate combined ERSS + PTA risk interpretation guide
 * Based on published literature (Santhiago et al., Chan et al., Randleman et al.)
 */
function generateCombinedRiskGuide(erssResult, ptaLasik, ptaLasek, topography) {
    const erss = erssResult.total;
    const guides = [];
    
    // Determine the overall risk category based on combined assessment
    const isNormalTopography = topography === 'normal';
    const isAbnormalTopography = topography === 'abnormal';
    const isSuspiciousTopography = topography === 'asymmetric-bowtie' || topography === 'inferior-steepening';
    
    // Case 1: Abnormal Topography - Highest priority risk factor
    if (isAbnormalTopography) {
        guides.push({
            type: 'high-risk',
            icon: 'üö´',
            title: 'Ï†àÎåÄÏ†Å Í∏àÍ∏∞',
            condition: 'Abnormal Topography (KC suspect/FFKC)',
            text: 'ÎπÑÏ†ïÏÉÅ Í∞ÅÎßâ ÏßÄÌòïÎèÑÎäî ERSSÏóêÏÑú Í∞ÄÏû• Ï§ëÏöîÌïú Îã®Ïùº ÏúÑÌóòÏöîÏÜåÏûÖÎãàÎã§. Randleman Ïó∞Íµ¨ÏóêÏÑú ectasia Î∞úÏÉù ÎààÏùò 69%Í∞Ä ÎπÑÏ†ïÏÉÅ topographyÎ•º Î≥¥ÏòÄÏäµÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: ÏãúÎ†•ÍµêÏ†ïÏà† Í∏àÍ∏∞. Cross-linking ÎòêÎäî Îã§Î•∏ ÏπòÎ£å ÏòµÏÖò Í≥†Î†§.'
        });
        return guides;
    }
    
    // Case 2: High ERSS + High PTA
    if (erss >= 4 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: '‚õî',
            title: 'Í≥†ÏúÑÌóò - Î≥µÌï© ÏúÑÌóòÏöîÏÜå',
            condition: `ERSS ‚â• 4 (ÌòÑÏû¨: ${erss}) + PTA ‚â• 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSSÏôÄ PTA Î™®Îëê Í≥†ÏúÑÌóò Î≤îÏúÑÏûÖÎãàÎã§. Îëê ÏßÄÌëúÍ∞Ä ÎèôÏãúÏóê ÎÜíÏùÑ Í≤ΩÏö∞ ectasia Î∞úÏÉù ÏúÑÌóòÏù¥ ÌÅ¨Í≤å Ï¶ùÍ∞ÄÌï©ÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: LASIK Î∂ÄÏ†ÅÌï©. LASEK/PRK ÎòêÎäî ICL Îì± ÎåÄÏïà Í≥†Î†§.'
        });
    }
    // Case 3: High ERSS but Low PTA with Normal Topography
    else if (erss >= 4 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: '‚ö†Ô∏è',
            title: 'Ï£ºÏùò - ERSS Í≥ºÎåÄÌèâÍ∞Ä Í∞ÄÎä•ÏÑ±',
            condition: `ERSS ‚â• 4 (ÌòÑÏû¨: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), Ï†ïÏÉÅ Topography`,
            text: 'Binder & Trattler (2010) Ïó∞Íµ¨Ïóê Îî∞Î•¥Î©¥, Ï†ïÏÉÅ topographyÏóêÏÑú ERSSÍ∞Ä ÎÜíÎçîÎùºÎèÑ Ïã§Ï†ú ectasia Î∞úÏÉùÎ•†ÏùÄ Îß§Ïö∞ ÎÇÆÏïòÏäµÎãàÎã§. ERSSÍ∞Ä ÏúÑÌóòÏùÑ Í≥ºÎåÄÌèâÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: Ïã†Ï§ëÌïú ÌèâÍ∞Ä ÌïÑÏöî. Tomography(Pentacam Îì±) Ï∂îÍ∞Ä Í≤ÄÏÇ¨ Í∂åÏû•.'
        });
    }
    // Case 4: Low ERSS but High PTA
    else if (erss <= 2 && ptaLasik >= 40) {
        guides.push({
            type: 'high-risk',
            icon: '‚ö†Ô∏è',
            title: 'Ï£ºÏùò - PTA Îã®ÎèÖ Í≥†ÏúÑÌóò',
            condition: `ERSS ‚â§ 2 (ÌòÑÏû¨: ${erss}), PTA ‚â• 40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'Santhiago Ïó∞Íµ¨ÏóêÏÑú PTA ‚â• 40%Îäî ERSSÎ≥¥Îã§ ectasia ÏòàÏ∏°Ïóê Îçî Í∞ïÌïú ÏÉÅÍ¥ÄÍ¥ÄÍ≥ÑÎ•º Î≥¥ÏòÄÏäµÎãàÎã§. ERSSÍ∞Ä ÎÇÆÎçîÎùºÎèÑ ÎÜíÏùÄ PTAÎäî ÏúÑÌóò Ïã†Ìò∏ÏûÖÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: LASIK ÎåÄÏã† LASEK/PRK Í∂åÏû• (Îçî ÎÇÆÏùÄ PTA).'
        });
    }
    // Case 5: Moderate ERSS + Moderate PTA
    else if (erss === 3 && ptaLasik >= 35 && ptaLasik < 40) {
        guides.push({
            type: 'moderate-risk',
            icon: '‚ö°',
            title: 'Ï§ëÎì±ÎèÑ ÏúÑÌóò - Í≤ΩÍ≥Ñ Î≤îÏúÑ',
            condition: `ERSS = 3, PTA 35-40% (LASIK: ${ptaLasik.toFixed(1)}%)`,
            text: 'ERSS 3Ï†êÏùÄ "Ï£ºÏùò" Î≤îÏúÑÏù¥Î©∞, PTAÎèÑ Í≤ΩÍ≥Ñ ÏàòÏ§ÄÏûÖÎãàÎã§. Îã§Í∏∞Í¥Ä Ïó∞Íµ¨ÏóêÏÑú Ïù¥ Î≤îÏúÑÎäî Í∞úÎ≥Ñ ÏÇ¨Î°ÄÎ≥Ñ ÌåêÎã®Ïù¥ ÌïÑÏöîÌïú ÏòÅÏó≠ÏûÖÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: Ï∂îÍ∞Ä Í≤ÄÏÇ¨(Tomography, Biomechanics) ÌõÑ Í≤∞Ï†ï. LASEKÏù¥ Îçî ÏïàÏ†ÑÌï† Ïàò ÏûàÏùå.'
        });
    }
    // Case 6: Low ERSS + Low PTA + Normal Topography
    else if (erss <= 2 && ptaLasik < 35 && isNormalTopography) {
        guides.push({
            type: 'low-risk',
            icon: '‚úÖ',
            title: 'Ï†ÄÏúÑÌóò - ÏñëÌò∏Ìïú Ï°∞Í±¥',
            condition: `ERSS ‚â§ 2 (ÌòÑÏû¨: ${erss}), PTA < 35% (LASIK: ${ptaLasik.toFixed(1)}%), Ï†ïÏÉÅ Topography`,
            text: 'ERSS, PTA, Topography Î™®Îëê ÏñëÌò∏Ìï©ÎãàÎã§. Îã§Í∏∞Í¥Ä Ïó∞Íµ¨ÏóêÏÑú Ïù¥ Ï°∞Ìï©ÏùÄ ectasia Î∞úÏÉù ÏúÑÌóòÏù¥ Í∞ÄÏû• ÎÇÆÏùÄ Í∑∏Î£πÏûÖÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: LASIK Ï†ÅÌï©. ÌëúÏ§Ä ÏàòÏà† ÌîÑÎ°úÌÜ†ÏΩú Ï†ÅÏö© Í∞ÄÎä•.'
        });
    }
    // Case 7: Suspicious Topography
    else if (isSuspiciousTopography) {
        guides.push({
            type: 'moderate-risk',
            icon: 'üîç',
            title: 'Ï∂îÍ∞Ä Í≤ÄÏÇ¨ ÌïÑÏöî - ÏùòÏã¨ ÏÜåÍ≤¨',
            condition: `Suspicious Topography (${topography === 'asymmetric-bowtie' ? 'Asymmetric Bowtie' : 'Inferior Steepening/SRA'})`,
            text: 'ÏùòÏã¨Ïä§Îü¨Ïö¥ topography Ìå®ÌÑ¥ÏùÄ subclinical keratoconusÏùò Í∞ÄÎä•ÏÑ±ÏùÑ ÏãúÏÇ¨Ìï©ÎãàÎã§. ERSSÏôÄ PTA ÏàòÏπòÏôÄ Î¨¥Í¥ÄÌïòÍ≤å Ï∂îÍ∞Ä ÌèâÍ∞ÄÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: Pentacam, Corneal Biomechanics Í≤ÄÏÇ¨ ÌïÑÏàò. Í∞ÄÏ°±Î†•/Îàà ÎπÑÎπÑÎäî ÏäµÍ¥Ä ÌôïÏù∏.'
        });
    }
    // Default moderate case
    else {
        guides.push({
            type: 'moderate-risk',
            icon: 'üìã',
            title: 'Í∞úÎ≥Ñ ÌèâÍ∞Ä ÌïÑÏöî',
            condition: `ERSS: ${erss}, PTA(LASIK): ${ptaLasik.toFixed(1)}%`,
            text: 'Î≥µÌï© ÏßÄÌëúÍ∞Ä Î™ÖÌôïÌïú Î≤îÏ£ºÏóê Ìï¥ÎãπÌïòÏßÄ ÏïäÏäµÎãàÎã§. Í∞úÎ≥Ñ ÏúÑÌóòÏöîÏÜåÎ•º Ï¢ÖÌï©Ï†ÅÏúºÎ°ú Í≥†Î†§Ìï¥Ïïº Ìï©ÎãàÎã§.',
            recommendation: 'Í∂åÍ≥†: Ï†ÑÎ¨∏Ïùò ÏÉÅÎã¥ Î∞è Ï∂îÍ∞Ä Í≤ÄÏÇ¨ Í∂åÏû•.'
        });
    }
    
    // Add LASEK comparison if relevant
    if (ptaLasek < ptaLasik && ptaLasik >= 35) {
        guides.push({
            type: 'low-risk',
            icon: 'üí°',
            title: 'LASEK/PRK ÎåÄÏïà Í≥†Î†§',
            condition: `LASEK PTA: ${ptaLasek.toFixed(1)}% vs LASIK PTA: ${ptaLasik.toFixed(1)}%`,
            text: `LASEKÏùÄ ÌîåÎû©Ïù¥ ÏóÜÏñ¥ PTAÍ∞Ä ${(ptaLasik - ptaLasek).toFixed(1)}% ÎÇÆÏäµÎãàÎã§. Í≤ΩÍ≥Ñ Î≤îÏúÑÏùò ÌôòÏûêÏóêÏÑú LASEKÏù¥ Îçî ÏïàÏ†ÑÌïú ÏÑ†ÌÉùÏùº Ïàò ÏûàÏäµÎãàÎã§.`,
            recommendation: 'Í∂åÍ≥†: LASEK/PRKÎ°ú Ï†ÑÌôò Ïãú ectasia ÏúÑÌóò Í∞êÏÜå Í∏∞ÎåÄ.'
        });
    }
    
    return guides;
}

class RefractiveCalculator {
    constructor() {
        this.form = document.getElementById('patient-form');
        this.resultsContainer = document.getElementById('results-container');
        this.resultsTemplate = document.getElementById('results-template');
        this.currentEye = 'od'; // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠
        this.results = {}; // ÏñëÏïà Í≤∞Í≥º Ï†ÄÏû•
        this.init();
    }
    
    init() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.calculate();
        });
        
        // ÏñëÏïà SE Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
        ['od', 'os'].forEach(eye => {
            const sphInput = document.getElementById(`${eye}-sph`);
            const cylInput = document.getElementById(`${eye}-cyl`);
            
            [sphInput, cylInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => this.updateSE(eye));
                }
            });
        });
        
        // OD‚ÜíOS Î≥µÏÇ¨ Î≤ÑÌäº
        const copyBtn = document.getElementById('copy-od-to-os');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => this.copyODtoOS());
        }
        
        // ÌÖåÎßà ÌÜ†Í∏Ä
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => this.toggleTheme());
        
        // Tab ÌÇ§ Ïù¥Îèô Í∞úÏÑ† - Enter ÌÇ§Î°úÎèÑ Îã§Ïùå ÌïÑÎìú Ïù¥Îèô
        this.setupTabNavigation();
        
        this.loadTheme();
        this.updateSE('od');
        this.updateSE('os');
    }
    
    setupTabNavigation() {
        // ÏûÖÎ†• ÌïÑÎìúÏóêÏÑú Enter ÌÇ§Î•º ÎàÑÎ•¥Î©¥ TabÏ≤òÎüº Îã§Ïùå ÌïÑÎìúÎ°ú Ïù¥Îèô
        const inputs = this.form.querySelectorAll('input, select');
        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextInput = inputs[index + 1];
                    if (nextInput) {
                        nextInput.focus();
                        if (nextInput.select) nextInput.select();
                    } else {
                        // ÎßàÏßÄÎßâ ÌïÑÎìúÏóêÏÑú Enter Ïãú Í≥ÑÏÇ∞ Ïã§Ìñâ
                        this.calculate();
                    }
                }
            });
            
            // Ïà´Ïûê ÏûÖÎ†• ÌïÑÎìúÏóêÏÑú Ìè¨Ïª§Ïä§ Ïãú Ï†ÑÏ≤¥ ÏÑ†ÌÉù
            if (input.type === 'number') {
                input.addEventListener('focus', () => {
                    input.select();
                });
            }
        });
    }
    
    copyODtoOS() {
        const fields = [
            'sph', 'cyl', 'axis', 'cct', 'k1', 'k2', 'steep-axis', 'topography',
            'optical-zone', 'lasik-flap', 'lasek-epi', 'smile-cap'
        ];
        fields.forEach(field => {
            const odValue = document.getElementById(`od-${field}`)?.value;
            const osInput = document.getElementById(`os-${field}`);
            if (odValue !== undefined && osInput) {
                osInput.value = odValue;
            }
        });
        this.updateSE('os');
    }
    
    updateSE(eye) {
        const sph = parseFloat(document.getElementById(`${eye}-sph`)?.value) || 0;
        const cyl = parseFloat(document.getElementById(`${eye}-cyl`)?.value) || 0;
        const se = calculateSE(sph, cyl);
        const seDisplay = document.getElementById(`${eye}-se-display`);
        if (seDisplay) {
            seDisplay.textContent = `${se.toFixed(2)} D`;
        }
    }
    
    getFormData() {
        const formData = new FormData(this.form);
        const common = {
            patientName: formData.get('patient-name') || '',
            patientId: formData.get('patient-id') || '',
            age: parseInt(formData.get('age')),
            gender: formData.get('gender')
        };
        
        return {
            common,
            od: {
                eye: 'OD',
                sph: parseFloat(formData.get('od-sph')),
                cyl: parseFloat(formData.get('od-cyl')),
                axis: parseInt(formData.get('od-axis')),
                cct: parseInt(formData.get('od-cct')),
                k1: parseFloat(formData.get('od-k1')),
                k2: parseFloat(formData.get('od-k2')),
                steepAxis: parseInt(formData.get('od-steep-axis')),
                topography: formData.get('od-topography'),
                opticalZone: parseFloat(formData.get('od-optical-zone')),
                lasikFlap: parseInt(formData.get('od-lasik-flap')),
                lasekEpi: parseInt(formData.get('od-lasek-epi')),
                smileCap: parseInt(formData.get('od-smile-cap')),
                ...common
            },
            os: {
                eye: 'OS',
                sph: parseFloat(formData.get('os-sph')),
                cyl: parseFloat(formData.get('os-cyl')),
                axis: parseInt(formData.get('os-axis')),
                cct: parseInt(formData.get('os-cct')),
                k1: parseFloat(formData.get('os-k1')),
                k2: parseFloat(formData.get('os-k2')),
                steepAxis: parseInt(formData.get('os-steep-axis')),
                topography: formData.get('os-topography'),
                opticalZone: parseFloat(formData.get('os-optical-zone')),
                lasikFlap: parseInt(formData.get('os-lasik-flap')),
                lasekEpi: parseInt(formData.get('os-lasek-epi')),
                smileCap: parseInt(formData.get('os-smile-cap')),
                ...common
            }
        };
    }
    
    calculateForEye(data) {
        const se = calculateSE(data.sph, data.cyl);
        const totalCorrection = calculateTotalCorrection(data.sph, data.cyl);
        const ablationDepth = calculateAblationDepth(totalCorrection, data.opticalZone);
        
        const surgeryResults = {
            lasik: {
                name: 'LASIK',
                flapThickness: data.lasikFlap,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasikFlap, ablationDepth),
                pta: calculatePTA(data.cct, data.lasikFlap, ablationDepth)
            },
            lasek: {
                name: 'LASEK/PRK',
                flapThickness: data.lasekEpi,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.lasekEpi, ablationDepth),
                pta: calculatePTA(data.cct, data.lasekEpi, ablationDepth)
            },
            smile: {
                name: 'SMILE',
                flapThickness: data.smileCap,
                ablationDepth,
                rsb: calculateRSB(data.cct, data.smileCap, ablationDepth),
                pta: calculatePTA(data.cct, data.smileCap, ablationDepth)
            }
        };
        
        const preopK = Math.min(data.k1, data.k2);
        const postopK = calculatePostopK(data.k1, data.k2, data.sph, data.cyl);
        
        const erssResult = calculateERSS({
            age: data.age,
            cct: data.cct,
            topography: data.topography,
            rsb: surgeryResults.lasik.rsb,
            mrse: se
        });
        
        Object.keys(surgeryResults).forEach(key => {
            const result = surgeryResults[key];
            if (key === 'smile') {
                result.eligibility = { status: 'pending', message: 'Ï§ÄÎπÑÏ§ë' };
            } else {
                result.eligibility = determineSurgeryEligibility(
                    result.rsb,
                    result.pta,
                    data.topography,
                    erssResult.total
                );
            }
        });
        
        const nomogramRecommendations = getWellingtonNomogramAdjustments(
            data.sph,
            data.cyl,
            data.age
        );
        
        const combinedRiskInterpretation = getCombinedRiskInterpretation(
            erssResult.total,
            surgeryResults.lasik.pta,
            data.topography
        );
        
        const combinedRiskGuide = generateCombinedRiskGuide(
            erssResult,
            surgeryResults.lasik.pta,
            surgeryResults.lasek.pta,
            data.topography
        );
        
        return {
            surgeryResults,
            preopK,
            postopK,
            erssResult,
            nomogramRecommendations,
            combinedRiskInterpretation,
            combinedRiskGuide,
            se,
            data
        };
    }
    
    calculate() {
        const formData = this.getFormData();
        
        // ÏñëÏïà Í∞ÅÍ∞Å Í≥ÑÏÇ∞
        this.results = {
            od: this.calculateForEye(formData.od),
            os: this.calculateForEye(formData.os)
        };
        
        this.renderResults();
    }
    
    renderResults() {
        const template = this.resultsTemplate.content.cloneNode(true);
        
        // ÏñëÏïà ÌÉ≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        const eyeTabs = template.querySelectorAll('.eye-tab');
        eyeTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const eye = e.currentTarget.dataset.eye;
                this.switchEyeTab(eye);
            });
        });
        
        // ÏñëÏïà Í∞ÅÍ∞Å Î†åÎçîÎßÅ
        ['od', 'os'].forEach(eye => {
            this.renderEyeResults(template, eye, this.results[eye]);
        });
        
        this.resultsContainer.innerHTML = '';
        this.resultsContainer.appendChild(template);
        
        this.setupActionButtons();
    }
    
    renderEyeResults(template, eye, results) {
        // Summary cards
        ['lasik', 'lasek', 'smile'].forEach(key => {
            const summaryItem = template.querySelector(`#summary-${key}-${eye}`);
            if (summaryItem) {
                const result = results.surgeryResults[key];
                summaryItem.classList.add(result.eligibility.status);
                summaryItem.querySelector('.surgery-status').textContent = result.eligibility.message;
            }
        });
        
        // Ablation table
        const tableBody = template.querySelector(`#ablation-table-body-${eye}`);
        if (tableBody) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                const row = document.createElement('tr');
                
                let rsbClass = 'success';
                if (result.rsb < CONFIG.RSB_WARNING_THRESHOLD) rsbClass = 'warning';
                if (result.rsb < CONFIG.RSB_DANGER_THRESHOLD) rsbClass = 'danger';
                
                let ptaClass = 'success';
                if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) ptaClass = 'warning';
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) ptaClass = 'danger';
                
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td>${result.ablationDepth.toFixed(1)}</td>
                    <td class="${rsbClass}">${result.rsb.toFixed(1)}</td>
                    <td class="${ptaClass}">${result.pta.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // K values
        const preopK = template.querySelector(`#preop-k-${eye}`);
        const postopK = template.querySelector(`#postop-k-${eye}`);
        if (preopK) preopK.textContent = `${results.preopK.toFixed(2)} D`;
        if (postopK) postopK.textContent = `${results.postopK.toFixed(2)} D`;
        
        // K warning
        const kWarning = template.querySelector(`#k-warning-${eye}`);
        if (kWarning) {
            if (results.postopK < CONFIG.K_OPTIMAL_MIN) {
                kWarning.textContent = `‚ö†Ô∏è ÏàòÏà† ÌõÑ Í∞ÅÎßâÏù¥ Í≥ºÎèÑÌïòÍ≤å Ìé∏ÌèâÌï¥Ïßà Ïàò ÏûàÏäµÎãàÎã§ (K < ${CONFIG.K_OPTIMAL_MIN}D).`;
                kWarning.classList.add('warning');
            } else if (results.postopK < CONFIG.K_MIN_SAFE) {
                kWarning.textContent = `‚ùå ÏàòÏà† ÌõÑ Í∞ÅÎßâ Íµ¥Ï†àÎ†•Ïù¥ ÎÑàÎ¨¥ ÎÇÆÏäµÎãàÎã§ (K < ${CONFIG.K_MIN_SAFE}D).`;
                kWarning.classList.add('warning');
            } else {
                kWarning.textContent = `‚úì ÏàòÏà† ÌõÑ ÏòàÏÉÅ KÍ∞íÏù¥ ÏïàÏ†Ñ Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏäµÎãàÎã§.`;
            }
        }
        
        // ERSS breakdown
        const erssBreakdown = template.querySelector(`#erss-breakdown-${eye}`);
        if (erssBreakdown) {
            const labels = {
                topography: 'Topography',
                rsb: 'RSB',
                age: 'Age',
                cct: 'CCT',
                mrse: 'MRSE'
            };
            
            Object.entries(results.erssResult.breakdown).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'erss-item';
                item.innerHTML = `
                    <span class="erss-item-label">${labels[key]}</span>
                    <span class="erss-item-score">${value}</span>
                `;
                erssBreakdown.appendChild(item);
            });
        }
        
        // ERSS total
        const erssTotal = template.querySelector(`#erss-total-score-${eye}`);
        if (erssTotal) erssTotal.textContent = results.erssResult.total;
        
        const riskLevel = template.querySelector(`#erss-risk-level-${eye}`);
        if (riskLevel) {
            riskLevel.textContent = results.erssResult.riskLevel === 'low' ? 'Low Risk' :
                results.erssResult.riskLevel === 'moderate' ? 'Moderate Risk' : 'High Risk';
            riskLevel.classList.add(results.erssResult.riskLevel);
        }
        
        // PTA display
        const ptaDisplay = template.querySelector(`#pta-display-${eye}`);
        if (ptaDisplay) {
            Object.entries(results.surgeryResults).forEach(([key, result]) => {
                if (key === 'smile') return;
                
                let ptaClass = 'safe';
                let ptaStatus = 'ÏïàÏ†Ñ';
                
                if (result.pta >= CONFIG.PTA_WARNING_THRESHOLD) {
                    ptaClass = 'danger';
                    ptaStatus = 'ÏúÑÌóò';
                } else if (result.pta >= CONFIG.PTA_SAFE_THRESHOLD) {
                    ptaClass = 'caution';
                    ptaStatus = 'Ï£ºÏùò';
                }
                
                const item = document.createElement('div');
                item.className = `pta-item ${ptaClass}`;
                item.innerHTML = `
                    <div class="pta-surgery">${result.name}</div>
                    <div class="pta-value">${result.pta.toFixed(1)}%</div>
                    <div class="pta-status">${ptaStatus}</div>
                `;
                ptaDisplay.appendChild(item);
            });
        }
        
        // Combined risk matrix
        this.renderCombinedRiskMatrix(template, eye, results);
        
        // Nomogram info
        const nomogramInfo = template.querySelector(`#nomogram-info-${eye}`);
        if (nomogramInfo) {
            results.nomogramRecommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'nomogram-item';
                item.innerHTML = `
                    <div class="nomogram-title">${rec.title}</div>
                    <div class="nomogram-text">${rec.text}</div>
                `;
                nomogramInfo.appendChild(item);
            });
        }
    }
    
    renderCombinedRiskMatrix(template, eye, results) {
        const interpretation = results.combinedRiskInterpretation;
        const lasikPta = results.surgeryResults.lasik.pta;
        const erssScore = results.erssResult.total;
        
        const matrixContainer = template.querySelector(`#combined-risk-matrix-${eye}`);
        if (matrixContainer) {
            const matrixHTML = `
                <div class="matrix-cell matrix-header"></div>
                <div class="matrix-cell matrix-header">PTA &lt;35%<br>(Ï†ÄÏúÑÌóò)</div>
                <div class="matrix-cell matrix-header">PTA 35-40%<br>(Ï§ëÎì±ÏúÑÌóò)</div>
                <div class="matrix-cell matrix-header">PTA ‚â•40%<br>(Í≥†ÏúÑÌóò)</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 0-2<br>(Ï†ÄÏúÑÌóò)</div>
                <div class="matrix-cell risk-low ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'low')}">Ï†ÄÏúÑÌóò</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'moderate')}">Ï†Ä-Ï§ëÎì±</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'low', 'high')}">Ï§ëÎì±ÏúÑÌóò</div>
                
                <div class="matrix-cell matrix-row-header">ERSS 3<br>(Ï§ëÎì±ÏúÑÌóò)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'low')}">Ï†Ä-Ï§ëÎì±</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'moderate')}">Ï§ëÎì±ÏúÑÌóò</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'moderate', 'high')}">Í≥†ÏúÑÌóò</div>
                
                <div class="matrix-cell matrix-row-header">ERSS ‚â•4<br>(Í≥†ÏúÑÌóò)</div>
                <div class="matrix-cell risk-moderate ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'low')}">Ï§ëÎì±ÏúÑÌóò</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'moderate')}">Í≥†ÏúÑÌóò</div>
                <div class="matrix-cell risk-high ${this.getMatrixHighlight(erssScore, lasikPta, 'high', 'high')}">Îß§Ïö∞ Í≥†ÏúÑÌóò</div>
            `;
            matrixContainer.innerHTML = matrixHTML;
        }
        
        const guideContainer = template.querySelector(`#interpretation-guide-${eye}`);
        if (guideContainer && interpretation) {
            let badgeClass = 'low';
            if (interpretation.level === 'moderate' || interpretation.level === 'low-moderate') {
                badgeClass = 'moderate';
            } else if (interpretation.level === 'high' || interpretation.level === 'very-high') {
                badgeClass = 'high';
            }
            
            const recommendationsHTML = interpretation.recommendations
                .map(rec => `<li>${rec}</li>`)
                .join('');
            
            guideContainer.innerHTML = `
                <div class="interpretation-title">
                    ${interpretation.title}
                    <span class="interpretation-badge ${badgeClass}">
                        ERSS ${erssScore}Ï†ê + PTA ${lasikPta.toFixed(1)}%
                    </span>
                </div>
                <div class="interpretation-text">${interpretation.text}</div>
                <div class="interpretation-recommendations">
                    <h5>Í∂åÏû• ÏÇ¨Ìï≠</h5>
                    <ul class="recommendation-list">
                        ${recommendationsHTML}
                    </ul>
                </div>
            `;
        }
    }
    
    getMatrixHighlight(erssScore, pta, erssLevel, ptaLevel) {
        let currentErssLevel;
        if (erssScore <= 2) currentErssLevel = 'low';
        else if (erssScore === 3) currentErssLevel = 'moderate';
        else currentErssLevel = 'high';
        
        let currentPtaLevel;
        if (pta < 35) currentPtaLevel = 'low';
        else if (pta < 40) currentPtaLevel = 'moderate';
        else currentPtaLevel = 'high';
        
        if (currentErssLevel === erssLevel && currentPtaLevel === ptaLevel) {
            return 'current-position';
        }
        return '';
    }
    
    switchEyeTab(eye) {
        this.currentEye = eye;
        
        // ÌÉ≠ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelectorAll('.eye-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.eye === eye);
        });
        
        // Í≤∞Í≥º ÏΩòÌÖêÏ∏† ÌëúÏãú/Ïà®ÍπÄ
        document.querySelectorAll('.eye-results-content').forEach(content => {
            content.classList.toggle('active', content.id === `results-${eye}`);
        });
    }
    
    setupActionButtons() {
        document.getElementById('btn-print')?.addEventListener('click', () => {
            window.print();
        });
        
        document.getElementById('btn-save')?.addEventListener('click', () => {
            this.saveResults();
        });
        
        document.getElementById('btn-new')?.addEventListener('click', () => {
            this.form.reset();
            this.resultsContainer.innerHTML = `
                <div class="results-placeholder">
                    <div class="placeholder-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
                            <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <p>ÌôòÏûê Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÍ≥†<br><strong>Í≥ÑÏÇ∞ÌïòÍ∏∞</strong> Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
                </div>
            `;
            this.updateSE('od');
            this.updateSE('os');
        });
    }
    
    saveResults() {
        const formData = this.getFormData();
        const results = this.results;
        
        // Use enhanced save function
        const savedPatient = savePatientData(formData, results);
        
        showNotification(`${savedPatient.patientName || savedPatient.patientId || 'ÌôòÏûê'} Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        console.log('Saved patient:', savedPatient);
    }
    
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }
    
    loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.calculator = new RefractiveCalculator();
    new TopographyAnalyzer();
});
    </script>
</body>
</html>
